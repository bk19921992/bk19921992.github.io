<!DOCTYPE html>
<html lang="en-Gest match">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Numan Healthspan - Own Your Healthspan</title>
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
	<style>
		:root {
			--numan-teal:#1ecfc0; --numan-teal-600:#15b5a8; --ink:#111; --ink-60:#6b7280; --paper:#fff; --canvas:#f4f7f6; --mint-50:#eaf7f5;
			--shadow:0 4px 14px rgba(0,0,0,.08);
			--success:#10b981; --warning:#f59e0b; --error:#ef4444;
			--ink-10:#f3f4f6; --ink-20:#e5e7eb; --ink-40:#9ca3af; --ink-50:#6b7280; --ink-80:#374151;
			--success-50:#ecfdf5; --error-50:#fef2f2;
			--font-mono:'Inter', monospace;
		}
		* {margin:0; padding:0; box-sizing:border-box}
		html,body {height:100%}
		html {background:linear-gradient(135deg, #ffffff 0%, #eaf7f5 50%, #1ecfc0 100%); background-repeat:no-repeat; background-attachment:fixed; background-size:100% 100%; min-height:100%}
		body {font-family:'Inter',sans-serif; color:var(--ink); background:transparent; min-height:100vh; line-height:1.6; position:relative}
		
		/* Fallback for browsers with poor background-attachment support */
		@supports not (background-attachment: fixed) {
			html::before {
				content: '';
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background: linear-gradient(135deg, #ffffff 0%, #eaf7f5 50%, #1ecfc0 100%);
				z-index: -1;
			}
		}
		h1,h2,h3,h4 {font-family:'Bebas Neue',sans-serif; letter-spacing:.02em}
		h1{font-size:clamp(2.5rem,5vw,4rem); line-height:1.1}
		h2{font-size:clamp(2rem,4vw,3rem); line-height:1.2}
		h3{font-size:1.75rem}
		small, .muted {color:var(--ink-60)}
		a {color:inherit}
		button {font-family:inherit}
		.visually-hidden{position:absolute; width:1px; height:1px; margin:-1px; padding:0; border:0; clip:rect(0 0 0 0); overflow:hidden}
		/* Nav */
		nav{background:var(--paper); padding:1rem 2rem; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 8px rgba(0,0,0,.05); position:sticky; top:0; z-index:100}
		.logo{font-weight:800; font-size:1.5rem; color:var(--ink); text-decoration:none; display:flex; align-items:center; gap:.5rem}
		.beta-ribbon{background:var(--mint-50); color:var(--numan-teal-600); padding:.125rem .5rem; border-radius:999px; font-weight:700; font-size:.75rem}
		.nav-links{display:flex; gap:1rem; align-items:center}
		.nav-links a{color:var(--ink); text-decoration:none; font-weight:600}
		.nav-links a:hover{color:var(--numan-teal)}
		.nav-links a.locked{color:var(--ink-60); cursor:not-allowed; opacity:0.6}
		.nav-links a.locked:hover{color:var(--ink-60)}
		.nav-links a:not(.locked){color:var(--ink) !important; opacity:1 !important; cursor:pointer !important}
		.nav-links a:not(.locked):hover{color:var(--numan-teal) !important}
		.device-chips{display:flex; gap:.5rem; align-items:center}
		.device-chip{display:inline-flex; gap:.375rem; align-items:center; padding:.25rem .5rem; background:var(--canvas); border:1px solid #e5e7eb; border-radius:999px; font-size:.8rem}
		.device-chip.primary{border-color:var(--numan-teal); background:var(--mint-50)}
		/* Layout */
        .container{max-width:1200px; margin:0 auto; padding:2rem; padding-bottom: var(--footer-h)}
		.hero{background:linear-gradient(135deg,var(--mint-50) 0%,var(--canvas) 100%); padding:2rem 2rem; text-align:center; border-radius:20px; margin:1rem 0}
		.hero p{font-size:1.125rem; color:var(--ink-60); margin:.5rem 0 1.5rem}
		/* Buttons */
		.btn{display:inline-block; padding:1rem 2rem; background:var(--numan-teal); color:#fff; text-decoration:none; border-radius:999px; font-weight:700; border:none; cursor:pointer; transition:.2s}
		.btn:hover{background:var(--numan-teal-600); transform:translateY(-1px); box-shadow:0 10px 18px rgba(30,207,192,.25)}
		.btn:focus{outline:3px solid var(--numan-teal); outline-offset:3px}
		.btn-secondary{background:var(--paper); color:var(--numan-teal); border:2px solid var(--numan-teal)}
		.btn-ghost{background:transparent; color:var(--ink); border:1px solid #e5e7eb}
		.btn-small{padding:.5rem 1rem; font-weight:600}
		/* Cards */
		.card{background:var(--paper); border-radius:16px; padding:1.5rem; box-shadow:var(--shadow); margin-bottom:1rem}
		.card-grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:1rem; margin:1rem 0}
		.health-tiles-grid{display:grid; grid-template-columns:repeat(3,1fr); gap:1rem; margin:1rem 0}
		/* Forms */
		label{display:block; margin-bottom:.4rem; font-weight:600}
		input,select,textarea{width:100%; padding:.75rem; border:2px solid #e5e7eb; border-radius:10px; font-size:1rem}
		input:focus,select:focus,textarea:focus{outline:none; border-color:var(--numan-teal)}
		.checkbox-grid{display:flex; flex-wrap:wrap; gap:.75rem}
		.check-pill{display:flex; align-items:center; gap:.5rem; padding:.6rem .9rem; border:2px solid #e5e7eb; border-radius:12px; cursor:pointer; transition:all 0.2s ease}
		.check-pill.selected{border-color:var(--numan-teal); background:var(--mint-50)}
		.check-pill input[type="checkbox"]{margin:0; width:18px; height:18px; accent-color:var(--numan-teal); cursor:pointer; flex-shrink:0}
		.check-pill span{flex:1; line-height:1.4}
		.check-pill:hover{border-color:var(--numan-teal); background:var(--mint-25)}
		/* Toggle Switch */
		.toggle-switch{position:relative; display:inline-block; width:50px; height:24px}
		.toggle-switch input{opacity:0; width:0; height:0}
		.toggle-slider{position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background-color:#ccc; transition:.4s; border-radius:24px}
		.toggle-slider:before{position:absolute; content:""; height:18px; width:18px; left:3px; bottom:3px; background-color:white; transition:.4s; border-radius:50%}
		input:checked + .toggle-slider{background-color:var(--numan-teal)}
		input:checked + .toggle-slider:before{transform:translateX(26px)}
		/* Views */
        .view{display:none; min-height:100vh; overflow-y:auto}
        .view.active{display:block; animation:fadeIn .25s ease-in}
		@keyframes fadeIn{from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:none}}
		/* Service tiles */
		.service-card{position:relative; border:2px solid #e5e7eb; border-radius:12px; padding:1rem; cursor:pointer; transition:all 0.2s ease}
		.service-card:hover{border-color:var(--numan-teal); background:var(--mint-50)}
		.service-card.selected{border-color:var(--numan-teal); background:var(--mint-50); box-shadow:0 0 0 2px var(--numan-teal) inset}
		.service-card.connected{border-color:#10b981; background:#ecfdf5}
		.service-card.connected:hover{border-color:#059669; background:#d1fae5}
		.service-card.primary{border-color:var(--numan-teal); background:var(--mint-50); box-shadow:0 2px 8px rgba(30,207,192,0.2)}
		.service-card.primary:hover{border-color:var(--numan-teal); background:var(--mint-50)}
		.service-card .tick{position:absolute; top:10px; right:10px; width:24px; height:24px; border-radius:50%; background:var(--numan-teal); color:#fff; display:none; align-items:center; justify-content:center; font-weight:800; font-size:.9rem}
		.service-card.selected .tick{display:flex}
		.service-card.gated{opacity:0.6; cursor:not-allowed}
		.service-category{margin-top:.5rem; font-size:.9rem; line-height:1.4; color:#6b7280}
		.service-category strong{color:#374151}
		.service-header{display:flex; justify-content:space-between; gap:0.5rem; margin-bottom:0.5rem}
		.badges{display:flex; gap:.4rem; flex-wrap:wrap}
		.badge{display:inline-block; padding:.1rem .5rem; border-radius:999px; font-size:.72rem; font-weight:700}
		.badge.recommended{background:#fbbf24; color:#111}
		.badge.clinical{background:#8b5cf6; color:#fff}
		.badge.bundle{background:var(--numan-teal); color:#fff}
		.badge.saver{background:#d1fae5; color:#065f46; border:1px solid #a7f3d0}
		.badge.requestable{background:#f3f4f6; color:#6b7280; border:1px solid #d1d5db}
		.badge.tooltip{position:relative}
		.badge.tooltip:hover:after{content:attr(data-tip); position:absolute; white-space:nowrap; left:0; top:120%; background:#111; color:#fff; padding:.25rem .5rem; border-radius:6px; font-size:.72rem}
		.service-price{font-weight:800; color:var(--numan-teal)}
		
		/* Catalog sections */
		.catalog-section{margin-top:1rem}
		.catalog-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem}
		.catalog-header h4{margin:0; color:var(--ink)}
		.catalog-header small{color:var(--ink-60)}
		.section-body.collapsed{display:none}
		
		
		/* New Plan Design Styles */
		.section-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem}
		.section-header h3{margin:0; color:var(--ink)}
		.section-header small{margin:0; color:var(--ink-60)}
		
		.service-grid{display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); gap:1rem; margin-bottom:1.5rem}
		.service-grid.recommended{grid-template-columns:repeat(auto-fit, minmax(300px, 1fr))}
		
		.service-card{position:relative; border:2px solid #e5e7eb; border-radius:12px; padding:0.75rem; cursor:pointer; transition:all 0.2s ease; min-height:70px}
		.service-card h4{margin:0 0 0.25rem 0; font-size:0.95rem; line-height:1.2}
		.service-card p{margin:0 0 0.5rem 0; font-size:0.85rem; line-height:1.3}
		.service-card a{font-size:0.8rem}
		.service-card:hover{border-color:var(--numan-teal); background:var(--mint-50); transform:translateY(-2px); box-shadow:0 4px 12px rgba(30,207,192,0.15)}
		.service-card.selected{border-color:var(--numan-teal); background:var(--mint-50); border-width:3px}
		.service-card.selected:hover{border-color:var(--numan-teal); background:var(--mint-50)}
		
		.selected-indicator{position:absolute; top:0.75rem; right:0.75rem; width:24px; height:24px; background:var(--numan-teal); color:white; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:14px}
		
		.service-outcome{font-size:0.9rem; color:var(--ink-60); margin:0.25rem 0; font-weight:500}
		.service-features{font-size:0.85rem; color:var(--ink-40); margin:0.25rem 0 0.5rem 0}
		.service-reasons{margin-top:0.5rem}
		.service-reasons .reason{display:block; font-size:0.8rem; color:var(--ink-50); margin:0.125rem 0}
		
		.plan-hint{animation:pulse 2s infinite}
		@keyframes pulse{0%, 100%{opacity:1} 50%{opacity:0.8}}
		
		.gated-panel{animation:slideDown 0.3s ease-out}
		@keyframes slideDown{from{opacity:0; transform:translateY(-10px)} to{opacity:1; transform:translateY(0)}}
		
		/* Focus and accessibility */
		.service-card:focus{outline:2px solid var(--numan-teal); outline-offset:2px}
		.service-card:focus-visible{outline:2px solid var(--numan-teal); outline-offset:2px}
		
		/* Mobile responsiveness */
		@media (max-width: 768px) {
			.service-grid{grid-template-columns:1fr; gap:0.75rem}
			.service-card{padding:0.5rem; min-height:60px}
			.section-header{flex-direction:column; align-items:flex-start; gap:0.5rem}
			.health-tiles-grid{grid-template-columns:1fr; gap:0.75rem}
		}
		/* Plan Builder */
		.tiers{display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:1rem}
		.tier{border:2px solid #e5e7eb; border-radius:14px; padding:1rem}
		.tier.anchor{border-color:var(--numan-teal)}
		.tier .row{display:flex; justify-content:space-between; gap:.5rem; align-items:center}
		.tier ul{margin:.5rem 0 0 1rem}
		.mini{font-size:.9rem; color:var(--ink-60)}
		.progress-banner{padding:.75rem 1rem; background:var(--canvas); border:1px dashed #d1d5db; border-radius:12px}
		/* =============== STANDARDIZED CHECKOUT FOOTER ARCHITECTURE =============== */
		
		/* Base footer class - unified design system */
		.checkout-footer {
			position: fixed;
			left: 0;
			right: 0;
			bottom: 0;
			z-index: 60;
			height: 80px;
			background: rgba(255, 255, 255, 0.98);
			border-top: 1px solid rgba(30, 207, 192, 0.15);
			backdrop-filter: saturate(120%) blur(20px);
			box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.12), 0 -2px 8px rgba(30, 207, 192, 0.1);
			padding: 1rem 1.5rem;
			transition: all 0.3s ease;
		}
		
		/* Three-section horizontal layout */
		.checkout-footer .footer-inner {
			max-width: 1200px;
			margin: 0 auto;
			height: 100%;
			display: grid;
			grid-template-columns: 1.4fr 1fr auto;
			gap: 2rem;
			align-items: center;
			width: 100%;
		}
		
		/* Left section: Plan summary information */
		.checkout-footer .section-left {
			min-width: 0;
			display: flex;
			flex-direction: column;
			gap: 0.4rem;
		}
		
		.checkout-footer .plan-title {
			font-weight: 800;
			font-size: 1.15rem;
			color: var(--ink);
			margin: 0;
			letter-spacing: -0.01em;
			line-height: 1.2;
		}
		
		.checkout-footer .plan-meta {
			font-size: 0.9rem;
			color: var(--ink-70);
			margin: 0;
			font-weight: 600;
			line-height: 1.3;
		}
		
		.checkout-footer .plan-details {
			font-size: 0.85rem;
			color: var(--ink-60);
			margin: 0;
			line-height: 1.3;
			font-weight: 500;
		}
		
		/* Center section: Pricing breakdown */
		.checkout-footer .pricing {
			display: flex;
			flex-direction: column;
			gap: 0.5rem;
			text-align: center;
			min-width: 0;
			background: rgba(240, 253, 250, 0.9);
			padding: 0.875rem 1.125rem;
			border-radius: 10px;
			border: 1px solid rgba(30, 207, 192, 0.15);
			box-shadow: 0 2px 8px rgba(30, 207, 192, 0.08);
		}
		
		.checkout-footer .pricing .row {
			display: flex;
			justify-content: space-between;
			gap: 1.5rem;
			align-items: center;
		}
		
		.checkout-footer .pricing .label {
			color: var(--ink-70);
			font-size: 0.9rem;
			font-weight: 600;
		}
		
		.checkout-footer .pricing .value {
			color: var(--ink);
			font-weight: 800;
			font-size: 1rem;
		}
		
		.checkout-footer .pricing .total-value {
			color: var(--numan-teal);
			font-weight: 800;
			font-size: 1rem;
		}
		
		/* Right section: Primary action button */
		.checkout-footer .actions {
			display: flex;
			gap: 0.75rem;
			justify-content: flex-end;
			align-items: center;
			min-width: 0;
		}
		
		.checkout-footer .actions .checkout-cta {
			background: linear-gradient(135deg, var(--numan-teal) 0%, #15b5a8 100%);
			color: #fff;
			border: none;
			padding: 0.875rem 1.5rem;
			border-radius: 12px;
			font-weight: 800;
			font-size: 1rem;
			cursor: pointer;
			transition: all 0.3s ease;
			box-shadow: 0 4px 16px rgba(30, 207, 192, 0.3);
			min-width: 180px;
			text-align: center;
			letter-spacing: -0.01em;
		}
		
		.checkout-footer .actions .checkout-cta:hover {
			transform: translateY(-2px);
			box-shadow: 0 8px 20px rgba(30, 207, 192, 0.4);
		}
		
		.checkout-footer .actions .checkout-cta:disabled {
			opacity: 0.6;
			cursor: not-allowed;
			transform: none;
			box-shadow: 0 4px 12px rgba(30, 207, 192, 0.2);
		}
		
		.checkout-footer .actions .btn-secondary {
			background: var(--ink-20);
			color: var(--ink);
			border: 1px solid var(--ink-30);
			padding: 0.75rem 1rem;
			border-radius: 8px;
			font-weight: 600;
			font-size: 0.9rem;
			cursor: pointer;
			transition: all 0.3s ease;
			min-width: 100px;
		}
		
		.checkout-footer .actions .btn-secondary:hover {
			background: var(--ink-30);
			transform: translateY(-1px);
		}
		
		/* Responsive design */
		@media (max-width: 768px) {
			.checkout-footer {
				height: auto;
				padding: 0.75rem 1rem;
			}
			
			.checkout-footer .footer-inner {
				grid-template-columns: 1fr;
				gap: 0.75rem;
				height: auto;
			}
			
			.checkout-footer .section-left {
				text-align: center;
				order: 1;
			}
			
			.checkout-footer .pricing {
				text-align: center;
				padding: 0.625rem 0.875rem;
				order: 2;
			}
			
			.checkout-footer .actions {
				justify-content: stretch;
				flex-direction: row;
				gap: 0.75rem;
				order: 3;
			}
			
			.checkout-footer .actions .checkout-cta,
			.checkout-footer .actions .btn-secondary {
				flex: 1;
				min-width: auto;
				padding: 0.75rem 1rem;
				font-size: 0.9rem;
			}
		}

		/* Inline Checkout Sections (no fixed footer) */
        section[data-view="plan"] .checkout-footer,
        section[data-view="build-first-month"] .checkout-footer,
        section[data-view="addons"] .checkout-footer {
            position: relative !important;
            left: auto !important;
            right: auto !important;
            bottom: auto !important;
            height: auto !important;
            margin-top: 0.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
            z-index: 1;
            pointer-events: auto;
        }

		section[data-view="plan"] .checkout-footer .footer-inner,
		section[data-view="build-first-month"] .checkout-footer .footer-inner,
		section[data-view="addons"] .checkout-footer .footer-inner {
			height: auto;
		}

		/* Remove extra bottom padding reserved for fixed footers */
		section[data-view="plan"] .container,
		section[data-view="build-first-month"] .container,
		section[data-view="addons"] .container {
			padding-bottom: 0 !important;
			margin-bottom: 0 !important;
		}

		@media (max-width: 768px) {
			section[data-view="plan"] .container,
			section[data-view="build-first-month"] .container,
			section[data-view="addons"] .container {
				padding-bottom: 0 !important;
			}
		}
		
		/* Legacy compatibility - maintain existing plan-summary class */
		.plan-summary {
			position: fixed;
			left: 0;
			right: 0;
			bottom: 0;
			z-index: 50;
			background: var(--paper);
			border-top: 1px solid var(--mint-50);
			box-shadow: 0 -4px 18px rgba(0, 0, 0, 0.08);
			padding: 0.75rem 0;
		}
		
		.summary-content {
			max-width: 1200px;
			margin: 0 auto;
			display: flex;
			align-items: center;
			justify-content: space-between;
			gap: 0.75rem;
			flex-wrap: wrap;
		}
		
		/* Remove bottom gap but ensure scrolling works */
		body{margin-bottom:0; padding-bottom:0; overflow-x:hidden; overflow-y:auto}
		.container:last-child{margin-bottom:0; padding-bottom:0}
		
		/* Ensure main content areas are scrollable */
        /* Ensure only the active view is visible (override earlier resets) */
        .view{display:none; overflow-y:auto; min-height:100vh; position:relative}
        .view.active{display:block}
		section{position:relative; min-height:100vh}
		
        /* Ensure page content has adequate bottom padding for standardized footer */
        .container{padding-bottom:120px}
        
        /* Specific padding for pages with standardized checkout footer */
        section[data-view="plan"] .container,
        section[data-view="build-first-month"] .container,
        section[data-view="addons"] .container {
            padding-bottom: 120px;
        }
        
        /* Remove per-view padding overrides for footer */
        
        /* Remove per-view footer overrides */
        
        /* Footer button styling (shared) */
        .plan-summary .btn{min-width:100px; padding:0.5rem 1rem; font-weight:600; border-radius:6px; font-size:0.9rem; transition:all 0.3s ease}
        
        .plan-summary .checkout-cta{background: linear-gradient(135deg, var(--numan-teal) 0%, #15b5a8 100%); color: white; border: none; box-shadow: 0 3px 10px rgba(30, 207, 192, 0.25)}
        
        .plan-summary .checkout-cta:hover{transform: translateY(-2px); box-shadow: 0 8px 20px rgba(30, 207, 192, 0.4)}
        
        /* Ensure proper spacing for pages with fixed footers */
        section[data-view="plan"] .container,
        section[data-view="build-first-month"] .container,
        section[data-view="addons"] .container {
            padding-bottom: 200px;
            margin-bottom: 0;
        }
        
        /* Make footer content more compact */
        section[data-view="plan"] .plan-summary .summary-content,
        section[data-view="build-first-month"] .plan-summary .summary-content,
        section[data-view="addons"] .plan-summary .summary-content {
            gap: 0.5rem;
            align-items: center;
        }
        
        section[data-view="plan"] .plan-summary .pricing-row,
        section[data-view="build-first-month"] .plan-summary .pricing-row,
        section[data-view="addons"] .plan-summary .pricing-row {
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
        }
        
        /* Ensure the view sections are scrollable */
        section[data-view="build-first-month"],
        section[data-view="addons"] {
            min-height: 100vh;
            overflow-y: auto;
            padding-bottom: 0;
        }
		.summary-price{font-size:1.5rem; font-weight:800; color:var(--numan-teal)}
        .pricing-card{background:linear-gradient(135deg, var(--mint-50) 0%, #f0fdfa 100%); border:1px solid var(--numan-teal); border-radius:12px; padding:0.75rem 1rem; margin:0.5rem 0; position:relative; overflow:hidden}
		.pricing-card::before{content:''; position:absolute; top:0; left:0; right:0; height:4px; background:linear-gradient(90deg, var(--numan-teal) 0%, #15b5a8 100%)}
        .pricing-row{display:flex; justify-content:space-between; align-items:center; margin-bottom:0.4rem; padding:0.25rem 0}
        .pricing-row:last-child{margin-bottom:0; padding-top:0.5rem; border-top:1px solid rgba(30,207,192,0.2); font-weight:700; font-size:1rem}
        .pricing-label{color:var(--ink-60); font-weight:500; font-size:0.95rem}
        .pricing-value{color:var(--ink); font-weight:600; font-size:0.95rem}
        .pricing-total{color:var(--numan-teal); font-weight:800; font-size:1.05rem}
        .checkout-cta{background:linear-gradient(135deg, var(--numan-teal) 0%, #15b5a8 100%); border:none; color:white; padding:0.75rem 1.5rem; border-radius:10px; font-weight:700; font-size:1rem; cursor:pointer; transition:all 0.3s ease; box-shadow:0 3px 10px rgba(30,207,192,0.25)}
		.checkout-cta:hover{transform:translateY(-2px); box-shadow:0 8px 20px rgba(30,207,192,0.4)}
		.checkout-cta:disabled{opacity:0.6; cursor:not-allowed; transform:none; box-shadow:0 4px 12px rgba(30,207,192,0.2)}
		.collapsible{background:var(--canvas); border-radius:10px}
		.collapsible-header{display:flex; justify-content:space-between; align-items:center; padding:.75rem 1rem; cursor:pointer; user-select:none}
		.collapsible-header:hover{background:rgba(0,0,0,0.02)}
		.collapsible-content{display:none; padding:0 1rem 1rem; transition:all 0.3s ease}
		.collapsible-content.show{display:block}
		/* Charts */
		.chart-container{margin:1rem 0; background:var(--canvas); padding:1rem; border-radius:12px; position:relative}
		/* Hide legacy canvas gauges - use the new fixed semicircle gauges instead */
		#age-gauge, #ob-age-gauge{display:none}
		.chart-header{display:flex; justify-content:space-between}
		.chart-avg{font-size:1.25rem; font-weight:800; color:var(--numan-teal)}
		.impact-chip{display:inline-block; padding:.15rem .5rem; background:var(--mint-50); color:var(--numan-teal); border-radius:999px; font-weight:700; font-size:.8rem}
		
		/* Enhanced Biological Age Gauge */
		.bio-gauge{width:100%; max-width:480px; height:auto; margin:1rem auto; display:block}
		.bio-gauge text{font-family:'Inter',sans-serif; font-weight:600}
		.bio-gauge .tick{font-size:clamp(10px, 2vw, 14px); fill:#6b7280; font-weight:600}
		.bio-gauge .arc-good{stroke:#16a34a; stroke-width:8; transition:stroke-width 0.3s ease}
		.bio-gauge .arc-warn{stroke:#f59e0b; stroke-width:8; transition:stroke-width 0.3s ease}
		.bio-gauge .needle{stroke:#14b8a6; stroke-width:6; stroke-linecap:round; transition:all 0.5s ease; filter:drop-shadow(0 2px 4px rgba(20, 184, 166, 0.3))}
		.bio-gauge .hub{fill:#fff; stroke:#14b8a6; stroke-width:6; filter:drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1))}
		.bio-gauge:hover .arc-good,
		.bio-gauge:hover .arc-warn{stroke-width:10}
		
		/* Gauge Info Panel */
		.gauge-info-panel{margin-top:1rem; padding:1rem; background:var(--canvas); border-radius:12px; border:1px solid var(--mint-50)}
		.age-comparison{display:grid; grid-template-columns:repeat(auto-fit, minmax(120px, 1fr)); gap:1rem; text-align:center}
		.biological-age, .chronological-age{display:flex; flex-direction:column; gap:0.25rem}
		.biological-age .label, .chronological-age .label{font-size:0.8rem; color:var(--ink-60); font-weight:500}
		.biological-age .value, .chronological-age .value{font-size:1.5rem; font-weight:800; color:var(--ink)}
		.age-delta{display:flex; flex-direction:column; gap:0.25rem; align-items:center}
		.age-delta.positive .delta-value{color:#10b981; font-weight:700}
		.age-delta.negative .delta-value{color:#ef4444; font-weight:700}
		.delta-direction{font-size:0.8rem; color:var(--ink-60)}
		
		/* Personalization Engine Styles */
		.personalisation-header{text-align:center; margin-bottom:2rem; padding:1.5rem; background:var(--canvas); border-radius:12px; border:1px solid var(--mint-50)}
		.personalisation-note{color:var(--ink-60); margin:0.5rem 0 1rem; font-size:0.9rem}
		.recommendation-sections{display:grid; gap:1.5rem; margin-bottom:2rem}
		.recommendation-section{background:var(--paper); border-radius:12px; padding:1.5rem; border:1px solid var(--mint-50)}
		.recommendation-section h4{display:flex; align-items:center; gap:0.75rem; margin:0 0 1rem; color:var(--ink); font-size:1.1rem}
		.allowance-badge{background:var(--numan-teal); color:white; padding:0.25rem 0.5rem; border-radius:12px; font-size:0.8rem; font-weight:600}
		.recommendation-grid{display:grid; gap:1rem; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr))}
		.recommendation-card{display:flex; align-items:center; justify-content:space-between; padding:1rem; background:var(--canvas); border-radius:8px; border:1px solid var(--mint-50); transition:all 0.3s ease}
		.recommendation-card:hover{border-color:var(--numan-teal); box-shadow:0 2px 8px rgba(30,207,192,0.1)}
		.recommendation-content{flex:1}
		.recommendation-content h5{margin:0 0 0.25rem; color:var(--ink); font-size:1rem; font-weight:600}
		.recommendation-reason{color:var(--ink-60); font-size:0.85rem; margin:0 0 0.75rem}
		.recommendation-actions{display:flex; gap:0.5rem; margin-top:0.5rem}
		.recommendation-actions .btn-ghost{font-size:0.8rem; padding:0.25rem 0.5rem; border:1px solid var(--mint-50); color:var(--ink-60)}
		.recommendation-actions .btn-ghost:hover{color:var(--numan-teal); border-color:var(--numan-teal); background:var(--mint-50)}
		.add-custom-section{margin-top:1rem; text-align:center; padding-top:1rem; border-top:1px solid var(--mint-50)}
		.personalisation-controls{display:flex; gap:0.75rem; justify-content:center; margin-top:1rem}
		.recommendation-controls{display:flex; gap:1rem; justify-content:center; margin-top:2rem}
		
		/* Plan Recommendation Styles - Compact Version */
		.plan-recommendation-content{background:var(--paper); border-radius:8px; padding:0.75rem; border:1px solid var(--numan-teal); box-shadow:0 2px 8px rgba(30,207,192,0.08); text-align:center; max-width:400px; margin:0 auto}
		.recommendation-badge{display:inline-flex; align-items:center; gap:0.25rem; background:linear-gradient(135deg, var(--numan-teal), #15b5a8); color:white; padding:0.4rem 0.8rem; border-radius:12px; font-weight:600; font-size:1rem; margin-bottom:0.75rem}
		.badge-icon{font-size:1rem}
		.plan-highlight{margin-bottom:0.5rem}
		.plan-highlight h4{color:var(--ink); font-size:1rem; margin:0 0 0.25rem; font-weight:700}
		.price-highlight{display:flex; align-items:baseline; justify-content:center; gap:0.25rem; margin-bottom:0.5rem}
		.price{color:var(--numan-teal); font-size:1.4rem; font-weight:800}
		.period{color:var(--ink-60); font-size:0.8rem}
		.recommendation-reasons{text-align:left; margin-bottom:0.75rem}
		.recommendation-reasons h5{color:var(--ink); font-size:0.85rem; margin:0 0 0.4rem; font-weight:600}
		.reason-list{list-style:none; padding:0; margin:0}
		.reason-item{display:flex; align-items:center; gap:0.3rem; padding:0.2rem 0; color:var(--ink-60); font-size:0.8rem}
		.reason-item::before{content:'✓'; color:var(--numan-teal); font-weight:700; font-size:0.75rem}
		.recommendation-cta{background:linear-gradient(135deg, var(--numan-teal), #15b5a8); border:none; color:white; padding:0.4rem 0.8rem; border-radius:8px; font-weight:700; font-size:0.8rem; cursor:pointer; transition:all 0.3s ease; box-shadow:0 4px 12px rgba(30,207,192,0.3)}
		.recommendation-cta:hover{transform:translateY(-2px); box-shadow:0 8px 20px rgba(30,207,192,0.4)}
		
		/* Navigation Controller Styles */
		.nav-links a.locked{opacity:0.5; cursor:not-allowed; pointer-events:none}
		.nav-links a.locked:hover{opacity:0.5}
		.navigation-progress{background:var(--canvas); border-radius:12px; padding:1.5rem; margin:1rem 0; border:1px solid var(--mint-50)}
		.progress-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem}
		.progress-header h4{margin:0; color:var(--ink); font-size:1.1rem}
		.progress-percentage{color:var(--numan-teal); font-weight:700; font-size:1.2rem}
		.progress-bar{background:var(--mint-50); height:8px; border-radius:4px; overflow:hidden; margin-bottom:1.5rem}
		.progress-fill{background:linear-gradient(90deg, var(--numan-teal), #15b5a8); height:100%; transition:width 0.5s ease}
		.progress-steps{display:grid; grid-template-columns:repeat(auto-fit, minmax(120px, 1fr)); gap:1rem}
		.progress-step{display:flex; flex-direction:column; align-items:center; gap:0.5rem; padding:1rem; background:var(--paper); border-radius:8px; border:1px solid var(--mint-50); transition:all 0.3s ease; position:relative}
		.progress-step.completed{border-color:var(--numan-teal); background:var(--mint-50)}
		.progress-step.locked{opacity:0.5; background:var(--canvas)}
		.step-icon{font-size:1.5rem}
		.step-label{font-size:0.8rem; color:var(--ink-60); font-weight:500; text-align:center}
		.step-check{position:absolute; top:0.5rem; right:0.5rem; background:var(--numan-teal); color:white; width:20px; height:20px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:0.8rem; font-weight:700}
		
		/* Active Plan Display Styles */
		.active-plan-card{background:var(--paper); border-radius:16px; padding:2rem; border:1px solid var(--mint-50); box-shadow:0 4px 12px rgba(0,0,0,0.05)}
		.plan-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem}
		.plan-tier-badge{background:var(--numan-teal); color:white; padding:0.5rem 1rem; border-radius:20px; font-weight:700; font-size:0.8rem; text-transform:uppercase}
		.plan-tier-badge.base{background:#6b7280}
		.plan-tier-badge.standard{background:var(--numan-teal)}
		.plan-tier-badge.premium{background:linear-gradient(135deg, #f59e0b, #d97706)}
		.plan-status{display:flex; align-items:center; gap:0.5rem; color:var(--ink-60); font-size:0.9rem}
		.status-indicator{width:8px; height:8px; background:#10b981; border-radius:50%}
		.plan-details{margin-bottom:1.5rem; text-align:center}
		.plan-details h4{color:var(--ink); font-size:1.5rem; margin:0 0 0.5rem}
		.plan-pricing{display:flex; align-items:baseline; justify-content:center; gap:0.25rem}
		.current-price{color:var(--numan-teal); font-size:2rem; font-weight:800}
		.billing-cycle{color:var(--ink-60); font-size:0.9rem}
		.plan-allowances{margin-bottom:1.5rem}
		.allowance-grid{display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:1rem}
		.allowance-item{text-align:center; padding:1rem; background:var(--canvas); border-radius:8px}
		.allowance-label{display:block; color:var(--ink-60); font-size:0.8rem; margin-bottom:0.25rem}
		.allowance-value{display:block; color:var(--ink); font-weight:600; font-size:1rem}
		.plan-usage{margin-bottom:1.5rem}
		.plan-usage h5{color:var(--ink); font-size:1.1rem; margin:0 0 1rem}
		.usage-bars{display:grid; gap:1rem}
		.usage-item{display:flex; flex-direction:column; gap:0.5rem}
		.usage-header{display:flex; justify-content:space-between; align-items:center}
		.usage-label{color:var(--ink-60); font-size:0.9rem}
		.usage-count{color:var(--ink); font-weight:600; font-size:0.9rem}
		.usage-bar{background:var(--mint-50); height:6px; border-radius:3px; overflow:hidden}
		.usage-fill{background:linear-gradient(90deg, var(--numan-teal), #15b5a8); height:100%; transition:width 0.5s ease}
		.plan-actions{display:flex; gap:1rem; justify-content:center}
		
		/* Plan Change Modal Styles */
		.plan-options{display:grid; gap:1rem; margin:1.5rem 0}
		.plan-option{background:var(--canvas); border:2px solid var(--mint-50); border-radius:12px; padding:1.5rem; cursor:pointer; transition:all 0.3s ease; position:relative}
		.plan-option:hover{border-color:var(--numan-teal)}
		.plan-option.current{border-color:var(--numan-teal); background:var(--mint-50)}
		.plan-option-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem}
		.plan-option-header h4{margin:0; color:var(--ink); font-size:1.1rem}
		.plan-price{color:var(--numan-teal); font-weight:700; font-size:1.2rem}
		.plan-features{list-style:none; padding:0; margin:0}
		.plan-features li{color:var(--ink-60); font-size:0.9rem; padding:0.25rem 0}
		.plan-features li::before{content:'✓'; color:var(--numan-teal); font-weight:700; margin-right:0.5rem}
		.current-badge{position:absolute; top:1rem; right:1rem; background:var(--numan-teal); color:white; padding:0.25rem 0.5rem; border-radius:12px; font-size:0.7rem; font-weight:600}
		.modal-actions{display:flex; gap:1rem; justify-content:flex-end; margin-top:1.5rem; padding-top:1rem; border-top:1px solid var(--mint-50)}
		
		/* Replacement Modal Styles */
		.replacement-options{display:grid; gap:1rem; margin:1.5rem 0}
		.replacement-option{background:var(--canvas); border:2px solid var(--mint-50); border-radius:12px; padding:1.5rem; cursor:pointer; transition:all 0.3s ease}
		.replacement-option:hover{border-color:var(--numan-teal); background:var(--mint-50)}
		.replacement-option h4{margin:0 0 0.5rem; color:var(--ink); font-size:1.1rem}
		.replacement-option p{margin:0; color:var(--ink-60); font-size:0.9rem}
		
		/* Enhanced Recommendation Modal Styles */
		.enhanced-recommendation-overlay{position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index:1000}
		.enhanced-recommendation-modal{background:var(--paper); border-radius:16px; max-width:640px; width:90%; max-height:90vh; overflow-y:auto; box-shadow:0 20px 60px rgba(0,0,0,0.15); position:relative}
		.enhanced-modal-header{padding:2rem 2rem 1rem; border-bottom:1px solid #e5e7eb}
		.enhanced-modal-title{font-size:1.75rem; font-weight:700; color:var(--ink); margin:0; font-family:'Bebas Neue',sans-serif; letter-spacing:0.02em}
		.enhanced-modal-subtitle{color:var(--ink-60); margin:0.5rem 0 0; font-size:1rem}
		.enhanced-modal-content{padding:1.5rem 2rem 2rem}
		.enhanced-plan-recommendation{background:linear-gradient(135deg, var(--mint-50) 0%, #f0fdfa 100%); border:2px solid var(--numan-teal); border-radius:12px; padding:1.5rem; margin-bottom:1.5rem; position:relative}
		.enhanced-plan-badge{position:absolute; top:-8px; left:1.5rem; background:var(--numan-teal); color:white; padding:0.25rem 0.75rem; border-radius:20px; font-size:0.8rem; font-weight:600}
		.enhanced-plan-title{font-size:1.5rem; font-weight:700; color:var(--ink); margin:0.5rem 0 1rem}
		.enhanced-recommendation-item{display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem; padding:0.75rem; background:white; border-radius:8px; border:1px solid rgba(30,207,192,0.2)}
		.enhanced-recommendation-item:last-child{margin-bottom:0}
		.enhanced-recommendation-details{flex:1}
		.enhanced-recommendation-type{font-size:0.8rem; color:var(--numan-teal); font-weight:600; text-transform:uppercase; margin-bottom:0.25rem}
		.enhanced-recommendation-name{font-weight:600; color:var(--ink); margin-bottom:0.25rem}
		.enhanced-recommendation-meta{font-size:0.85rem; color:var(--ink-60)}
		.enhanced-credit-indicator{background:var(--numan-teal); color:white; padding:0.25rem 0.5rem; border-radius:12px; font-size:0.75rem; font-weight:600; white-space:nowrap}
		.enhanced-reasoning-section{background:var(--canvas); border-radius:12px; padding:1.5rem; margin:1.5rem 0}
		.enhanced-reasoning-title{font-size:1.1rem; font-weight:600; color:var(--ink); margin:0 0 1rem; display:flex; align-items:center; gap:0.5rem}
		.enhanced-data-insights{display:grid; gap:0.75rem; margin-bottom:1rem}
		.enhanced-insight-card{display:flex; align-items:center; gap:0.75rem; padding:0.75rem; background:white; border-radius:8px; border-left:4px solid var(--numan-teal)}
		.enhanced-insight-icon{width:24px; height:24px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:0.8rem; font-weight:600; color:white}
		.enhanced-insight-icon.elevated{background:#f59e0b}
		.enhanced-insight-icon.suboptimal{background:#f59e0b}
		.enhanced-insight-icon.unknown{background:var(--ink-60)}
		.enhanced-insight-text{flex:1}
		.enhanced-insight-label{font-weight:600; color:var(--ink); font-size:0.9rem}
		.enhanced-insight-value{color:var(--ink-60); font-size:0.8rem}
		.enhanced-reasoning-explanation{background:#f8fafc; border-radius:8px; padding:1rem; border-left:4px solid var(--numan-teal)}
		.enhanced-reasoning-text{font-size:0.9rem; color:var(--ink-80); line-height:1.5; margin:0}
		.enhanced-confidence-indicator{display:flex; align-items:center; gap:0.5rem; margin-top:1rem; padding:0.75rem; background:#f0f9ff; border-radius:6px; border:1px solid #0ea5e9}
		.enhanced-confidence-icon{width:20px; height:20px; background:#0ea5e9; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; font-size:0.7rem; font-weight:600}
		.enhanced-confidence-text{font-size:0.85rem; color:#075985}
		.enhanced-customisation-options{background:var(--canvas); border-radius:8px; padding:1rem; margin:1rem 0}
		.enhanced-customisation-title{font-weight:600; color:var(--ink); margin:0 0 0.75rem; font-size:0.9rem}
		.enhanced-customisation-controls{display:flex; flex-wrap:wrap; gap:0.5rem}
		.enhanced-customisation-btn{background:white; border:1px solid #d1d5db; border-radius:6px; padding:0.4rem 0.75rem; font-size:0.8rem; cursor:pointer; transition:all 0.2s ease; color:var(--ink-60)}
		.enhanced-customisation-btn:hover{border-color:var(--numan-teal); color:var(--numan-teal); background:var(--mint-50)}
		.enhanced-customisation-btn.active{background:var(--numan-teal); color:white; border-color:var(--numan-teal)}
		.enhanced-clinical-note{font-size:0.8rem; color:var(--ink-60); margin-top:1rem; padding:0.75rem; background:#f9fafb; border-radius:6px}
		.enhanced-modal-actions{display:flex; gap:1rem; justify-content:space-between; margin-top:2rem; flex-wrap:wrap}
		
		@media (max-width:640px){
			.enhanced-recommendation-modal{width:95%; max-height:95vh}
			.enhanced-modal-header, .enhanced-modal-content{padding-left:1rem; padding-right:1rem}
			.enhanced-recommendation-item{flex-direction:column; align-items:flex-start; gap:0.5rem}
			.enhanced-modal-actions{flex-direction:column}
		}
		
		/* Account Wearables Data Styles */
		.account-wearables{margin-top:1.5rem}
		.wearables-summary h4{margin:0 0 1rem; color:var(--ink); font-size:1.1rem}
		.wearables-grid{display:grid; gap:0.75rem; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr))}
		.wearable-metric{display:flex; flex-direction:column; gap:0.25rem; padding:0.75rem; background:var(--canvas); border-radius:6px; border:1px solid var(--mint-50)}
		.metric-label{font-size:0.8rem; color:var(--ink-60); font-weight:500}
		.metric-value{font-size:1.1rem; font-weight:600; color:var(--ink)}
		
		/* Streaks Grid Styles */
		.streaks-grid{
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
			gap: 1.5rem;
			margin-top: 1rem;
		}
		.streak-card{
			box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
		}
		.streak-card:hover{
			transform: translateY(-2px);
			box-shadow: 0 8px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
		}
		.streak-card.met{
			box-shadow: 0 4px 6px -1px rgba(20, 184, 166, 0.1), 0 2px 4px -1px rgba(20, 184, 166, 0.06);
		}
		.streak-card.met:hover{
			box-shadow: 0 8px 15px -3px rgba(20, 184, 166, 0.1), 0 4px 6px -2px rgba(20, 184, 166, 0.05);
		}
		
		/* Plan State Management Styles */
		.plan-state-indicator{display:inline-block; padding:0.25rem 0.5rem; border-radius:4px; font-size:0.8rem; font-weight:600; margin-left:0.5rem}
		.plan-state-active{background:var(--numan-teal); color:white}
		.plan-state-selected{background:var(--numan-teal); color:white}
		.plan-state-new{background:var(--success); color:white}
		.plan-state-available{background:var(--ink-20); color:var(--ink)}
		
		/* Plan Button States */
		.tier-button{transition:all 0.2s ease; cursor:pointer; position:relative; overflow:hidden}
		.tier-button:disabled{cursor:not-allowed; opacity:0.7}
		.tier-button.active{background:var(--numan-teal) !important; color:white !important; border-color:var(--numan-teal) !important; box-shadow:0 0 0 2px rgba(20, 184, 166, 0.2)}
		.tier-button.new{background:var(--success) !important; color:white !important; border-color:var(--success) !important; box-shadow:0 0 0 2px rgba(34, 197, 94, 0.2)}
		.tier-button.selected{background:var(--numan-teal) !important; color:white !important; border-color:var(--numan-teal) !important; box-shadow:0 0 0 2px rgba(20, 184, 166, 0.2)}
		.tier-button:hover:not(:disabled){transform:translateY(-1px); box-shadow:0 2px 8px rgba(0,0,0,0.1)}
		
		/* Plan Card Selection States */
		.plan-card{transition:all 0.3s ease; position:relative}
		.plan-card.active{border:2px solid var(--numan-teal); background:var(--mint-50); transform:scale(1.02)}
		.plan-card.new{border:2px solid var(--success); background:var(--success-50); transform:scale(1.02)}
		.plan-card.selected{border:2px solid var(--numan-teal); background:var(--mint-50); transform:scale(1.02)}
		.plan-card:hover:not(.active):not(.new):not(.selected){border-color:var(--ink-30); transform:translateY(-2px)}
		
		/* Plan Selection Indicator */
		.plan-card::before{content:''; position:absolute; top:0.5rem; right:0.5rem; width:1rem; height:1rem; border-radius:50%; background:var(--ink-20); transition:all 0.2s ease}
		.plan-card.active::before{background:var(--numan-teal); box-shadow:0 0 0 2px var(--mint-50)}
		.plan-card.new::before{background:var(--success); box-shadow:0 0 0 2px var(--success-50)}
		.plan-card.selected::before{background:var(--numan-teal); box-shadow:0 0 0 2px var(--mint-50)}

		/* Global scale down to 81% for overall UI size reduction (90% of 90%) */
        /* Remove global scaling to avoid text blur; adjust base size instead */
        html{font-size:87%}
        /* Maintain horizontal safety */
		body{overflow-x:hidden}
		
		/* Enhanced Clinical Biological Age Gauge */
		.bio-age-gauge-container{
			position:relative; 
			width:100%; 
			max-width:400px; 
			margin:1rem auto; 
			text-align:center;
			background:var(--canvas);
			border-radius:16px;
			padding:0;
			box-shadow:0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
		}
		.bio-age-gauge{
			width:100%; 
			max-width:100%; 
			height:auto; 
			margin:0 auto; 
			position:relative;
		}
		.bio-age-gauge svg{
			width:100%; 
			height:auto;
			filter:drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
		}
		
		/* Clinical gauge elements with smooth transitions */
		.gauge-segment{
			transition:stroke-width 0.3s ease, opacity 0.3s ease;
		}
		.gauge-needle{
			transition:transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
			filter:drop-shadow(0 2px 4px rgba(30, 207, 192, 0.3));
		}
		.gauge-hub{
			transition:all 0.3s ease;
			filter:drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
		}
		
		/* Typography enhancements */
		.biological-age-number{
			transition:all 0.3s ease;
			text-shadow:0 1px 2px rgba(0, 0, 0, 0.1);
		}
		.age-differential{
			transition:color 0.3s ease;
			font-weight:700;
		}
		.zone-label{
			transition:color 0.3s ease;
			text-transform:capitalize;
		}
		
		/* Hover effects for clinical context */
		.bio-age-gauge:hover .gauge-segment{
			stroke-width:18;
		}
		.bio-age-gauge:hover .gauge-needle{
			filter:drop-shadow(0 3px 6px rgba(30, 207, 192, 0.4));
		}
		
		/* Dashboard specific gauge styling */
		#dashboard-bio-gauge-container .bio-age-gauge-container{
			max-width: 320px;
			padding: 0;
			margin: 0.5rem auto;
		}
		
		/* Responsive adjustments */
		@media (max-width: 640px) {
			.bio-age-gauge-container{
				max-width:350px;
				padding:0;
				margin:0.75rem auto;
			}
			.biological-age-number{
				font-size:28px !important;
			}
			.age-differential{
				font-size:14px !important;
			}
		}
		
		/* Gauge Interpretation Styles */
		.gauge-interpretation-container{margin-top:1rem}
		.gauge-interpretation{padding:1rem; border-radius:8px; border-left:4px solid var(--ink-20)}
		.gauge-interpretation.excellent{border-left-color:var(--success); background:var(--success-50)}
		.gauge-interpretation.optimal{border-left-color:var(--numan-teal); background:var(--mint-50)}
		.gauge-interpretation.concerning{border-left-color:var(--error); background:var(--error-50)}
		.gauge-interpretation h4{margin:0 0 0.5rem; font-size:1rem; color:var(--ink)}
		.gauge-interpretation p{margin:0.25rem 0; font-size:0.9rem; color:var(--ink-80)}
		.gauge-interpretation .age-group-info{margin-top:0.5rem; padding-top:0.5rem; border-top:1px solid var(--ink-10)}
		.gauge-interpretation .age-group-info small{color:var(--ink-60); font-size:0.8rem}
		/* Modal */
		.modal{display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:1000; justify-content:center; align-items:center}
		.modal.active{display:flex}
		.modal-content{background:var(--paper); padding:1rem; border-radius:14px; width:min(560px,92%); max-height:90vh; overflow:auto; outline:none}
		
		/* Optimize recommendations modal specifically */
		#recsModal .modal-content {
			max-height: 88vh;
			padding: 1.5rem;
			font-size: 1rem;
		}
		
		#recsModal .modal-body {
			max-height: 70vh;
			overflow-y: auto;
			padding: 0.75rem 0;
		}
		
		/* Improved readability for recommendations modal content */
		#recsModal .stack {
			gap: 1rem !important;
		}
		
		#recsModal .card.soft {
			padding: 1.25rem !important;
			margin-bottom: 1rem !important;
			background: #f8fafc !important;
			border: 1px solid #e2e8f0 !important;
		}
		
		#recsModal .h6 {
			font-size: 1.1rem !important;
			margin-bottom: 0.75rem !important;
			font-weight: 600 !important;
			color: #1e293b !important;
		}
		
		#recsModal .picks {
			line-height: 1.6 !important;
			font-size: 1rem !important;
		}
		
		#recsModal .picks li {
			margin-bottom: 0.75rem !important;
			font-size: 1rem !important;
			color: #374151 !important;
		}
		
		#recsModal .picks strong {
			color: #111827 !important;
			font-weight: 600 !important;
		}
		
		#recsModal .muted {
			color: #6b7280 !important;
			font-size: 1rem !important;
		}
		
		#recsModal .chips {
			gap: 0.5rem !important;
		}
		
		#recsModal .chip {
			background: #e0f2fe !important;
			color: #0369a1 !important;
			font-size: 0.9rem !important;
			padding: 0.5rem 0.75rem !important;
			border-radius: 8px !important;
			font-weight: 500 !important;
		}
		
		#recsModal .tag {
			font-size: 0.8rem !important;
			padding: 0.25rem 0.5rem !important;
			font-weight: 600 !important;
		}
		
		/* Responsive adjustments for mobile */
		@media (max-width: 640px) {
			#recsModal .modal-content {
				max-height: 92vh;
				padding: 0.5rem;
			}
			
			#recsModal .modal-body {
				max-height: 75vh;
			}
		}
		
		/* Assessment Modal Optimization */
		#assessment-modal .modal-content {
			max-height: 90vh;
			padding: 0.75rem;
		}
		
		#assessment-modal .modal-body {
			max-height: 75vh;
			overflow-y: auto;
			padding: 0.5rem 0;
		}
		
		/* Compact assessment styling */
		#assessment-modal .assessment-option {
			padding: 1rem !important;
			min-height: 60px !important;
			margin-bottom: 0.5rem !important;
		}
		
		#assessment-modal .assessment-option span {
			font-size: 1rem !important;
		}
		
		#assessment-modal .custom-radio {
			width: 20px !important;
			height: 20px !important;
		}
		
		#assessment-modal .radio-dot {
			width: 10px !important;
			height: 10px !important;
		}
		
		/* Mobile assessment adjustments */
		@media (max-width: 640px) {
			#assessment-modal .modal-content {
				max-height: 95vh;
				padding: 0.5rem;
			}
			
			#assessment-modal .modal-body {
				max-height: 80vh;
			}
			
			#assessment-modal .assessment-option {
				padding: 0.75rem !important;
				min-height: 50px !important;
			}
			
			#assessment-modal .assessment-option span {
				font-size: 0.9rem !important;
			}
			
			/* Make question text smaller on mobile */
			#assessment-modal h4 {
				font-size: 1rem !important;
				line-height: 1.3 !important;
			}
			
			/* Reduce header spacing on mobile */
			#assessment-modal h3 {
				font-size: 1.1rem !important;
			}
		}
		
		/* Biological Age Calculation Modal Styles */
		.calculation-summary{background:var(--mint-50); padding:1rem; border-radius:8px; margin-bottom:1.5rem; border-left:4px solid var(--numan-teal)}
		.summary-row{display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem}
		.summary-row:last-child{margin-bottom:0}
		.calculation-section{margin-bottom:1.5rem}
		.calculation-section h4{margin:0 0 0.75rem 0; color:var(--ink); font-size:1.1rem}
		.calculation-grid{display:grid; gap:0.5rem}
		.calculation-item{display:flex; justify-content:space-between; align-items:center; padding:0.5rem 0}
		.calculation-item .badge{background:var(--numan-teal); color:white; padding:0.25rem 0.5rem; border-radius:12px; font-size:0.8rem; font-weight:600}
		.calculation-note{background:#fef3cd; padding:1rem; border-radius:8px; border-left:4px solid #f59e0b; margin-top:1rem}
		.calculation-note h5{margin:0 0 0.5rem 0; color:#92400e; font-size:1rem}
		.calculation-note p{margin:0; color:#92400e; font-size:0.9rem; line-height:1.5}
		/* Toast */
		.toast{position:fixed; right:1rem; bottom:1rem; background:#111; color:#fff; padding:.7rem 1rem; border-radius:10px; display:none; z-index:2000}
		.toast.show{display:block}
		/* Coach */
		.coach-button{position:fixed; right:1rem; bottom:1rem; width:56px; height:56px; background:var(--numan-teal); border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:0 8px 18px rgba(30,207,192,.35); z-index:900}
		.coach-panel{position:fixed; right:-420px; top:0; width:420px; max-width:100%; height:100%; background:var(--paper); box-shadow:-6px 0 18px rgba(0,0,0,.1); transition:right .25s; z-index:950; display:flex; flex-direction:column}
		.coach-panel.open{right:0}
		.coach-header{padding:1rem; background:var(--numan-teal); color:#fff; display:flex; align-items:center; justify-content:space-between}
		.coach-plan-info{padding:1rem; background:var(--mint-50); border-bottom:1px solid #e5e7eb; display:flex; flex-direction:column; gap:0.75rem}
		.coach-messages{flex:1; padding:1rem; overflow:auto}
		.coach-message{margin-bottom:.75rem; padding:.6rem .8rem; background:var(--canvas); border-radius:12px}
		.coach-message.user{background:var(--mint-50); margin-left:2rem}
		.message-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:0.25rem; font-size:0.85rem}
		.message-content{font-size:0.9rem; line-height:1.4}
		.coach-input{display:flex; gap:.5rem; padding:.75rem; border-top:1px solid #e5e7eb}
		.coach-input input{flex:1}
		/* Calendar */
		.calendar{background:var(--paper); border-radius:12px; padding:1.5rem; box-shadow:var(--shadow); border:1px solid #f3f4f6}
		.calendar-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem}
		.calendar-grid{display:grid; grid-template-columns:repeat(7,1fr); gap:.5rem; margin-top:.5rem}
		.calendar-weekday{font-weight:600; color:#6b7280; text-align:center; padding:.5rem 0; font-size:.9rem; text-transform:uppercase; letter-spacing:.5px}
		.calendar-day{aspect-ratio:1; display:flex; align-items:center; justify-content:center; border-radius:10px; cursor:pointer; position:relative; font-weight:500; transition:all 0.2s ease; border:1px solid transparent}
		.calendar-day:hover{background:var(--mint-50); border-color:var(--numan-teal); transform:scale(1.05)}
		.calendar-day.today{background:var(--numan-teal); color:#fff; font-weight:700; box-shadow:0 2px 8px rgba(30,207,192,0.3)}
		.calendar-day.has-event::after{content:''; position:absolute; bottom:6px; width:6px; height:6px; border-radius:50%; background:var(--numan-teal); box-shadow:0 1px 3px rgba(0,0,0,0.2)}
		.calendar-day.today.has-event::after{background:#fff; box-shadow:0 1px 3px rgba(0,0,0,0.3)}
		.calendar-day.other-month{color:#d1d5db; opacity:0.5}
		/* NPS/Issues footer */
		.footer{margin-top:1rem; display:flex; gap:.75rem; align-items:center; flex-wrap:wrap}
		/* Tests badge */
		.tests-badge{position:fixed; left:1rem; bottom:6rem; background:#111; color:#fff; padding:.3rem .6rem; border-radius:999px; font-size:.8rem; z-index:999}
		/* Focus ring */
		:focus-visible{outline:3px solid #22d3ee; outline-offset:2px}
		/* Symptoms */
		.symptoms-grid{display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); gap:1rem; margin-top:1rem}
		.symptom-item{border:2px solid #e5e7eb; border-radius:12px; padding:1rem; cursor:pointer; transition:all 0.2s ease; background:var(--paper)}
		.symptom-item:hover{border-color:var(--numan-teal); background:var(--mint-50)}
		.symptom-item.selected{border-color:var(--numan-teal); background:var(--mint-50)}
		.symptom-item:focus-visible{outline:2px solid var(--numan-teal); outline-offset:2px}
		/* Validation styles */
		.error{color:#dc2626; font-size:0.85rem; margin-top:0.25rem; display:block}
		.warning{color:#d97706; font-size:0.85rem; margin-top:0.25rem; display:block}
		input.error{border-color:#dc2626}
		.symptom-label{font-weight:600; color:var(--ink); margin-bottom:0.5rem}
		.severity-selector{display:flex; gap:0.5rem; margin-top:0.75rem}
		.severity-option{display:flex; align-items:center; gap:0.25rem; font-size:0.9rem}
		.severity-option input[type="radio"]{margin:0}
		.severity-option span{color:var(--ink-60)}
		
		/* Assessments */
		.assessment-item{border:1px solid #e5e7eb; border-radius:12px; padding:1.5rem; margin-bottom:1rem; background:var(--paper)}
		.assessment-header{display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:0.5rem}
		.assessment-header h4{margin:0; color:var(--ink)}
		.assessment-header small{color:var(--ink-60); font-size:0.8rem}
		.assessment-option:hover{border-color:var(--numan-teal); background:var(--mint-50)}
		.assessment-option input[type="radio"]:checked + span{color:var(--numan-teal); font-weight:600}
		
		/* Responsive */
		@media (max-width:768px){
			.summary-content{flex-direction:column; align-items:stretch; gap:0.5rem}
			.plan-summary{padding:0.75rem 0.75rem; max-height:none}
			.container{padding-bottom:240px}
			
			/* Specific mobile padding for pages with standardized checkout footer */
			section[data-view="plan"] .container,
			section[data-view="build-first-month"] .container,
			section[data-view="addons"] .container {
				padding-bottom: 130px;
			}
			
			/* Mobile-specific footer adjustments */
			section[data-view="plan"] .plan-summary,
			section[data-view="build-first-month"] .plan-summary,
			section[data-view="addons"] .plan-summary,
			section[data-view="checkout"] .plan-summary {
				padding: 0.5rem 0.75rem;
				position: fixed !important;
				bottom: 0;
				left: 0;
				right: 0;
				width: 100%;
				/* Make mobile footer more compact */
				max-height: 100px;
				/* Prevent footer from bouncing during scroll on mobile */
				transform: translateZ(0);
				-webkit-transform: translateZ(0);
				will-change: transform;
			}
			
			section[data-view="plan"] .container,
			section[data-view="build-first-month"] .container,
			section[data-view="addons"] .container {
				padding-bottom: 250px;
			}
			
			/* Ensure mobile scrolling works properly */
			section[data-view="plan"],
			section[data-view="build-first-month"],
			section[data-view="addons"] {
				min-height: 100vh;
				overflow-y: auto;
				-webkit-overflow-scrolling: touch;
				position: relative;
			}
			
			/* Mobile footer button layout */
			section[data-view="plan"] .plan-summary > div:last-child {
				flex-direction: column;
				gap: 0.75rem;
				align-items: stretch;
			}
			
			section[data-view="plan"] .plan-summary .checkout-cta {
				width: 100%;
				min-width: auto;
			}
			
			/* Ensure body can scroll on mobile */
			body {
				overflow-y: auto;
				-webkit-overflow-scrolling: touch;
			}
		}
		
		/* Utility classes */
		.hidden{display:none!important}
		
		/* =============== WEARABLES INTEGRATION STYLES =============== */
		
		/* Dashboard sections */
		.dashboard-section {
			background: var(--paper);
			border-radius: 16px;
			padding: 1.5rem;
			margin-bottom: 1.5rem;
			box-shadow: var(--shadow);
		}
		
		.dashboard-section h3 {
			margin: 0 0 1rem 0;
			color: var(--ink);
			font-size: 1.25rem;
		}
		
		/* Metrics grid */
		.metrics-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
			gap: 1rem;
			margin-bottom: 1.5rem;
		}
		
		.metric-card {
			background: var(--canvas);
			border-radius: 12px;
			padding: 1rem;
			text-align: center;
			border: 1px solid #e5e7eb;
		}
		
		.metric-card h4 {
			margin: 0 0 0.5rem 0;
			color: var(--ink-60);
			font-size: 0.9rem;
			font-weight: 600;
		}
		
		.metric-value {
			font-size: 2rem;
			font-weight: 700;
			color: var(--numan-teal);
			margin-bottom: 0.25rem;
		}
		
		.metric-target {
			font-size: 0.8rem;
			color: var(--ink-60);
			margin-bottom: 0.5rem;
		}
		
		.streak {
			font-size: 0.75rem;
			color: var(--numan-teal-600);
			font-weight: 600;
		}
		
		/* Insights */
		.insights {
			background: var(--mint-50);
			border-radius: 8px;
			padding: 1rem;
		}
		
		.insights h4 {
			margin: 0 0 0.5rem 0;
			color: var(--ink);
			font-size: 1rem;
		}
		
		.insights ul {
			margin: 0;
			padding-left: 1.5rem;
		}
		
		.insights li {
			margin-bottom: 0.25rem;
			color: var(--ink-60);
			font-size: 0.9rem;
		}
		
		/* Level info */
		.level-info {
			display: flex;
			justify-content: space-between;
			align-items: center;
			background: var(--canvas);
			border-radius: 8px;
			padding: 1rem;
			margin-bottom: 1rem;
		}
		
		.level {
			font-size: 1.5rem;
			font-weight: 700;
			color: var(--numan-teal);
		}
		
		.xp {
			font-size: 1rem;
			color: var(--ink-60);
		}
		
		/* Quests */
		.quests {
			display: flex;
			flex-direction: column;
			gap: 1rem;
		}
		
		.quest-item {
			background: var(--canvas);
			border-radius: 8px;
			padding: 1rem;
			border: 1px solid #e5e7eb;
		}
		
		.quest-title {
			font-weight: 600;
			color: var(--ink);
			margin-bottom: 0.5rem;
		}
		
		.quest-progress {
			display: flex;
			align-items: center;
			gap: 0.5rem;
			margin-bottom: 0.5rem;
		}
		
		.progress-bar {
			flex: 1;
			height: 8px;
			background: #e5e7eb;
			border-radius: 4px;
			overflow: hidden;
		}
		
		.progress-fill {
			height: 100%;
			background: var(--numan-teal);
			transition: width 0.3s ease;
		}
		
		.progress-text {
			font-size: 0.8rem;
			color: var(--ink-60);
			min-width: 50px;
		}
		
		.quest-reward {
			font-size: 0.8rem;
			color: var(--numan-teal-600);
			font-weight: 600;
		}
		
		.quest-item button {
			margin-top: 0.5rem;
			padding: 0.5rem 1rem;
			background: var(--numan-teal);
			color: white;
			border: none;
			border-radius: 6px;
			font-size: 0.8rem;
			cursor: pointer;
		}
		
		.quest-item button:hover {
			background: var(--numan-teal-600);
		}
		
		/* Streaks grid */
		.streaks-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
			gap: 1rem;
		}
		
		.streak-item {
			background: var(--canvas);
			border-radius: 12px;
			padding: 1rem;
			text-align: center;
			border: 2px solid #e5e7eb;
			transition: all 0.2s ease;
		}
		
		.streak-item.met {
			border-color: var(--numan-teal);
			background: var(--mint-50);
		}
		
		/* Account page layout */
		.account-top-row {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 1.5rem;
			margin-bottom: 1.5rem;
		}
		
		.account-bottom-row {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 1.5rem;
		}
		
		.account-personal-info {
			min-height: 400px;
		}
		
		.account-current-plan {
			min-height: 400px;
			display: flex;
			flex-direction: column;
		}
		
		.account-current-plan h3 {
			margin-bottom: 1.5rem;
		}
		
		.account-current-plan #account-plan-details {
			flex: 1;
			display: flex;
			flex-direction: column;
			justify-content: center;
		}
		
		
		.account-referral {
			min-height: 300px;
		}
		
		.account-support {
			min-height: 300px;
		}
		
		@media (max-width: 1024px) {
			.account-top-row {
				grid-template-columns: 1fr 1fr;
			}
		}
		
		@media (max-width: 768px) {
			.account-top-row,
			.account-bottom-row {
				grid-template-columns: 1fr;
				gap: 1rem;
			}
			
			.account-personal-info,
			.account-current-plan,
			.account-referral,
			.account-support {
				min-height: auto;
			}
		}
		
		.streak-icon {
			font-size: 2rem;
			margin-bottom: 0.5rem;
		}
		
		.streak-title {
			font-weight: 600;
			color: var(--ink);
			margin-bottom: 0.25rem;
		}
		
		.streak-count {
			font-size: 1.5rem;
			font-weight: 700;
			color: var(--numan-teal);
			margin-bottom: 0.25rem;
		}
		
		.streak-status {
			font-size: 0.8rem;
			color: var(--ink-60);
		}
		
		/* Responsive adjustments */
		@media (max-width: 768px) {
			.metrics-grid {
				grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
			}
			
			.streaks-grid {
				grid-template-columns: 1fr;
			}
			
			.level-info {
				flex-direction: column;
				gap: 0.5rem;
				text-align: center;
			}
		}

		/* Driver Chips Styling */
		.driver-chips {
			display: flex;
			flex-wrap: wrap;
			gap: 0.5rem;
			margin: 1rem 0;
			justify-content: center;
		}

		.driver-chip {
			display: inline-flex;
			align-items: center;
			gap: 0.5rem;
			padding: 0.5rem 0.75rem;
			border-radius: 20px;
			font-size: 0.85rem;
			font-weight: 600;
			cursor: pointer;
			transition: all 0.2s ease;
			border: 2px solid transparent;
		}

		.driver-chip:hover {
			transform: translateY(-1px);
			box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
		}

		.driver-chip.positive {
			background: #dcfce7;
			color: #166534;
			border-color: #22c55e;
		}

		.driver-chip.negative {
			background: #fef2f2;
			color: #991b1b;
			border-color: #ef4444;
		}

		.driver-chip .impact-value {
			font-weight: 800;
			font-size: 0.9rem;
		}

		.driver-chip .driver-label {
			font-weight: 500;
		}

		.driver-chip .driver-value {
			font-size: 0.8rem;
			opacity: 0.8;
		}

		/* Driver Playbook Modal Styling */
		#driver-playbook-modal {
			display: none;
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.5);
			z-index: 1000;
			align-items: center;
			justify-content: center;
			padding: 1rem;
		}

		#driver-playbook-modal .modal-content {
			background: white;
			border-radius: 12px;
			max-width: 600px;
			width: 100%;
			max-height: 90vh;
			overflow-y: auto;
			box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
		}

		#driver-playbook-modal .modal-header {
			padding: 1.5rem 1.5rem 0 1.5rem;
			border-bottom: 1px solid #e5e7eb;
			margin-bottom: 1.5rem;
		}

		#driver-playbook-modal .modal-title {
			font-size: 1.5rem;
			font-weight: 700;
			color: var(--ink);
			margin: 0;
		}

		#driver-playbook-modal .modal-body {
			padding: 0 1.5rem 1.5rem 1.5rem;
		}

		.playbook-header {
			margin-bottom: 2rem;
		}

		.current-status {
			text-align: center;
			padding: 1.5rem;
			background: #f8fafc;
			border-radius: 8px;
			border: 1px solid #e2e8f0;
		}

		.current-status h4 {
			margin: 0 0 1rem 0;
			color: var(--ink-80);
			font-size: 1rem;
			font-weight: 600;
		}

		.status-value {
			font-size: 2rem;
			font-weight: 800;
			display: flex;
			align-items: center;
			justify-content: center;
			gap: 1rem;
		}

		.impact-badge {
			display: inline-block;
			padding: 0.25rem 0.75rem;
			border-radius: 20px;
			color: white;
			font-size: 1rem;
			font-weight: 700;
		}

		.playbook-actions {
			margin-bottom: 2rem;
		}

		.action-section {
			margin-bottom: 1.5rem;
		}

		.action-section h4 {
			font-size: 1.1rem;
			font-weight: 700;
			color: var(--numan-teal);
			margin: 0 0 0.75rem 0;
			padding-bottom: 0.5rem;
			border-bottom: 2px solid var(--numan-teal);
		}

		.action-section ul {
			list-style: none;
			padding: 0;
			margin: 0;
		}

		.action-section li {
			padding: 0.75rem;
			margin-bottom: 0.5rem;
			background: #f8fafc;
			border-radius: 6px;
			border-left: 4px solid var(--numan-teal);
			font-size: 0.9rem;
			line-height: 1.5;
		}

		.playbook-trackers,
		.playbook-addons {
			margin-bottom: 1.5rem;
		}

		.playbook-trackers h4,
		.playbook-addons h4 {
			font-size: 1.1rem;
			font-weight: 700;
			color: var(--ink);
			margin: 0 0 0.75rem 0;
		}

		.tracker-chips,
		.addon-chips {
			display: flex;
			flex-wrap: wrap;
			gap: 0.5rem;
		}

		.tracker-chip,
		.addon-chip {
			display: inline-block;
			padding: 0.5rem 0.75rem;
			background: #e0f2fe;
			color: #0369a1;
			border-radius: 20px;
			font-size: 0.8rem;
			font-weight: 600;
			border: 1px solid #0ea5e9;
		}

		.addon-chip {
			background: #f0fdf4;
			color: #166534;
			border-color: #22c55e;
		}

		/* Responsive design for driver chips */
		@media (max-width: 768px) {
			.driver-chips {
				gap: 0.25rem;
			}

			.driver-chip {
				padding: 0.4rem 0.6rem;
				font-size: 0.8rem;
			}

			#driver-playbook-modal .modal-content {
				margin: 0.5rem;
				max-height: 95vh;
			}

			.status-value {
				font-size: 1.5rem;
				flex-direction: column;
				gap: 0.5rem;
			}
		}

		/* Addons Interstitial Styling */
		.lab-grid, .supplement-grid, .coaching-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
			gap: 1.25rem;
			margin-top: 1rem;
		}

		.lab-option, .supplement-option, .coaching-option {
			padding: 1.5rem;
			border: 2px solid #e5e7eb;
			border-radius: 16px;
			background: linear-gradient(135deg, #ffffff, #f8fafc);
			transition: all 0.3s ease;
			position: relative;
			overflow: hidden;
		}

		.lab-option:hover, .supplement-option:hover {
			transform: translateY(-4px);
			box-shadow: 0 12px 28px rgba(0,0,0,0.12);
			border-color: var(--numan-teal);
		}

		.lab-option.selected, .supplement-option.selected, .coaching-option.selected {
			border-color: var(--numan-teal);
			background: linear-gradient(135deg, var(--mint-50), #f0fdf4);
			box-shadow: 0 8px 25px rgba(0,0,0,0.1);
			opacity: 1 !important; /* Ensure selected items are never greyed out */
		}

		.lab-option::before, .supplement-option::before, .coaching-option::before {
			content: '';
			position: absolute;
			top: 0;
			left: 0;
			right: 0;
			height: 4px;
			background: linear-gradient(90deg, var(--numan-teal), #0ea5e9);
			opacity: 0;
			transition: opacity 0.3s ease;
		}

		.lab-option.selected::before, .supplement-option.selected::before, .coaching-option.selected::before {
			opacity: 1;
		}
		
		.lab-option.disabled {
			opacity: 0.5;
			cursor: not-allowed;
			background: #f3f4f6;
			box-shadow: none;
			border-color: #d1d5db !important;
		}
		
		.lab-option.disabled:hover {
			border-color: #e5e7eb;
			background: #f9fafb;
			box-shadow: none;
			transform: none;
		}
		
		.supplement-option.disabled {
			opacity: 0.5;
			pointer-events: none;
		}

		.coaching-option.disabled {
			opacity: 0.6;
			cursor: pointer; /* Keep clickable for coaching selection changes */
			background: #f9fafb;
			box-shadow: none;
		}
		
		.coaching-option.disabled:hover {
			border-color: #e5e7eb;
			background: #f9fafb;
			transform: none;
			box-shadow: none;
		}
		
.recommended-badge {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    background: var(--numan-teal);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
    z-index: 10;
}

		.lab-option h4, .supplement-option h4 {
			margin: 0 0 0.5rem 0;
			font-size: 1rem;
		}

		.credits {
			font-size: 0.9rem;
			color: var(--ink-60);
			font-weight: 600;
		}

		.supplement-option .price {
			display: flex;
			flex-direction: column;
			gap: 0.25rem;
		}

		.rrp {
			font-size: 0.9rem;
			color: var(--ink-60);
		}

		.topup {
			font-size: 0.8rem;
			color: var(--numan-teal);
			font-weight: 600;
		}

		.covered {
			font-size: 0.8rem;
			color: #10b981;
			font-weight: 600;
		}


		.addon-stepper {
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding: 1rem;
			border: 2px solid #e5e7eb;
			border-radius: 8px;
			margin-bottom: 0.5rem;
			transition: all 0.2s ease;
			background: white;
		}
		
		.addon-stepper.selected {
			border-color: var(--numan-teal);
			background: var(--mint-50);
			box-shadow: 0 2px 8px rgba(30, 207, 192, 0.15);
		}
		
		.addon-stepper:hover {
			border-color: var(--numan-teal);
			background: #f0fdfa;
		}

		.addon-info h4 {
			margin: 0 0 0.25rem 0;
			font-size: 1rem;
		}

		.addon-info .price {
			font-size: 0.9rem;
			color: var(--numan-teal);
			font-weight: 600;
		}
		
		.selected-badge {
			display: inline-block;
			background: var(--numan-teal);
			color: white;
			padding: 0.25rem 0.5rem;
			border-radius: 4px;
			font-size: 0.75rem;
			font-weight: 600;
			margin-top: 0.25rem;
		}
		
		.qty-display {
			min-width: 2rem;
			text-align: center;
			font-weight: 600;
			padding: 0.25rem 0.5rem;
			border-radius: 4px;
			background: #f3f4f6;
			color: var(--ink);
		}
		
		.qty-display.selected {
			background: var(--numan-teal);
			color: white;
		}

		.stepper {
			display: flex;
			align-items: center;
			gap: 0.5rem;
		}

		.stepper button {
			width: 32px;
			height: 32px;
			border: 1px solid #d1d5db;
			border-radius: 4px;
			background: white;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 1.2rem;
			font-weight: 600;
		}

		.stepper button:hover {
			background: #f3f4f6;
		}

		.stepper span {
			min-width: 2rem;
			text-align: center;
			font-weight: 600;
		}

		/* Recommendation Modal Styling */
		.stack {
			display: flex;
			flex-direction: column;
		}

		.gap-3 {
			gap: 1rem;
		}

		.card.soft {
			background: #f8fafc;
			border: 1px solid #e2e8f0;
			border-radius: 8px;
			padding: 1rem;
		}

		.h6 {
			font-size: 1.1rem;
			font-weight: 600;
			margin-bottom: 0.75rem;
			color: var(--ink);
		}

		.picks {
			list-style: none;
			padding: 0;
			margin: 0;
		}

		.picks li {
			padding: 0.5rem 0;
			border-bottom: 1px solid #e5e7eb;
		}

		.picks li:last-child {
			border-bottom: none;
		}

		.tag {
			display: inline-block;
			background: var(--numan-teal);
			color: white;
			padding: 0.25rem 0.5rem;
			border-radius: 12px;
			font-size: 0.8rem;
			font-weight: 600;
			margin-left: 0.5rem;
		}

		.chip {
			display: inline-block;
			background: #e0f2fe;
			color: #0369a1;
			padding: 0.25rem 0.5rem;
			border-radius: 12px;
			font-size: 0.8rem;
			font-weight: 600;
			margin: 0.125rem;
		}

		.chips {
			display: flex;
			flex-wrap: wrap;
			gap: 0.25rem;
			margin-top: 0.5rem;
		}

		.reasons {
			margin-top: 1rem;
		}

		.nudges {
			background: #fef3c7;
			border: 1px solid #f59e0b;
			border-radius: 8px;
			padding: 1rem;
			margin-top: 1rem;
		}

		.nudges ul {
			list-style: none;
			padding: 0;
			margin: 0;
		}

		.nudges li {
			padding: 0.25rem 0;
		}

		.nudge {
			font-style: italic;
			color: #92400e;
		}

		.footnote {
			font-size: 0.8rem;
			line-height: 1.4;
			margin-top: 1rem;
			padding-top: 1rem;
			border-top: 1px solid #e5e7eb;
		}
	</style>

	<script>
	// =============== SINGLE SOURCE OF TRUTH - MODEL ===============
	const MODEL = {
		currency: "GBP",
		plans: {
			Base:     { price: 49,  labCreditsPerYear: 1, supplementCreditPerMonth: 10, supplementQuantityPerMonth: 1, coachingMinutesPerMonth: 15, gpConsultsPerYear: 1 },
			Standard: { price: 99,  labCreditsPerYear: 2, supplementCreditPerMonth: 10, supplementQuantityPerMonth: 2, coachingMinutesPerMonth: 30, gpConsultsPerYear: 2 },
			Premium:  { price: 149, labCreditsPerYear: 4, supplementCreditPerMonth: 15, supplementQuantityPerMonth: 3, coachingMinutesPerMonth: 45, gpConsultsPerYear: 3 }
		},
		annual: { discountPct: 10 },                        // Annual billing = 10% off
		credits: { standard:1, complete:2, venous:3, topUpPerCreditGBP: 20 },
		memberAddOns: {
			tests: {
				standard: { id:'addon-test-standard', title:"Extra standard blood test (≤16 biomarkers)", price:59 },
				complete: { id:'addon-test-complete', title:"Extra complete blood test (20 biomarkers)", price:79 },
				venous:   { id:'addon-test-venous',   title:"Extra venous blood test", price:99 }
			},
			supplements: { bottle:{ id:'addon-supp-bottle', title:"Extra supplement bottle", price:8.49 } },
			services: {
				coaching30: { id:'addon-coach-30', title:"Extra 30-min coaching session", price:15 },
				gpConsult:  { id:'addon-gp-20',    title:"Extra GP consult (15–20 min)", price:29 }
			}
		},
		fees: { paymentPct:1.9, paymentFixed:0.20, shippingPerKit:3.80 },
		catalog: {
			labs: [
				{id:"core",             name:"Core Blood Test",                credits:1, tag:"standard", gender:"any"},
				{id:"metabolic",        name:"Metabolic Health",               credits:1, tag:"standard", gender:"any"},
				{id:"cardio",           name:"Cardiovascular",                 credits:1, tag:"standard", gender:"any"},
				{id:"male-hormone",     name:"Male Hormone",                   credits:1, tag:"standard", gender:"male"},
				{id:"thyroid",          name:"Thyroid Health",                 credits:1, tag:"standard", gender:"any"},
				{id:"nutritional",      name:"Nutritional Health",             credits:1, tag:"standard", gender:"any"},
				{id:"complete-20",      name:"Complete Blood Test (20)",       credits:2, tag:"complete", gender:"any"},
				{id:"complete-met",     name:"Complete Metabolic",             credits:2, tag:"complete", gender:"any"},
				{id:"venous-testosterone", name:"Testosterone (Venous)",       credits:3, tag:"venous", gender:"male"},
				{id:"female-hormone",   name:"Female Hormone Panel",           credits:1, tag:"standard", gender:"female"},
				{id:"prenatal-panel",   name:"Prenatal Health Panel",          credits:2, tag:"complete", gender:"female"}
			],
			supplements: [
				{id:"multi",    name:"Men's Multivitamin", rrp:12.6, gender:"male"},
				{id:"multi-women", name:"Women's Multivitamin", rrp:12.6, gender:"female"},
				{id:"omega3",   name:"High-Strength Omega-3", rrp:9.34, gender:"any"},
				{id:"sleep",    name:"Sleep Support", rrp:9.34, gender:"any"},
				{id:"cellular", name:"Cellular Protection", rrp:9.34, gender:"any"},
				{id:"b12",      name:"Vitamin B12", rrp:14, gender:"any"},
				{id:"hair",     name:"Hair Support", rrp:9.34, gender:"any"},
				{id:"iron",     name:"Iron Support", rrp:11.50, gender:"female"},
				{id:"prenatal", name:"Prenatal Vitamins", rrp:15.00, gender:"female"},
				{id:"testosterone", name:"Testosterone Support", rrp:18.00, gender:"male"}
			],
			coaching: [
				{id:"weight",   name:"Weight & metabolic fitness", gender:"any"},
				{id:"nutrition",name:"Nutrition & habit change", gender:"any"},
				{id:"sleep",    name:"Sleep & recovery", gender:"any"},
				{id:"sexual",   name:"Sexual health performance", gender:"any"},
				{id:"mens",     name:"General men's health", gender:"male"},
				{id:"womens",   name:"General women's health", gender:"female"},
				{id:"energy",   name:"Energy & vitality", gender:"any"},
				{id:"menopause", name:"Menopause support", gender:"female"},
				{id:"fertility", name:"Fertility & reproductive health", gender:"female"}
			]
		}
	};
	Object.assign(window, { MODEL });

	// =============== GENDER FILTERING ===============
	function filterByGender(items, userGender) {
		console.log('filterByGender called with userGender:', userGender, 'items count:', items.length);
		
		if (!userGender || userGender === 'prefer-not-to-say' || userGender === 'non-binary') {
        // For unspecified/non-binary/prefer not to say, show ALL items (any, female, male)
        console.log('Gender unspecified, non-binary, or prefer not to say — return all items');
        return items;
		}
		
		// Filter based on gender
		const filtered = items.filter(item => {
			const itemGender = item.gender || 'any';
			const shouldInclude = itemGender === 'any' || itemGender === userGender;
			console.log(`Item ${item.id} (${item.name}): gender=${itemGender}, userGender=${userGender}, include=${shouldInclude}`);
			return shouldInclude;
		});
		
		console.log(`Filtered ${items.length} items to ${filtered.length} items for gender: ${userGender}`);
		return filtered;
	}

    // =============== UTIL & PERSISTENCE ===============
    const LS_PREFIX = 'numan.healthspan.v5.';
    function persist(key, value){ try{ localStorage.setItem(LS_PREFIX+key, JSON.stringify(value)); }catch(e){} }
    function read(key, fallback=null){ try{ const v=localStorage.getItem(LS_PREFIX+key); return v? JSON.parse(v): fallback; }catch(e){ return fallback; } }
    
    // =============== RESILIENT STATE LAYER ===============
    const BUILD_ID = "hs-v6-2025-01-19";
    const SCHEMA_VERSION = 6;
    const STORAGE_PREFIX = "numan.hs";

    const Storage = {
        _key(k){ return `${STORAGE_PREFIX}.${k}`; },
        get(k, fallback=null){
            try { const raw = localStorage.getItem(this._key(k)); return raw ? JSON.parse(raw) : fallback; }
            catch { return fallback; }
        },
        set(k, v){ try { localStorage.setItem(this._key(k), JSON.stringify(v)); } catch {} },
        remove(k){ try { localStorage.removeItem(this._key(k)); } catch {} },
    };

    const ROUTE_ALIASES = {
        "biological-age": "metabolic-age",
        "bio-age": "metabolic-age"
    };

    function viewExists(id){ return !!document.querySelector(`[data-view="${id}"]`); }

    (function retireOldKeys(){
        // Remove legacy keys so stale routes can't "follow" across builds
        ["numan.healthspan.v5.currentView","numan.healthspan.v4.currentView"].forEach(k => { try { localStorage.removeItem(k); } catch {} });
    })();

    function migrateState(){
        const meta = Storage.get("meta", {});
        if (meta.buildId !== BUILD_ID || meta.schemaVersion !== SCHEMA_VERSION){
            Storage.remove("currentView");
            Storage.set("meta", { buildId: BUILD_ID, schemaVersion: SCHEMA_VERSION, migratedAt: Date.now() });
        }
        let cur = Storage.get("currentView", "dashboard");
        if (typeof cur !== "string") cur = "dashboard";
        if (!viewExists(cur) && ROUTE_ALIASES[cur]) cur = ROUTE_ALIASES[cur];
        if (!viewExists(cur)) cur = "dashboard";
        Storage.set("currentView", cur);
    }

    function installGlobalGuards(){
        const recover = () => {
            const safe = Storage.get("currentView", "dashboard");
            const fallback = viewExists(safe) ? safe : (viewExists("dashboard") ? "dashboard" : "landing");
            document.querySelectorAll("[data-view]").forEach(v=>v.classList.remove("active"));
            const el = document.querySelector(`[data-view="${fallback}"]`);
            if (el) el.classList.add("active");
            if (typeof window.showToast === "function") showToast("Something went wrong. Restored your last page.");
        };
        window.addEventListener("error", recover);
        window.addEventListener("unhandledrejection", recover);
    }
    // Support both direct key writes and prefixed state updates
    function save(arg1, arg2){
        if (typeof arg1 === 'string') {
            localStorage.setItem(arg1, JSON.stringify(arg2));
            return;
        }
        if (arg1 && typeof arg1 === 'object' && arg2 === undefined) {
            Object.entries(arg1).forEach(([k,v])=>persist(k,v));
            return;
        }
        console.warn('save called with invalid arguments', arg1);
    }
    function showToast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2500); }

	// =============== CORE HELPERS & STATE MANAGEMENT ===============
	const money = n => `£${(Math.round(n*100)/100).toFixed(2)}`;
	function paymentFees(amount){ return amount*(MODEL.fees.paymentPct/100) + MODEL.fees.paymentFixed; }
	function load(k, d=null){ try{ return JSON.parse(localStorage.getItem(k)) ?? d; }catch{ return d; } }

	// App state
	const HS = load('hs', {
		plan: { tier:'Base' },
		firstMonth: { lab:null, useLabLater:false, supplements:[], coaching:null },
		addons: { }, // map id -> qty
		editMode: false, // for plan editing
	});
	
	// Migrate old plan data to new HS state
	function migratePlanData() {
		const oldPlanTier = load('plan.tier');
		if (oldPlanTier && !HS.plan.tier) {
			// Map old plan names to new ones
			const planMapping = {
				'Basic': 'Base',
				'Standard': 'Standard', 
				'Premium': 'Premium'
			};
				// Only migrate if there's a valid old plan tier, don't default to Standard
				if (planMapping[oldPlanTier]) {
					HS.plan.tier = planMapping[oldPlanTier];
			commit();
				}
		}
	}
	
	// Run migration on load
	migratePlanData();
	
	// Ensure correct plan tier is always used
	function ensureCorrectPlanTier() {
		// Check if we have old plan data that needs migration
		const oldPlanTier = load('plan.tier');
		if (oldPlanTier && oldPlanTier !== HS.plan.tier) {
			const planMapping = {
				'Basic': 'Base',
				'Standard': 'Standard', 
				'Premium': 'Premium'
			};
				// Only migrate if there's a valid old plan tier, don't default to Standard
				if (planMapping[oldPlanTier]) {
					HS.plan.tier = planMapping[oldPlanTier];
			State.plan.tier = HS.plan.tier; // Sync both states
			commit();
				}
		}
		
		// Sync State.plan.tier to HS.plan.tier if State has a valid plan
		if (State.plan.tier && State.plan.tier !== HS.plan.tier) {
			HS.plan.tier = State.plan.tier;
			commit();
		}
		
		// Don't pre-select a plan for first-time users - let them choose
		const hasActiveSubscription = State.subscription?.active && State.subscription?.status === 'active';
		if (!hasActiveSubscription) {
			// Only set a plan if one was previously selected, don't default to Standard
		if (!HS.plan.tier || !MODEL.plans[HS.plan.tier]) {
				HS.plan.tier = null;
				State.plan.tier = null; // No pre-selection for first-time checkout
			commit();
			}
		}
	}
	
	function commit(){ save('hs', HS); }
	Object.assign(window, { HS, commit, ensureCorrectPlanTier });

	function calcPlanMonthly(tier, isAnnual = false){ 
		const basePrice = MODEL.plans[tier].price;
		return isAnnual ? Math.round(basePrice * 0.9) : basePrice; // 10% discount for annual
	}
	function addonsSubtotal(){
		return Object.entries(HS.addons).reduce((sum,[id,qty])=>{
			const all = { ...MODEL.memberAddOns.tests, ...MODEL.memberAddOns.supplements, ...MODEL.memberAddOns.services };
			const item = Object.values(all).find(x=>x.id===id);
			return sum + (item ? item.price * qty : 0);
		},0);
	}
	function shippingThisMonth(){
		const kits = (HS.firstMonth.labs && HS.firstMonth.labs.length > 0 && !HS.firstMonth.useLabLater) ? HS.firstMonth.labs.length : 0;
		return kits * MODEL.fees.shippingPerKit;
	}
	function quote(tier){
		// Use billing cycle from State.plan.billingCycle
		const isAnnual = State.plan.billingCycle === 'annual';
		const base = calcPlanMonthly(tier, isAnnual);
		const addOns = addonsSubtotal();
		const sub = base + addOns;
		const fees = paymentFees(sub);
		const ship = shippingThisMonth();
		return { base, addOns, fees, ship, total: sub + fees + ship };
	}
	Object.assign(window, { money, paymentFees, calcPlanMonthly, addonsSubtotal, shippingThisMonth, quote });

	// =============== RECOMMENDATION ENGINE ===============
	const recEngine = (() => {
		// 1) Read enhanced signals from onboarding / wearables / clinical assessments with safe fallbacks
		function readSignals(){
			const ob = (window.onboardingState || State?.onboarding || HS?.onboarding || load('onboarding') || {});
			const wear = (HS?.wearables || load('wearables') || {});
			const user = (State?.user || HS?.user || {});
			const series = wear.series || {};
			const assessments = (State?.assessments || {});
			
			const avg7 = k => {
				const arr = (series[k] || []).slice(-7);
				const n = Math.max(1, arr.length);
				return arr.reduce((a,b)=>a+b,0)/n;
			};

			// Basic demographics
			const age = Number(ob.age || user.age || 38);
			const height = Number(ob.heightCm || user.height || 175);
			const weight = Number(ob.weightKg || user.weight || 80);
			const waist = Number(ob.waistCm || user.waist || 92);
			const whtr = height ? (waist/height) : 0.53;
			const bmi = height && weight ? (weight / ((height/100) ** 2)) : 25;

			// Wearables data
			const sleepHours = Number(ob.sleepHours || avg7('sleep') || 6.0);
			const steps7 = Number(ob.steps || avg7('steps') || 6500);
			const rhr7 = Number(ob.rhr || avg7('rhr') || 68);
			const hrv7 = Number(ob.hrv || avg7('hrv') || 40);

			// Clinical assessment scores
			const stressScore = Number(assessments.stress || 0);
			const sleepScore = Number(assessments.sleep || 0);
			const energyScore = Number(assessments.energy || 0);
			const moodScore = Number(assessments.mood || 0);

			// Lifestyle factors
			const biomarkersUnknown = Boolean(ob.biomarkersUnknown ?? true);
			const goal = String(ob.goal || 'weight'); // weight | energy | sexual | hair | general
			const budgetSensitive = Boolean(ob.budgetSensitive ?? false);
			const prefersCoaching = Boolean(ob.prefersCoaching ?? true);
			const budget = String(ob.budget || ob.answers?.budget || State?.onboarding?.answers?.budget || ''); // under-50 | 50-99 | 100-plus
			const smoker = Boolean(ob.smoker || user.smoker || false);
			const alcoholUnits = Number(ob.alcoholUnits || user.alcoholUnits || 0);
			const activityMins = Number(ob.activityMins || user.activityMins || 0);

			// Health conditions and symptoms
			const hasDiabetes = Boolean(ob.hasDiabetes || user.hasDiabetes || false);
			const hasHypertension = Boolean(ob.hasHypertension || user.hasHypertension || false);
			const hasHeartDisease = Boolean(ob.hasHeartDisease || user.hasHeartDisease || false);
			const hasThyroidIssues = Boolean(ob.hasThyroidIssues || user.hasThyroidIssues || false);

			// Current plan context
			const currentPlan = String(State?.plan?.tier || HS?.plan?.tier || '');

			return { 
				// Demographics
				age, whtr, bmi, height, weight, waist,
				// Wearables
				sleepHours, steps7, rhr7, hrv7,
				// Clinical assessments
				stressScore, sleepScore, energyScore, moodScore,
				// Lifestyle
				biomarkersUnknown, goal, budgetSensitive, prefersCoaching, budget,
				smoker, alcoholUnits, activityMins,
				// Health conditions
				hasDiabetes, hasHypertension, hasHeartDisease, hasThyroidIssues,
				// Context
				currentPlan
			};
		}

		// 2) Choose plan (transparent heuristics)
		function recommendPlan(s){
			let score = 0;
			if (s.whtr >= 0.50) score += 2;
			if (s.sleepHours < 6.5) score += 1;
			if (s.steps7 < 6000) score += 1;
			if (s.biomarkersUnknown) score += 1;
			if (s.prefersCoaching) score += 1;
			if (s.age >= 50) score += 1;

			// Budget-based plan recommendation - direct mapping
			let plan = 'Standard'; // Default fallback
			if (s.budget === 'under-50') {
				plan = 'Base';
			} else if (s.budget === '50-99') {
				plan = 'Standard';
			} else if (s.budget === '100-plus') {
				plan = 'Premium';
			} else {
				// Fallback to original logic if no budget specified
				if (score >= 4) plan = 'Premium';
				if (score <= 1 || s.budgetSensitive) plan = 'Base';
			}

			const reasons = [];
			if (s.whtr >= 0.50) reasons.push(`WHtR ${s.whtr.toFixed(2)} (elevated)`);
			if (s.sleepHours < 6.5) reasons.push(`Short sleep (${s.sleepHours.toFixed(1)} h)`);
			if (s.steps7 < 6000) reasons.push(`Low activity (${Math.round(s.steps7)} steps)`);
			if (s.biomarkersUnknown) reasons.push('Key biomarkers unknown');
			if (s.budget) {
				const budgetText = s.budget === 'under-50' ? '<£50' : s.budget === '50-99' ? '£50-99' : '£100+';
				reasons.push(`Budget: ${budgetText}`);
			}
			return { plan, reasons };
		}

		// 3) Pick lab kits (credit-aware, gender-aware, plan tier-aware)
		function pickLabs(s, plan, userGender){
        // Only treat 'male' or 'female' as gendered; otherwise null = unspecified
        const gender = (userGender === 'male' || userGender === 'female') ? userGender : null;
			const planDetails = MODEL.plans[plan];
			const totalCredits = planDetails.labCreditsPerYear; // 1, 2, or 4 credits
			
			// Get available labs filtered by gender
			const availableLabs = filterByGender(MODEL.catalog.labs || [], gender);
			
			const recommendations = [];
			let creditsUsed = 0;
			
			// Enhanced lab recommendation logic based on user data
			
			// For users with unknown biomarkers or age 50+, prioritize comprehensive testing
			if (s.biomarkersUnknown || s.age >= 50) {
				// Try to fit a complete panel if credits allow
				if (totalCredits >= 2) {
					const complete = availableLabs.find(x => x.id === 'complete-20' || x.credits === 2);
					if (complete && creditsUsed + complete.credits <= totalCredits) {
						recommendations.push({
							id: complete.id,
							name: complete.name,
							credits: complete.credits,
							tag: complete.tag,
							reason: 'Comprehensive health assessment for baseline establishment'
						});
						creditsUsed += complete.credits;
					}
				} else if (totalCredits === 1) {
					// For Base plan (1 credit), recommend the most comprehensive 1-credit test
					const core = availableLabs.find(x => x.id === 'core');
					if (core && creditsUsed + core.credits <= totalCredits) {
						recommendations.push({
							id: core.id,
							name: core.name,
							credits: core.credits,
							tag: core.tag,
							reason: 'Essential health markers for baseline establishment'
						});
						creditsUsed += core.credits;
					}
				}
			}
			
			// Goal-specific lab recommendations (only if we haven't already used all credits)
			if (creditsUsed < totalCredits && (s.goal === 'weight' || s.whtr >= 0.50)) {
				const metabolic = availableLabs.find(x => x.id === 'metabolic');
				if (metabolic && creditsUsed + metabolic.credits <= totalCredits) {
					recommendations.push({
						id: metabolic.id,
						name: metabolic.name,
						credits: metabolic.credits,
						tag: metabolic.tag,
						reason: 'Metabolic health markers for weight management'
					});
					creditsUsed += metabolic.credits;
				}
			}
			
			if (creditsUsed < totalCredits && s.goal === 'sexual') {
				if (gender === 'male') {
					const maleHormone = availableLabs.find(x => x.id === 'male-hormone');
					if (maleHormone && creditsUsed + maleHormone.credits <= totalCredits) {
						recommendations.push({
							id: maleHormone.id,
							name: maleHormone.name,
							credits: maleHormone.credits,
							tag: maleHormone.tag,
							reason: 'Male hormone panel for sexual health'
						});
						creditsUsed += maleHormone.credits;
					}
				} else if (gender === 'female') {
					const femaleHormone = availableLabs.find(x => x.id === 'female-hormone');
					if (femaleHormone && creditsUsed + femaleHormone.credits <= totalCredits) {
						recommendations.push({
							id: femaleHormone.id,
							name: femaleHormone.name,
							credits: femaleHormone.credits,
							tag: femaleHormone.tag,
							reason: 'Female hormone panel for sexual health'
						});
						creditsUsed += femaleHormone.credits;
					}
				}
			}
			
			if (creditsUsed < totalCredits && s.goal === 'hair') {
				const thyroid = availableLabs.find(x => x.id === 'thyroid');
				if (thyroid && creditsUsed + thyroid.credits <= totalCredits) {
					recommendations.push({
						id: thyroid.id,
						name: thyroid.name,
						credits: thyroid.credits,
						tag: thyroid.tag,
						reason: 'Thyroid function affects hair health'
					});
					creditsUsed += thyroid.credits;
				}
			}
			
			// Age and gender-specific recommendations (only if we haven't already used all credits)
			if (creditsUsed < totalCredits && s.age >= 40) {
				const cardio = availableLabs.find(x => x.id === 'cardio');
				if (cardio && creditsUsed + cardio.credits <= totalCredits) {
					recommendations.push({
						id: cardio.id,
						name: cardio.name,
						credits: cardio.credits,
						tag: cardio.tag,
						reason: 'Cardiovascular health screening for age 40+'
					});
					creditsUsed += cardio.credits;
				}
			}
			
			// Fill remaining credits with core health markers (only if we haven't already used all credits)
			if (creditsUsed < totalCredits) {
				const core = availableLabs.find(x => x.id === 'core');
				if (core && creditsUsed + core.credits <= totalCredits) {
					recommendations.push({
						id: core.id,
						name: core.name,
						credits: core.credits,
						tag: core.tag,
						reason: 'Essential health markers'
					});
					creditsUsed += core.credits;
				}
			}
			
			// For premium plans, add nutritional health if credits allow
			if (plan === 'Premium' && creditsUsed < totalCredits) {
				const nutritional = availableLabs.find(x => x.id === 'nutritional');
				if (nutritional && creditsUsed + nutritional.credits <= totalCredits) {
					recommendations.push({
						id: nutritional.id,
						name: nutritional.name,
						credits: nutritional.credits,
						tag: nutritional.tag,
						reason: 'Nutritional health optimization'
					});
					creditsUsed += nutritional.credits;
				}
			}
			
			// Ensure we always have at least one recommendation, even for Base plan
			if (recommendations.length === 0) {
				const core = availableLabs.find(x => x.id === 'core');
				if (core) {
					recommendations.push({
						id: core.id,
						name: core.name,
						credits: core.credits,
						tag: core.tag,
						reason: 'Essential health markers'
					});
				}
			}
			
			return recommendations;
		}

		// 4) Pick supplements (respect monthly credit, gender, and plan tier)
		function pickSupplements(s, plan, userGender){
        const gender = (userGender === 'male' || userGender === 'female') ? userGender : null;
			const planDetails = MODEL.plans[plan];
			const supplementQuantity = planDetails.supplementQuantityPerMonth; // 1, 2, or 3
			const credit = planDetails.supplementCreditPerMonth; // Used for internal calculations
			
			// Get available supplements filtered by gender
			const availableSupplements = filterByGender(MODEL.catalog.supplements || [], gender);
			
			// Enhanced supplement recommendation logic based on user data
			const recommendations = [];
			
        // Include a multivitamin only when gender is specified; otherwise keep gender-neutral picks
        if (gender) {
			const multiId = gender === 'female' ? 'multi-women' : 'multi';
			const multi = availableSupplements.find(x => x.id === multiId);
			if (multi) {
				recommendations.push({
					id: multi.id,
					name: multi.name,
					rrp: multi.rrp,
					topUp: 0, // No top-up fees - supplements are included
					reason: 'Essential daily nutrition foundation'
				});
            }
			}
			
			// Add goal-specific supplements
			if (s.goal === 'weight' || s.whtr >= 0.50) {
				const omega3 = availableSupplements.find(x => x.id === 'omega3');
				if (omega3 && recommendations.length < supplementQuantity) {
					recommendations.push({
						id: omega3.id,
						name: omega3.name,
						rrp: omega3.rrp,
						topUp: 0, // No top-up fees - supplements are included
						reason: 'Supports metabolic health and weight management'
					});
				}
			}
			
			if (s.goal === 'energy' || s.sleepHours < 6.5) {
				const sleep = availableSupplements.find(x => x.id === 'sleep');
				if (sleep && recommendations.length < supplementQuantity) {
					recommendations.push({
						id: sleep.id,
						name: sleep.name,
						rrp: sleep.rrp,
						topUp: 0, // No top-up fees - supplements are included
						reason: 'Improves sleep quality and energy levels'
					});
				}
			}
			
			if (s.goal === 'hair') {
				const hair = availableSupplements.find(x => x.id === 'hair');
				if (hair && recommendations.length < supplementQuantity) {
					recommendations.push({
						id: hair.id,
						name: hair.name,
						rrp: hair.rrp,
						topUp: 0, // No top-up fees - supplements are included
						reason: 'Supports hair health and growth'
					});
				}
			}
			
			// Gender-specific recommendations
			if (gender === 'female' && s.age >= 40) {
				const iron = availableSupplements.find(x => x.id === 'iron');
				if (iron && recommendations.length < supplementQuantity) {
					recommendations.push({
						id: iron.id,
						name: iron.name,
						rrp: iron.rrp,
						topUp: 0, // No top-up fees - supplements are included
						reason: 'Supports iron levels and energy'
					});
				}
			}
			
			if (gender === 'male' && s.goal === 'sexual') {
				const testosterone = availableSupplements.find(x => x.id === 'testosterone');
				if (testosterone && recommendations.length < supplementQuantity) {
					recommendations.push({
						id: testosterone.id,
						name: testosterone.name,
						rrp: testosterone.rrp,
						topUp: 0, // No top-up fees - supplements are included
						reason: 'Supports testosterone levels and sexual health'
					});
				}
			}
			
			// Fill remaining slots with general health supplements
			if (recommendations.length < supplementQuantity) {
				const cellular = availableSupplements.find(x => x.id === 'cellular');
				if (cellular && !recommendations.find(r => r.id === cellular.id)) {
					recommendations.push({
						id: cellular.id,
						name: cellular.name,
						rrp: cellular.rrp,
						topUp: 0, // No top-up fees - supplements are included
						reason: 'Antioxidant protection and cellular health'
					});
				}
			}
			
			// Limit to plan's supplement quantity
			return recommendations.slice(0, supplementQuantity);
		}

		// 5) Pick coaching focus (length from plan and gender)
		function pickCoaching(s, plan, userGender){
        const gender = (userGender === 'male' || userGender === 'female') ? userGender : null;
			
			// Gender-aware coaching mapping
			const map = { 
				weight: 'weight', 
            sexual: gender ? (gender === 'female' ? 'womens' : 'mens') : 'sexual',
            hair: gender ? (gender === 'female' ? 'womens' : 'mens') : 'nutrition',
            energy: 'energy',
            general: gender ? (gender === 'female' ? 'womens' : 'mens') : 'nutrition'
        };
        const id = map[s.goal] || (gender ? (gender === 'female' ? 'womens' : 'mens') : 'energy');
			
			// Filter coaching options by gender and find the recommended one
			const availableCoaching = filterByGender(MODEL.catalog.coaching || [], gender);
			const i = availableCoaching.find(x=>x.id===id) || availableCoaching[0] || {id:'mens', name:"General men's health"};
			return { id:i.id, name:i.name, minutes: MODEL.plans[plan].coachingMinutesPerMonth };
		}

		// 6) Optional add-on suggestions
		function suggestAddOns(s, plan, lab){
			const out = [];
			if (plan === 'Base' && lab.credits === 2){
				out.push({type:'nudge', message:'Upgrade to Standard to cover a Complete panel with credits, or add a one-off Complete test at member price (£79).'});
			}
			// Removed extra supplement bottle suggestion
			return out;
		}

		// 7) Build enhanced recommendations
		function buildRecommendations(signals, userGender){
			// Use the selected plan instead of recommending a new one, but don't default to Standard
			const plan = State.plan.tier || HS.plan.tier || null;
			console.log('buildRecommendations: Using selected plan:', plan, 'State.plan.tier:', State.plan.tier, 'HS.plan.tier:', HS.plan.tier);
			
			// If no plan is selected, return empty recommendations
			if (!plan) {
				return {
					plan: null,
					picks: {
						labs: [],
						supplements: [],
						coaching: { name: 'General Health', minutes: 30 }
					},
					reasons: ['Please select a plan first to get personalized recommendations']
				};
			}
			
			const labs = pickLabs(signals, plan, userGender);
			const supplements = pickSupplements(signals, plan, userGender);
			const coaching = pickCoaching(signals, plan, userGender);
			
			// Generate specific reasons based on the actual recommendations made
			const reasons = [];
			
            // Lab-specific reasons enriched with user metrics
			labs.forEach(lab => {
				if (lab.id === 'complete-blood-test') {
					if (signals.biomarkersUnknown) {
						reasons.push('Complete blood test to establish baseline biomarkers');
					} else if (signals.whtr >= 0.50) {
						reasons.push(`Complete blood test for metabolic health (WHtR ${signals.whtr.toFixed(2)})`);
					} else {
						reasons.push('Complete blood test for comprehensive health assessment');
					}
				} else if (lab.id === 'hormone-panel') {
					if (signals.goals?.includes('sexual')) {
						reasons.push('Hormone panel for sexual health optimization');
					} else if (signals.goals?.includes('energy')) {
						reasons.push('Hormone panel to assess energy and vitality markers');
					} else {
						reasons.push('Hormone panel for comprehensive hormonal assessment');
					}
				} else if (lab.id === 'vitamin-d') {
					if (signals.sleepHours < 6.5) {
						reasons.push('Vitamin D test (linked to sleep quality)');
					} else {
						reasons.push('Vitamin D test for immune and bone health');
					}
                } else if (lab.id === 'cardio') {
                    // Tie to age and RHR where possible
                    if (signals.rhr7 > 64) {
                        reasons.push(`Cardiovascular panel due to RHR ${Math.round(signals.rhr7)} bpm (>64 optimal)`);
                    } else if (signals.age >= 40) {
                        reasons.push('Cardiovascular health screening for age 40+');
                    } else {
                        reasons.push('Cardiovascular risk screening');
					}
				}
			});
			
            // Supplement-specific reasons enriched with user metrics
			supplements.forEach(supp => {
				if (supp.id === 'omega-3') {
					if (signals.whtr >= 0.50) {
						reasons.push('Omega-3 for cardiovascular and metabolic health');
                    } else if (signals.rhr7 > 64) {
                        reasons.push(`Omega-3 to support heart health (RHR ${Math.round(signals.rhr7)} bpm)`);
                    } else if (signals.hrv7 < 60) {
                        reasons.push(`Omega-3 for autonomic balance (HRV ${Math.round(signals.hrv7)} ms < 60)`);
					} else if (signals.goals?.includes('cognitive')) {
						reasons.push('Omega-3 for brain and cognitive function');
					} else {
						reasons.push('Omega-3 for general health and inflammation support');
					}
				} else if (supp.id === 'vitamin-d') {
					if (signals.sleepHours < 6.5) {
						reasons.push('Vitamin D3 for sleep quality improvement');
					} else {
						reasons.push('Vitamin D3 for immune system support');
					}
				} else if (supp.id === 'magnesium') {
					if (signals.sleepHours < 6.5) {
                        reasons.push(`Magnesium for sleep quality (avg ${signals.sleepHours.toFixed(1)}h < 7–9h)`);
					} else if (signals.steps7 < 6000) {
                        reasons.push(`Magnesium for muscle function (steps ${Math.round(signals.steps7)}/day)`);
					} else {
						reasons.push('Magnesium for stress management and recovery');
					}
				} else if (supp.id === 'multivitamin') {
					reasons.push('Multivitamin for comprehensive nutritional support');
				}
			});
			
            // Coaching-specific reasons enriched with user metrics
			if (coaching.id === 'weight') {
				if (signals.whtr >= 0.50) {
					reasons.push(`Weight management coaching (WHtR ${signals.whtr.toFixed(2)})`);
				} else if (signals.goals?.includes('weight')) {
					reasons.push('Weight management coaching for your goals');
				} else {
					reasons.push('Weight management coaching for metabolic health');
				}
			} else if (coaching.id === 'nutrition') {
				if (signals.whtr >= 0.50) {
					reasons.push('Nutrition coaching for metabolic health');
				} else {
					reasons.push('Nutrition coaching for optimal health habits');
				}
			} else if (coaching.id === 'sleep') {
				if (signals.sleepHours < 6.5) {
                    reasons.push(`Sleep coaching (avg ${signals.sleepHours.toFixed(1)}h < 7–9h)`);
				} else {
					reasons.push('Sleep coaching for recovery optimization');
				}
			} else if (coaching.id === 'sexual') {
				if (signals.goals?.includes('sexual')) {
					reasons.push('Sexual health coaching for your goals');
				} else {
					reasons.push('Sexual health coaching for vitality');
				}
			}
			
			// Fallback to generic reason if no specific reasons found
			if (reasons.length === 0) {
				reasons.push('Based on your selected plan and health profile');
			}
			
			// Calculate total lab credits used
			const totalLabCredits = labs.reduce((sum, lab) => sum + lab.credits, 0);
			const addOns = suggestAddOns(signals, plan, { credits: totalLabCredits });
			
            // Also include high‑level wearable insights if outside targets
            if (signals.steps7 < 8000) reasons.push(`Average steps ${Math.round(signals.steps7)}/day (target ≥ 8,000)`);
            if (signals.sleepHours < 7) reasons.push(`Sleep ${signals.sleepHours.toFixed(1)}h (target 7–9h)`);
            if (signals.rhr7 > 64) reasons.push(`Resting HR ${Math.round(signals.rhr7)} bpm (above optimal 55–64)`);
            if (signals.hrv7 && signals.hrv7 < 60) reasons.push(`HRV ${Math.round(signals.hrv7)} ms (target ≥ 60)`);

            // Deduplicate and keep concise
            const uniqueReasons = Array.from(new Set(reasons));
			
			return { 
				plan, 
                reasons: uniqueReasons, 
				picks: { 
					labs, 
					supplements, 
					coaching 
				}, 
				addOns,
				summary: {
					totalLabCredits,
					supplementCount: supplements.length,
					planTier: plan
				}
			};
		}

		// 8) Render modal
		function renderModal(rec){
			const el = document.querySelector('#recsModal .modal-body');
			if (!el) return;
			
			try {
				const chip = t => `<span class="chip" style="font-size:0.8rem; padding:0.25rem 0.5rem; margin:0.125rem">${t}</span>`;
				
				// Ensure addOns array exists and is safe to map
				const addOns = rec.addOns || [];
				const nudges = addOns.map(a => {
					if (a.type === 'nudge') {
						return `<li class="nudge">${a.message || 'Additional recommendation'}</li>`;
					} else if (a.item) {
						return `<li>${a.item.title || 'Add-on'} <span class="price">£${(a.item.price || 0).toFixed(2)}</span></li>`;
					}
					return '';
				}).filter(n => n).join('');
				
				// Ensure all required properties exist with fallbacks
				const plan = rec.plan || 'Standard';
				const picks = rec.picks || {};
				const coaching = picks.coaching || { name: 'General Health', minutes: 30 };
				const reasons = rec.reasons || ['Based on your profile'];
				
				// Handle multiple labs
				const labs = picks.labs || (picks.lab ? [picks.lab] : [{ name: 'Core Blood Test', credits: 1 }]);
				const totalLabCredits = labs.reduce((sum, lab) => sum + (lab.credits || 1), 0);
				
				// Handle multiple supplements
				const supplements = picks.supplements || (picks.supplement ? [picks.supplement] : [{ name: 'Multivitamin', topUp: 0 }]);
				
				// Build lab recommendations HTML
				const labHTML = labs.map(lab => 
					`<li style="margin-bottom:0.25rem">Lab: <strong>${lab.name}</strong> <span class="tag" style="background:#10b981; color:white; padding:0.125rem 0.375rem; border-radius:12px; font-size:0.75rem; font-weight:600">uses ${lab.credits || 1} credit${(lab.credits || 1) > 1 ? 's' : ''}</span>${lab.reason ? ` <em style="font-size:0.85rem">(${lab.reason})</em>` : ''}</li>`
				).join('');
				
				// Build supplement recommendations HTML
				const supplementHTML = supplements.map(supp => 
					`<li style="margin-bottom:0.25rem">Supplement: <strong>${supp.name}</strong>${supp.reason ? ` <em style="font-size:0.85rem">(${supp.reason})</em>` : ''}</li>`
				).join('');
				
				// Plan summary
				const selectedPlan = State.plan.tier || HS.plan.tier || plan;
				console.log('renderModal: selectedPlan:', selectedPlan, 'State.plan.tier:', State.plan.tier, 'HS.plan.tier:', HS.plan.tier, 'rec.plan:', rec.plan);
				const planSummary = ''; // Removed plan summary text
				
				el.innerHTML = `
					<div class="stack gap-2">
						<p class="muted" style="font-size:1rem; margin-bottom:1rem; line-height:1.5; color:#6b7280">Based on your answers and any connected device data, here's a simple month-one plan.</p>
						${planSummary}
						<div class="card soft" style="padding:1rem; margin-bottom:0.75rem">
							<div class="h6" style="margin-bottom:0.75rem; font-size:1rem">Selected plan: <strong>${State.plan.tier || HS.plan.tier || plan}</strong></div>
							
							<!-- Labs Section -->
							${labs.length > 0 ? `
							<div style="margin-bottom:1rem">
								<h4 style="margin:0 0 0.5rem 0; font-size:1rem; font-weight:600; color:#1f2937">Labs</h4>
							<ul class="picks" style="margin:0; padding-left:1rem; line-height:1.4">
								${labHTML}
								</ul>
							</div>
							` : ''}
							
							<!-- Supplements Section -->
							${supplements.length > 0 ? `
							<div style="margin-bottom:1rem">
								<h4 style="margin:0 0 0.5rem 0; font-size:1rem; font-weight:600; color:#1f2937">Supplements</h4>
								<ul class="picks" style="margin:0; padding-left:1rem; line-height:1.4">
								${supplementHTML}
								</ul>
							</div>
							` : ''}
							
							<!-- Coaching Section -->
							<div style="margin-bottom:0">
								<h4 style="margin:0 0 0.5rem 0; font-size:1rem; font-weight:600; color:#1f2937">Coaching</h4>
								<ul class="picks" style="margin:0; padding-left:1rem; line-height:1.4">
								<li style="margin-bottom:0.25rem">Coaching focus: <strong>${coaching.name}</strong> <span class="muted">(${coaching.minutes} min)</span></li>
							</ul>
						</div>
						</div>
						<div class="reasons" style="margin-bottom:1rem">
							<div class="muted" style="font-size:1rem; margin-bottom:0.75rem; font-weight:600; color:#374151">How we picked this</div>
							<div class="chips" style="display:flex; flex-wrap:wrap; gap:0.5rem">${reasons.map(chip).join('')}</div>
						</div>
						${nudges?`<div class="nudges" style="margin-bottom:0.75rem"><ul style="margin:0; padding-left:1rem; font-size:0.9rem">${nudges}</ul></div>`:''}
						<div class="footnote muted" style="font-size:0.9rem; line-height:1.5; margin-top:1rem; padding-top:1rem; border-top:1px solid #e5e7eb; color:#6b7280">Educational guidance; not diagnostic. Medicines are priced/approved separately.</div>
					</div>
				`;
			} catch (error) {
				console.error('Error rendering modal:', error);
				el.innerHTML = `
					<div class="stack gap-3">
						<p class="muted">Unable to generate recommendations at this time. Please try again later.</p>
						<div class="card soft">
							<p>We're having trouble generating your personalised recommendations. Please ensure you've completed the onboarding process and try again.</p>
						</div>
					</div>
				`;
			}
		}

		// 9) Write into HS + go to addons interstitial
		function applyToHS(rec, force = false){
			if (!rec || !rec.picks) {
				throw new Error('Invalid recommendation data');
			}

			console.log('🚨 applyToHS called with:', rec);
			console.log('🚨 Force flag:', force);
			console.log('🚨 Current HS.firstMonth before applying:', HS.firstMonth);
			console.log('🚨 Stack trace:', new Error().stack);

			// If no plan is selected, don't apply recommendations
			if (!rec.plan) {
				console.log('No plan selected - skipping recommendation application');
				return;
			}

			// Check if user already has selections - if so, don't override them unless forced
			const hasExistingSelections = (
				(HS.firstMonth.labs && HS.firstMonth.labs.length > 0) ||
				(HS.firstMonth.supplements && HS.firstMonth.supplements.length > 0) ||
				HS.firstMonth.coaching
			);

			console.log('🚨 Has existing selections:', hasExistingSelections);
			console.log('🚨 Existing selections details:', {
				labs: HS.firstMonth.labs,
				supplements: HS.firstMonth.supplements,
				coaching: HS.firstMonth.coaching,
				labsLength: HS.firstMonth.labs?.length || 0,
				supplementsLength: HS.firstMonth.supplements?.length || 0,
				hasCoaching: !!HS.firstMonth.coaching
			});

			if (hasExistingSelections && !force) {
				console.log('🚨 User already has selections - skipping recommendation application to preserve user choices');
				console.log('🚨 Existing selections:', {
					labs: HS.firstMonth.labs,
					supplements: HS.firstMonth.supplements,
					coaching: HS.firstMonth.coaching
				});
				return;
			}
			
			console.log('🚨 Proceeding with recommendation application (force =', force, ')');

			// Only set plan tier if user hasn't manually selected a plan
			// This preserves user's manual plan selection from the plan page
			if (!State.plan.tier && !HS.plan.tier) {
			HS.plan.tier = rec.plan;
				State.plan.tier = rec.plan;
				save({'plan.tier': State.plan.tier});
			}

			// Handle multiple lab selections
			if (rec.picks.labs && Array.isArray(rec.picks.labs)) {
				// Initialize labs array if it doesn't exist
				if (!HS.firstMonth.labs) {
					HS.firstMonth.labs = [];
				}
				// Apply recommended labs (only if no existing selections)
				console.log('🚨 Applying recommended labs:', rec.picks.labs);
				HS.firstMonth.labs = rec.picks.labs.map(lab => lab.id);
				// Maintain backward compatibility with first lab
				HS.firstMonth.lab = rec.picks.labs[0]?.id;
			} else if (rec.picks.lab && rec.picks.lab.id) {
				// Backward compatibility for single lab
				if (!HS.firstMonth.labs) {
					HS.firstMonth.labs = [];
				}
				// Apply recommended lab (only if no existing selections)
				HS.firstMonth.labs = [rec.picks.lab.id];
				HS.firstMonth.lab = rec.picks.lab.id;
			}
			HS.firstMonth.useLabLater = false; // we're shipping a kit now by default

			// Handle multiple supplement selections
			if (rec.picks.supplements && Array.isArray(rec.picks.supplements)) {
				// Apply recommended supplements (only if no existing selections)
				console.log('🚨 Applying recommended supplements:', rec.picks.supplements);
				HS.firstMonth.supplements = rec.picks.supplements.map(supp => supp.id);
				// No top-up fees - supplements are included in plan
			} else if (rec.picks.supplement && rec.picks.supplement.id) {
				// Backward compatibility for single supplement
				// Apply recommended supplement (only if no existing selections)
				console.log('🚨 Applying recommended supplement (single):', rec.picks.supplement);
				HS.firstMonth.supplements = [rec.picks.supplement.id];
				// No top-up fees - supplements are included in plan
			}

			// Safely handle coaching selection
			if (rec.picks.coaching && rec.picks.coaching.id) {
				// Apply recommended coaching (only if no existing selection)
				console.log('🚨 Applying recommended coaching:', rec.picks.coaching);
				HS.firstMonth.coaching = rec.picks.coaching.id;
			}
			
			// Sync all selections to State.plan.firstMonthPicks for checkout consistency
			if (!State.plan.firstMonthPicks) {
				State.plan.firstMonthPicks = { labs: [], supplements: [], coaching: null };
			}
			State.plan.firstMonthPicks.labs = [...(HS.firstMonth.labs || [])];
			State.plan.firstMonthPicks.supplements = [...(HS.firstMonth.supplements || [])];
			State.plan.firstMonthPicks.coaching = HS.firstMonth.coaching;
			save({'plan.firstMonthPicks': State.plan.firstMonthPicks});
			
			console.log('HS.firstMonth after applying recommendations:', HS.firstMonth);
			console.log('State.plan.firstMonthPicks after applying recommendations:', State.plan.firstMonthPicks);
			
			// Debug logging to verify selections were applied
			console.log('Recommendations applied successfully:', {
				labs: HS.firstMonth.labs,
				supplements: HS.firstMonth.supplements,
				coaching: HS.firstMonth.coaching,
				statePicks: State.plan.firstMonthPicks,
				labDetails: HS.firstMonth.labs?.map(id => {
					const lab = MODEL.catalog.labs.find(l => l.id === id);
					return { id, name: lab?.name || 'Unknown' };
				}),
				supplementDetails: HS.firstMonth.supplements?.map(id => {
					const supp = MODEL.catalog.supplements.find(s => s.id === id);
					return { id, name: supp?.name || 'Unknown' };
				}),
				coachingDetails: HS.firstMonth.coaching ? {
					id: HS.firstMonth.coaching,
					name: MODEL.catalog.coaching.find(c => c.id === HS.firstMonth.coaching)?.name || 'Unknown'
				} : null
			});

			// Add-on suggestions (monetary items only)
			if (rec.addOns && Array.isArray(rec.addOns)) {
				rec.addOns.filter(x=>x.type==='addon').forEach(x=>{
					if (x.item && x.item.id) {
						HS.addons[x.item.id] = (HS.addons[x.item.id]||0) + 1;
					}
				});
			}

			commit();

            // After applying recommendations, do not auto-redirect away from
            // whatever the user is viewing. If they are already on the
            // build-first-month page, just refresh it so the picks show.
			if (State.currentView === 'build-first-month') {
				renderBuildFirstMonthPage();
			} else {
                // No automatic navigation; user can proceed via CTA.
                console.log('Recommendations applied (no auto-redirect)');
			}
		}

		// 10) Modal open/close helpers
		function open(){ 
			const modal = document.getElementById('recsModal');
			if (modal) modal.classList.add('active');
		}
		function close(){ 
			const modal = document.getElementById('recsModal');
			if (modal) modal.classList.remove('active');
		}

		// keep last rec (useful for Apply)
		let _current = null;
		return {
			readSignals,
            // Expose plan recommender for other views
            recommendPlan,
			buildRecommendations: (s)=> (_current = buildRecommendations(s, State.user.sex)),
			renderModal,
			apply: (suppressToast = false)=> {
				if (!_current) {
					console.error('No recommendations to apply. Please generate recommendations first.');
					if (!suppressToast) {
					showToast('No recommendations to apply. Please generate recommendations first.');
					}
					return;
				}
				try {
					applyToHS(_current, true); // Force application when user explicitly clicks Apply
					if (!suppressToast) {
					showToast('Recommendations applied successfully!');
					}
				} catch (error) {
					console.error('Error applying recommendations:', error);
					if (!suppressToast) {
					showToast('Error applying recommendations. Please try again.');
					}
				}
			},
			open, close,
			get current(){ return _current; }
		};
	})();
	Object.assign(window, { recEngine });

	// ROUTER
	(function initRouter(){
		const listeners = new Set();
		const Router = {
			current: Storage.get("currentView", "landing"),
			go(viewId){
				// Normalise aliases before doing anything
				viewId = ROUTE_ALIASES[viewId] || viewId;

				const prev = this.current || Storage.get("currentView", "landing");
				const targetExists = viewExists(viewId);

				// Decide the next safe view BEFORE touching classes
				const next = targetExists ? viewId
						   : (prev && viewExists(prev) ? prev
						   : (viewExists("dashboard") ? "dashboard"
						   : (viewExists("landing") ? "landing" : null)));

				if (!next){
					if (typeof showToast === "function") showToast("That page isn't available yet.");
					return; // don't remove .active if no safe target
				}

				// Prevent any programmatic navigation away while onboarding is in progress
				if (window.__onboardingLock && this.current === 'onboarding' && next !== 'onboarding') {
					console.log('Navigation blocked by onboarding lock');
					return; // stay in onboarding until user completes it
				}
				// Boot guard: during initial load/reset, suppress auto-navigation away from landing
				if (typeof window.__bootGuardUntil === 'number') {
					const now = performance.now();
					if (now < window.__bootGuardUntil && next !== 'landing') {
						console.log('Navigation blocked by boot guard');
						return; // ignore programmatic navigations during boot window
					}
				}

				console.log('Router.go called with:', viewId, 'resolved to:', next, 'from:', this.current);
				
				// Now toggle
				document.querySelectorAll("[data-view]").forEach(s=>s.classList.remove("active"));
				const el = document.querySelector(`[data-view="${next}"]`);
				if (el) el.classList.add("active");

				this.current = next;
				State.currentView = next; // Update State.currentView for tests badge
				Storage.set("currentView", next);
				persist('currentView', next); // Keep legacy storage updated
				listeners.forEach(fn=>fn(next));
				
				// Scroll to top when navigating to a new view
				window.scrollTo(0, 0);
				
				// Update tests badge visibility based on current view
				if (typeof updateTestsBadge === 'function') {
					updateTestsBadge();
				}
				
				// Update standardized footer based on current view
				setTimeout(() => {
					switch(next) {
						case 'plan':
							if (typeof updatePlanSelectionFooter === 'function') {
								updatePlanSelectionFooter();
							}
							break;
						case 'build-first-month':
							if (typeof updateCoachingFooter === 'function') {
								updateCoachingFooter();
							}
							break;
						case 'addons':
							if (typeof updateAddonsFooter === 'function') {
								updateAddonsFooter();
							}
							break;
					}
				}, 100);

				if (!targetExists && typeof showToast === "function") showToast("That page isn't available yet.");
			},
			onChange(fn){ listeners.add(fn); return ()=>listeners.delete(fn); }
		};
		function showView(id){ Router.go(id); }
		Object.assign(window,{Router,showView});
	})();
	
    // =============== PRICING SYSTEM TOGGLE ===============
    // Toggle function removed - using new pricing system only
	
	// =============== NEW PRICING MODEL (SINGLE SOURCE OF TRUTH) ===============
	// Using the MODEL defined above - no duplicate needed
	
	// ==== UTILITIES (single copy) ====
	// money function already defined above
	// paymentFees function already defined above
	const planMonthly = (planKey, annual=false) => {
		const base = MODEL.plans[planKey]?.price || 0;
		return annual ? base * (1 - MODEL.annual.discountPct/100) : base;
	};

	// ==== CANONICAL CART (single copy) ====
	window.cart = {
		planKey: 'Base',
		annual: false,
		addOns: {},          // key -> { qty, unitPrice, label }
		kitsToShip: 0        // 0 or 1 this month
	};

	// ==== PURE QUOTE ====
	function quoteNow() {
		const base = planMonthly(cart.planKey, cart.annual);
		const addOnsTotal = Object.values(cart.addOns).reduce((s, it)=> s + it.qty * it.unitPrice, 0);
		const topUps = 0; // if you later add supplement top-ups, include here
		const shipping = cart.kitsToShip ? MODEL.fees.shippingPerKit : 0;
		const todaySubtotal = base + addOnsTotal + topUps;
		const fees = paymentFees(todaySubtotal);
		const dueToday = todaySubtotal + fees + shipping;
		const dueMonthlyFromNext = planMonthly(cart.planKey, cart.annual);

		return {
			baseMonthly: base,
			addOnsTotal, topUps, fees, shipping,
			dueToday, dueMonthlyFromNext,
			breakdown: [
				`This month: ${money(dueToday)}`,
				`Next month: ${money(dueMonthlyFromNext)}`,
				`Plan: ${money(base)}/mo`,
				addOnsTotal ? `Add-ons: ${money(addOnsTotal)}` : `Add-ons: £0.00`
			]
		};
	}

	// ==== LEGACY WRAPPERS (stop "is not defined" errors) ====
	function unifiedPriceQuote(/*args*/) { return quoteNow(); }
	function applyBestDiscount(/*selectedIds, opts*/) { return quoteNow(); }

	// =============== DRIVER CHIPS & PLAYBOOK SYSTEM ===============
	
	// Driver rules and thresholds
	const DRIVER_RULES = {
		sleep: {
			name: 'Sleep',
			unit: 'h',
			thresholds: [
				{ min: 0, max: 5, impact: 4, label: 'Very Poor' },
				{ min: 5, max: 6, impact: 2, label: 'Poor' },
				{ min: 6, max: 7, impact: 1, label: 'Below Target' },
				{ min: 7, max: 9, impact: 0, label: 'Optimal' },
				{ min: 9, max: 12, impact: 1, label: 'Oversleeping' }
			]
		},
		steps: {
			name: 'Steps',
			unit: 'steps',
			thresholds: [
				{ min: 0, max: 3000, impact: 2, label: 'Low' },
				{ min: 3000, max: 5000, impact: 1, label: 'Below Target' },
				{ min: 5000, max: 8000, impact: -1, label: 'Good' },
				{ min: 8000, max: 15000, impact: -2, label: 'Excellent' }
			]
		},
		rhr: {
			name: 'RHR',
			unit: 'bpm',
			thresholds: [
				{ min: 0, max: 54, impact: -3, label: 'Athletic' },
				{ min: 54, max: 64, impact: -1, label: 'Excellent' },
				{ min: 64, max: 74, impact: 1, label: 'Good' },
				{ min: 74, max: 84, impact: 3, label: 'Elevated' },
				{ min: 84, max: 200, impact: 5, label: 'High Risk' }
			]
		},
		bmi: {
			name: 'BMI',
			unit: '',
			thresholds: [
				{ min: 0, max: 18.5, impact: 1, label: 'Underweight' },
				{ min: 18.5, max: 25, impact: 0, label: 'Healthy' },
				{ min: 25, max: 30, impact: 2, label: 'Overweight' },
				{ min: 30, max: 50, impact: 5, label: 'Obese' }
			]
		},
		waist: {
			name: 'Waist',
			unit: '',
			thresholds: [
				{ min: 0, max: 0.5, impact: 0, label: 'Healthy' },
				{ min: 0.5, max: 0.6, impact: 2, label: 'Elevated' },
				{ min: 0.6, max: 1.0, impact: 5, label: 'High Risk' }
			]
		},
		smoking: {
			name: 'Smoking',
			unit: 'cigarettes/day',
			thresholds: [
				{ min: 0, max: 0.5, impact: 0, label: 'Non-smoker' },
				{ min: 0.5, max: 5, impact: 2, label: 'Light smoker' },
				{ min: 5, max: 10, impact: 3, label: 'Moderate smoker' },
				{ min: 10, max: 20, impact: 4, label: 'Heavy smoker' },
				{ min: 20, max: 100, impact: 5, label: 'Very heavy smoker' }
			]
		},
		alcohol: {
			name: 'Alcohol',
			unit: 'units/week',
			thresholds: [
				{ min: 0, max: 14, impact: 0, label: 'Low Risk' },
				{ min: 14, max: 28, impact: 2, label: 'Moderate Risk' },
				{ min: 28, max: 100, impact: 5, label: 'High Risk' }
			]
		},
		hrv: {
			name: 'HRV',
			unit: 'ms',
			thresholds: [
				{ min: 0, max: 20, impact: 2, label: 'Poor' },
				{ min: 20, max: 30, impact: 1, label: 'Below Average' },
				{ min: 30, max: 50, impact: 0, label: 'Average' },
				{ min: 50, max: 100, impact: -1, label: 'Good' },
				{ min: 100, max: 200, impact: -2, label: 'Excellent' }
			]
		},
		moderateActivity: {
			name: 'Moderate Activity',
			unit: 'min/week',
			thresholds: [
				{ min: 0, max: 75, impact: 2, label: 'Insufficient' },
				{ min: 75, max: 150, impact: 1, label: 'Below Target' },
				{ min: 150, max: 300, impact: 0, label: 'Target' },
				{ min: 300, max: 600, impact: -1, label: 'Good' },
				{ min: 600, max: 1000, impact: -2, label: 'Excellent' }
			]
		},
		veryActive: {
			name: 'Very Active',
			unit: 'min/week',
			thresholds: [
				{ min: 0, max: 25, impact: 1, label: 'Insufficient' },
				{ min: 25, max: 75, impact: 0, label: 'Target' },
				{ min: 75, max: 150, impact: -1, label: 'Good' },
				{ min: 150, max: 300, impact: -2, label: 'Excellent' }
			]
		},
		activity: {
			name: 'Activity',
			unit: 'min/week',
			thresholds: [
				{ min: 0, max: 1, impact: 2, label: 'No Activity' },
				{ min: 1, max: 60, impact: 0, label: 'Low Activity' },
				{ min: 60, max: 150, impact: -1, label: 'Active' },
				{ min: 150, max: 1000, impact: -2, label: 'Very Active' }
			]
		}
	};

	// Playbook generation rules
	const PLAYBOOK_RULES = {
		sleep: {
			title: 'Sleep Optimization',
			actions: {
				'this-week': [
					'Set consistent bedtime within 30 minutes',
					'Remove screens 1 hour before bed',
					'Keep bedroom cool (18-20°C) and dark'
				],
				'next-month': [
					'Establish wind-down routine',
					'Consider sleep tracking device',
					'Evaluate caffeine timing (cut off by 2pm)'
				],
				'sustain': [
					'Maintain 7-9 hours nightly',
					'Regular sleep schedule even weekends',
					'Address sleep disorders if suspected'
				]
			},
			trackers: ['Sleep duration', 'Sleep quality', 'Bedtime consistency'],
			addons: ['Sleep supplement trial', 'Sleep coaching session']
		},
		steps: {
			title: 'Activity Enhancement',
			actions: {
				'this-week': [
					'Take 5-minute walking breaks every hour',
					'Park further away or get off bus one stop early',
					'Use stairs instead of elevators'
				],
				'next-month': [
					'Build daily 30-minute walk habit',
					'Try activity tracking device',
					'Join walking group or fitness class'
				],
				'sustain': [
					'Aim for 8,000+ steps daily',
					'Mix cardio and strength training',
					'Find activities you enjoy long-term'
				]
			},
			trackers: ['Daily steps', 'Active minutes', 'Exercise sessions'],
			addons: ['Fitness tracker', 'Personal training session']
		},
		rhr: {
			title: 'Heart Health',
			actions: {
				'this-week': [
					'Practice 5-minute daily breathing exercises',
					'Reduce caffeine intake',
					'Ensure adequate hydration'
				],
				'next-month': [
					'Start regular cardio exercise',
					'Manage stress with meditation',
					'Monitor heart rate during activities'
				],
				'sustain': [
					'Maintain regular exercise routine',
					'Manage chronic stress',
					'Regular cardiovascular health checks'
				]
			},
			trackers: ['Resting heart rate', 'Heart rate variability', 'Exercise intensity'],
			addons: ['Heart rate monitor', 'Cardio health assessment']
		},
		bmi: {
			title: 'Weight Management',
			actions: {
				'this-week': [
					'Track food intake for 3 days',
					'Increase vegetable portions',
					'Reduce processed foods'
				],
				'next-month': [
					'Create sustainable meal plan',
					'Start strength training',
					'Work with nutritionist if needed'
				],
				'sustain': [
					'Maintain healthy eating habits',
					'Regular physical activity',
					'Monitor weight trends monthly'
				]
			},
			trackers: ['Weight', 'Body measurements', 'Food intake'],
			addons: ['Nutrition consultation', 'Weight management program']
		},
		waist: {
			title: 'Waist Management',
			actions: {
				'this-week': [
					'Measure waist circumference',
					'Focus on core-strengthening exercises',
					'Reduce refined carbohydrates'
				],
				'next-month': [
					'Implement targeted core workouts',
					'Address stress eating patterns',
					'Consider intermittent fasting'
				],
				'sustain': [
					'Maintain healthy waist circumference',
					'Regular core and cardio exercise',
					'Monitor metabolic health markers'
				]
			},
			trackers: ['Waist circumference', 'Core strength', 'Metabolic markers'],
			addons: ['Body composition analysis', 'Metabolic health assessment']
		},
		smoking: {
			title: 'Smoking Cessation Support',
			actions: {
				'this-week': [
					'Identify smoking triggers',
					'Set quit date',
					'Remove smoking paraphernalia'
				],
				'next-month': [
					'Use nicotine replacement therapy',
					'Join support group or program',
					'Develop alternative coping strategies'
				],
				'sustain': [
					'Stay smoke-free long-term',
					'Manage cravings and triggers',
					'Regular health monitoring'
				]
			},
			trackers: ['Cigarettes per day', 'Cravings intensity', 'Lung function'],
			addons: ['Smoking cessation program', 'Lung health assessment']
		},
		alcohol: {
			title: 'Alcohol Moderation',
			actions: {
				'this-week': [
					'Track alcohol consumption',
					'Set weekly unit limits',
					'Plan alcohol-free days'
				],
				'next-month': [
					'Reduce alcohol gradually',
					'Find alternative social activities',
					'Address underlying stress/anxiety'
				],
				'sustain': [
					'Maintain low-risk drinking levels',
					'Regular alcohol-free periods',
					'Monitor liver health markers'
				]
			},
			trackers: ['Alcohol units', 'Drinking days', 'Liver function'],
			addons: ['Alcohol reduction program', 'Liver health assessment']
		},
		hrv: {
			title: 'Heart Rate Variability Optimization',
			actions: {
				'this-week': [
					'Practice deep breathing exercises',
					'Reduce caffeine intake after 2pm',
					'Ensure consistent sleep schedule'
				],
				'next-month': [
					'Incorporate meditation or mindfulness',
					'Optimize stress management techniques',
					'Consider HRV tracking device'
				],
				'sustain': [
					'Maintain regular recovery practices',
					'Monitor HRV trends over time',
					'Adjust training based on HRV data'
				]
			},
			trackers: ['HRV readings', 'Recovery score', 'Stress levels'],
			addons: ['HRV monitoring device', 'Recovery coaching session']
		},
		moderateActivity: {
			title: 'Moderate Activity Enhancement',
			actions: {
				'this-week': [
					'Take 10-minute walking breaks',
					'Use stairs instead of elevators',
					'Park further from destinations'
				],
				'next-month': [
					'Join group fitness classes',
					'Set weekly activity goals',
					'Track moderate activity minutes'
				],
				'sustain': [
					'Maintain 150+ minutes weekly',
					'Vary activity types',
					'Monitor progress regularly'
				]
			},
			trackers: ['Moderate activity minutes', 'Weekly goals', 'Activity variety'],
			addons: ['Fitness tracker', 'Group fitness classes']
		},
		veryActive: {
			title: 'High-Intensity Activity Boost',
			actions: {
				'this-week': [
					'Add 2-3 high-intensity intervals',
					'Try HIIT workouts',
					'Increase workout intensity gradually'
				],
				'next-month': [
					'Join high-intensity classes',
					'Set weekly vigorous activity goals',
					'Track heart rate zones'
				],
				'sustain': [
					'Maintain 75+ minutes weekly',
					'Balance intensity with recovery',
					'Monitor performance metrics'
				]
			},
			trackers: ['Vigorous activity minutes', 'Heart rate zones', 'Performance metrics'],
			addons: ['Heart rate monitor', 'HIIT training program']
		},
		activity: {
			title: 'Activity Enhancement',
			actions: {
				'this-week': [
					'Take 10-minute walking breaks',
					'Use stairs instead of elevators',
					'Park further away to walk more'
				],
				'next-month': [
					'Join a fitness class or group',
					'Set weekly activity goals',
					'Try new physical activities'
				],
				'sustain': [
					'Maintain 150+ minutes weekly',
					'Vary activity types',
					'Monitor progress regularly'
				]
			},
			trackers: ['Activity minutes', 'Weekly goals', 'Activity variety'],
			addons: ['Fitness tracker', 'Activity coaching session']
		}
	};

	// Calculate driver impact
	function calculateDriverImpact(driverKey, value) {
		const rule = DRIVER_RULES[driverKey];
		if (!rule) return null;

		for (const threshold of rule.thresholds) {
			if (value >= threshold.min && value < threshold.max) {
				return {
					impact: threshold.impact,
					label: threshold.label,
					value: value,
					unit: rule.unit
				};
			}
		}
		return null;
	}

	// Generate playbook for a driver
	function generatePlaybook(driverKey, currentValue, impact) {
		const rule = PLAYBOOK_RULES[driverKey];
		if (!rule) return null;

    // Normalise display value consistently with driver chips
    let displayValue = currentValue;
    if (driverKey === 'activity') {
        displayValue = Math.round(currentValue);
    } else if (typeof currentValue === 'number') {
        const r = Math.round(currentValue * 10) / 10;
        displayValue = (r % 1 === 0) ? Math.round(r) : r;
    }

		return {
			title: rule.title,
			driver: driverKey,
        currentValue: displayValue,
			impact: impact,
			actions: rule.actions,
			trackers: rule.trackers,
			addons: rule.addons
		};
	}

	// Get all driver chips for current user data using the same computeDrivers function
	function getDriverChips() {
		// Get current user data
		const age = State.user.age || 33;
		const height = State.user.height || 175;
		const weight = State.user.weight || 80;
		const waist = State.user.waist || 90;
		
		// Get wearable data
		let steps = 0;
		if (State.wearables.series.steps && State.wearables.series.steps.length > 0) {
			const last7Steps = State.wearables.series.steps.slice(-7);
			steps = last7Steps.reduce((sum, val) => sum + val, 0) / last7Steps.length;
		}
		
		let sleep = 0;
		if (State.wearables.series.sleep && State.wearables.series.sleep.length > 0) {
			const last7Sleep = State.wearables.series.sleep.slice(-7);
			sleep = last7Sleep.reduce((sum, val) => sum + val, 0) / last7Sleep.length;
		}
		
		let rhr = 0;
		if (State.wearables.series.rhr && State.wearables.series.rhr.length > 0) {
			const last7RHR = State.wearables.series.rhr.slice(-7);
			rhr = last7RHR.reduce((sum, val) => sum + val, 0) / last7RHR.length;
		}
		
		const activity = State.onboarding.answers.activityMins || 0;
		
		// Use the same computeDrivers function that calculates biological age
		const { drivers } = computeDrivers(age, height, weight, waist, steps, sleep, rhr, activity);
		console.log('Driver chips calculation:', { age, height, weight, waist, steps, sleep, rhr, activity, drivers });
		
		// Convert drivers to chips format, filtering out zero-impact drivers
		const chips = drivers
			.filter(driver => driver.value !== 0) // Only show non-zero drivers
			.map(driver => {
				// Map driver names to consistent keys and labels
				let key, label, value;
				
				switch (driver.name) {
					case 'BMI':
						key = 'bmi';
						label = 'BMI';
						value = (weight / Math.pow(height / 100, 2)).toFixed(1);
						break;
					case 'Waist-to-Height':
						key = 'waist';
						label = 'Waist-to-Height';
						value = (waist / height).toFixed(2);
						break;
					case 'Low RHR':
					case 'Good RHR':
					case 'Heart Rate':
					case 'High RHR':
					case 'Very High RHR':
						key = 'rhr';
						label = 'Heart Rate';
						value = `${Math.round(rhr)} bpm`;
						break;
					case 'Active':
					case 'Moderate Activity':
					case 'Low Steps':
						key = 'steps';
						label = 'Steps';
						value = `${Math.round(steps)} steps/day`;
						break;
					case 'Very Poor Sleep':
					case 'Poor Sleep':
					case 'Sleep':
					case 'Oversleep':
						key = 'sleep';
						label = 'Sleep';
						value = `${sleep.toFixed(1)}h`;
						break;
					case 'No Activity':
					case 'Insufficient Activity':
					case 'Below Target Activity':
					case 'Good Activity':
					case 'Excellent Activity':
					case 'Active':
					case 'Very Active':
						key = 'activity';
						label = 'Activity';
						value = `${activity} min/week`;
						break;
					case 'Smoking':
						key = 'smoking';
						label = 'Smoking';
						value = `${State.onboarding.answers.cigarettesPerDay || 0} cigarettes/day`;
						break;
					case 'Alcohol':
						key = 'alcohol';
						label = 'Alcohol';
						value = `${State.onboarding.answers.alcoholUnits || 0} units/week`;
						break;
					case 'High HRV':
					case 'Good HRV':
					case 'Very Low HRV':
					case 'Low HRV':
					case 'Poor HRV':
					case 'Below Average HRV':
					case 'Excellent HRV':
						key = 'hrv';
						label = 'HRV';
						const avgHRV = State.wearables.series.hrv ? 
							State.wearables.series.hrv.slice(-7).reduce((sum, val) => sum + val, 0) / 7 : 0;
						value = `${avgHRV.toFixed(1)} ms`;
						break;
					default:
						key = driver.name.toLowerCase().replace(/\s+/g, '-');
						label = driver.name;
						value = '';
				}
				
				return {
					key,
					label,
					value,
					impact: driver.value,
					impactLabel: driver.name
				};
			});

		// Sort by absolute impact (highest first)
		return chips.sort((a, b) => Math.abs(b.impact) - Math.abs(a.impact));
	}

	// Open driver playbook modal
	function openDriverPlaybook(driverKey) {
		const chips = getDriverChips();
		const chip = chips.find(c => c.key === driverKey);
		if (!chip) return;

		// Check if we're in onboarding mode (ob- prefix) or regular mode
		const isOnboarding = document.getElementById('ob-calc-age');

		// Get current value for the driver
		let currentValue = chip.value;
		if (driverKey === 'sleep' && State.wearables.series.sleep?.length) {
			// Use the same calculation as driver chips for consistency
			const last7Sleep = State.wearables.series.sleep.slice(-7);
			currentValue = last7Sleep.reduce((sum, val) => sum + val, 0) / last7Sleep.length;
		} else if (driverKey === 'steps' && State.wearables.series.steps?.length) {
			// Use the same calculation as driver chips for consistency
			const last7Steps = State.wearables.series.steps.slice(-7);
			currentValue = last7Steps.reduce((sum, val) => sum + val, 0) / last7Steps.length;
		} else if (driverKey === 'rhr' && State.wearables.series.rhr?.length) {
			// Use the same calculation as driver chips for consistency
			const last7RHR = State.wearables.series.rhr.slice(-7);
			currentValue = last7RHR.reduce((sum, val) => sum + val, 0) / last7RHR.length;
		} else if (driverKey === 'bmi' && State.user.height && State.user.weight) {
			// Use the same calculation as driver chips for consistency
			currentValue = State.user.weight / Math.pow(State.user.height / 100, 2);
			console.log('BMI popup calculation:', { 
				height: State.user.height, 
				weight: State.user.weight, 
				bmi: currentValue,
				impact: calculateDriverImpact('bmi', currentValue)
			});
		} else if (driverKey === 'waist') {
			currentValue = State.user.waist && State.user.height ? State.user.waist / State.user.height : 0;
		} else if (driverKey === 'smoking') {
			currentValue = State.onboarding.answers.smoker ? (State.onboarding.answers.cigarettesPerDay || 0) : 0;
		} else if (driverKey === 'alcohol') {
			currentValue = Math.round((State.onboarding.answers.alcoholUnits || 0) * 10) / 10;
		} else if (driverKey === 'hrv' && State.wearables.series.hrv?.length) {
			// Use the same calculation as driver chips for consistency
			const last7HRV = State.wearables.series.hrv.slice(-7);
			currentValue = last7HRV.reduce((sum, val) => sum + val, 0) / last7HRV.length;
			console.log('HRV popup calculation:', { currentValue, rawValue: last7HRV.reduce((sum, val) => sum + val, 0) / last7HRV.length });
		} else if (driverKey === 'hrv' && !State.wearables.series.hrv?.length) {
			// Fallback: try to parse from chip.value if no series data
			const hrvMatch = chip.value.match(/(\d+\.?\d*)/);
			currentValue = hrvMatch ? parseFloat(hrvMatch[1]) : 0;
		} else if (driverKey === 'activity') {
			// Use the same calculation as driver chips for consistency
			currentValue = State.onboarding.answers.activityMins || 0;
		}

		// For BMI, use the same logic as computeDrivers instead of calculateDriverImpact
		let impact;
		if (driverKey === 'bmi') {
			const bmi = currentValue;
			let impactValue = 0;
			if (bmi >= 25 && bmi < 30) impactValue = 2;
			else if (bmi >= 30) impactValue = 5;
			else if (bmi < 18.5) impactValue = 1;
			
			impact = {
				impact: impactValue,
				label: impactValue === 0 ? 'Healthy' : (impactValue === 1 ? 'Underweight' : (impactValue === 2 ? 'Overweight' : 'Obese')),
				value: currentValue,
				unit: ''
			};
			console.log('BMI popup impact calculation:', { bmi, impactValue, impact });
		} else {
			impact = calculateDriverImpact(driverKey, currentValue);
		}
		const playbook = generatePlaybook(driverKey, currentValue, impact);

		if (playbook) {
			// Update modal content
			updateDriverPlaybookModal(playbook);
			// Show modal
			document.getElementById('driver-playbook-modal').style.display = 'flex';
		}
	}

	// Update driver playbook modal content
	function updateDriverPlaybookModal(playbook) {
		const modal = document.getElementById('driver-playbook-modal');
		if (!modal) return;

		const title = modal.querySelector('.modal-title');
		const content = modal.querySelector('.modal-body');

		if (title) {
			title.textContent = playbook.title;
		}

		if (content) {
			const impactValue = playbook.impact ? playbook.impact.impact : 0;
			const impactColor = impactValue < 0 ? '#10b981' : '#ef4444';
			const impactSign = impactValue > 0 ? '+' : '';

			// Consistent rounding/formatting for current status and impact badge
			const unit = DRIVER_RULES[playbook.driver]?.unit || '';
			let currentVal = playbook.currentValue;
			// Numbers like 355.59999999999997 → 356; allow one decimal only if needed
			if (typeof currentVal === 'number') {
				const rounded = Math.round(currentVal * 10) / 10;
				currentVal = (rounded % 1 === 0) ? Math.round(rounded) : rounded.toFixed(1);
			}
			const impactDisplay = (impactValue % 1 === 0) ? impactValue : (Math.round(impactValue * 10) / 10).toFixed(1);
			
			content.innerHTML = `
				<div class="playbook-header">
					<div class="current-status">
						<h4>Current Status</h4>
						<div class="status-value" style="color: ${impactColor}">
							${currentVal} ${unit}
							<span class="impact-badge" style="background: ${impactColor}">
								${impactSign}${impactDisplay}y
							</span>
						</div>
					</div>
				</div>

				<div class="playbook-actions">
					<div class="action-section">
						<h4>This Week</h4>
						<ul>
							${playbook.actions['this-week'].map(action => `<li>${action}</li>`).join('')}
						</ul>
					</div>

					<div class="action-section">
						<h4>Next 4 Weeks</h4>
						<ul>
							${playbook.actions['next-month'].map(action => `<li>${action}</li>`).join('')}
						</ul>
					</div>

					<div class="action-section">
						<h4>Sustain</h4>
						<ul>
							${playbook.actions['sustain'].map(action => `<li>${action}</li>`).join('')}
						</ul>
					</div>
				</div>

				<div class="playbook-trackers">
					<h4>Track These</h4>
					<div class="tracker-chips">
						${playbook.trackers.map(tracker => `<span class="tracker-chip">${tracker}</span>`).join('')}
					</div>
				</div>

				<div class="playbook-addons">
					<h4>Recommended Add-ons</h4>
					<div class="addon-chips">
						${playbook.addons.map(addon => `<span class="addon-chip">${addon}</span>`).join('')}
					</div>
				</div>
			`;
		}
	}

	// Render driver chips for a specific container
	function renderDriverChips(containerId) {
		const container = document.getElementById(containerId);
		if (!container) return;

		const chips = getDriverChips();
		
		if (chips.length === 0) {
			container.innerHTML = '<p class="muted">No significant drivers detected. Keep up the good work!</p>';
			return;
		}

		container.innerHTML = `
			<div style="margin-bottom: 1rem; text-align: center;">
				<p style="margin: 0; color: var(--ink-60); font-size: 1.1rem; line-height: 1.4;">
					💡 <strong style="font-size: 1.2rem;">Discover your health drivers</strong><br>
					Click any factor below to see how it affects your biological age and get personalized recommendations to improve it
				</p>
			</div>
			<div class="driver-chips">
				${chips
					.filter(chip => chip.impact !== 0)
					.map(chip => {
					const impactClass = chip.impact < 0 ? 'positive' : 'negative';
					const impactSign = chip.impact > 0 ? '+' : '';
					return `
						<div class="driver-chip ${impactClass}" onclick="openDriverPlaybook('${chip.key}')" style="cursor: pointer;" title="Click to learn more about ${chip.label}">
							<span class="driver-label">${chip.label}</span>
							<span class="impact-value">${impactSign}${chip.impact}y</span>
						</div>
					`;
				}).join('')}
			</div>
		`;
	}

	// Export driver functions
	Object.assign(window, { 
		getDriverChips, 
		openDriverPlaybook, 
		calculateDriverImpact, 
		generatePlaybook,
		renderDriverChips,
		DRIVER_RULES,
		PLAYBOOK_RULES
	});

		// Export for inline handlers
	Object.assign(window, { 
		money, paymentFees, calcPlanMonthly, addonsSubtotal, shippingThisMonth, quote,
		HS, commit, selectPlanTier, updatePlanSummary, renderTierGrid,
		toggleUseLabLater, selectLab, selectSupplement, selectCoaching, updateAddonQty, updateAddonsSummary, renderAddonsPage,
		MODEL, cart, selectPlan, toggleAnnual, setAddonQty, setKitsToShip, refreshPlanSummary, testPlanRendering,
		updateActivePlanDisplay, togglePlanEditMode, setPlanAppropriateRecommendations
	});

	// Debug function to test plan rendering
	function testPlanRendering() {
		console.log('=== PLAN RENDERING TEST ===');
		console.log('MODEL exists:', !!MODEL);
		console.log('MODEL.plans exists:', !!MODEL?.plans);
		console.log('MODEL.plans keys:', MODEL?.plans ? Object.keys(MODEL.plans) : 'N/A');
		console.log('HS exists:', !!HS);
		console.log('HS.plan exists:', !!HS?.plan);
		console.log('HS.plan.tier:', HS?.plan?.tier);
		console.log('new-tier-grid element exists:', !!document.getElementById('new-tier-grid'));
		console.log('========================');
	}

	// ==== NEW PLAN UI FUNCTIONS ====
	function selectPlan(k){
		if (!MODEL.plans[k]) return;
		// Delegate to the unified selector so state and UI stay in sync
		selectPlanTier(k);
	}
	function toggleAnnual(cb){
		cart.annual = !!cb.checked;
		refreshPlanSummary();
	}
	function setAddonQty(key, label, unitPrice, delta){
		const entry = cart.addOns[key] || { qty:0, unitPrice, label };
		entry.qty = Math.max(0, (entry.qty||0) + delta);
		if (entry.qty === 0) delete cart.addOns[key]; else cart.addOns[key] = entry;
		refreshPlanSummary();
	}
	function setKitsToShip(on){ cart.kitsToShip = on ? 1 : 0; refreshPlanSummary(); }

	function refreshPlanSummary(){
		const q = quoteNow();
		const host = document.getElementById('plan-summary');
		if (host){
			const todayEl = host.querySelector('[data-today]');
			const nextEl = host.querySelector('[data-next]');
			const breakdownEl = host.querySelector('[data-breakdown]');
			if (todayEl) todayEl.textContent = money(q.dueToday);
			if (nextEl) nextEl.textContent = money(q.dueMonthlyFromNext);
			if (breakdownEl) breakdownEl.textContent = q.breakdown.join(' · ');
		}
	}

	function renderTierGrid(){
		const grid = document.getElementById('new-tier-grid');
		if (!grid) {
			console.error('new-tier-grid element not found');
			return;
		}
		
		if (!MODEL || !MODEL.plans) {
			console.error('MODEL or MODEL.plans not found');
			return;
		}
		
		console.log('Rendering plan tiers:', Object.keys(MODEL.plans));
		
		// Determine if the user has an active subscription
		const hasActiveSubscription = State.subscription?.active && State.subscription?.status === 'active';
		
		grid.innerHTML = Object.entries(MODEL.plans).map(([tier, plan]) => {
			const isSelected = State.plan.tier === tier;
			const isActiveSubscriptionTier = hasActiveSubscription && (State.subscription?.tier === tier);
			
			// Decide button label and disabled state based on context
			let buttonLabel = 'Choose Plan';
			let buttonDisabled = '';
		let buttonClass = 'btn-secondary';
		
			if (isActiveSubscriptionTier && !HS.editMode) {
				buttonLabel = '✓ Current Plan';
				buttonDisabled = 'disabled';
			buttonClass = 'btn-primary';
			} else if (isActiveSubscriptionTier && HS.editMode) {
			buttonLabel = isSelected ? '✓ New Selection' : 'Choose Plan';
				buttonDisabled = isSelected ? 'disabled' : '';
			buttonClass = isSelected ? 'btn-primary' : 'btn-secondary';
			} else if (isSelected) {
				buttonLabel = '✓ Selected Plan';
				buttonDisabled = 'disabled';
			buttonClass = 'btn-primary';
		} else {
			buttonLabel = 'Choose Plan';
			buttonDisabled = '';
			buttonClass = 'btn-secondary';
			}
			
			return `
				<div class="tier plan-card ${isSelected ? 'active' : ''}" data-key="${tier}" onclick="${buttonDisabled ? '' : `selectPlanTier('${tier}')`}">
					<h4>${tier}</h4>
					<div class="price">
						<div class="monthly">${money(plan.price)}/mo</div>
					</div>
					<ul>
						<li><strong>Lab credits:</strong> ${plan.labCreditsPerYear} per year</li>
						<li><strong>Supplements:</strong> ${plan.supplementQuantityPerMonth} supplement${plan.supplementQuantityPerMonth > 1 ? 's' : ''} per month</li>
						<li><strong>Coaching:</strong> ${plan.coachingMinutesPerMonth} min 1:1 per month</li>
						<li><strong>GP access:</strong> ${plan.gpConsultsPerYear} consults per year</li>
					</ul>
					<button class="btn ${buttonClass}" ${buttonDisabled}>
						${buttonLabel}
					</button>
				</div>
			`;
		}).join('');
	}

	function updateActivePlanDisplay() {
		const activeDisplay = document.getElementById('active-plan-display');
		const activeSubscriptionDisplay = document.getElementById('active-subscription-display');
		const planName = document.getElementById('active-plan-name');
		const planDetails = document.getElementById('active-plan-details');
		const planPrice = document.getElementById('active-plan-price');
		const activePlanDetails = document.getElementById('active-plan-details');
		
		// Check if user has an active subscription
		const hasActiveSubscription = State.subscription?.active && State.subscription?.status === 'active';
		const currentPlanTier = State.plan.tier || State.subscription?.tier;
		
		// Update the edit mode button text based on current state
		const updateBtn = document.querySelector('button[onclick="togglePlanEditMode()"]');
		if (updateBtn) {
			updateBtn.textContent = HS.editMode ? 'Cancel' : 'Update Plan';
			updateBtn.className = HS.editMode ? 'btn btn-secondary btn-small' : 'btn btn-secondary btn-small';
		}
		
		if (hasActiveSubscription && currentPlanTier && MODEL.plans[currentPlanTier]) {
			const plan = MODEL.plans[currentPlanTier];
			
			// Get billing cycle and calculate appropriate price
			const billingCycle = State.subscription?.billingCycle || State.plan.billingCycle || 'monthly';
			const isAnnual = billingCycle === 'annual';
			const displayPrice = isAnnual ? plan.price * 12 * 0.9 : plan.price; // 10% discount for annual
			const priceLabel = isAnnual ? '/year' : '/month';
			
			// Show active subscription display on plan page
			if (activeSubscriptionDisplay) {
				activeSubscriptionDisplay.style.display = 'block';
				if (activePlanDetails) {
					activePlanDetails.innerHTML = `
						<div>
							<strong>${currentPlanTier} Plan</strong><br>
							<span style="color:var(--ink-60); font-size:0.9rem">${money(displayPrice)}${priceLabel}</span>
							${isAnnual ? '<br><span style="color:var(--numan-teal); font-size:0.8rem; font-weight:600">Annual billing (10% OFF)</span>' : ''}
						</div>
						<div>
							<strong>${plan.labCreditsPerYear} lab credits</strong><br>
							<span style="color:var(--ink-60); font-size:0.9rem">per year</span>
						</div>
						<div>
							<strong>${Math.min(plan.labCreditsPerYear, 3)} supplement${Math.min(plan.labCreditsPerYear, 3) > 1 ? 's' : ''}</strong><br>
							<span style="color:var(--ink-60); font-size:0.9rem">per month</span>
						</div>
						<div>
							<strong>${plan.coachingMinutesPerMonth} min coaching</strong><br>
							<span style="color:var(--ink-60); font-size:0.9rem">per month</span>
						</div>
						<div>
							<strong>${plan.gpConsultsPerYear} GP consults</strong><br>
							<span style="color:var(--ink-60); font-size:0.9rem">per year</span>
						</div>
					`;
				}
			}
			
			// Legacy active display (if it exists)
			if (activeDisplay && planName && planDetails && planPrice) {
				activeDisplay.style.display = 'block';
				planName.textContent = currentPlanTier;
				planDetails.innerHTML = `
					${plan.labCreditsPerYear} lab credits/year • ${plan.supplementQuantityPerMonth} supplement${plan.supplementQuantityPerMonth > 1 ? 's' : ''}/month<br>
					${plan.coachingMinutesPerMonth} min coaching/month • ${plan.gpConsultsPerYear} GP consults/year
				`;
				planPrice.textContent = `${money(displayPrice)}${priceLabel}`;
			}
		} else {
			// Hide active subscription displays
			if (activeSubscriptionDisplay) {
				activeSubscriptionDisplay.style.display = 'none';
			}
			if (activeDisplay) {
				activeDisplay.style.display = 'none';
			}
		}
	}

	function togglePlanEditMode() {
		HS.editMode = !HS.editMode;
		commit();
		
		// Update plan state after toggling edit mode
		updatePlanState();
		
		// Re-render the plan page to show the correct state
		renderPlan();
		
		showToast(HS.editMode ? 'Edit mode enabled - select a new plan' : 'Edit mode disabled');
	}
	
	// New pricing system functions
	function selectPlanTier(tier) {
		// Update plan state first
		updatePlanState();
		
		// Check if user has an active subscription and is not in edit mode
		if (State.planState.hasActiveSubscription && !State.planState.isEditingPlan) {
			showToast('You have an active subscription. Click "Update Plan" to modify your plan.');
			return;
		}
		
		State.plan.tier = tier;
		HS.plan.tier = tier; // Sync with HS state
		console.log('Plan selected:', { tier, statePlanTier: State.plan.tier, hsPlanTier: HS.plan.tier });
		save({'plan.tier': State.plan.tier});
		commit(); // Save HS state
		
		// Update plan state after selection
		updatePlanState();
		
		// Re-render the plan grid so the selected card gets the visual state
		renderNewTierGrid();
		// Ensure all plan cards reflect the selection highlight
		document.querySelectorAll('.plan-card').forEach(card=>{
			card.classList.toggle('selected', card.dataset.key===tier);
			card.classList.toggle('active', card.dataset.key===tier);
		});
		updatePlanSummary();
		// Update standardized footer for plan selection page
		if (State.currentView === 'plan') {
			updatePlanSelectionFooter();
		}
		// Update build first month page if we're on it
		if (State.currentView === 'build-first-month') {
			renderBuildFirstMonthPage();
			renderStandardizedCheckoutFooter('coaching');
		}
		showToast(`${tier} plan selected`);
	}

	function updatePlanSummary() {
		const summary = document.getElementById('plan-summary');
		if (!summary) return;
		
		// Update billing toggle state
		const billingToggle = document.getElementById('billing-toggle');
		if (billingToggle) {
			billingToggle.checked = State.plan.billingCycle === 'annual';
		}
		
		// Calculate plan pricing based on billing cycle
		const plan = MODEL.plans[State.plan.tier];
		if (!plan) return;
		
		const isAnnual = State.plan.billingCycle === 'annual';
		const planPrice = isAnnual ? calcPlanMonthly(State.plan.tier, true) : plan.price;
		
		// Calculate add-ons total
		const addOnsTotal = (State.plan.selectedAddOns || []).reduce((total, addOnId) => {
			for (const category of Object.values(MODEL.memberAddOns)) {
				for (const addon of Object.values(category)) {
					if (addon.id === addOnId) {
						return total + addon.price;
					}
				}
			}
			return total;
		}, 0);
		
		// Today's price includes plan + add-ons (no fees/shipping as they're included)
		const todayPrice = planPrice + addOnsTotal;
		// Next month is just the plan price (add-ons are one-time)
		const nextMonthPrice = planPrice;
		
		// Render standardized checkout footer content into summary container
		const planName = State.plan.tier ? `${State.plan.tier[0].toUpperCase()}${State.plan.tier.slice(1)} Plan` : 'Select a plan';
		summary.innerHTML = `
			<div class="checkout-footer">
				<div class="footer-inner">
					<div class="section-left">
						<div class="plan-title">${planName}</div>
						<div class="plan-meta">Billing: ${State.plan.billingCycle}</div>
					</div>
					<div class="pricing">
						<div class="row"><span class="label">Today</span><span class="value">${money(todayPrice)}</span></div>
						<div class="row"><span class="label">Ongoing</span><span class="value">${money(nextMonthPrice)}/mo</span></div>
				</div>
					<div class="actions">
						<button class="btn btn-secondary" id="back-to-dashboard-btn" style="display:${(State.subscription?.active && State.subscription?.status==='active') ? 'block' : 'none'}">Back to dashboard</button>
						<button class="checkout-cta" id="plan-continue-btn" ${!State.plan.tier ? 'disabled' : ''} onclick="handleBuildFirstMonthClick()">Continue</button>
					</div>
				</div>
			</div>`;
	}

	// Addons interstitial functions
	function toggleUseLabLater(checkbox) {
		console.log('toggleUseLabLater called:', {
			checkboxChecked: checkbox.checked,
			previousUseLabLater: HS.firstMonth.useLabLater,
			planTier: HS.plan.tier,
			userCredits: HS.plan.tier ? MODEL.plans[HS.plan.tier].labCreditsPerYear : 'no plan'
		});
		
		HS.firstMonth.useLabLater = checkbox.checked;
		
		// If toggling "Use lab credit later" ON, clear all selected lab kits
		if (checkbox.checked) {
			HS.firstMonth.labs = [];
			console.log('Use lab credit later toggled ON - cleared all selected lab kits');
		}
		
		commit();
		updateAddonsSummary();
		
		// Re-render the build first month page to update lab selections
		if (State.currentView === 'build-first-month') {
			renderBuildFirstMonthPage();
		}
		
		// Update lab selection to reflect the new disabled state
		updateLabSelection();
		
		const labSelection = document.getElementById('lab-selection');
		if (labSelection) {
			// Remove container-level opacity - let individual lab options handle their own styling
			labSelection.style.opacity = '1';
			labSelection.style.pointerEvents = 'auto';
		}
	}

	function clearAllLabSelections() {
		console.log('clearAllLabSelections called');
		
		// Clear all lab selections
		HS.firstMonth.labs = [];
		
		// Also clear supplements and coaching to ensure clean slate
		HS.firstMonth.supplements = [];
		HS.firstMonth.coaching = null;
		
		// Sync to State.plan.firstMonthPicks for checkout
		if (!State.plan.firstMonthPicks) {
			State.plan.firstMonthPicks = { labs: [], supplements: [], coaching: null };
		}
		State.plan.firstMonthPicks.labs = [];
		State.plan.firstMonthPicks.supplements = [];
		State.plan.firstMonthPicks.coaching = null;
		save({'plan.firstMonthPicks': State.plan.firstMonthPicks});
		
		commit();
		
		// Re-render the lab selection to update the UI
		renderBuildFirstMonthPage();
		
		// Show toast notification
		showToast('All lab selections cleared');
	}

	function selectLab(labId) {
		if (HS.firstMonth.useLabLater) return;
		
		// Initialize labs array if it doesn't exist
		if (!HS.firstMonth.labs) {
			HS.firstMonth.labs = [];
		}
		
		// Get plan and lab details
		const plan = MODEL.plans[HS.plan.tier];
		const lab = MODEL.catalog.labs.find(l => l.id === labId);
		if (!lab) return;
		
		// Calculate current credit usage
		const currentCreditsUsed = HS.firstMonth.labs.reduce((total, id) => {
			const selectedLab = MODEL.catalog.labs.find(l => l.id === id);
			return total + (selectedLab ? selectedLab.credits : 0);
		}, 0);
		
		// Check if lab is already selected
		const isSelected = HS.firstMonth.labs.includes(labId);
		
		if (isSelected) {
			// Remove from selection
			HS.firstMonth.labs = HS.firstMonth.labs.filter(id => id !== labId);
		} else {
			// Add to selection if we have enough credits
			if (currentCreditsUsed + lab.credits <= plan.labCreditsPerYear) {
				HS.firstMonth.labs.push(labId);
			} else {
				showToast(`Not enough credits. You have ${plan.labCreditsPerYear - currentCreditsUsed} credits remaining.`);
				return;
			}
		}
		
		// Maintain backward compatibility - set the first lab as the primary lab
		HS.firstMonth.lab = HS.firstMonth.labs.length > 0 ? HS.firstMonth.labs[0] : null;
		
		// Sync to State.plan.firstMonthPicks for checkout
		if (!State.plan.firstMonthPicks) {
			State.plan.firstMonthPicks = { labs: [], supplements: [], coaching: null };
		}
		State.plan.firstMonthPicks.labs = [...HS.firstMonth.labs];
		save({'plan.firstMonthPicks': State.plan.firstMonthPicks});
		
		console.log('🔧 selectLab - Updated State.plan.firstMonthPicks:', {
			hsFirstMonth: HS.firstMonth,
			stateFirstMonthPicks: State.plan.firstMonthPicks,
			labId: labId
		});
		
		commit();
		updateAddonsSummary();
		// Update standardized footer for addons page
		if (State.currentView === 'addons') {
			updateAddonsFooter();
		}
		updateLabSelection();
		
		// Update checkout summary if we're on checkout page
		if (State.currentView === 'checkout') {
			loadCheckoutSummary();
		}
	}

	function updateLabSelection() {
		const plan = MODEL.plans[HS.plan.tier];
		const userCredits = plan.labCreditsPerYear;
		
		// Calculate current credit usage
		const currentCreditsUsed = (HS.firstMonth.labs || []).reduce((total, id) => {
			const selectedLab = MODEL.catalog.labs.find(l => l.id === id);
			return total + (selectedLab ? selectedLab.credits : 0);
		}, 0);
		
		// Update the main credit counter display
		const creditsRemaining = Math.max(0, userCredits - currentCreditsUsed);
		const creditCounter = document.querySelector('.lab-credit-counter');
		if (creditCounter) {
			creditCounter.innerHTML = `
				<strong>${creditsRemaining} of ${userCredits} credits remaining</strong>
				${currentCreditsUsed > 0 ? `<br><small>Selected: ${currentCreditsUsed} credits used</small>` : ''}
			`;
		}
		
		
		
		// Update visual selection
		document.querySelectorAll('.lab-option').forEach(el => {
			const labId = el.dataset.lab;
			const lab = MODEL.catalog.labs.find(l => l.id === labId);
			if (!lab) return;
			
			const isSelected = (HS.firstMonth.labs || []).includes(labId);
			const canAfford = userCredits >= lab.credits;
			const creditsRemaining = Math.max(0, userCredits - currentCreditsUsed);
			
			// Calculate if we can afford this lab:
			// 1. If already selected, we can always deselect it (never disabled)
			// 2. If not selected, disable if either:
			//    - Lab costs more than total available credits, OR
			//    - User has chosen to use lab credit later
			const labTooExpensive = lab.credits > userCredits;
			const useLabLater = HS.firstMonth.useLabLater;
			
			// Only disable if the user has explicitly chosen to use lab credits later
			// AND they haven't already selected any labs
			const shouldDisableForUseLabLater = useLabLater && HS.firstMonth.labs.length === 0;
			
			// A lab should only be disabled if:
			// 1. It costs more than the total available credits (e.g., 2-credit lab with only 1 credit plan)
			// 2. User has chosen to use lab credit later and hasn't selected any labs yet
			// We should NOT disable based on remaining credits - let the selection logic handle limits
			const isDisabled = labTooExpensive || shouldDisableForUseLabLater;
			
			el.classList.toggle('selected', isSelected);
			el.classList.toggle('disabled', isDisabled);
            // Only apply opacity styling if the element doesn't already have inline opacity set from rendering
            // This prevents overriding the correct styling from the HTML generation
            if (!el.style.opacity || el.style.opacity === '') {
                el.style.opacity = isSelected ? '1' : (isDisabled ? '0.5' : '1');
            }
			el.style.pointerEvents = isDisabled ? 'none' : 'auto';
			// Ensure click handler reflects current enabled/disabled state
			el.onclick = isDisabled ? null : (() => selectLab(lab.id));
			
			// Update the credits remaining display
			const creditsInfo = el.querySelector('.credits-remaining');
			if (creditsInfo) {
				creditsInfo.textContent = `${Math.max(0, creditsRemaining)} credits remaining`;
			}
		});
	}

	function selectSupplement(suppId) {
		const plan = MODEL.plans[HS.plan.tier];
		// Use lab credits to determine max supplements (capped at 3)
		const maxSupplements = Math.min(plan.labCreditsPerYear, 3);
		
		// Check if already selected
		const isSelected = HS.firstMonth.supplements.includes(suppId);
		
		if (isSelected) {
			// Remove from selection
			HS.firstMonth.supplements = HS.firstMonth.supplements.filter(id => id !== suppId);
		} else {
			// Add to selection if under limit
			if (HS.firstMonth.supplements.length < maxSupplements) {
				HS.firstMonth.supplements.push(suppId);
			} else {
				showToast(`You can only select ${maxSupplements} supplement${maxSupplements > 1 ? 's' : ''} per month (based on your ${plan.labCreditsPerYear} lab credit${plan.labCreditsPerYear > 1 ? 's' : ''})`);
				return;
			}
		}
		
		// Sync to State.plan.firstMonthPicks for checkout
		if (!State.plan.firstMonthPicks) {
			State.plan.firstMonthPicks = { labs: [], supplements: [], coaching: null };
		}
		State.plan.firstMonthPicks.supplements = [...HS.firstMonth.supplements];
		save({'plan.firstMonthPicks': State.plan.firstMonthPicks});
		
		console.log('🔧 selectSupplement - Updated State.plan.firstMonthPicks:', {
			hsFirstMonth: HS.firstMonth,
			stateFirstMonthPicks: State.plan.firstMonthPicks,
			supplementId: suppId,
			timestamp: Date.now()
		});
		
		commit();
		updateAddonsSummary();
		// Update standardized footer for addons page
		if (State.currentView === 'addons') {
			updateAddonsFooter();
		}
		updateSupplementSelection();
		
		// Update checkout summary if we're on checkout page
		if (State.currentView === 'checkout') {
			loadCheckoutSummary();
		}
	}

	function updateSupplementSelection() {
		const plan = MODEL.plans[HS.plan.tier];
		// Use the plan's supplement allowance per month
		const maxSupplements = plan.supplementQuantityPerMonth;
		
		console.log('Updating supplement selection:', {
			planTier: HS.plan.tier,
			maxSupplements,
			selectedCount: HS.firstMonth.supplements.length,
			selectedSupplements: HS.firstMonth.supplements
		});
		
		// Update visual selection
		document.querySelectorAll('.supplement-option').forEach(el => {
			const suppId = el.dataset.supp;
			const isSelected = HS.firstMonth.supplements.includes(suppId);
			// Only disable if allowance is reached (not when nothing is selected)
			const isDisabled = !isSelected && HS.firstMonth.supplements.length >= maxSupplements;
			
			el.classList.toggle('selected', isSelected);
			el.classList.toggle('disabled', isDisabled);
            // Binary state only: disabled => greyed, otherwise normal
			el.style.opacity = isDisabled ? '0.5' : '1';
			el.style.pointerEvents = isDisabled ? 'none' : 'auto';
			
			// Update the "Available"/"Selected" text
			const includedDiv = el.querySelector('.included');
			if (includedDiv) {
				includedDiv.textContent = isSelected ? 'Selected' : 'Available';
			}
		});
	}

	function updateCoachingSelection() {
		// Update visual selection for coaching options
		const hasSelectedCoaching = HS.firstMonth.coaching !== null && HS.firstMonth.coaching !== undefined;
		
		document.querySelectorAll('.coaching-option').forEach(el => {
			const coachId = el.dataset.coach;
			const isSelected = HS.firstMonth.coaching === coachId;
			
			el.classList.toggle('selected', isSelected);
			
			// Grey out unselected options when one is selected, but keep them clickable
			if (hasSelectedCoaching && !isSelected) {
				el.classList.add('disabled');
			} else {
				el.classList.remove('disabled');
			}
			
			// Update the "Available"/"Selected" text
			const includedDiv = el.querySelector('.included');
			if (includedDiv) {
				includedDiv.textContent = isSelected ? 'Selected' : 'Available';
			}
		});
	}
	
	function getRecommendedLabs(planTier, user) {
		// Get recommended labs based on plan tier and user profile
		const plan = MODEL.plans[planTier];
		if (!plan) return [];
		
		const recommendedLabs = [];
		
		// Base recommendations by plan tier
		if (planTier === 'Premium') {
			// Premium: Multiple labs (up to 4 credits)
			recommendedLabs.push('complete-20', 'metabolic-health', 'core-blood');
		} else if (planTier === 'Standard') {
			// Standard: 2 labs (up to 2 credits)
			recommendedLabs.push('complete-20', 'metabolic-health');
		} else {
			// Base: 1 lab (up to 2 credits)
			recommendedLabs.push('complete-20');
		}
		
		// Add gender-specific recommendations
		if (user && user.sex === 'female') {
			// Add female-specific labs if they fit within credit budget
			const totalCredits = plan.labCreditsPerYear;
			const currentCredits = recommendedLabs.reduce((total, labId) => {
				const lab = MODEL.catalog.labs.find(l => l.id === labId);
				return total + (lab ? lab.credits : 0);
			}, 0);
			
			// Add female hormone panel if credits allow
			if (currentCredits + 1 <= totalCredits && !recommendedLabs.includes('female-hormone-panel')) {
				recommendedLabs.push('female-hormone-panel');
			}
		}
		
		return recommendedLabs;
	}

	function setPlanAppropriateRecommendations(planTier) {
		const plan = MODEL.plans[planTier];
		if (!plan) return;
		
		console.log('Setting recommendations for plan tier:', planTier, 'with limits:', {
			labCredits: plan.labCreditsPerYear,
			supplements: plan.supplementQuantityPerMonth,
			coaching: plan.coachingMinutesPerMonth
		});
		
		// Set lab recommendations based on plan tier
		if (planTier === 'Premium') {
			// Premium: Multiple labs (up to 4 credits)
			HS.firstMonth.labs = ['complete-20', 'metabolic-health', 'core-blood'];
			HS.firstMonth.lab = 'complete-20'; // Backward compatibility
		} else if (planTier === 'Standard') {
			// Standard: 2 labs (up to 2 credits)
			HS.firstMonth.labs = ['complete-20', 'metabolic-health'];
			HS.firstMonth.lab = 'complete-20'; // Backward compatibility
		} else {
			// Base: 1 lab (up to 2 credits)
			HS.firstMonth.labs = ['complete-20'];
			HS.firstMonth.lab = 'complete-20'; // Backward compatibility
		}
		
		// Set supplement recommendations based on plan tier
		if (planTier === 'Premium') {
			// Premium: 3 supplements
			HS.firstMonth.supplements = ['multivitamin', 'omega3', 'sleep-support'];
		} else if (planTier === 'Standard') {
			// Standard: 2 supplements
			HS.firstMonth.supplements = ['multivitamin', 'omega3'];
		} else {
			// Base: 1 supplement
			HS.firstMonth.supplements = ['multivitamin'];
		}
		
		// Set coaching recommendation based on plan tier
		if (planTier === 'Premium') {
			// Premium: Advanced coaching
			HS.firstMonth.coaching = 'weight_metabolic_fitness';
		} else if (planTier === 'Standard') {
			// Standard: Balanced coaching
			HS.firstMonth.coaching = 'nutrition_habit_change';
		} else {
			// Base: Basic coaching
			HS.firstMonth.coaching = 'general_mens_health';
		}
		
		// Sync to State.plan.firstMonthPicks for checkout consistency
		if (!State.plan.firstMonthPicks) {
			State.plan.firstMonthPicks = { labs: [], supplements: [], coaching: null };
		}
		State.plan.firstMonthPicks.labs = [...HS.firstMonth.labs];
		State.plan.firstMonthPicks.supplements = [...HS.firstMonth.supplements];
		State.plan.firstMonthPicks.coaching = HS.firstMonth.coaching;
		save({'plan.firstMonthPicks': State.plan.firstMonthPicks});
		
		commit();
		
		console.log('Plan-appropriate recommendations set:', {
			labs: HS.firstMonth.labs,
			supplements: HS.firstMonth.supplements,
			coaching: HS.firstMonth.coaching
		});
	}

	function selectCoaching(coachId) {
		HS.firstMonth.coaching = coachId;
		
		// Sync to State.plan.firstMonthPicks for checkout
		if (!State.plan.firstMonthPicks) {
			State.plan.firstMonthPicks = { labs: [], supplements: [], coaching: null };
		}
		State.plan.firstMonthPicks.coaching = coachId;
		save({'plan.firstMonthPicks': State.plan.firstMonthPicks});
		
		console.log('🔧 selectCoaching - Updated State.plan.firstMonthPicks:', {
			hsFirstMonth: HS.firstMonth,
			stateFirstMonthPicks: State.plan.firstMonthPicks,
			coachId: coachId
		});
		
		commit();
		updateAddonsSummary();
		// Update standardized footer for addons page
		if (State.currentView === 'addons') {
			updateAddonsFooter();
		}
		
		// Update visual selection
		updateCoachingSelection();
		
		// Update checkout summary if we're on checkout page
		if (State.currentView === 'checkout') {
			loadCheckoutSummary();
		}
	}

	function updateAddonQty(addonId, delta) {
		const currentQty = HS.addons[addonId] || 0;
		const newQty = Math.max(0, currentQty + delta);
		
		if (newQty === 0) {
			delete HS.addons[addonId];
		} else {
			HS.addons[addonId] = newQty;
		}
		
		commit();
		updateAddonsSummary();
		// Update standardized footer for addons page
		if (State.currentView === 'addons') {
			updateAddonsFooter();
		}
		
		// Update stepper display and visual state
		const qtyEl = document.getElementById(`qty-${addonId}`);
		const stepperEl = document.querySelector(`[data-addon="${addonId}"]`);
		
		if (qtyEl) {
			qtyEl.textContent = newQty;
			qtyEl.classList.toggle('selected', newQty > 0);
		}
		
		if (stepperEl) {
			stepperEl.classList.toggle('selected', newQty > 0);
			
			// Update or add/remove selected badge
			const addonInfo = stepperEl.querySelector('.addon-info');
			const existingBadge = addonInfo.querySelector('.selected-badge');
			
			if (newQty > 0 && !existingBadge) {
				const badge = document.createElement('div');
				badge.className = 'selected-badge';
				badge.textContent = 'Selected';
				addonInfo.appendChild(badge);
			} else if (newQty === 0 && existingBadge) {
				existingBadge.remove();
			}
		}
	}

	function updateAddonsSummary() {
		const summary = document.getElementById('addons-summary');
		if (!summary) return;
		
		const q = quote(HS.plan.tier);
		summary.innerHTML = `
			<div class="pricing-card">
				<div class="pricing-row">
					<span class="pricing-label">Plan (${HS.plan.tier})</span>
					<span class="pricing-value">${money(q.base)}/mo</span>
				</div>
				${q.addOns > 0 ? `
					<div class="pricing-row">
						<span class="pricing-label">Add-ons</span>
						<span class="pricing-value">${money(q.addOns)}</span>
					</div>
				` : ''}
				<div class="pricing-row">
                    <span class="pricing-label" style="text-decoration: line-through; color: #9ca3af;">Fees</span>
					<span class="pricing-value" style="text-decoration: line-through; color: #9ca3af;">${money(q.fees)}</span>
				</div>
				${q.ship > 0 ? `
					<div class="pricing-row">
						<span class="pricing-label" style="text-decoration: line-through; color: #9ca3af;">Shipping</span>
						<span class="pricing-value" style="text-decoration: line-through; color: #9ca3af;">${money(q.ship)}</span>
					</div>
				` : ''}
				<div class="pricing-row" style="padding:0.5rem; background:var(--mint-50); border-radius:6px; font-size:0.9rem; color:var(--numan-teal); margin:0.5rem 0;">
					<span class="pricing-label">Fees & shipping included with subscription</span>
				</div>
				<div class="pricing-row">
					<span class="pricing-label">Total today</span>
					<span class="pricing-total">${money(q.base + q.addOns)}</span>
				</div>
			</div>
		`;
	}

	function updateBuildFirstMonthSummary() {
		const summary = document.getElementById('build-first-month-summary');
		if (!summary) return;
		
		// Use State.plan.tier as the source of truth, fallback to HS.plan.tier
		const currentPlanTier = State.plan.tier || HS.plan.tier;
		if (!currentPlanTier) {
			console.error('No plan tier found in State.plan.tier or HS.plan.tier');
			return;
		}
		
		const q = quote(currentPlanTier);
		summary.innerHTML = `
			<div class="pricing-card">
				<div class="pricing-row">
					<span class="pricing-label">Plan (${currentPlanTier})</span>
					<span class="pricing-value">${money(q.base)}/mo</span>
				</div>
				<div class="pricing-row">
					<span class="pricing-label">Total today</span>
					<span class="pricing-total">${money(q.base)}</span>
				</div>
			</div>
		`;
	}

	// =============== STANDARDIZED CHECKOUT FOOTER FUNCTIONS ===============
	
	/**
	 * Renders standardized checkout footer with three-section layout
	 * @param {string} pageType - Type of page: 'plan', 'coaching', 'addons'
	 * @param {Object} data - Page-specific data for footer content
	 */
	function renderStandardizedCheckoutFooter(pageType, data = {}) {
		const footerHTML = generateCheckoutFooterHTML(pageType, data);
		
		// Find existing footer and replace with standardized version
		const existingFooter = document.querySelector(`section[data-view="${pageType === 'coaching' ? 'build-first-month' : pageType}"] .plan-summary`);
		if (existingFooter) {
			existingFooter.outerHTML = footerHTML;
		}
		
		// Also update any summary containers that might exist
		const summaryContainers = {
			'plan': 'plan-selection-summary',
			'coaching': 'build-first-month-summary', 
			'addons': 'addons-summary'
		};
		
		const summaryId = summaryContainers[pageType];
		if (summaryId) {
			const summaryElement = document.getElementById(summaryId);
			if (summaryElement) {
				// Clear existing content and add standardized footer
				const parentElement = summaryElement.closest('.plan-summary');
				if (parentElement) {
					parentElement.outerHTML = footerHTML;
				}
			}
		}
	}
	
	/**
	 * Generates HTML for standardized checkout footer based on page type
	 */
	function generateCheckoutFooterHTML(pageType, data) {
		const currentPlanTier = State.plan.tier || HS.plan.tier || null;
		const plan = currentPlanTier ? MODEL.plans[currentPlanTier] : null;
		const isAnnual = State.plan.billingCycle === 'annual';
		const planPrice = isAnnual ? calcPlanMonthly(currentPlanTier, true) : (plan?.price || 0);
		
		let leftSection, centerSection, rightSection;
		
		switch (pageType) {
			case 'plan':
				leftSection = generatePlanSelectionLeftSection(currentPlanTier, plan, isAnnual);
				centerSection = generatePlanSelectionCenterSection(planPrice, isAnnual);
				rightSection = generatePlanSelectionRightSection();
				break;
				
			case 'coaching':
				leftSection = generateCoachingLeftSection(currentPlanTier, plan, data);
				centerSection = generateCoachingCenterSection(planPrice, data);
				rightSection = generateCoachingRightSection();
				break;
				
			case 'addons':
				leftSection = generateAddonsLeftSection(currentPlanTier, plan);
				centerSection = generateAddonsCenterSection(planPrice, data);
				rightSection = generateAddonsRightSection();
				break;
				
			default:
				return '';
		}
		
		return `
			<div class="checkout-footer">
				<div class="footer-inner">
					<div class="section-left">
						${leftSection}
					</div>
					<div class="pricing">
						${centerSection}
					</div>
					<div class="actions">
						${rightSection}
					</div>
				</div>
			</div>
		`;
	}
	
	/**
	 * Plan Selection Page Footer Sections
	 */
	function generatePlanSelectionLeftSection(planTier, plan, isAnnual) {
		const planName = planTier ? `${planTier[0].toUpperCase()}${planTier.slice(1)} Plan` : 'Select a plan';
		const billingCycle = isAnnual ? 'Annual billing' : 'Monthly billing';
		const savings = isAnnual ? ' (10% off)' : '';
		
		return `
			<div class="plan-title">${planName}</div>
			<div class="plan-meta">${billingCycle}${savings}</div>
			<div class="plan-details">${plan ? `${plan.labCreditsPerYear} lab credits, ${plan.coachingMinutesPerMonth} min coaching` : 'Configure your plan'}</div>
		`;
	}
	
	function generatePlanSelectionCenterSection(planPrice, isAnnual) {
		const todayPrice = 0; // First month is free
		const nextMonthPrice = planPrice; // Actual plan price from next month
		
		return `
			<div class="row">
				<span class="label">Today:</span>
				<span class="value">£0.00</span>
			</div>
			<div class="row">
				<span class="label">From next month:</span>
				<span class="value">${money(nextMonthPrice)}/mo</span>
			</div>
		`;
	}
	
	function generatePlanSelectionRightSection() {
		const hasSelectedPlan = State.plan.tier;
		const buttonText = hasSelectedPlan ? 'Continue to build your first month →' : 'Select a plan first';
		const buttonDisabled = !hasSelectedPlan ? 'disabled' : '';
		
		return `
			<button class="btn-secondary" onclick="Router.go('dashboard')" id="back-to-dashboard-btn" style="display:none">← Back to Dashboard</button>
			<button class="checkout-cta" onclick="handleBuildFirstMonthClick()" id="plan-continue-btn" ${buttonDisabled}>${buttonText}</button>
		`;
	}
	
	/**
	 * Coaching Focus Page Footer Sections
	 */
	function generateCoachingLeftSection(planTier, plan, data) {
		const planName = planTier ? `${planTier[0].toUpperCase()}${planTier.slice(1)} Plan` : 'Standard Plan';
		const coachingMinutes = plan?.coachingMinutesPerMonth || 15;
		const selectedFocus = data.coachingFocus || 'General wellness';
		
		return `
			<div class="plan-title">${planName}</div>
        <div class="plan-meta" style="display:none">${coachingMinutes} min coaching this month</div>
        <div class="plan-details" style="display:none">Focus: ${selectedFocus}</div>
		`;
	}
	
	function generateCoachingCenterSection(planPrice, data) {
		const todayPrice = planPrice;
		const nextMonthPrice = planPrice;
		
		return `
			<div class="row">
				<span class="label">Today:</span>
				<span class="value">${money(todayPrice)}</span>
			</div>
			<div class="row">
				<span class="label">From next month:</span>
				<span class="value">${money(nextMonthPrice)}/mo</span>
			</div>
		`;
	}
	
	function generateCoachingRightSection() {
		return `
            <button id="build-month-back-btn" type="button" class="btn-secondary">← Back</button>
			<button id="build-month-continue-btn" type="button" class="checkout-cta">Continue to add-ons →</button>
		`;
	}
	
	/**
	 * Add-ons Page Footer Sections
	 */
	function generateAddonsLeftSection(planTier, plan) {
		const planName = planTier ? `${planTier[0].toUpperCase()}${planTier.slice(1)} Plan` : 'Standard Plan';
		const addonCount = Object.values(HS.addOns || {}).reduce((sum, qty) => sum + qty, 0);
		
		return `
			<div class="plan-title">${planName}</div>
        <div class="plan-meta" style="display:none">${addonCount > 0 ? `${addonCount} add-on${addonCount > 1 ? 's' : ''} selected` : 'No add-ons selected'}</div>
        <div class="plan-details" style="display:none">Base plan + selected add-ons</div>
		`;
	}
	
	function generateAddonsCenterSection(planPrice, data) {
		const addonTotal = data.addonTotal || 0;
		const todayTotal = planPrice + addonTotal;
		const nextMonthTotal = planPrice;
		
		return `
			<div class="row">
				<span class="label">Base plan:</span>
				<span class="value">${money(planPrice)}</span>
			</div>
			${addonTotal > 0 ? `
				<div class="row">
					<span class="label">Add-ons:</span>
					<span class="value">${money(addonTotal)}</span>
				</div>
			` : ''}
			<div class="row">
				<span class="label">Today:</span>
				<span class="total-value">${money(todayTotal)}</span>
			</div>
			<div class="row">
				<span class="label">From next month:</span>
				<span class="value">${money(nextMonthTotal)}/mo</span>
			</div>
		`;
	}
	
	function generateAddonsRightSection() {
		return `
			<button type="button" class="btn-secondary" onclick="Router.go('build-first-month')">← Back</button>
            <button type="button" class="checkout-cta" onclick="goToCheckout()">Continue to checkout →</button>
		`;
	}

	// =============== DYNAMIC FOOTER UPDATE FUNCTIONS ===============
	
	/**
	 * Updates the plan selection footer content dynamically
	 */
	function updatePlanSelectionFooter() {
		const currentPlanTier = State.plan.tier || HS.plan.tier;
		const plan = MODEL.plans[currentPlanTier];
		const isAnnual = State.plan.billingCycle === 'annual';
		const planPrice = isAnnual ? calcPlanMonthly(currentPlanTier, true) : (plan?.price || 0);
		
		// Update left section - Plan summary information
		const planTitle = document.getElementById('footer-plan-title');
		const planMeta = document.getElementById('footer-plan-meta');
		const planDetails = document.getElementById('footer-plan-details');
		
		if (planTitle) {
			planTitle.textContent = currentPlanTier ? 
				`${currentPlanTier.charAt(0).toUpperCase() + currentPlanTier.slice(1)} Plan` : 
				'Select a plan';
		}
		
    const billingText = currentPlanTier ? (isAnnual ? 'Annual billing (10% off)' : 'Monthly billing') : 'Choose your billing cycle';
    if (planMeta) planMeta.textContent = billingText;
    // Safety: also update any matching meta in the plan page footer even if IDs change
    try {
        document
          .querySelectorAll('section[data-view="plan"] .checkout-footer .plan-meta')
          .forEach(el => el.textContent = billingText);
    } catch(_) {}
		
		if (planDetails) {
			planDetails.textContent = plan ? 
				`${plan.labCreditsPerYear} lab credits • ${plan.coachingMinutesPerMonth} min coaching • ${plan.gpConsultsPerYear} GP consults` : 
				'Configure your plan';
		}
		
		// Update center section - Pricing breakdown
		const todayPrice = document.getElementById('footer-today-price');
		const nextPrice = document.getElementById('footer-next-price');
		
		if (todayPrice) {
			todayPrice.textContent = currentPlanTier ? money(planPrice) : '--';
		}
		if (nextPrice) {
			nextPrice.textContent = currentPlanTier ? `${money(planPrice)}/mo` : '--';
		}
		
		// Update right section - Action button
		const continueBtn = document.getElementById('plan-continue-btn');
		if (continueBtn) {
			const hasSelectedPlan = currentPlanTier;
			continueBtn.disabled = !hasSelectedPlan;
			continueBtn.textContent = hasSelectedPlan ? 
				'Continue to build your first month →' : 
				'Select a plan first';
			
			// Update button styling based on state
			if (hasSelectedPlan) {
				continueBtn.style.opacity = '1';
				continueBtn.style.cursor = 'pointer';
			} else {
				continueBtn.style.opacity = '0.6';
				continueBtn.style.cursor = 'not-allowed';
			}
		}
	}
	
	/**
	 * Updates the coaching footer content dynamically
	 */
	function updateCoachingFooter() {
		const currentPlanTier = State.plan.tier || HS.plan.tier;
		const plan = MODEL.plans[currentPlanTier];
		const isAnnual = State.plan.billingCycle === 'annual';
		const planPrice = isAnnual ? calcPlanMonthly(currentPlanTier, true) : (plan?.price || 0);
		const coachingFocus = HS.firstMonth.coaching || 'General wellness';
		
		// Debug logging
		console.log('updateCoachingFooter called:', {
			currentPlanTier,
			statePlanTier: State.plan.tier,
			hsPlanTier: HS.plan.tier,
			plan: plan ? `Found plan with price ${plan.price}` : 'No plan found',
			planPrice,
			isAnnual,
			availablePlans: Object.keys(MODEL.plans)
		});
		
		// Calculate lab selections for summary
		const selectedLabs = HS.firstMonth.labs || [];
		const labCount = selectedLabs.length;
		const supplementCount = (HS.firstMonth.supplements || []).length;
		
		// Update left section - Plan summary information
		const planTitle = document.getElementById('footer-coaching-plan-title');
		const planMeta = document.getElementById('footer-coaching-meta');
		const planDetails = document.getElementById('footer-coaching-details');
		
		if (planTitle) {
			planTitle.textContent = currentPlanTier ? 
				`${currentPlanTier.charAt(0).toUpperCase() + currentPlanTier.slice(1)} Plan` : 
				'Standard Plan';
		}
		
		if (planMeta) {
			planMeta.textContent = `${plan?.coachingMinutesPerMonth || 15} min coaching this month`;
		}
		
		if (planDetails) {
			const details = [`Focus: ${coachingFocus}`];
			if (labCount > 0) details.push(`${labCount} lab kit${labCount > 1 ? 's' : ''} selected`);
			if (supplementCount > 0) details.push(`${supplementCount} supplement${supplementCount > 1 ? 's' : ''} selected`);
			planDetails.textContent = details.join(' • ');
		}
		
		// Update center section - Pricing breakdown
		const todayPrice = document.getElementById('footer-coaching-today');
		const nextPrice = document.getElementById('footer-coaching-next');
		
		if (todayPrice) {
			// Today should reflect the selected plan price on this step
			todayPrice.textContent = money(planPrice);
		}
		if (nextPrice) {
			nextPrice.textContent = `${money(planPrice)}/mo`;
		}
	}
	
	/**
	 * Updates the addons footer content dynamically
	 */
	function updateAddonsFooter() {
		const currentPlanTier = State.plan.tier || HS.plan.tier;
		const plan = MODEL.plans[currentPlanTier];
		const isAnnual = State.plan.billingCycle === 'annual';
		const planPrice = isAnnual ? calcPlanMonthly(currentPlanTier, true) : (plan?.price || 0);
		
    // Calculate add-on totals from HS.addons using MODEL prices
    let addonCount = 0;
    let addonTotal = 0;
    try {
        const allAddons = { ...(MODEL.memberAddOns?.tests||{}), ...(MODEL.memberAddOns?.supplements||{}), ...(MODEL.memberAddOns?.services||{}) };
        const selected = HS.addons || {};
        Object.entries(selected).forEach(([id, qty]) => {
            const entry = Object.values(allAddons).find(a => a.id === id);
            const price = entry?.price || 0;
            addonCount += qty || 0;
            addonTotal += (qty || 0) * price;
        });
    } catch(_) {}
    const todayTotal = planPrice + addonTotal; // Today shows plan + one-time add-ons
    const nextMonthTotal = planPrice; // Next month is plan only
		
		// Update left section - Plan summary information
		const planTitle = document.getElementById('footer-addons-plan-title');
		const planMeta = document.getElementById('footer-addons-meta');
		const planDetails = document.getElementById('footer-addons-details');
		
		if (planTitle) {
			planTitle.textContent = currentPlanTier ? 
				`${currentPlanTier.charAt(0).toUpperCase() + currentPlanTier.slice(1)} Plan` : 
				'Standard Plan';
		}
		
		if (planMeta) {
			planMeta.textContent = addonCount > 0 ? 
				`${addonCount} add-on${addonCount > 1 ? 's' : ''} selected` : 
				'No add-ons selected';
		}
		
		if (planDetails) {
			planDetails.textContent = addonCount > 0 ? 
				'Base plan + selected add-ons' : 
				'Base plan only';
		}
		
		// Update center section - Pricing breakdown
		const basePrice = document.getElementById('footer-addons-base');
		const addonsRow = document.getElementById('footer-addons-addons-row');
		const addonsPrice = document.getElementById('footer-addons-addons');
		const totalPrice = document.getElementById('footer-addons-total');
		const nextPrice = document.getElementById('footer-addons-next');
		
		if (basePrice) {
        basePrice.textContent = money(planPrice);
		}
		
		if (addonCount > 0) {
			if (addonsRow) addonsRow.style.display = 'flex';
			if (addonsPrice) addonsPrice.textContent = money(addonTotal);
		} else {
			if (addonsRow) addonsRow.style.display = 'none';
		}
		
    if (totalPrice) { totalPrice.textContent = money(todayTotal); }
		if (nextPrice) {
			nextPrice.textContent = `${money(nextMonthTotal)}/mo`;
		}
	}

	function renderBuildFirstMonthPage() {
		// Sync plan state from State to HS - ensure both are in sync
		const previousPlanTier = HS.plan.tier;
		if (State.plan.tier && State.plan.tier !== HS.plan.tier) {
			HS.plan.tier = State.plan.tier;
			commit();
		} else if (HS.plan.tier && !State.plan.tier) {
			// If HS has a plan but State doesn't, sync State from HS
			State.plan.tier = HS.plan.tier;
			save({'plan.tier': State.plan.tier});
		}
		
		// Get current plan tier - use State.plan.tier as source of truth
		const currentPlanTier = State.plan.tier || HS.plan.tier;
		
		// Clear selections if plan has changed
		// This ensures clean state when switching between plans
		if (previousPlanTier && previousPlanTier !== currentPlanTier) {
			console.log('Plan changed from', previousPlanTier, 'to', currentPlanTier, '- clearing selections');
			HS.firstMonth.labs = [];
			HS.firstMonth.supplements = [];
			HS.firstMonth.coaching = null;
			HS.firstMonth.lab = null;
			
			// Clear State.plan.firstMonthPicks as well
			State.plan.firstMonthPicks = { labs: [], supplements: [], coaching: null };
			save({'plan.firstMonthPicks': State.plan.firstMonthPicks});
			
			console.log('Selections cleared successfully');
		}
		
		// Initialize labs array if it doesn't exist (but don't set defaults)
		if (!HS.firstMonth.labs) {
			HS.firstMonth.labs = [];
		}
		
		// Initialize supplements array if it doesn't exist (but don't set defaults)
		if (!HS.firstMonth.supplements) {
			HS.firstMonth.supplements = [];
		}
		
		// Initialize coaching if it doesn't exist (but don't set defaults)
		if (!HS.firstMonth.coaching) {
			HS.firstMonth.coaching = null;
		}
		
		// Debug logging for initial state
		console.log('Build first month page initial state:', {
			planTier: currentPlanTier,
			labs: HS.firstMonth.labs,
			supplements: HS.firstMonth.supplements,
			coaching: HS.firstMonth.coaching,
			hasAnySelections: HS.firstMonth.labs.length > 0 || HS.firstMonth.supplements.length > 0 || HS.firstMonth.coaching
		});
		
		// Don't set automatic recommendations - let users choose or use apply recommendations
		// const hasAnySelections = HS.firstMonth.labs.length > 0 || HS.firstMonth.supplements.length > 0 || HS.firstMonth.coaching;
		// if (!hasAnySelections && currentPlanTier) {
		// 	console.log('Setting plan-appropriate initial recommendations for:', currentPlanTier);
		// 	setPlanAppropriateRecommendations(currentPlanTier);
		// }
		
		commit();
		
		// Update page title to show current plan
		const pageTitle = document.querySelector('section[data-view="build-first-month"] h2');
		if (pageTitle) {
			const currentPlan = State.plan.tier || HS.plan.tier || 'No Plan Selected';
			pageTitle.textContent = `Build your first month - ${currentPlan}`;
		}
		
		// Update plan-specific text and displays - use State.plan.tier as source of truth
		const plan = MODEL.plans[currentPlanTier];
		
		// Get recommendations once for use in both supplements and coaching sections
		const signals = recEngine.readSignals();
		const recommendations = recEngine.buildRecommendations(signals);
		
		const supplementText = document.getElementById('supplement-credit-text');
		const coachingText = document.getElementById('coaching-minutes-text');
		
		// Update plan allowances display
		const planDetails = document.getElementById('plan-details');
		if (planDetails && plan) {
			planDetails.innerHTML = `
				<div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:1rem; text-align:left">
					<div><strong>${plan.labCreditsPerYear} lab credits</strong><br>per year</div>
					<div><strong>${plan.supplementQuantityPerMonth} supplement${plan.supplementQuantityPerMonth > 1 ? 's' : ''}</strong><br>per month</div>
					<div><strong>${plan.coachingMinutesPerMonth} min coaching</strong><br>per month</div>
					<div><strong>${plan.gpConsultsPerYear} GP consults</strong><br>per year</div>
				</div>
			`;
		}
		
		// Update lab credits info
		const labCreditsInfo = document.getElementById('lab-credits-info');
		if (labCreditsInfo && plan) {
			labCreditsInfo.innerHTML = `
				<strong>Your plan includes ${plan.labCreditsPerYear} lab credit${plan.labCreditsPerYear > 1 ? 's' : ''} per year.</strong> 
				Choose how to use your first credit this month.
			`;
		}
		
		// Update supplement allowance info
		const supplementAllowanceInfo = document.getElementById('supplement-allowance-info');
		if (supplementAllowanceInfo && plan) {
			const maxSupplements = plan.supplementQuantityPerMonth;
			supplementAllowanceInfo.innerHTML = `
				<strong>Your plan includes ${maxSupplements} supplement${maxSupplements > 1 ? 's' : ''} per month.</strong>
			`;
		}
		
		// Update coaching allowance info
		const coachingAllowanceInfo = document.getElementById('coaching-allowance-info');
		if (coachingAllowanceInfo && plan) {
			coachingAllowanceInfo.innerHTML = `
				<strong>Your plan includes ${plan.coachingMinutesPerMonth} minutes of 1:1 coaching per month.</strong> 
				Choose your focus area for this month's session.
			`;
		}
		
	
		
		// Render lab options with detailed descriptions and credit gating
		const labSelection = document.getElementById('lab-selection');
		if (labSelection) {
			// Ensure a plan is selected before rendering lab options
			if (!plan || !plan.labCreditsPerYear) {
				labSelection.innerHTML = `
					<div style="text-align: center; padding: 2rem; color: var(--ink-60);">
						<h4 style="margin: 0 0 1rem 0; color: var(--ink-80);">Please select a plan first</h4>
						<p style="margin: 0; font-size: 0.9rem;">You need to choose a plan before selecting lab kits for your first month.</p>
						<button class="btn btn-secondary" onclick="Router.go('plan')" style="margin-top: 1rem;">
							Go to Plan Selection
						</button>
					</div>
				`;
				return;
			}
			
			const userCredits = plan.labCreditsPerYear;
			const userGender = State.user.sex;
			
			// Initialize labs array if it doesn't exist
			if (!HS.firstMonth.labs) {
				HS.firstMonth.labs = [];
			}
			
			// Calculate current credit usage
			const currentCreditsUsed = HS.firstMonth.labs.reduce((total, id) => {
				const selectedLab = MODEL.catalog.labs.find(l => l.id === id);
				return total + (selectedLab ? selectedLab.credits : 0);
			}, 0);
			
			// Debug logging
			console.log('Lab selection debug:', {
				userCredits,
				currentCreditsUsed,
				selectedLabs: HS.firstMonth.labs,
				planTier: HS.plan.tier
			});
			
			// Filter labs by gender
			const availableLabs = filterByGender(MODEL.catalog.labs, userGender);
			
			// Lab test details with descriptions
			const labDetails = {
				'core': {
					name: 'Core Blood Test',
					credits: 1,
					description: 'Essential health markers including cholesterol, blood sugar, liver function, and kidney function',
					markers: '8 key biomarkers'
				},
				'metabolic': {
					name: 'Metabolic Health',
					credits: 1,
					description: 'Comprehensive metabolic panel including glucose, insulin, HbA1c, and metabolic hormones',
					markers: '12 metabolic markers'
				},
				'cardio': {
					name: 'Cardiovascular',
					credits: 1,
					description: 'Heart health assessment including cholesterol profile, inflammatory markers, and cardiac risk factors',
					markers: '10 cardiovascular markers'
				},
				'male-hormone': {
					name: 'Male Hormone',
					credits: 1,
					description: 'Testosterone, SHBG, and other male hormone levels with free testosterone calculation',
					markers: '6 hormone markers'
				},
				'thyroid': {
					name: 'Thyroid Health',
					credits: 1,
					description: 'Complete thyroid function test including TSH, T3, T4, and thyroid antibodies',
					markers: '5 thyroid markers'
				},
				'nutritional': {
					name: 'Nutritional Health',
					credits: 1,
					description: 'Vitamin and mineral levels including B12, folate, iron, vitamin D, and key nutrients',
					markers: '9 nutritional markers'
				},
				'complete-20': {
					name: 'Complete Blood Test (20)',
					credits: 2,
					description: 'Comprehensive health assessment covering all major health systems and biomarkers',
					markers: '20 comprehensive markers'
				},
				'complete-met': {
					name: 'Complete Metabolic',
					credits: 2,
					description: 'Advanced metabolic profiling including insulin resistance, metabolic syndrome markers, and metabolic health indicators',
					markers: '15 metabolic markers'
				},
				'venous-testosterone': {
					name: 'Testosterone (Venous)',
					credits: 3,
					description: 'Gold-standard venous blood draw for the most accurate testosterone measurement with detailed hormone analysis',
					markers: '8 hormone markers'
				},
				'female-hormone': {
					name: 'Female Hormone Panel',
					credits: 1,
					description: 'Comprehensive female hormone assessment including estrogen, progesterone, testosterone, and other key reproductive hormones',
					markers: '8 hormone markers'
				},
				'prenatal-panel': {
					name: 'Prenatal Health Panel',
					credits: 2,
					description: 'Specialized panel for pregnancy health including folate, B12, iron, thyroid function, and other pregnancy-specific markers',
					markers: '12 pregnancy markers'
				}
			};
			
			// Get recommended labs from the recommendation engine (same as supplements)
			const signals = recEngine.readSignals();
			const recommendations = recEngine.buildRecommendations(signals);
			const recommendedLabs = recommendations?.picks?.labs?.map(l => l.id) || [];
			
			labSelection.innerHTML = availableLabs.map(lab => {
				const details = labDetails[lab.id] || { name: lab.name, credits: lab.credits, description: 'Health assessment', markers: 'Multiple markers' };
				const isSelected = HS.firstMonth.labs.includes(lab.id);
				
				// Calculate if we can afford this lab:
				// 1. If already selected, we can always deselect it (never disabled)
				// 2. If not selected, disable if either:
				//    - Lab costs more than total available credits, OR
				//    - User has chosen to use lab credit later
                const labTooExpensive = lab.credits > userCredits; // Lab costs more than total available credits
                const useLabLater = HS.firstMonth.useLabLater;
                
                // Only disable if the user has explicitly chosen to use lab credits later
                // AND they haven't already selected any labs
                const shouldDisableForUseLabLater = useLabLater && HS.firstMonth.labs.length === 0;
                
                // A lab should only be disabled if:
                // 1. It costs more than the total available credits (e.g., 2-credit lab with only 1 credit plan)
                // 2. User has chosen to use lab credit later and hasn't selected any labs yet
                // We should NOT disable based on remaining credits - let the selection logic handle limits
                const isDisabled = labTooExpensive || shouldDisableForUseLabLater;
				
				// Only show recommended if it's in the recommended list AND the user can afford it
				const isRecommended = recommendedLabs.includes(lab.id) && !isDisabled;
				
				// Debug logging for each lab
				console.log(`Lab ${lab.id}:`, {
					credits: lab.credits,
					isSelected,
					currentCreditsUsed,
					userCredits,
					labTooExpensive,
					useLabLater: HS.firstMonth.useLabLater,
					shouldDisableForUseLabLater,
					isDisabled,
					disabledReasons: {
						labTooExpensive,
						shouldDisableForUseLabLater
					}
				});
				
				return `
        <div class="lab-option ${isSelected ? 'selected' : ''} ${isDisabled ? 'disabled' : ''}" 
             data-lab="${lab.id}" 
             onclick="${isDisabled ? '' : `selectLab('${lab.id}')`}"
             style="${isSelected ? 'cursor: pointer;' : (isDisabled ? 'opacity: 0.5; cursor: not-allowed;' : 'cursor: pointer;')}">
						${isRecommended ? '<div class="recommended-badge">Recommended</div>' : ''}
						<div style="margin-bottom: 0.75rem;">
							<h4 style="margin: 0; color: ${isSelected ? 'var(--ink)' : (isDisabled ? '#9ca3af' : 'var(--ink)')}; font-size: 1.1rem; font-weight: 600;">${details.name}</h4>
						</div>
						<p style="margin: 0 0 0.75rem 0; font-size: 0.95rem; color: ${isSelected ? 'var(--ink-60)' : (isDisabled ? '#9ca3af' : 'var(--ink-60)')}; line-height: 1.5;">
							${details.description}
						</p>
						<div style="font-size: 0.85rem; color: ${isSelected ? 'var(--ink-40)' : (isDisabled ? '#9ca3af' : 'var(--ink-40)')}; font-weight: 600; background: ${isSelected ? '#f0fdfa' : (isDisabled ? '#f3f4f6' : '#f0fdfa')}; padding: 0.4rem 0.6rem; border-radius: 4px; border-left: 3px solid ${isSelected ? 'var(--numan-teal)' : (isDisabled ? '#d1d5db' : 'var(--numan-teal)')}; margin-bottom: 0.75rem;">
							${details.markers}
						</div>
						<div style="display: flex; justify-content: center; margin-top: auto;">
							<div class="credits" style="background: ${isSelected ? 'var(--numan-teal)' : (isDisabled ? '#e5e7eb' : 'var(--numan-teal)')}; color: ${isSelected ? 'white' : (isDisabled ? '#9ca3af' : 'white')}; padding: 0.4rem 0.8rem; border-radius: 6px; font-size: 0.85rem; font-weight: 700; min-width: 2.5rem; text-align: center;">
								${lab.credits} credit${lab.credits > 1 ? 's' : ''}
							</div>
						</div>
						${labTooExpensive ? `
							<div style="margin-top: 0.75rem; padding: 0.6rem; background: #fef2f2; border: 1px solid #fecaca; border-radius: 6px; font-size: 0.85rem; color: #dc2626; font-weight: 500;">
								⚠️ Requires ${lab.credits} credit${lab.credits > 1 ? 's' : ''} (you have ${userCredits})
							</div>
						` : ''}
					</div>
				`;
			}).join('');
			
			// Update the credit counter display above the tiles
			const creditsRemaining = Math.max(0, userCredits - currentCreditsUsed);
			const creditCounter = document.querySelector('.lab-credit-counter');
			if (creditCounter) {
				creditCounter.innerHTML = `
					<strong>${creditsRemaining} of ${userCredits} credits remaining</strong>
					${currentCreditsUsed > 0 ? `<br><small>Selected: ${currentCreditsUsed} credits used</small>` : ''}
			`;
			}
		}
		
		// Render supplement options
		const supplementSelection = document.getElementById('supplement-selection');
		if (supplementSelection) {
			// Use lab credits to determine max supplements (capped at 3)
			const maxSupplements = Math.min(plan.labCreditsPerYear, 3);
			const userGender = State.user.sex;
			
			// Filter supplements by gender
			const availableSupplements = filterByGender(MODEL.catalog.supplements, userGender);
			
			// Get recommended supplements from the recommendation engine
			const recommendedSupplementIds = recommendations?.picks?.supplements?.map(s => s.id) || [];
			
			supplementSelection.innerHTML = availableSupplements.map(supp => {
				const isSelected = HS.firstMonth.supplements.includes(supp.id);
				// Check if user can afford more supplements (hasn't reached limit)
				const canAfford = HS.firstMonth.supplements.length < maxSupplements;
				// Show recommended if it's in the recommended list (regardless of affordability)
				const isRecommended = recommendedSupplementIds.includes(supp.id);
				return `
					<div class="supplement-option ${isSelected ? 'selected' : ''}" data-supp="${supp.id}" onclick="selectSupplement('${supp.id}')">
						<h4>${supp.name}</h4>
						<div class="included">${isSelected ? 'Selected' : 'Available'}</div>
						${isRecommended ? '<div class="recommended-badge">Recommended</div>' : ''}
					</div>
				`;
			}).join('');
			
			// Update selection state
			updateSupplementSelection();
		}
		
		// Render coaching options
		const coachingSelection = document.getElementById('coaching-selection');
		console.log('🎯 Looking for coaching-selection element:', coachingSelection);
		if (coachingSelection) {
			const userGender = State.user.sex;
			
			// Filter coaching options by gender
			const availableCoaching = filterByGender(MODEL.catalog.coaching, userGender);
			
			// Get recommended coaching from the recommendation engine
			const recommendedCoaching = recommendations?.picks?.coaching ? [recommendations.picks.coaching.id] : [];
			
			console.log('🎯 Coaching rendering debug:', {
				availableCoaching: availableCoaching,
				recommendedCoaching: recommendedCoaching,
				recommendations: recommendations,
				userGender: userGender,
				coachingSelection: coachingSelection
			});
			
			coachingSelection.innerHTML = availableCoaching.map(coach => {
				const isSelected = HS.firstMonth.coaching === coach.id;
				// Show recommended if it's in the recommended list
				// Coaching is always available as it's included in the plan
				const isRecommended = recommendedCoaching.includes(coach.id);
				
				return `
					<div class="coaching-option ${isSelected ? 'selected' : ''}" data-coach="${coach.id}" onclick="selectCoaching('${coach.id}')">
						<h4>${coach.name}</h4>
						<div class="included">${isSelected ? 'Selected' : 'Available'}</div>
						${isRecommended ? '<div class="recommended-badge">Recommended</div>' : ''}
					</div>
				`;
			}).join('');
			
			console.log('🎯 Coaching HTML generated:', coachingSelection.innerHTML);
			
			// Update selection state
			updateCoachingSelection();
		}
		
		// Ensure the "Use my lab credit later" checkbox reflects the correct state
		const useLabLaterCheckbox = document.getElementById('use-lab-later');
		if (useLabLaterCheckbox) {
			useLabLaterCheckbox.checked = HS.firstMonth.useLabLater || false;
			console.log('Checkbox state updated:', {
				hsUseLabLater: HS.firstMonth.useLabLater,
				checkboxChecked: useLabLaterCheckbox.checked,
				planTier: HS.plan.tier,
				userCredits: HS.plan.tier ? MODEL.plans[HS.plan.tier].labCreditsPerYear : 'no plan'
			});
		}
		
		updateBuildFirstMonthSummary();
		// Update standardized footer for coaching page
		if (State.currentView === 'build-first-month') {
			updateCoachingFooter();
		}
	}

	function renderAddonsPage() {
		// Render addon steppers
		const addonSteppers = document.getElementById('addon-steppers');
		if (addonSteppers) {
			const allAddons = { ...MODEL.memberAddOns.tests, ...MODEL.memberAddOns.supplements, ...MODEL.memberAddOns.services };
			addonSteppers.innerHTML = Object.entries(allAddons).map(([key, addon]) => {
				const qty = HS.addons[addon.id] || 0;
				const isSelected = qty > 0;
				return `
					<div class="addon-stepper ${isSelected ? 'selected' : ''}" data-addon="${addon.id}">
						<div class="addon-info">
							<h4>${addon.title}</h4>
							<span class="price">${money(addon.price)}</span>
							${isSelected ? '<div class="selected-badge">Selected</div>' : ''}
						</div>
						<div class="stepper">
							<button onclick="updateAddonQty('${addon.id}', -1)">−</button>
							<span id="qty-${addon.id}" class="qty-display ${isSelected ? 'selected' : ''}">${qty}</span>
							<button onclick="updateAddonQty('${addon.id}', 1)">+</button>
						</div>
					</div>
				`;
			}).join('');
		}
		
		updateAddonsSummary();
		// Update standardized footer for addons page
		if (State.currentView === 'addons') {
			updateAddonsFooter();
		}
		updateLabSelection();
		
		// Ensure footer is updated with current plan information
		setTimeout(() => {
			updateCoachingFooter();
		}, 100);
	}
	
	function toggleBillingCycle() {
		const toggle = document.getElementById('billing-toggle');
		if (!toggle) {
			console.error('Billing toggle not found');
			return;
		}
		const isAnnual = toggle.checked;
		console.log('Toggling billing cycle:', {isAnnual, newCycle: isAnnual ? 'annual' : 'monthly'});
		State.plan.billingCycle = isAnnual ? 'annual' : 'monthly';
		save({'plan.billingCycle': State.plan.billingCycle});
		renderNewPlanPage();
		updatePlanSummary();
		// Update standardized footer
		if (State.currentView === 'plan') {
			updatePlanSelectionFooter();
		}
		// Don't call renderBudgetRecommendation here - it should be independent of billing toggle
	}
	
	function setAnnual(isAnnual) {
		State.plan.billingCycle = isAnnual ? 'annual' : 'monthly';
		save({'plan.billingCycle': State.plan.billingCycle});
		renderNewPlanPage();
		updatePlanSummary();
	}
	
	function updateBillingToggle() {
		// Update billing toggle to reflect current state
		const toggle = document.getElementById('billing-toggle');
		if (toggle) {
			console.log('Updating billing toggle:', {billingCycle: State.plan.billingCycle, checked: State.plan.billingCycle === 'annual'});
			toggle.checked = State.plan.billingCycle === 'annual';
		} else {
			console.log('Billing toggle not found');
		}
	}
	
	function selectPlan(planKey) {
		selectPlanTier(planKey);
	}
	
	function setFirstMonthPicks(picks) {
		// Store the first month picks in State
		State.plan.firstMonthPicks = picks;
		save({'plan.firstMonthPicks': picks});
		renderNewPlanPage();
		updatePlanSummary();
	}
	
	function toggleAddOn(addOnId) {
		const index = State.plan.selectedAddOns.indexOf(addOnId);
		if (index > -1) {
			State.plan.selectedAddOns.splice(index, 1);
		} else {
			State.plan.selectedAddOns.push(addOnId);
		}
		save({'plan.selectedAddOns': State.plan.selectedAddOns});
		renderNewPlanPage();
		updatePlanSummary();
	}
	
	function openBuildFirstMonth() {
		showBuildFirstMonthModal();
	}
	
	function showBuildFirstMonthModal() {
		const modal = document.createElement('div');
		modal.className = 'modal active';
		modal.innerHTML = `
			<div class="modal-content" style="max-width:600px">
				<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem">
					<h3>Build First Month</h3>
					<button class="btn-ghost btn-small" onclick="closeModal()">✕</button>
				</div>
				
				<div class="card" style="background:var(--canvas); margin-bottom:1rem">
					<h4>Your Plan Allowances</h4>
					<div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:1rem; margin-top:0.5rem">
						<div>
							<strong>Lab Credits:</strong> ${MODEL.plans[State.plan.tier].labCreditsPerYear} per year
						</div>
						<div>
							<strong>Supplements:</strong> ${MODEL.plans[State.plan.tier].supplementQuantityPerMonth} supplement${MODEL.plans[State.plan.tier].supplementQuantityPerMonth > 1 ? 's' : ''} per month
						</div>
					</div>
				</div>
				
				<div class="form-group">
					<label>Lab kits this month</label>
					<input type="number" id="lab-kits-input" value="0" min="0" max="${MODEL.plans[State.plan.tier].labCreditsPerYear}">
					<small class="muted">You have ${MODEL.plans[State.plan.tier].labCreditsPerYear} lab credits per year</small>
				</div>
				
				<div class="form-group">
					<label>Supplement packs this month</label>
					<input type="number" id="supplement-packs-input" value="0" min="0">
					<small class="muted">Each pack counts as 1 supplement</small>
				</div>
				
				<div class="form-group">
					<label>Extra lab credits (optional)</label>
					<input type="number" id="extra-lab-credits" value="0" min="0">
					<small class="muted">£${MODEL.credits.topUpPerCreditGBP} per extra credit</small>
				</div>
				
				<div style="display:flex; gap:0.5rem; margin-top:1rem">
					<button class="btn" onclick="applyFirstMonthConfiguration()">Apply to Plan</button>
					<button class="btn-ghost" onclick="closeModal()">Cancel</button>
				</div>
			</div>
		`;
		document.body.appendChild(modal);
	}
	
	function applyFirstMonthConfiguration() {
		const labKits = parseInt(document.getElementById('lab-kits-input').value) || 0;
		const supplementPacks = parseInt(document.getElementById('supplement-packs-input').value) || 0;
		const extraCredits = parseInt(document.getElementById('extra-lab-credits').value) || 0;
		
		State.cart.kitsToShip = labKits + supplementPacks;
		
		// Add extra credits to cart
		if (extraCredits > 0) {
			State.cart.addOns['extra-lab-credits'] = {
				unitPrice: MODEL.credits.topUpPerCreditGBP,
				qty: extraCredits,
				label: 'Extra Lab Credits'
			};
		}
		
		save({cart: State.cart});
		
		updatePlanSummary();
		closeModal();
		showToast('First month configuration updated');
	}
	
	function renderNewPlanPage() {
		renderNewTierGrid();
		renderAddOns();
		updatePlanSummary();
	}
	
	
	function renderPlanRecommendation() {
		console.log('renderPlanRecommendation called');
		const budgetRecEl = document.getElementById('budget-recommendation');
		if (!budgetRecEl) {
			console.log('budget-recommendation element not found');
			return;
		}
		
		// Hide recommendation card entirely when user already has an active subscription
		const hasActiveSubscription = State.subscription?.active && State.subscription?.status === 'active';
		console.log('hasActiveSubscription:', hasActiveSubscription);
		if (hasActiveSubscription) {
			budgetRecEl.style.display = 'none';
			return;
		}
		
		// Show recommendation card and render based on budget
		budgetRecEl.style.display = 'block';
		
		// Choose plan strictly by budget answer
		const budget = (State.onboarding?.answers?.budget || State.preferences?.budget || '').toLowerCase();
		let recommendedPlanKey = 'Standard';
		if (budget.includes('under-50') || budget.includes('<') || budget === 'under-50') {
			recommendedPlanKey = 'Base';
		} else if (budget.includes('100') || budget.includes('100+') || budget.includes('100-plus') || budget.includes('>')) {
			recommendedPlanKey = 'Premium';
		} else if (budget.includes('50-99') || budget.includes('50 – 99')) {
			recommendedPlanKey = 'Standard';
		}
		
		const plan = MODEL.plans[recommendedPlanKey] || MODEL.plans.Standard;
		const isAnnual = State.plan.billingCycle === 'annual';
		const price = isAnnual ? calcPlanMonthly(recommendedPlanKey, true) : plan.price;
		
		budgetRecEl.innerHTML = `
			<div class="plan-recommendation-content">
				<div class="recommendation-badge">
					<span class="badge-icon">🎯</span>
					<span class="badge-text">Best Match for You</span>
				</div>
				<div class="plan-highlight">
					<h4>${recommendedPlanKey} Plan</h4>
					<div class="price-highlight">
						<span class="price">${money(price)}</span>
						<span class="period">/month</span>
					</div>
					${isAnnual ? '<div style="font-size:0.85rem; color:var(--numan-teal); font-weight:700; margin-top:0.25rem">Annual (10% off)</div>' : ''}
				</div>
				<div class="recommendation-reasons">
					<h5>Why this plan?</h5>
					<ul class="reason-list">
						<li class="reason-item">Perfect balance of features and value</li>
						<li class="reason-item">Includes ${plan.labCreditsPerYear} lab credit${plan.labCreditsPerYear>1?'s':''} per year</li>
						<li class="reason-item">${plan.coachingMinutesPerMonth} minutes of coaching monthly</li>
						<li class="reason-item">Matches your budget preference</li>
					</ul>
				</div>
				<button class="btn recommendation-cta" onclick="selectRecommendedPlan('${recommendedPlanKey}')">
					Select This Plan
				</button>
			</div>
		`;
		// Stop here; we render the budget-based recommendation above
			return;
	}

	function renderNewTierGrid() {
		const grid = document.getElementById('new-tier-grid');
		if (!grid) return;
		
		// Update plan state before rendering
		updatePlanState();
		
		// Only show plan recommendation on the plan page, not on build-first-month
		if (State.currentView === 'plan') {
			renderPlanRecommendation();
		}
		
		const isAnnual = State.plan.billingCycle === 'annual';
		const hasActiveSubscription = State.subscription?.active && State.subscription?.status === 'active';
		const currentActiveTier = State.subscription?.tier;
		
		// Only show plan recommendations on the plan page, not on build-first-month
		const showRecommendations = State.currentView === 'plan';
		let recommendedPlan = null;
		if (showRecommendations) {
			const budget = State.onboarding?.answers?.budget || State.preferences?.budget || '';
		if (budget) {
			const signals = recEngine.readSignals();
			const { plan } = recEngine.recommendPlan(signals);
			recommendedPlan = plan;
			}
		}
		
		const planEntries = Object.entries(MODEL.plans);
		
    grid.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; margin: 2rem 0;">
				${planEntries.map(([tierKey, plan]) => {
			const price = isAnnual ? calcPlanMonthly(tierKey, true) : plan.price;
			const isSelected = State.plan.tier === tierKey;
					
					// Button text logic
					let buttonText = 'Choose Plan';
					let buttonClass = 'btn-secondary';
					let buttonDisabled = '';
					
					if (isSelected) {
				buttonText = '✓ Selected Plan';
						buttonClass = 'btn-primary';
				buttonDisabled = 'disabled';
					}
					
					// Plan-specific details
					const supplements = tierKey === 'Premium' ? 3 : tierKey === 'Standard' ? 2 : 1;
					const supplementCredit = tierKey === 'Premium' ? '£15' : '£10';
			
			return `
						<div class="plan-card" style="
							position: relative;
							background: white;
							border: ${isSelected ? '3px solid var(--numan-teal)' : '1px solid #e5e7eb'};
							border-radius: 12px;
							padding: 1.5rem;
							text-align: center;
							cursor: pointer;
							transition: all 0.3s ease;
							box-shadow: ${isSelected ? '0 8px 25px rgba(30, 207, 192, 0.15)' : '0 2px 8px rgba(0, 0, 0, 0.08)'};
						" onclick="selectPlanTier('${tierKey}')">
							<!-- Selection indicator dot -->
							<div style="
								position: absolute;
								top: 1rem;
								right: 1rem;
								width: 12px;
								height: 12px;
								border-radius: 50%;
								background: ${isSelected ? 'var(--numan-teal)' : '#e5e7eb'};
								transition: background 0.3s ease;
							"></div>
							
							<!-- Plan title -->
							<h2 style="
								font-size: 1.5rem;
								font-weight: 700;
								color: var(--ink);
								margin: 0 0 1rem 0;
								text-transform: uppercase;
								letter-spacing: 0.5px;
							">${tierKey}</h2>
							
							<!-- Price -->
							<div style="
								font-size: 2rem;
								font-weight: 800;
								color: var(--numan-teal);
								margin-bottom: 1.5rem;
							">
								${money(price)}<small style="font-size: 1rem; color: var(--ink-60);">/mo</small>
						</div>
							
							<!-- Features list -->
							<div style="
								text-align: left;
								margin-bottom: 2rem;
								font-size: 0.9rem;
								color: var(--ink-80);
								line-height: 1.6;
							">
								<div style="margin-bottom: 0.5rem;">Lab credits: ${plan.labCreditsPerYear} per year</div>
								<div style="margin-bottom: 0.5rem;">Supplements: ${supplements} supplement${supplements > 1 ? 's' : ''} per month</div>
								<div style="margin-bottom: 0.5rem;">Coaching: ${plan.coachingMinutesPerMonth} min 1:1 per month</div>
								<div>GP access: ${plan.gpConsultsPerYear} consults per year</div>
					</div>
							
							<!-- Button -->
							<button class="${buttonClass}" ${buttonDisabled} style="
								width: 100%;
								padding: 0.75rem 1rem;
								border-radius: 8px;
								font-weight: 600;
								transition: all 0.3s ease;
								${isSelected ? 'background: var(--numan-teal); color: white; border: none;' : 'background: white; color: var(--numan-teal); border: 2px solid var(--numan-teal);'}
							">
							${buttonText}
						</button>
					</div>
					`;
				}).join('')}
				</div>
			`;

    // Ensure the plan footer reflects the current selection immediately
    if (typeof updatePlanSelectionFooter === 'function') {
        updatePlanSelectionFooter();
    }
	}
	
	function renderAddOns() {
		const section = document.getElementById('addons-section');
		const grid = document.getElementById('addons-grid');
		const buildSection = document.getElementById('build-first-month-section');
		
		if (!State.plan.tier) {
			if (section) section.style.display = 'none';
			if (buildSection) buildSection.style.display = 'none';
			return;
		}
		
		if (section) section.style.display = 'block';
		if (buildSection) buildSection.style.display = 'block';
		
		// Flatten memberAddOns into a single array for rendering
		const allAddOns = [];
		Object.values(MODEL.memberAddOns).forEach(category => {
			Object.values(category).forEach(addon => {
				allAddOns.push([addon.id, addon]);
			});
		});
		
		if (grid) {
			grid.innerHTML = allAddOns.map(([addOnId, addOn]) => {
			const isSelected = State.plan.selectedAddOns.includes(addOnId);
			
			return `
				<div class="card ${isSelected ? 'anchor' : ''}" style="cursor:pointer" onclick="toggleAddOn('${addOnId}')">
					<div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:0.5rem">
						<h4 style="margin:0">${addOn.title}</h4>
						<div class="summary-price">${money(addOn.price)}<small>/month</small></div>
					</div>
					<p class="service-outcome">Add this service to your plan</p>
					<div style="margin-top:0.5rem">
						<button class="btn btn-small" ${isSelected?'disabled':''}>
							${isSelected?'Added':'Add to plan'}
						</button>
					</div>
				</div>
			`;
		}).join('');
		}
	}
	
	
	// Missing function implementations
	function calcCartTotal(state = State) {
		if (!state.plan.tier) {
			return { monthlyTotal: 0, base: 0 };
		}
		
		const plan = MODEL.plans[state.plan.tier];
		if (!plan) {
			return { monthlyTotal: 0, base: 0 };
		}
		
		const isAnnual = state.plan.billingCycle === 'annual';
		const basePrice = calcPlanMonthly(state.plan.tier, isAnnual);
		const addOnsTotal = (state.plan.selectedAddOns || []).reduce((total, addOnId) => {
			// Find addon in memberAddOns
			for (const category of Object.values(MODEL.memberAddOns)) {
				for (const addon of Object.values(category)) {
					if (addon.id === addOnId) {
						return total + addon.price;
					}
				}
			}
			return total;
		}, 0);
		
		return {
			monthlyTotal: basePrice + addOnsTotal,
			base: basePrice,
			addOns: addOnsTotal
		};
	}
	
	function clearErrorsNearby(element) {
		// Clear any error messages near the given element
		if (!element) return;
		const container = element.closest('.card, .form-group, .input-group');
		if (container) {
			const errors = container.querySelectorAll('.error-message, .error');
			errors.forEach(error => error.remove());
		}
	}

	// Function to select the recommended plan
	function selectRecommendedPlan(planId) {
		// Map plan IDs to tiers (handle both lowercase and proper case)
		const planMapping = {
			'base': 'Base',
			'standard': 'Standard',
			'premium': 'Premium',
			'Base': 'Base',
			'Standard': 'Standard',
			'Premium': 'Premium'
		};
		
		const tier = planMapping[planId] || planId; // Use the mapping or the original if not found
		if (tier && MODEL.plans[tier]) {
			selectPlanTier(tier);
			
			// Bring the plan grid into view so users can see their selection
    const grid = document.getElementById('new-tier-grid');
    if (grid && typeof grid.scrollIntoView === 'function') {
        grid.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
			
			showToast(`${tier} plan selected! You can change it below if needed.`);
		} else {
			console.error('Invalid plan ID:', planId);
			showToast('Error selecting plan. Please try again.');
		}
	}

	// Expose for inline handlers
    Object.assign(window, { MODEL, money, paymentFees, calcPlanMonthly, calcCartTotal, selectPlanTier, toggleBillingCycle, toggleAddOn, openBuildFirstMonth, renderNewPlanPage, updatePlanSummary, showBuildFirstMonthModal, applyFirstMonthConfiguration, updateBillingToggle, renderPlanRecommendation, selectRecommendedPlan });
	</script>
</head>
<body>
	<!-- Navigation -->
	<nav aria-label="Primary">
		<a href="#" class="logo" onclick="Router.go('landing')" aria-label="Numan home">
			numan <span class="beta-ribbon" aria-label="Beta">BETA</span>
		</a>
		<div class="nav-links" role="navigation">
			<a href="#" onclick="Router.go('landing')">What we treat</a>
			<a href="#" onclick="console.log('Wearables clicked'); Router.go('wearables'); console.log('Router.go called for wearables')" id="nav-wearables" data-nav="wearables">
				Wearables
			</a>
			<a href="#" onclick="Router.go('plan')" id="nav-plan" data-nav="plan">
				Personalised Plan
			</a>
			<a href="#" onclick="Router.go('dashboard')" id="nav-dashboard" data-nav="dashboard">
				Dashboard
			</a>
			<a href="#" onclick="Router.go('streaks')" id="nav-streaks" data-nav="streaks">
				Streaks & Goals <span>🔒</span>
			</a>
			<a href="#" onclick="Router.go('account')" id="nav-account" data-nav="account">
				Account <span>🔒</span>
			</a>
			<a href="#" id="nav-signin" onclick="handleSignInOut()">Sign in</a>
			<div class="device-chips" id="nav-device-chips" aria-label="Connected devices"></div>
		</div>
	</nav>

	<!-- Fixed Reset Demo Button -->
	<button 
		id="reset-demo-btn"
		onclick="resetDemo()"
		style="
			position: fixed;
			bottom: 1rem;
			left: 8rem;
			background: var(--paper);
			border: 1px solid #e5e7eb;
			border-radius: 8px;
			padding: 0.5rem 1rem;
			font-size: 0.8rem;
			color: var(--ink-60);
			cursor: pointer;
			z-index: 1000;
			box-shadow: 0 2px 8px rgba(0,0,0,0.1);
			transition: all 0.2s ease;
		"
		onmouseover="this.style.borderColor='var(--numan-teal)'; this.style.color='var(--numan-teal)'"
		onmouseout="this.style.borderColor='#e5e7eb'; this.style.color='var(--ink-60)'"
	>
		Reset demo
	</button>

	<!-- Feature Flag Toggle removed -->

	<!-- Urgent helper -->
	<!-- Urgent symptoms alert banner removed -->

	<!-- Main App -->
	<div id="app" aria-live="polite">
		<!-- Landing -->
		<section data-view="landing" class="view active">
			<div class="container">
				<div class="hero">
					<div id="campaign-slot">
						<h1 id="campaign-title">Own your healthspan</h1>
						<p id="campaign-subtitle">Clinical, personalised, preventative care—built around you.</p>
						<button class="btn" onclick="startOnboarding()">Get started</button>
					</div>
				</div>

				<!-- Trust & Credibility Badges -->
                <div class="card" style="margin:2rem 0; padding:1.25rem; background:var(--paper); border:1px solid var(--ink-10)">
					<div style="display:flex; justify-content:center; align-items:center; gap:2rem; flex-wrap:wrap">
						<div style="display:flex; align-items:center; gap:0.75rem">
							<div style="width:40px; height:40px; background:linear-gradient(135deg, #803380, #a855a8); border-radius:8px; display:flex; align-items:center; justify-content:center; color:white; font-weight:700; font-size:18px">Q</div>
							<div>
								<div style="font-weight:600; color:var(--ink); font-size:0.9rem">CQC Registered</div>
								<div style="color:var(--ink-60); font-size:0.8rem">Care Quality Commission</div>
							</div>
						</div>
						
						<div style="display:flex; align-items:center; gap:0.75rem">
							<div style="width:40px; height:40px; background:linear-gradient(135deg, #1e40af, #3b82f6); border-radius:8px; display:flex; align-items:center; justify-content:center; color:white; font-weight:700; font-size:14px">🛡️</div>
							<div>
								<div style="font-weight:600; color:var(--ink); font-size:0.9rem">GDPR Compliant</div>
								<div style="color:var(--ink-60); font-size:0.8rem">Data Protection Certified</div>
							</div>
						</div>
						
						<div style="display:flex; align-items:center; gap:0.75rem">
							<div style="width:40px; height:40px; background:linear-gradient(135deg, #059669, #10b981); border-radius:8px; display:flex; align-items:center; justify-content:center; color:white; font-weight:700; font-size:14px">⚕️</div>
							<div>
								<div style="font-weight:600; color:var(--ink); font-size:0.9rem">Clinically Led</div>
								<div style="color:var(--ink-60); font-size:0.8rem">UK Medical Team</div>
							</div>
						</div>
					</div>
				</div>

				<!-- Reclaiming healthy years section -->
				<div class="card" style="margin:2rem 0; padding:1.5rem; background:white; border:1px solid var(--border)">
					<h2 style="text-align:center; margin-bottom:2rem; color:var(--ink)">Reclaiming healthy years</h2>
					
					<div class="card-grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:2rem; margin-bottom:1rem">
						<div>
							<h3 style="color:var(--numan-teal); margin-bottom:1rem">Learn your biological age</h3>
							<p style="color:var(--ink-80); line-height:1.6; margin-bottom:1rem">Go beyond the number on your birth certificate. With advanced testing, you can understand how fast you're really ageing, and spot early signs of chronic conditions before symptoms show.⁷</p>
						</div>
						
						<div>
							<h3 style="color:var(--numan-teal); margin-bottom:1rem">Treat your conditions</h3>
							<p style="color:var(--ink-80); line-height:1.6; margin-bottom:1rem">Don't wait for symptoms to get worse. From high blood pressure to low testosterone, tackling underlying issues early helps prevent long-term damage and keeps you performing at your best.⁸</p>
						</div>
						
						<div>
							<h3 style="color:var(--numan-teal); margin-bottom:1rem">Optimise your life</h3>
							<p style="color:var(--ink-80); line-height:1.6; margin-bottom:1rem">A longer, healthier life isn't about doing more, it's about doing what matters. By understanding your unique biology, you can pinpoint future risks and adopt preventative measures that genuinely work for you.⁷</p>
						</div>
					</div>
				</div>

				<div class="card">
					<h2>Your health decoded</h2>
					<div class="health-tiles-grid" id="landing-tiles"></div>
				</div>
			</div>
		</section>

		<!-- Onboarding -->
		<section data-view="onboarding" class="view" aria-label="Onboarding">
			<div class="container">
				<div class="card">
					<h2>Let's personalise your plan</h2>
					<div id="ob-steps"></div>
						<div style="display:flex; justify-content:space-between; margin-top:1rem">
							<button class="btn btn-secondary" id="ob-back" onclick="obPrev()">Back</button>
							<button class="btn" id="ob-next" onclick="obNext()">Continue</button>
					</div>
					
				</div>
			</div>
		</section>
		<!-- Wearables -->
		<section data-view="wearables" class="view">
			<div class="container">
				<div class="card">
					<h2>Connect your wearables</h2>
					<p class="muted">Connect your device to get personalised insights and track your health progress. You control what data we access.</p>
					
					<div id="wearable-catalogue" class="card-grid" style="margin-top:1rem">
						<!-- Wearable brands will be rendered here -->
					</div>
					
					<div style="display:flex; gap:.5rem; margin:.75rem 0; justify-content:flex-start">
						<div>
						<button class="btn-ghost btn-small" onclick="openModal('manage-devices', manageDevicesModal())">Manage devices</button>
							<button class="btn btn-small" onclick="openModal('request-device', requestDeviceModal())">Request another wearable</button>
						</div>
					</div>

					<!-- Onboarding wearable charts -->
					<div id="ob-wearable-charts" style="display:none">
						<h3>Insights from your device</h3>
						<p style="margin-bottom:1rem; color:var(--ink-60); font-size:0.9rem">Click on any metric below to view detailed charts</p>
						
						<!-- Steps Accordion -->
						<div class="collapsible" style="margin-bottom:1rem; border:1px solid var(--ink-10); border-radius:8px; background:white">
							<div class="collapsible-header" onclick="toggleWearableAccordion(this)" style="display:flex; justify-content:space-between; align-items:center; padding:1rem; cursor:pointer; border-bottom:1px solid var(--ink-05)">
								<div>
									<h4 style="margin:0; font-size:1.1rem; color:var(--ink)"><strong>Steps (28 days)</strong></h4>
									<div style="display:flex; align-items:center; gap:1rem; margin-top:0.25rem">
										<span class="chart-avg" id="ob-steps-avg" style="font-weight:600; color:var(--numan-teal)">--</span>
										<small class="muted" id="ob-steps-change" style="color:var(--ink-60)">--</small>
								</div>
							</div>
								<span style="font-size:1.2rem; color:var(--ink-40); transition:transform 0.2s ease">▼</span>
							</div>
							<div class="collapsible-content" style="display:none; padding:1rem">
							<canvas id="ob-steps-chart" width="900" height="300" aria-label="Steps chart"></canvas>
						</div>
						</div>
						
						<!-- Sleep Accordion -->
						<div class="collapsible" style="margin-bottom:1rem; border:1px solid var(--ink-10); border-radius:8px; background:white">
							<div class="collapsible-header" onclick="toggleWearableAccordion(this)" style="display:flex; justify-content:space-between; align-items:center; padding:1rem; cursor:pointer; border-bottom:1px solid var(--ink-05)">
								<div>
									<h4 style="margin:0; font-size:1.1rem; color:var(--ink)"><strong>Sleep hours (28 days)</strong></h4>
									<div style="display:flex; align-items:center; gap:1rem; margin-top:0.25rem">
										<span class="chart-avg" id="ob-sleep-avg" style="font-weight:600; color:var(--numan-teal)">--</span>
										<small class="muted" id="ob-sleep-change" style="color:var(--ink-60)">--</small>
								</div>
							</div>
								<span style="font-size:1.2rem; color:var(--ink-40); transition:transform 0.2s ease">▼</span>
							</div>
							<div class="collapsible-content" style="display:none; padding:1rem">
							<canvas id="ob-sleep-chart" width="900" height="300" aria-label="Sleep chart"></canvas>
						</div>
						</div>
						
						<!-- RHR Accordion -->
						<div class="collapsible" style="margin-bottom:1rem; border:1px solid var(--ink-10); border-radius:8px; background:white">
							<div class="collapsible-header" onclick="toggleWearableAccordion(this)" style="display:flex; justify-content:space-between; align-items:center; padding:1rem; cursor:pointer; border-bottom:1px solid var(--ink-05)">
								<div>
									<h4 style="margin:0; font-size:1.1rem; color:var(--ink)"><strong>Resting heart rate (28 days)</strong></h4>
									<div style="display:flex; align-items:center; gap:1rem; margin-top:0.25rem">
										<span class="chart-avg" id="ob-rhr-avg" style="font-weight:600; color:var(--numan-teal)">--</span>
										<small class="muted" id="ob-rhr-change" style="color:var(--ink-60)">--</small>
								</div>
							</div>
								<span style="font-size:1.2rem; color:var(--ink-40); transition:transform 0.2s ease">▼</span>
							</div>
							<div class="collapsible-content" style="display:none; padding:1rem">
							<canvas id="ob-rhr-chart" width="900" height="300" aria-label="RHR chart"></canvas>
						</div>
						</div>
						
						<!-- HRV Accordion -->
						<div class="collapsible" style="margin-bottom:1rem; border:1px solid var(--ink-10); border-radius:8px; background:white">
							<div class="collapsible-header" onclick="toggleWearableAccordion(this)" style="display:flex; justify-content:space-between; align-items:center; padding:1rem; cursor:pointer; border-bottom:1px solid var(--ink-05)">
								<div>
									<h4 style="margin:0; font-size:1.1rem; color:var(--ink)"><strong>HRV (28 days)</strong></h4>
									<div style="display:flex; align-items:center; gap:1rem; margin-top:0.25rem">
										<span class="chart-avg" id="ob-hrv-avg" style="font-weight:600; color:var(--numan-teal)">--</span>
										<small class="muted" id="ob-hrv-change" style="color:var(--ink-60)">--</small>
								</div>
							</div>
								<span style="font-size:1.2rem; color:var(--ink-40); transition:transform 0.2s ease">▼</span>
							</div>
							<div class="collapsible-content" style="display:none; padding:1rem">
							<canvas id="ob-hrv-chart" width="900" height="300" aria-label="HRV chart"></canvas>
							</div>
						</div>
					</div>
				</div>
			</div>
		</section>

		<!-- Metabolic Age -->
		<section data-view="metabolic-age" class="view">
			<div class="container">
				<div class="card">
					<h2>Your Biological & Chronological Age</h2>
					
					<!-- 1. Gauge at the top -->
					<div class="card" style="margin-top:1rem">
						<div style="padding:1rem 1rem 0.25rem">
							</div>
						<div style="text-align:center; padding:0.5rem 1rem 0.5rem">
							<div id="bio-age-gauge-container">
								<!-- Gauge will be rendered here -->
						</div>
					</div>
					</div>

					<!-- 2. Health driver chips -->
					<div class="card" style="margin-top:1rem">
						<div style="margin-top:1.5rem">
							<div id="drivers-list"></div>
						</div>
					</div>

					<!-- 3. Compare with peers -->
					<div class="card" style="margin-top:1rem">
						<div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem">
							<div>
								<h4 style="margin:0">Compare with peers</h4>
								<small class="muted">See how your biological age compares to others with similar demographics</small>
							</div>
							<label class="toggle-switch">
						<input id="peer-compare" type="checkbox" onchange="togglePeerComparison()">
								<span class="toggle-slider"></span>
							</label>
					</div>

						<div id="peer-comparison" style="display:none">
							<h5>Your percentile ranking (age ±5y, similar BMI)</h5>
							<div id="peer-bars" style="margin-top:1rem"></div>
						</div>
					</div>

					<!-- 4. Calculation Method -->
        <div class="card" style="margin-top:1rem">
						<div style="background:var(--canvas); padding:1rem; border-radius:8px; border-left:4px solid var(--numan-teal)">
							<h5 style="margin:0 0 0.5rem 0">Calculation Method</h5>
							<p style="margin:0; font-size:0.9rem; color:var(--ink-80)">
								Your biological age is calculated using biomarkers including BMI, waist-to-height ratio, 
								resting heart rate, physical activity, sleep quality, and lifestyle factors. 
								The calculation compares your metrics to age-matched healthy populations.
							</p>
                </div>
            </div>
							
					<!-- 5. Biological Age Inputs at the bottom -->
        <div class="card" style="margin-top:1rem">
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem">
                <div>
                    <h4 style="margin:0">Biological Age Inputs</h4>
                    <small class="muted">Open to view or update the inputs used by the gauge</small>
                </div>
                <label class="toggle-switch">
                    <input id="bio-inputs-toggle" type="checkbox" onchange="toggleBioInputs()">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div id="bio-inputs-content" style="display:none; padding:1rem">
                <div class="card-grid">
                    <div>
                        <div class="form-group">
                            <label>Age</label>
                            <div style="display:flex; gap:0.5rem; align-items:center">
											<input type="number" id="calc-age" placeholder="Enter age" onchange="calculateBiologicalAge(true)" style="flex:1">
                                <input type="text" id="calc-dob" placeholder="YYYY-MM-DD" onchange="calculateAgeFromDOBInput()" onblur="formatDateInput(this)" style="flex:1; color-scheme: light">
                            </div>
                            <small class="muted">Enter either age or date of birth</small>
                        </div>
									<div class="form-group"><label>Height (cm)</label><input type="number" id="calc-height" onchange="calculateBiologicalAge(true)"></div>
									<div class="form-group"><label>Weight (kg)</label><input type="number" id="calc-weight" onchange="calculateBiologicalAge(true)"></div>
									<div class="form-group"><label>Waist (cm)</label><input type="number" id="calc-waist" onchange="calculateBiologicalAge(true)"></div>
									<div class="form-group"><label>Steps/day</label><input type="number" id="calc-steps" onchange="calculateBiologicalAge(true)"></div>
									<div class="form-group"><label>Sleep hours</label><input type="number" step="0.1" id="calc-sleep" onchange="calculateBiologicalAge(true)"></div>
									<div class="form-group"><label>Resting HR</label><input type="number" id="calc-rhr" onchange="calculateBiologicalAge(true)"></div>
									<div class="form-group"><label>Activity mins/week</label><input type="number" id="calc-activity" onchange="calculateBiologicalAge(true)"></div>
                    </div>
                </div>
            </div>
        </div>
							

					<div id="view-plan-section" style="margin-top:1rem"><button class="btn" onclick="Router.go('plan'); setTimeout(() => updateNavLocks(), 100)">View your plan</button></div>
				</div>
			</div>
		</section>

		<!-- Plan - New Pricing System -->
		<section data-view="plan" class="view">
			<div class="container">
				<!-- Active Subscription Display -->
				<div id="active-subscription-display" class="card" style="background:var(--mint-50); border:2px solid var(--numan-teal); margin-bottom:2rem; display:none">
					<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem">
						<div>
							<h3 style="color:var(--numan-teal); margin:0">Active Subscription</h3>
							<p style="margin:0.5rem 0 0 0; color:var(--ink-60)">You have an active health plan subscription</p>
						</div>
						<button class="btn btn-secondary" onclick="togglePlanEditMode()" id="change-plan-btn">Update Plan</button>
					</div>
					<div id="active-plan-details" style="display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:1rem; padding:1rem; background:white; border-radius:8px; border:1px solid var(--mint-50)">
						<!-- Active plan details will be populated here -->
					</div>
				</div>

				<div class="card">
					<h2>Select Your Plan</h2>
					<div class="card" style="background:var(--mint-50); border:2px solid var(--numan-teal); margin-bottom:2rem">
						<h3 style="color:var(--numan-teal); margin-bottom:1rem">How Your Healthspan Subscription Works</h3>
						<p style="margin-bottom:1rem">Your Healthspan subscription includes lab credits, supplements, coaching sessions, and GP consultations. Each plan tier offers different allowances to match your health goals.</p>
						<p style="margin-bottom:0"><strong>Next step:</strong> After selecting your plan, we'll recommend specific test kits, coaching focus areas, and supplements tailored to your health profile.</p>
					</div>
					
					<!-- Budget-Based Recommendation -->
					<div id="budget-recommendation" class="card" style="background:var(--mint-50); border:2px solid var(--numan-teal); margin-bottom:1.5rem; padding:1rem; display:none; max-width:500px; margin-left:auto; margin-right:auto">
						<div id="budget-recommendation-content">
							<!-- Budget recommendation content will be populated here -->
						</div>
					</div>

					<!-- Plan Tiers -->
					<div class="card" style="background:var(--canvas)">
						<h3>Plan Tiers</h3>
						<div class="tiers" id="new-tier-grid">
							<!-- Tiers will be rendered here -->
						</div>
					</div>


			<!-- Standardized Checkout Footer -->
			<div class="checkout-footer" id="plan-checkout-footer">
				<div class="footer-inner">
					<div class="section-left">
						<div class="plan-title" id="footer-plan-title">Select a plan</div>
						<div class="plan-meta" id="footer-plan-meta">Monthly billing</div>
					</div>
					<div class="pricing">
						<div class="row">
							<span class="label">Today:</span>
							<span class="value" id="footer-today-price">£0.00</span>
						</div>
						<div class="row">
							<span class="label">From next month:</span>
							<span class="value" id="footer-next-price">£0.00/mo</span>
						</div>
					</div>
					<div class="actions">
						<button class="btn-secondary" onclick="Router.go('dashboard')" id="back-to-dashboard-btn" style="display:none">← Back to Dashboard</button>
						<button class="checkout-cta" onclick="handleBuildFirstMonthClick()" id="plan-continue-btn" disabled>Select a plan first</button>
					</div>
				</div>
			</div>
			
			<!-- Billing Toggle - moved above footer for better UX -->
			<div class="card" style="background:var(--mint-50); margin-bottom:1rem; padding:1rem; min-height:60px">
				<div style="display:flex; align-items:center; gap:1rem; justify-content:center; min-height:28px">
							<span style="font-weight:600; color:var(--ink-60); min-width:50px">Billing:</span>
							<div style="display:flex; align-items:center; gap:0.5rem; min-width:280px; justify-content:center">
								<span style="font-weight:600; color:var(--ink); min-width:60px; text-align:center">Monthly</span>
								<label class="toggle-switch" style="flex-shrink:0">
									<input type="checkbox" id="billing-toggle" onchange="toggleBillingCycle()">
									<span class="toggle-slider"></span>
								</label>
								<span style="font-weight:600; color:var(--ink); min-width:60px; text-align:center">Annual</span>
								<span style="background:var(--numan-teal); color:white; padding:0.25rem 0.5rem; border-radius:4px; font-size:0.75rem; font-weight:700; flex-shrink:0">10% OFF</span>
							</div>
				</div>
			</div>
		</section>

		<!-- Dashboard -->
		<section data-view="dashboard" class="view">
			<div class="container">
				<!-- Top Row: Overview, Biological Age, Today's Actions -->
				<div class="card-grid">
					<div class="card">
						<h3>Overview</h3>
						<div style="display:flex; gap:1rem; flex-wrap:wrap">
							<div style="min-width:200px">
								<div class="muted">Healthy Engagement</div>
								<div style="font-weight:800; font-size:2rem; color:var(--numan-teal)">78%</div>
							</div>
							<div style="min-width:200px">
								<div class="muted">Current Plan</div>
								<div id="dashboard-plan" style="font-weight:800; font-size:1.5rem">${State.subscription?.tier || State.plan.tier || 'Standard'}</div>
								<div class="footer" id="dashboard-chips"></div>
							</div>
							<div style="min-width:200px">
								<div class="muted">Next action</div>
								<div style="font-weight:800; font-size:1.25rem">Tomorrow</div>
							</div>
						</div>
					</div>

					<div class="card">
						<h3 style="margin-bottom: 1rem; text-align: center;">YOUR BIOLOGICAL AGE</h3>
						<div style="text-align:center">
							<!-- New improved gauge container -->
							<div id="dashboard-bio-gauge-container">
								<!-- Gauge will be rendered here -->
							</div>
							<!-- Fallback for legacy canvas -->
							<canvas id="dashboard-gauge" width="220" height="110" style="display: none;"></canvas>
							<div id="dashboard-age" style="font-size:2rem; font-weight:800; color:var(--numan-teal); display: none;"></div>
							<div id="dashboard-age-diff" style="font-size:1rem; font-weight:600; margin-top:.25rem; display: none;"></div>
						</div>
						<div style="text-align:center; margin-top:1rem">
							<button class="btn btn-outline" onclick="openBiologicalAgePopup()" style="font-size:0.9rem; padding:0.75rem 1.5rem">
								View Detailed Analysis
							</button>
						</div>
					</div>

					<div class="card">
						<h3>Today's actions</h3>
						<div class="checkbox-grid">
							<label class="check-pill">
								<input type="checkbox" onchange="toggleAction(this)">
								<span>Take morning supplements</span>
							</label>
							<label class="check-pill">
								<input type="checkbox" onchange="toggleAction(this)">
								<span>30-minute activity session</span>
							</label>
							<label class="check-pill">
								<input type="checkbox" onchange="toggleAction(this)">
								<span>Log sleep quality</span>
							</label>
						</div>
					</div>
				</div>

				<!-- Risk Flags & Safety Alerts -->
				<div class="card" id="risk-flags-card" style="display:none; margin-top:2rem">
					<h3>Health Alerts</h3>
					<div id="risk-flags-content"></div>
				</div>
				
				<!-- Trends - Full Width Tile -->
				<div class="card" id="trends-card" style="display:none; margin-top:2rem">
					<h3>Trends</h3>
					<div id="trends-content"></div>
				</div>



				<div class="card">
					<h3>Calendar & Upcoming Events</h3>
					<div style="display:grid; grid-template-columns:1fr 1fr; gap:2rem; align-items:start">
						<div>
							<div class="calendar" style="padding:1rem">
						<div class="calendar-header">
							<button class="btn-ghost btn-small" onclick="changeMonth(-1)">←</button>
									<strong id="calendar-month">Loading...</strong>
							<button class="btn-ghost btn-small" onclick="changeMonth(1)">→</button>
						</div>
						<div id="calendar-grid" class="calendar-grid"></div>
					</div>
					<div style="display:flex; gap:.5rem; margin-top:.75rem">
						<button class="btn-ghost btn-small" onclick="openModal('reschedule')">Request change</button>
						<button class="btn-ghost btn-small" onclick="addCoachSession()">Add coach session</button>
							</div>
						</div>
						<div>
							<h4 style="margin:0 0 1rem 0; color:var(--ink-60)">Upcoming Events</h4>
							<div id="calendar-events"></div>
						</div>
					</div>
				</div>

				<div class="card">
					<h3>Assessments</h3>
					<div id="assessments-list"></div>
					<div style="display:flex; gap:.5rem; margin-top:.5rem">
						<button class="btn-ghost btn-small" onclick="addSuggestedAssessment()">Add suggested assessment</button>
					</div>
				</div>

				<div class="footer">
					<!-- Manage subscription button removed -->
				</div>
			</div>
		</section>

		<!-- Build First Month -->
		<section data-view="build-first-month" class="view">
			<div class="container">
				<div class="card">
					<h2>Build your first month</h2>
					<p class="muted">Configure your first month with lab kit, supplement, and coaching focus.</p>
					
					<!-- Get Personalised Recommendations -->
					<div class="card" style="text-align:center; margin:2rem 0; background:linear-gradient(135deg, var(--mint-50) 0%, #f0f9ff 100%); border:2px solid var(--numan-teal); box-shadow: 0 4px 12px rgba(0,0,0,0.1)">
						<div id="plan-allowances" style="margin-bottom:1.5rem; padding:1.5rem; background:white; border-radius:12px; border:1px solid var(--numan-teal)">
							<h4 style="margin:0 0 0.5rem 0; color:var(--numan-teal); font-size:1.2rem">Your Plan Includes:</h4>
							<div id="plan-details" style="font-size:0.9rem; color:var(--ink-60)">
								<!-- Plan details will be populated here -->
							</div>
						</div>
						<button id="btnGetRecs" class="btn btn-primary" style="font-size:1.1rem; padding:1rem 2rem; background:var(--numan-teal); color:white; border:none; border-radius:8px; font-weight:600; box-shadow: 0 2px 8px rgba(0,0,0,0.15); transition:all 0.3s ease" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.15)'" onclick="getEnhancedPersonalisedRecommendations()">Get Personalised Recommendations for Your Plan</button>
						<p style="margin-top:1rem; font-size:0.9rem; color:var(--ink-60)">Let us recommend the best lab tests, supplements, and coaching focus based on your health goals</p>
					</div>
					
					<!-- Lab Kit Selection -->
					<div class="card" style="background:var(--canvas); margin-bottom:1rem; border: 2px solid #f0f9ff; box-shadow: 0 4px 12px rgba(0,0,0,0.05)">
						<div style="margin-bottom:1.5rem">
							<h3 style="margin:0; color:var(--ink); font-size:1.4rem; font-weight:700">Lab Kit</h3>
						</div>
						
                        <div id="lab-credits-info" style="margin-bottom:1rem; padding:0.75rem 1rem; background:var(--paper); border:1px solid var(--ink-10); border-radius:8px">
                            <div style="position:relative; z-index:1">
							<!-- Lab credits info will be populated here -->
						</div>
							</div>
						
						<div style="margin-bottom:1rem">
							<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem">
								<h4 style="margin:0; color:var(--ink); font-size:1.1rem; font-weight:600" id="lab-selection-title">Choose your lab test(s)</h4>
								<div style="display:flex; align-items:center; gap:0.5rem; color:var(--ink-60); font-size:0.9rem">
									<button id="clear-all-labs-btn" class="btn-ghost btn-small" onclick="clearAllLabSelections()" style="padding:0.3rem 0.6rem; font-size:0.8rem; color:var(--ink-60); border:1px solid var(--ink-20)">Clear All</button>
									<span>Click to select</span>
							</div>
							</div>
							
							<div class="lab-credit-counter" style="margin-bottom: 1rem; padding: 0.75rem; background: var(--mint-50); border-radius: 8px; border: 1px solid var(--numan-teal); text-align: center;">
								<!-- Credit counter will be populated here -->
							</div>
							
                            <div style="display:flex; align-items:center; gap:0.75rem; padding:0.75rem 1rem; background:var(--canvas); border-radius:8px; border:1px solid var(--ink-10)">
								<label class="toggle-switch" style="margin:0; transform:scale(1.1)">
									<input type="checkbox" id="use-lab-later" onchange="toggleUseLabLater(this)">
									<span class="toggle-slider"></span>
								</label>
								<div style="display:flex; align-items:center; gap:0.5rem">
									<span style="font-size:1.1rem"></span>
									<span style="font-size:1rem; color:var(--ink-80); font-weight:600">Use my lab credit later</span>
							</div>
								<div style="margin-left:auto; font-size:0.85rem; color:var(--ink-60); font-style:italic">
									Save for next month
						</div>
							</div>
						</div>
						
                        <div id="lab-selection" class="lab-grid" style="gap:0.75rem">
							<!-- Lab options will be rendered here -->
						</div>
					</div>

					<!-- Supplement Selection -->
					<div class="card" style="background:var(--canvas); margin-bottom:1rem">
						<h3>Supplement</h3>
                        <div id="supplement-allowance-info" style="margin-bottom:0.75rem; padding:0.5rem 0.75rem; background:var(--paper); border-radius:8px; border:1px solid var(--ink-10); font-size:0.9rem; color:var(--ink-60)">
							<!-- Supplement allowance info will be populated here -->
						</div>
						<div id="supplement-selection" class="supplement-grid">
							<!-- Supplement options will be rendered here -->
						</div>
					</div>

					<!-- Coaching Focus -->
					<div class="card" style="background:var(--canvas); margin-bottom:2rem">
						<h3>Coaching Focus</h3>
						<div id="coaching-allowance-info" style="margin-bottom:1rem; padding:0.75rem; background:var(--mint-50); border-radius:6px; border:1px solid var(--numan-teal); font-size:0.9rem; color:var(--ink-60)">
							<!-- Coaching allowance info will be populated here -->
						</div>
						<div id="coaching-selection" class="coaching-grid">
							<!-- Coaching options will be rendered here -->
						</div>
					</div>

					<!-- Standardized Checkout Footer -->
					<div class="checkout-footer" id="coaching-checkout-footer">
						<div class="footer-inner">
                            <div class="section-left">
                                <div class="plan-title" id="footer-coaching-plan-title">Standard Plan</div>
                                <div class="plan-meta" id="footer-coaching-meta" style="display:none">15 min coaching this month</div>
                                <div class="plan-details" id="footer-coaching-details" style="display:none">Focus: General wellness</div>
						</div>
							<div class="pricing">
								<div class="row">
									<span class="label">Today:</span>
									<span class="value" id="footer-coaching-today">£0.00</span>
						</div>
								<div class="row">
									<span class="label">From next month:</span>
									<span class="value" id="footer-coaching-next">£0.00/mo</span>
								</div>
							</div>
							<div class="actions">
								<button class="btn-secondary" onclick="Router.go('plan')">← Back</button>
								<button class="checkout-cta" onclick="goToAddons()">Continue to add-ons →</button>
							</div>
						</div>
					</div>
				</div>
			</div>
		</section>

		<!-- Add-ons Page -->
		<section data-view="addons" class="view">
			<div class="container">
				<div class="card">
					<h2>Add-ons</h2>
					<p class="muted">Enhance your plan with additional services and products.</p>
					
					<!-- Member Add-ons -->
                    <div class="card" style="background:var(--paper); border:1px solid var(--ink-10); margin-bottom:1rem">
						<h3>Member add-ons (optional)</h3>
						<div id="addon-steppers">
							<!-- Addon steppers will be rendered here -->
						</div>
					</div>

					<!-- Standardized Checkout Footer -->
					<div class="checkout-footer" id="addons-checkout-footer">
						<div class="footer-inner">
                            <div class="section-left">
                                <div class="plan-title" id="footer-addons-plan-title">Standard Plan</div>
                                <div class="plan-meta" id="footer-addons-meta" style="display:none">No add-ons selected</div>
                                <div class="plan-details" id="footer-addons-details" style="display:none">Base plan + selected add-ons</div>
						</div>
							<div class="pricing">
								<div class="row">
									<span class="label">Base plan:</span>
									<span class="value" id="footer-addons-base">£0.00</span>
								</div>
								<div class="row" id="footer-addons-addons-row" style="display:none">
									<span class="label">Add-ons:</span>
									<span class="value" id="footer-addons-addons">£0.00</span>
								</div>
								<div class="row">
									<span class="label">Today:</span>
									<span class="total-value" id="footer-addons-total">£0.00</span>
								</div>
								<div class="row">
									<span class="label">From next month:</span>
									<span class="value" id="footer-addons-next">£0.00/mo</span>
								</div>
							</div>
							<div class="actions">
								<button class="btn-secondary" onclick="Router.go('build-first-month')">← Back</button>
							<button type="button" class="checkout-cta" onclick="goToCheckout()">Continue to checkout →</button>
							</div>
						</div>
					</div>
				</div>
			</div>
		</section>

		<!-- Checkout -->
		<section data-view="checkout" class="view">
			<div class="container">
				<div class="card">
					<div style="display:flex; align-items:center; gap:1rem; margin-bottom:1rem">
						<button class="btn btn-secondary" onclick="Router.go('addons')" style="display:flex; align-items:center; gap:0.5rem">
							← Back
						</button>
						<h2 style="margin:0">Checkout</h2>
					</div>
					
					<!-- Order Summary -->
					<div class="card" style="background:var(--canvas); margin-bottom:1rem">
						<h3>Order Summary</h3>
					<div id="checkout-summary"></div>
				</div>

					<!-- Checkout Totals -->
					<div id="checkout-totals" class="card" style="background:var(--mint-50); margin-bottom:1rem">
						<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem">
							<div>Today:</div>
							<strong id="summary-today">£0.00</strong>
						</div>
						<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem">
							<div>From next month:</div>
							<strong id="summary-next">£0.00/mo</strong>
						</div>
					</div>

					<!-- User Details -->
					<div class="card" style="margin-bottom:1rem">
						<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem">
							<h3>Your Details</h3>
							<button class="btn btn-secondary btn-small" onclick="populateDemoCheckoutData()" style="font-size:0.8rem; padding:0.4rem 0.8rem">
								Fill Demo Data
							</button>
						</div>
					<div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:1rem; margin-bottom:1.5rem">
						<div class="form-group">
							<label>First name</label>
							<input type="text" id="checkout-firstname" placeholder="Enter your first name">
						</div>
						<div class="form-group">
							<label>Last name</label>
							<input type="text" id="checkout-lastname" placeholder="Enter your last name">
						</div>
						<div class="form-group">
							<label>Email address</label>
							<input type="email" id="checkout-email" placeholder="your.email@example.com">
						</div>
						<div class="form-group">
							<label>Phone number</label>
							<input type="tel" id="checkout-phone" placeholder="+44 7xxx xxx xxx">
						</div>
					</div>
					</div>

					<!-- Payment Information -->
					<div class="card" style="margin-bottom:1rem">
						<h3>Payment Information</h3>
						<div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:1rem; margin-bottom:1.5rem">
							<div class="form-group">
								<label>Card number</label>
								<input type="text" id="checkout-card" placeholder="1234 5678 9012 3456">
						</div>
							<div class="form-group">
								<label>Expiry date</label>
								<input type="text" id="checkout-expiry" placeholder="MM/YY">
					</div>
					<div class="form-group">
								<label>CVC</label>
								<input type="text" id="checkout-cvc" placeholder="123">
					</div>
						</div>
					</div>

					<!-- Discount Codes -->
					<div class="card" style="margin-bottom:1rem">
						<h3>Discount codes</h3>
						
						<div class="form-group">
							<label style="font-weight:600; color:var(--numan-teal); margin-bottom:0.5rem; display:block">Employer/Gym code</label>
							<input id="employer-code-input" type="text" placeholder="EMP-xxxx or GYM-xxxx" oninput="onEmployerCodeChange()">
						</div>
						
						<div class="form-group">
							<label style="font-weight:600; color:var(--numan-teal); margin-bottom:0.5rem; display:block">Coupon code</label>
							<input id="coupon-input" type="text" placeholder="Enter coupon" oninput="onCouponChange()">
						</div>
					</div>

					<!-- Consent -->
					<div class="card" style="margin-bottom:1rem">
						<label class="check-pill">
							<input type="checkbox" id="consent-checkbox">
							<span>I understand this is an educational service and not a medical device.</span>
						</label>
						<label class="check-pill">
							<input type="checkbox" id="checkout-terms">
							<span>I agree to the <a href="#" style="color:var(--numan-teal)">Terms of Service</a> and <a href="#" style="color:var(--numan-teal)">Privacy Policy</a></span>
						</label>
						<label class="check-pill">
							<input type="checkbox" id="checkout-marketing">
							<span>I'd like to receive marketing communications and health tips</span>
						</label>
					</div>

					<!-- Confirm Button -->
					<div style="text-align:center">
						<button class="btn" onclick="confirmCheckout()">Confirm & start</button>
					</div>
				</div>
			</div>
			
			<!-- Checkout footer removed: totals are shown above on this page -->
		</section>

		<!-- Account -->
		<section data-view="account" class="view">
			<div class="container">
				
				<!-- Urgent Symptoms Banner -->
				<div class="card" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 2px solid #0ea5e9; margin-bottom: 2rem; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(14, 165, 233, 0.15)">
					<div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem">
						<div style="display: flex; align-items: center; gap: 0.75rem">
							<div style="color: #ef4444; font-size: 1.2rem; font-weight: bold">▲</div>
							<div>
								<div style="font-weight: 700; color: var(--ink); margin-bottom: 0.25rem">Urgent symptoms?</div>
								<div style="color: var(--ink-60); font-size: 0.9rem">
									For urgent concerns contact <a href="tel:111" style="color: #ef4444; text-decoration: underline; font-weight: 600">NHS 111/999</a>.
								</div>
							</div>
						</div>
						<button class="btn" onclick="checkSubscriptionAndMessage()" style="background: white; color: var(--ink); border: 1px solid #e5e7eb; border-radius: 8px; padding: 0.75rem 1.5rem; font-weight: 600; white-space: nowrap">
							Message a clinician
						</button>
					</div>
				</div>
				
				<!-- Top Row: Personal Information and Current Plan -->
				<div class="account-top-row">
					<div class="card account-personal-info">
						<h3>Personal Information</h3>
						<div class="form-group">
							<label>Full Name</label>
							<input type="text" id="account-name" value="" readonly>
						</div>
						<div class="form-group">
							<label>Email</label>
							<input type="email" id="account-email" value="" readonly>
						</div>
						<div class="form-group">
							<label>Phone Number</label>
							<input type="tel" id="account-phone" value="" readonly>
						</div>
						<div class="form-group">
							<label>Date of Birth</label>
							<input type="date" id="account-dob" value="" readonly>
						</div>
					</div>
					
					<div class="card account-current-plan">
						<h3>Current Plan</h3>
						<div id="account-plan-details">
							<p class="muted">No active plan</p>
						</div>
						<div style="margin-top:1.5rem; display:flex; flex-direction:column; gap:0.75rem">
							<button class="btn" onclick="openManageSubscriptionModal()">Manage subscription</button>
							<button class="btn btn-secondary" onclick="Router.go('plan')">Change Plan</button>
						</div>
					</div>
					
				</div>
				
				<!-- Bottom Row: Referral Program and Support -->
				<div class="account-bottom-row">
					<div class="card account-referral">
						<h3>Referral Program</h3>
						<div class="form-group">
							<label>Your Referral Code</label>
							<div style="display:flex; gap:0.5rem; align-items:center">
								<input type="text" id="referral-code" value="" readonly style="flex:1">
								<button class="btn-ghost btn-small" onclick="copyReferralCode()">Copy</button>
							</div>
						</div>
						<div class="form-group">
							<label>Referral Link</label>
							<div style="display:flex; gap:0.5rem; align-items:center">
								<input type="text" id="referral-link" value="" readonly style="flex:1">
								<button class="btn-ghost btn-small" onclick="copyReferralLink()">Copy</button>
							</div>
						</div>
						<small class="muted">Share your referral code with friends and earn credits when they subscribe!</small>
					</div>
					
					<div class="card account-support">
						<h3>Feedback & Support</h3>
						<div style="display:flex; flex-direction:column; gap:0.75rem">
							<button class="btn-ghost" onclick="openFeedbackModal()" style="text-align:left; padding:0.75rem; border:1px solid #e5e7eb; border-radius:8px; background:white">
								<div style="font-weight:600; margin-bottom:0.25rem">📝 Give Feedback</div>
								<div style="font-size:0.9rem; color:var(--ink-60)">Help us improve your experience</div>
							</button>
							<button class="btn-ghost" onclick="openSupportModal()" style="text-align:left; padding:0.75rem; border:1px solid #e5e7eb; border-radius:8px; background:white">
								<div style="font-weight:600; margin-bottom:0.25rem">🆘 Get Support</div>
								<div style="font-size:0.9rem; color:var(--ink-60)">Contact our support team</div>
							</button>
							<button class="btn-ghost" onclick="checkSubscriptionAndMessage()" style="text-align:left; padding:0.75rem; border:1px solid #e5e7eb; border-radius:8px; background:white">
								<div style="font-weight:600; margin-bottom:0.25rem">💬 Message Clinician</div>
								<div style="font-size:0.9rem; color:var(--ink-60)">Chat with your health coach</div>
							</button>
						</div>
					</div>
					
					<!-- Wearables Data Section removed for account page -->
				</div>
			</div>
		</section>

		<!-- Streaks & Goals -->
		<section data-view="streaks" class="view">
			<div class="container">
				<div class="hero">
					<h1>Streaks & Goals</h1>
					<p>Track your progress and celebrate your health journey</p>
				</div>

				<!-- XP and Level Display -->
				<div class="card" style="text-align:center; margin-bottom:2rem">
					<div style="display:flex; justify-content:center; align-items:center; gap:1rem; margin-bottom:1rem">
						<div style="font-size:2rem; font-weight:800; color:var(--numan-teal)" id="current-level">Lv 1</div>
						<div style="font-size:1.2rem; color:var(--ink-60)">·</div>
						<div style="font-size:1.5rem; font-weight:600; color:var(--ink)" id="current-xp">0 XP</div>
					</div>
					<div style="background:#e5e7eb; height:8px; border-radius:4px; overflow:hidden; margin-bottom:1rem">
						<div style="background:var(--numan-teal); height:100%; transition:width 0.3s ease" id="xp-progress-bar"></div>
					</div>
					<small class="muted" id="xp-to-next">200 XP to next level</small>
				</div>

				<!-- Wearables & Health Data -->
				<div id="streaks-wearables" class="card" style="margin-bottom:2rem">
					<h3>Wearables & Health Data</h3>
					<div id="streaks-wearables-content">
						<!-- Wearables content will be rendered here -->
					</div>
				</div>

				<!-- Daily Streaks -->
					<div class="card">
					<div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem">
						<div style="
							width: 40px;
							height: 40px;
							background: linear-gradient(135deg, var(--numan-teal), #0ea5e9);
							border-radius: 12px;
							display: flex;
							align-items: center;
							justify-content: center;
							font-size: 1.2rem;
						">🔥</div>
						<div>
							<h3 style="margin: 0; color: var(--ink); font-size: 1.4rem; font-weight: 700">Daily Streaks</h3>
							<p style="margin: 0; color: var(--ink-60); font-size: 0.9rem">Track your daily health goals</p>
					</div>
					</div>
					<div id="daily-streaks-grid" class="streaks-grid">
						<!-- Daily streaks content will be rendered here -->
					</div>
				</div>

				<!-- Active Quests -->
				<div class="card">
					<h3>🎯 Active Quests</h3>
					<div id="active-quests">
						<p class="muted">Loading quests...</p>
					</div>
				</div>

				<!-- Badges -->
				<div class="card">
					<h3>🏆 Badges Earned</h3>
					<div class="card-grid" style="grid-template-columns:repeat(auto-fit,minmax(200px,1fr))" id="badges-container">
						<p class="muted">Loading badges...</p>
					</div>
				</div>

				<!-- Labs Hub (if blood tests are selected) -->
				<div class="card" id="labs-hub-card" style="display:none">
					<h3>🧪 Labs & Test Results</h3>
					<div id="labs-hub">
						<p class="muted">Loading lab results...</p>
					</div>
				</div>
			</div>
		</section>
	</div>

	<!-- Coach chat -->
	<button class="coach-button" aria-label="Coach chat" onclick="toggleCoachChat()">
		<svg width="26" height="26" fill="#fff" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 3C6.486 3 2 6.589 2 11c0 1.923.744 3.695 2 5.117V21l4.078-2.039C9.155 19.64 10.543 20 12 20c5.514 0 10-3.589 10-9s-4.486-8-10-8z"/></svg>
	</button>
	<div class="coach-panel" id="coach-panel" role="dialog" aria-modal="true" aria-label="Coach chat">
		<div class="coach-header">
			<strong>Dr. Sarah — Health Coach</strong>
			<button class="btn-ghost btn-small" onclick="toggleCoachChat()" aria-label="Close chat">×</button>
		</div>
		
		<!-- Plan Information and Actions -->
		<div id="coach-plan-info" class="coach-plan-info">
			<!-- Plan info will be populated here -->
		</div>
		
		<div id="coach-messages" class="coach-messages"></div>
		<div class="coach-input">
			<input id="coach-input" type="text" placeholder="Type a message..." onkeydown="if(event.key==='Enter')sendCoachMessage()">
			<button class="btn btn-small" onclick="sendCoachMessage()">Send</button>
		</div>
	</div>

	<!-- Modal -->
	<div id="modal" class="modal" onclick="closeModal(event)">
		<div id="modal-content" class="modal-content" tabindex="-1"></div>
	</div>

	<!-- Recommendations Modal -->
	<div id="recsModal" class="modal" onclick="closeModal(event)">
		<div class="modal-content" tabindex="-1">
			<h3 style="margin:0 0 1rem 0; font-size:1.5rem; line-height:1.3; font-weight:700; color:#111827; text-align:center; letter-spacing:0.02em">YOUR PERSONALISED HEALTH PLAN</h3>
			<div class="modal-body">
				<!-- Content will be dynamically generated here -->
			</div>
			<div style="margin-top:0.75rem; text-align:center; display:flex; gap:0.75rem; justify-content:center; padding-top:0.5rem; border-top:1px solid #e5e7eb">
				<button class="btn btn-secondary" data-close="recsModal" style="padding:0.5rem 1rem; font-size:0.9rem">Close</button>
				<button id="btnApplyRecs" class="btn btn-primary" style="padding:0.5rem 1rem; font-size:0.9rem">Apply Recommendations</button>
			</div>
		</div>
	</div>

	<!-- Assessment Modal -->
	<div id="assessment-modal" class="modal" onclick="closeModal(event)">
		<div class="modal-content" tabindex="-1">
			<div class="modal-body" id="assessment-body">
				<!-- Assessment content will be rendered here -->
			</div>
		</div>
	</div>

	<!-- Biological Age Explanation Modal -->
	<div id="bio-age-explanation-modal" class="modal" onclick="if(event.target.id==='bio-age-explanation-modal') document.getElementById('bio-age-explanation-modal').classList.remove('active')">
		<div class="modal-content" tabindex="-1">
			<h3>How we calculate your biological age</h3>
			<div class="modal-body">
				<div class="calculation-summary">
					<h4>Your Current Calculation</h4>
					<div class="summary-row">
						<span>Chronological Age:</span>
						<strong id="modal-chronological-age">33 years</strong>
					</div>
					<div class="summary-row">
						<span>Biological Age:</span>
						<strong id="modal-biological-age">31.0 years</strong>
					</div>
					<div class="summary-row">
						<span>Difference:</span>
						<strong id="modal-difference" style="color: #10b981">-2.0 years</strong>
					</div>
				</div>
				
				<div class="calculation-section">
					<h4>Detailed Driver Breakdown</h4>
					<div class="calculation-grid">
						<div class="calculation-item">
							<span>BMI & Waist-to-Height Ratio</span>
							<span class="badge">25%</span>
						</div>
						<div class="calculation-item">
							<span>Resting Heart Rate</span>
							<span class="badge">20%</span>
						</div>
						<div class="calculation-item">
							<span>Sleep Quality & Duration</span>
							<span class="badge">20%</span>
						</div>
						<div class="calculation-item">
							<span>Physical Activity</span>
							<span class="badge">15%</span>
						</div>
						<div class="calculation-item">
							<span>Lifestyle Factors (smoking, alcohol)</span>
							<span class="badge">10%</span>
						</div>
						<div class="calculation-item">
							<span>Age & Demographics</span>
							<span class="badge">10%</span>
						</div>
					</div>
				</div>
				
				<div class="calculation-section">
					<h4>Calculation Method</h4>
					<p style="color: #6b7280; font-size: 0.9rem; line-height: 1.5; margin: 0;">
						Our biological age calculator uses a proprietary algorithm based on peer-reviewed research 
						linking lifestyle factors to cellular aging markers. The calculation considers multiple 
						health indicators and applies weighted scoring to determine your biological age relative 
						to your chronological age.
					</p>
				</div>
				
				<div class="calculation-section">
					<h4>Update Frequency</h4>
					<p style="color: #6b7280; font-size: 0.9rem; line-height: 1.5; margin: 0;">
						Your biological age is recalculated automatically when you update any health data. 
						For the most accurate results, we recommend updating your metrics monthly or after 
						significant lifestyle changes.
					</p>
				</div>
				
				<div class="calculation-note">
					<h5>Important Note</h5>
					<p>
						This calculation is for informational purposes only and is not a medical diagnosis. 
						It should not replace professional medical advice. Individual results may vary based 
						on genetics, medical conditions, and other factors not captured in this assessment.
					</p>
				</div>
			</div>
			<div class="modal-footer" style="display:flex; justify-content:flex-end; margin-top:1.5rem; padding-top:1rem; border-top:1px solid #e5e7eb">
				<button class="btn" onclick="document.getElementById('bio-age-explanation-modal').classList.remove('active')">Close</button>
			</div>
		</div>
	</div>

	<!-- Driver Playbook Modal -->
	<div id="driver-playbook-modal" onclick="closeModal(event)">
		<div class="modal-content" tabindex="-1">
			<div class="modal-header">
				<h3 class="modal-title">Driver Playbook</h3>
				<button class="btn-ghost" onclick="closeDriverPlaybookModal()" style="position: absolute; top: 1rem; right: 1rem; padding: 0.75rem; font-size: 1.2rem; font-weight: bold;">✕</button>
			</div>
			<div class="modal-body">
				<!-- Playbook content will be dynamically generated here -->
			</div>
			<div class="modal-footer" style="padding: 1rem 1.5rem; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end;">
				<button class="btn btn-secondary" onclick="closeDriverPlaybookModal()">Close</button>
			</div>
		</div>
	</div>

	<!-- Toast -->
	<div id="toast" class="toast" aria-live="polite"></div>

	<!-- Tests badge -->
    <div id="tests-badge" class="tests-badge" title="Tests running..." style="display:none">Tests: 0/0</div>

	<script>
        // =============== ADDITIONAL UTILITIES ===============
        function load(keys){ const out={}; if (Array.isArray(keys)) keys.forEach(k=>out[k]=read(k)); return out; }
	function toggleCollapsible(el){ const root=el.closest('.collapsible'); root.classList.toggle('open'); }
	
	function toggleWearableAccordion(header) {
		const content = header.nextElementSibling;
		const arrow = header.querySelector('span:last-child');
		
		if (content && arrow) {
			const isVisible = content.style.display !== 'none';
			
			if (isVisible) {
				// Close the accordion
				content.style.display = 'none';
				arrow.textContent = '▼';
				arrow.style.transform = 'rotate(0deg)';
				header.setAttribute('aria-expanded', 'false');
			} else {
				// Open the accordion
				content.style.display = 'block';
				arrow.textContent = '▲';
				arrow.style.transform = 'rotate(0deg)';
				header.setAttribute('aria-expanded', 'true');
			}
		}
	}
	function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }

        // Wearables persistence helpers
	function lsGet(k, d) { 
		try { 
			return JSON.parse(localStorage.getItem(LS_PREFIX + k)) ?? d; 
		} catch (e) { 
			return d; 
		} 
	}
	function lsSet(k, v) { 
		localStorage.setItem(LS_PREFIX + k, JSON.stringify(v)); 
	}

	function loadWearablesFromStorage() {
		const prov = lsGet("wearables.providers", null);
		const ser = lsGet("wearables.series", null);
		if (prov) State.wearables.providers = prov;
		if (ser) State.wearables.series = ser;
	}

	function saveWearables() {
		lsSet("wearables.providers", State.wearables.providers || []);
		lsSet("wearables.series", State.wearables.series || {});
	}

	// Centralized wearables data access functions for consistency
	function getWearablesData(type, days = 7) {
		if (!State.wearables.series || !State.wearables.series[type] || State.wearables.series[type].length === 0) {
			return null;
		}
		
		const data = State.wearables.series[type];
		const recentData = data.slice(-days);
		
		switch (type) {
			case 'steps':
				return {
					latest: data.slice(-1)[0] || 0,
					average: Math.round(recentData.reduce((a, b) => a + b, 0) / recentData.length),
					formatted: `${Math.round(recentData.reduce((a, b) => a + b, 0) / recentData.length / 1000)}k`,
					raw: recentData
				};
			case 'sleep':
				return {
					latest: data.slice(-1)[0] || 0,
					average: recentData.reduce((a, b) => a + b, 0) / recentData.length,
					formatted: `${(recentData.reduce((a, b) => a + b, 0) / recentData.length).toFixed(1)}h`,
					raw: recentData
				};
			case 'rhr':
				return {
					latest: data.slice(-1)[0] || 0,
					average: Math.round(recentData.reduce((a, b) => a + b, 0) / recentData.length),
					formatted: `${Math.round(recentData.reduce((a, b) => a + b, 0) / recentData.length)}bpm`,
					raw: recentData
				};
			case 'hrv':
				return {
					latest: data.slice(-1)[0] || 0,
					average: recentData.reduce((a, b) => a + b, 0) / recentData.length,
					formatted: `${(recentData.reduce((a, b) => a + b, 0) / recentData.length).toFixed(1)}ms`,
					raw: recentData
				};
			default:
				return null;
		}
	}

	// Ensure wearables data consistency across all pages
	function ensureWearablesDataConsistency() {
		// Generate data if needed
		if (!State.wearables.series || !State.wearables.series.steps || State.wearables.series.steps.length === 0) {
			generateWearableSeries();
		}
		
		// Update all displays that use wearables data
		if (State.currentView === 'wearables') {
			updateWearablesDataDisplay();
		}
		if (State.currentView === 'metabolic-age') {
			calculateBiologicalAge();
		}
		if (State.currentView === 'account') {
			// Update account page wearables display if it exists
			updateAccountWearablesDisplay();
		}
	}

	// Update account page wearables display
	function updateAccountWearablesDisplay() {
    const wearablesSection = document.getElementById('account-wearables-data');
    if (!wearablesSection) return; // Section removed on account page; keep function harmless

		const stepsData = getWearablesData('steps');
		const sleepData = getWearablesData('sleep');
		const rhrData = getWearablesData('rhr');
		const hrvData = getWearablesData('hrv');

		wearablesSection.innerHTML = `
			<div class="wearables-summary">
				<h4>Recent Health Data</h4>
				<div class="wearables-grid">
					${stepsData ? `
						<div class="wearable-metric">
							<span class="metric-label">Steps (7-day avg)</span>
							<span class="metric-value">${stepsData.formatted}</span>
						</div>
					` : ''}
					${sleepData ? `
						<div class="wearable-metric">
							<span class="metric-label">Sleep (7-day avg)</span>
							<span class="metric-value">${sleepData.formatted}</span>
						</div>
					` : ''}
					${rhrData ? `
						<div class="wearable-metric">
							<span class="metric-label">Resting HR (7-day avg)</span>
							<span class="metric-value">${rhrData.formatted}</span>
						</div>
					` : ''}
					${hrvData ? `
						<div class="wearable-metric">
							<span class="metric-label">HRV (7-day avg)</span>
							<span class="metric-value">${hrvData.formatted}</span>
						</div>
					` : ''}
				</div>
			</div>
		`;
	}

	// =============== FIXED SEMICIRCLE BIOLOGICAL AGE GAUGE REMOVED ===============
	// Legacy fixed gauge implementation fully removed; using new working SVG gauge below

    // Enhanced Biological Age Gauge - Clinical Specification Implementation
    function renderBiologicalAgeGauge(chronologicalAge, biologicalAge, containerId) {
        try {
            const container = document.getElementById(containerId);
            if (!container) return false;

            // Enhanced geometry for clinical precision - moved down for better centering
            const cx = 200, cy = 180, r = 140; // moved down to center gauge better in container
            const startDeg = -90, endDeg = 90; // semicircle spanning 180°
            const toRad = d => (d - 90) * Math.PI / 180; // convert deg to SVG polar (0deg=up)
            const polar = (deg, radius=r) => ({
                x: cx + radius * Math.cos(toRad(deg)),
                y: cy + radius * Math.sin(toRad(deg))
            });
            const arcPath = (a1, a2, radius=r) => {
                const p1 = polar(a1, radius), p2 = polar(a2, radius);
                const large = Math.abs(a2 - a1) > 180 ? 1 : 0;
                return `M ${p1.x.toFixed(2)} ${p1.y.toFixed(2)} A ${radius} ${radius} 0 ${large} 1 ${p2.x.toFixed(2)} ${p2.y.toFixed(2)}`;
            };

            // Dynamic content with clinical scale
            const delta = biologicalAge - chronologicalAge;
            const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
            const minDelta = -10, maxDelta = 10; // clinical scale window
            const norm = (clamp(delta, minDelta, maxDelta) - minDelta) / (maxDelta - minDelta); // 0..1
            const needleDeg = startDeg + norm * (endDeg - startDeg);

            // Clinical color zones with gradual transitions
            const segs = [
                { from: -90, to: -30, color: '#16a34a' }, // Green zone: 2+ years younger
                { from: -30, to: 30,  color: '#f59e0b' }, // Amber zone: ±2 years
                { from: 30,  to: 90,  color: '#ef4444' }  // Red zone: 2+ years older
            ];

            // Clinical differential color coding
            let deltaColor, zoneLabel;
            if (delta < -2) {
                deltaColor = '#16a34a'; // Green
                zoneLabel = 'Significantly younger';
            } else if (delta <= 2) {
                deltaColor = '#f59e0b'; // Amber
                zoneLabel = 'Age-Appropriate';
            } else {
                deltaColor = '#ef4444'; // Red
                zoneLabel = 'Significantly older';
            }

            // Build clinical-grade SVG with enhanced visual hierarchy
            const segments = segs.map(s => `<path d="${arcPath(s.from, s.to)}" stroke="${s.color}" stroke-width="16" fill="none" stroke-linecap="round" class="gauge-segment"/>`).join('');

            // Background arc for clinical context
            const bg = `<path d="${arcPath(startDeg, endDeg)}" stroke="#e5e7eb" stroke-width="16" fill="none" stroke-linecap="round" opacity="0.3"/>`;

            // Scale markers for clinical precision (-10 to +10 years)
            const tickMarks = [];
            const tickValues = [-10, -8, -6, -4, -2, 0, 2, 4, 6, 8, 10];
            tickValues.forEach(value => {
                const tickNorm = (value - minDelta) / (maxDelta - minDelta);
                const tickDeg = startDeg + tickNorm * (endDeg - startDeg);
                const tickPos = polar(tickDeg, r - 25);
                const labelPos = polar(tickDeg, r - 45);
                const isMajor = value === 0 || Math.abs(value) === 10;
                const tickLength = isMajor ? 12 : 8;
                
                tickMarks.push(`<line x1="${tickPos.x.toFixed(2)}" y1="${tickPos.y.toFixed(2)}" x2="${(tickPos.x + tickLength * Math.cos(toRad(tickDeg))).toFixed(2)}" y2="${(tickPos.y + tickLength * Math.sin(toRad(tickDeg))).toFixed(2)}" stroke="#6b7280" stroke-width="${isMajor ? 2 : 1}" stroke-linecap="round"/>`);
                
                if (isMajor) {
                    tickMarks.push(`<text x="${labelPos.x.toFixed(2)}" y="${labelPos.y.toFixed(2)}" text-anchor="middle" font-family="Inter, sans-serif" font-weight="600" font-size="12" fill="#6b7280" dominant-baseline="central">${value}</text>`);
                }
            });

            // Enhanced needle with platform teal color
            const needleEnd = polar(needleDeg, r - 20);
            const needle = `<line x1="${cx}" y1="${cy}" x2="${needleEnd.x.toFixed(2)}" y2="${needleEnd.y.toFixed(2)}" stroke="#1ecfc0" stroke-width="4" stroke-linecap="round" class="gauge-needle"/>`;
            const hub = `<circle cx="${cx}" cy="${cy}" r="6" fill="#fff" stroke="#1ecfc0" stroke-width="3" class="gauge-hub"/>`;

            // Clinical typography hierarchy
            // Position text further down to avoid overlapping with gauge needle
            const ageTextY = cy + 45;
            const diffTextY = cy + 70;

            const svg = `
                <svg viewBox="0 0 400 300" width="100%" height="300" aria-label="Biological age clinical gauge" style="max-width: 720px;">
                    ${bg}
                    ${segments}
                    ${tickMarks.join('')}
                    ${needle}
                    ${hub}
                    <!-- Large biological age number -->
                    <text x="${cx}" y="${ageTextY}" text-anchor="middle" font-family="Inter, sans-serif" font-weight="800" font-size="40" fill="#111827" class="biological-age-number">${biologicalAge.toFixed(1)}</text>
                    <!-- Color-coded differential -->
                    <text x="${cx}" y="${diffTextY}" text-anchor="middle" font-family="Inter, sans-serif" font-weight="700" font-size="20" fill="${deltaColor}" class="age-differential">${delta > 0 ? '+' : ''}${delta.toFixed(1)} vs your age</text>
                </svg>`;

            container.innerHTML = `<div class="bio-age-gauge-container" style="text-align: center;"><div class="bio-age-gauge">${svg}</div></div>`;
            return true;
        } catch(e){ console.error('Enhanced gauge render failed', e); return false; }
    }

    /**
     * Updates the display values in the collapsible biological age section
     */
    function updateBiologicalAgeDisplayValues(age, height, weight, waist, steps, sleep, rhr, activity) {
        const displayElements = {
            'display-age': age || '--',
            'display-height': height || '--',
            'display-weight': weight || '--',
            'display-waist': waist || '--',
            'display-steps': steps || '--',
            'display-sleep': sleep || '--',
            'display-rhr': rhr || '--',
            'display-activity': activity || '--'
        };

        Object.entries(displayElements).forEach(([id, value]) => {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = value;
            }
        });
    }

	// =============== PLAN STATE MANAGEMENT ===============
	function updatePlanState() {
		// Check if user has an active subscription
		const hasActiveSubscription = State.subscription?.active && State.subscription?.status === 'active';
		const activePlanTier = hasActiveSubscription ? (State.subscription?.tier || State.plan?.tier) : null;
		
		// Update plan state
		State.planState = {
			hasActiveSubscription,
			activePlanTier,
			selectedPlanTier: State.plan?.tier || null,
			newPlanTier: HS.editMode ? State.plan?.tier : null,
			isEditingPlan: HS.editMode || false,
			canProceedToBuildMonth: !hasActiveSubscription && State.plan?.tier !== null
		};
		
		// Save plan state
		save({'planState': State.planState});
		
		// Update UI based on plan state
		updatePlanStateUI();
	}

	function updatePlanStateUI() {
		const { hasActiveSubscription, activePlanTier, selectedPlanTier, newPlanTier, isEditingPlan, canProceedToBuildMonth } = State.planState;
		
		// Update "Build your first month" button state
		const buildMonthBtn = document.getElementById('plan-continue-btn');
		if (buildMonthBtn) {
			if (hasActiveSubscription && !isEditingPlan) {
				buildMonthBtn.disabled = true;
				buildMonthBtn.textContent = 'Active Plan - Use "Update Plan" to modify';
				buildMonthBtn.style.background = 'var(--ink-20)';
				buildMonthBtn.style.color = 'var(--ink-60)';
				buildMonthBtn.style.cursor = 'not-allowed';
			} else if (!selectedPlanTier) {
				buildMonthBtn.disabled = true;
				buildMonthBtn.textContent = 'Select a plan first';
				buildMonthBtn.style.background = 'var(--ink-20)';
				buildMonthBtn.style.color = 'var(--ink-60)';
				buildMonthBtn.style.cursor = 'not-allowed';
			} else {
				buildMonthBtn.disabled = false;
				buildMonthBtn.textContent = 'Continue to build your first month →';
				buildMonthBtn.style.background = 'var(--numan-teal)';
				buildMonthBtn.style.color = 'white';
				buildMonthBtn.style.cursor = 'pointer';
				buildMonthBtn.style.border = 'none';
				buildMonthBtn.style.borderRadius = '8px';
				buildMonthBtn.style.fontWeight = '600';
				buildMonthBtn.style.transition = 'all 0.2s ease';
			}
		}
		
		// Update plan selection buttons
		updatePlanSelectionButtons();
		
		// Update plan section header
		updatePlanSectionHeader();
	}

	function updatePlanSelectionButtons() {
		const { hasActiveSubscription, activePlanTier, selectedPlanTier, newPlanTier, isEditingPlan } = State.planState;
		
		// Update all plan tier buttons
		Object.keys(MODEL.plans).forEach(tierKey => {
			const button = document.querySelector(`[data-key="${tierKey}"] .tier-button`);
			if (!button) return;
			
			const isActive = hasActiveSubscription && activePlanTier === tierKey && !isEditingPlan;
			const isSelected = selectedPlanTier === tierKey;
			const isNew = isEditingPlan && newPlanTier === tierKey;
			
			// Reset button styles
			button.style.background = 'var(--ink-20)';
			button.style.color = 'var(--ink)';
			button.style.border = '1px solid var(--ink-20)';
			button.disabled = false;
			
			if (isActive) {
				// Active subscription plan
				button.textContent = '✓ Current Plan';
				button.style.background = 'var(--numan-teal)';
				button.style.color = 'white';
				button.style.border = '2px solid var(--numan-teal)';
				button.style.fontWeight = '600';
				button.disabled = true;
			} else if (isNew) {
				// New plan being selected for change
				button.textContent = '✓ New Selection';
				button.style.background = 'var(--success)';
				button.style.color = 'white';
				button.style.border = '2px solid var(--success)';
				button.style.fontWeight = '600';
			} else if (isSelected) {
				// Selected plan (no active subscription)
				button.textContent = '✓ Selected';
				button.style.background = 'var(--numan-teal)';
				button.style.color = 'white';
				button.style.border = '2px solid var(--numan-teal)';
				button.style.fontWeight = '600';
			} else {
				// Available for selection
				button.textContent = 'Select Plan';
				button.style.background = 'var(--ink-20)';
				button.style.color = 'var(--ink)';
				button.style.border = '1px solid var(--ink-20)';
				button.style.fontWeight = '500';
			}
		});
	}

	// Update plan section header based on current state
	function updatePlanSectionHeader() {
		const { hasActiveSubscription, activePlanTier, selectedPlanTier, isEditingPlan } = State.planState;
		
		// Update the main plan section header
		const planHeader = document.querySelector('section[data-view="plan"] h2');
		if (planHeader) {
			if (hasActiveSubscription && !isEditingPlan) {
				planHeader.textContent = `Your Current Plan - ${activePlanTier}`;
			} else if (isEditingPlan) {
				planHeader.textContent = 'Select Your Plan';
			} else if (selectedPlanTier) {
				planHeader.textContent = 'Select Your Plan';
			} else {
				planHeader.textContent = 'Select Your Plan';
			}
		}
		
		// Update the plan tiers section header
		const tiersHeader = document.querySelector('#new-tier-grid')?.previousElementSibling;
		if (tiersHeader && tiersHeader.tagName === 'H3') {
			if (hasActiveSubscription && !isEditingPlan) {
				tiersHeader.textContent = 'Your Current Plan';
			} else if (isEditingPlan) {
				tiersHeader.textContent = 'Select Plan';
			} else if (selectedPlanTier) {
				tiersHeader.textContent = `Selected: ${selectedPlanTier} Plan`;
			} else {
				tiersHeader.textContent = 'Available Plans';
			}
		}
		
		// Update the change plan button text
		const changePlanBtn = document.getElementById('change-plan-btn');
		if (changePlanBtn) {
			if (isEditingPlan) {
				changePlanBtn.textContent = 'Cancel Changes';
			} else {
				changePlanBtn.textContent = 'Update Plan';
			}
		}
	}

	// Handle "Build your first month" button click with validation
	function handleBuildFirstMonthClick() {
		// Update plan state first
		updatePlanState();
		
		const { hasActiveSubscription, selectedPlanTier, isEditingPlan } = State.planState;
		
		// Check if user has an active subscription and is not in edit mode
		if (hasActiveSubscription && !isEditingPlan) {
			showToast('You have an active subscription. Click "Update Plan" to modify your plan.');
			return;
		}
		
		// Check if a plan is selected
		if (!selectedPlanTier) {
			showToast('Please select a plan first before building your first month.');
			return;
		}
		
		// Clear all lab selections when user first lands on this page
		clearAllLabSelections();
		
		// Proceed to build first month page
		Router.go('build-first-month');
	}

	// =============== FIXED GAUGE INTEGRATION REMOVED ===============
	// All fixed gauge integration replaced by renderBiologicalAgeGauge usages.

	// =============== GLOBAL APP STATE ===============
	const State = {
		// user and consent
		user: read('user.profile',{age:null, sex:null, height:null, weight:null, waist:null}),
		preferences: read('user.preferences',{}),
		consent: read('consent', {health:false}),
		// devices
		devices: {
			connected: read('devices.connected', []),
			primaryId: read('devices.primaryId', null)
		},
		deviceRequests: read('deviceRequests', []),
		// wearables
		wearables: {
			providers: read('wearables.providers', []), // connections
			series: read('wearables.series', {
				steps: [],   // integers (count)
				sleep: [],   // hours
				rhr: [],     // bpm
				hrv: []      // ms (optional)
			}),
		},
		// onboarding
		onboarding: {
			answers: read('onboarding.answers', {}),
			currentStep: read('onboarding.currentStep', 0),
			completed: read('onboarding.completed', false)
		},
		// existing plans
		activePlans: read('activePlans', []),
		// plan - New pricing system
		plan: {
			tier: read('plan.tier', null), // 'Base', 'Standard', 'Premium'
			selectedAddOns: read('plan.selectedAddOns', []), // Array of add-on IDs
			billingCycle: read('plan.billingCycle', 'monthly'), // 'monthly' or 'annual'
			editing: read('plan.editing', false),
			firstMonthPicks: read('plan.firstMonthPicks', null), // First month configuration
		},
		// cart - Unified pricing system
		cart: {
			planKey: read('cart.planKey', null),
			annual: read('cart.annual', false),
			addOns: read('cart.addOns', {}), // Dictionary keyed by addon id with qty, unitPrice, label
			kitsToShip: read('cart.kitsToShip', 0)
		},
		// schedule
		schedule: read('schedule', { events: [] }),
		// navigation unlocks
		navUnlocked: read('navUnlocked', {
			wearables: false,
			bioAge: false,
			plan: false,
			dashboard: false,
			streaks: false,
			account: false
		}),
		partner: {
			channel: read('partner.channel',''),
			code: read('partner.code','')
		},
		coupon: read('coupon',''),
		employerCode: read('employerCode',''),
		rewards: read('rewards', { xp: 0, level: 1, streak: { sleepDays: 0, stepsDays: 0 }, activeQuests: [] }),
		requests: { services: read('requests.services', []) },
		calendar: { events: read('calendar.events', []) },
		coach: { messages: read('coach.messages', []) },
		outcomes: {
			baseline: read('_outcomes.baseline', {weight:null, rhr:null, sleep:null}),
			current: read('_outcomes.current', {weight:null, rhr:null, sleep:null})
		},
		eventsLog: read('_events', []),
		issues: read('issues', []),
		assessments: read('assessments', [
			{id:'weekly-checkin', title:'Weekly check-in', recommended:true, optedIn:true, scheduledAt: new Date().toISOString(), frequency:'weekly', completed:false},
			{id:'bloods', title:'Monthly bloods', recommended:true, optedIn:true, scheduledAt: new Date(Date.now()+14*864e5).toISOString(), frequency:'monthly', completed:false},
			{id:'q-review', title:'Quarterly review', recommended:false, optedIn:false, scheduledAt: new Date(Date.now()+42*864e5).toISOString(), frequency:'quarterly', completed:false},
		]),
		biologicalAge: read('biologicalAge', null),
		ageHistory: read('ageHistory', []),
		currentView: read('currentView','landing'),
		billing: read('billing','monthly'),
		subscription: read('subscription', {active: false, plan: null, startDate: null}),
		referrals: read('referrals', {conversions: 0, credits: 0}),
		tests: { total:0, passed:0, failures:[] },
		crossSell: { currentCategory: read('crossSell.currentCategory','None') },
		nps: { score: read('nps.score', null), comment: read('nps.comment','') },
		claims: [
			{id:'bio-age', copy:'Understand your biological age', evidenceNote:'Observational links between lifestyle and biomarkers; non-diagnostic.', version:'1.0'},
			{id:'sleep-focus', copy:'Improve sleep and focus', evidenceNote:'CBT-I and sleep hygiene improve daytime function.', version:'1.0'},
			{id:'weight-cardio', copy:'Weight loss improves cardiometabolic risk', evidenceNote:'Multiple RCTs show improvements in BP, A1c, lipids.', version:'1.0'},
		],
		// Settings
		settings: read('settings', {
			peerComparison: false
		}),
		// Gamification system
		rewards: {
			mode: read('rewards.mode', 'soft'),
			levels: [
				{level:1, xp:0},
				{level:2, xp:200},
				{level:3, xp:600},
				{level:4, xp:1200},
				{level:5, xp:2000}
			],
			badges: [
				{id:'first-sync', name:'First Sync', icon:'📱', description:'Connect a wearable device', criteriaFn: (state) => state.devices?.connected?.length > 0},
				{id:'consistency', name:'Consistency', icon:'🔥', description:'7-day sleep streak', criteriaFn: (state) => state.rewards?.state?.streak?.sleepDays >= 7},
				{id:'momentum', name:'Momentum', icon:'🚶', description:'7-day steps streak', criteriaFn: (state) => state.rewards?.state?.streak?.stepsDays >= 7},
				{id:'alcohol-smart', name:'Alcohol Smart', icon:'🍷', description:'≤14 units this week', criteriaFn: (state) => state.user?.alcoholUnits <= 14},
				{id:'smoke-free-start', name:'Smoke-Free Start', icon:'🚭', description:'7 smoke-free days', criteriaFn: (state) => state.user?.smoking === 'no' && state.rewards?.state?.streak?.smokeFreeDays >= 7},
			],
			quests: [
				{id:'sleep-foundation', title:'Sleep Foundation', driver:'sleep', goal:{kind:'avgSleep>=', value:7.0}, durationDays:7, rewardXP:150},
				{id:'move-more', title:'Move More', driver:'steps', goal:{kind:'stepsAvg>=', value:8000}, durationDays:7, rewardXP:150},
				{id:'lower-rhr', title:'Lower RHR', driver:'rhr', goal:{kind:'rhrAvg<', value:65}, durationDays:7, rewardXP:200}
			],
			state: read('rewards.state', {
				xp: 0,
				level: 1,
				streak: {sleepDays:0, stepsDays:0, smokeFreeDays:0},
				badgesEarned: [],
				activeQuests: [],
				completedQuests: []
			})
		},
		// Labs system
		labs: {
			orders: read('labs.orders', []),
			results: read('labs.results', []),
			nextDue: read('labs.nextDue', null),
			preferences: read('labs.preferences', {shareWithCoach: true})
		},
		// Feature flag for pricing system
		useNewPricing: read('useNewPricing', false),
		// First-time checkout tracking
		firstTimeCheckout: read('firstTimeCheckout', true),
		// Plan state management
		planState: read('planState', {
			hasActiveSubscription: false,
			activePlanTier: null,
			selectedPlanTier: null,
			newPlanTier: null,
			isEditingPlan: false,
			canProceedToBuildMonth: false
		})
	};
	
	// =============== ENHANCED RECOMMENDATION ENGINE ===============
	class EnhancedRecommendationEngine {
		constructor(userProfile) {
			this.userProfile = userProfile;
			this.confidenceScore = 0;
			this.recommendations = [];
			this.healthMetrics = {};
			this.riskFactors = [];
		}

		generatePersonalisedRecommendations() {
			this.healthMetrics = this.analyseHealthMetrics();
			this.riskFactors = this.identifyRiskFactors();
			const optimisationAreas = this.determineOptimisationPriorities();

			this.recommendations = this.synthesiseRecommendations(
				this.healthMetrics, 
				this.riskFactors, 
				optimisationAreas
			);

			this.calculateConfidenceScore();
			return this.recommendations;
		}

		analyseHealthMetrics() {
			const metrics = {};
			
			// Anthropometric analysis
			if (State.user.waist && State.user.height) {
				const whtr = State.user.waist / State.user.height;
				if (whtr >= 0.53) {
					metrics.cardiovascularRisk = 'elevated';
					metrics.metabolicFocus = true;
					metrics.whtr = whtr;
				}
			}

			// Sleep analysis
			if (State.wearables.series.sleep?.length) {
				const avgSleep = State.wearables.series.sleep.slice(-7).reduce((a, b) => a + b, 0) / 7;
				if (avgSleep < 7) {
					metrics.sleepOptimisation = 'priority';
					metrics.metabolicImpact = true;
					metrics.sleepDuration = avgSleep;
				}
			}

			// Heart rate analysis
			if (State.wearables.series.rhr?.length) {
				const avgRHR = State.wearables.series.rhr.slice(-7).reduce((a, b) => a + b, 0) / 7;
				if (avgRHR > 80) {
					metrics.cardiovascularStress = 'elevated';
					metrics.avgRHR = avgRHR;
				}
			}

			// Biomarker status
			metrics.baselineTestingRequired = !State.labs?.hasRecentResults;
			metrics.personalisationLimited = !State.labs?.hasRecentResults;

			return metrics;
		}

		identifyRiskFactors() {
			const risks = [];
			
			// Cardiovascular risk
			if (this.healthMetrics.whtr >= 0.50) {
				risks.push({
					factor: 'cardiovascular',
					severity: this.healthMetrics.whtr >= 0.55 ? 'high' : 'moderate',
					interventions: ['metabolic_coaching', 'lipid_testing', 'omega3_supplementation'],
					description: `Waist-to-height ratio of ${this.healthMetrics.whtr.toFixed(2)} indicates elevated cardiovascular risk`
				});
			}

			// Sleep-related metabolic risk
			if (this.healthMetrics.sleepDuration < 7) {
				risks.push({
					factor: 'metabolic_dysregulation',
					severity: this.healthMetrics.sleepDuration < 6 ? 'high' : 'moderate',
					interventions: ['sleep_optimisation_coaching', 'circadian_support'],
					description: `Average sleep duration of ${this.healthMetrics.sleepDuration.toFixed(1)} hours affects metabolic regulation`
				});
			}

			// Cardiovascular stress
			if (this.healthMetrics.avgRHR > 80) {
				risks.push({
					factor: 'cardiovascular_stress',
					severity: this.healthMetrics.avgRHR > 90 ? 'high' : 'moderate',
					interventions: ['stress_management', 'cardiovascular_testing'],
					description: `Elevated resting heart rate of ${Math.round(this.healthMetrics.avgRHR)} bpm indicates cardiovascular stress`
				});
			}

			// Smoking risk
			if (State.onboarding.answers.smoker) {
				risks.push({
					factor: 'smoking',
					severity: 'high',
					interventions: ['smoking_cessation_coaching', 'lung_function_testing'],
					description: 'Smoking significantly increases cardiovascular and metabolic risk'
				});
			}

			return risks;
		}

		determineOptimisationPriorities() {
			const priorities = [];
			
			if (this.healthMetrics.cardiovascularRisk === 'elevated') {
				priorities.push({
					area: 'cardiovascular_health',
					priority: 'high',
					recommendedTests: ['cardio', 'metabolic'],
					recommendedSupplements: ['omega3'],
					recommendedCoaching: ['metabolic_fitness']
				});
			}

			if (this.healthMetrics.sleepOptimisation === 'priority') {
				priorities.push({
					area: 'sleep_optimisation',
					priority: 'high',
					recommendedTests: ['metabolic'],
					recommendedSupplements: ['sleep'],
					recommendedCoaching: ['sleep_hygiene']
				});
			}

			if (this.healthMetrics.baselineTestingRequired) {
				priorities.push({
					area: 'baseline_establishment',
					priority: 'critical',
					recommendedTests: ['complete-20'],
					recommendedSupplements: ['multi'],
					recommendedCoaching: ['health_optimisation']
				});
			}

			return priorities;
		}

		synthesiseRecommendations(healthMetrics, riskFactors, optimisationAreas) {
			const plan = this.recommendOptimalPlan();
			const recommendations = {
				plan: plan,
				labs: [],
				supplements: [],
				coaching: [],
				reasoning: '', // Will be set after supplements are populated
				dataInsights: this.getKeyDataPoints(healthMetrics, riskFactors)
			};

			// Get plan-specific limits
			const planDetails = MODEL.plans[plan.tier];
			const maxLabCredits = planDetails ? planDetails.labCreditsPerYear : 2;
			const maxSupplements = Math.min(maxLabCredits, 3); // Supplements capped at 3

			// Generate lab recommendations (respecting credit limits)
			let totalCreditsUsed = 0;
			optimisationAreas.forEach(area => {
				area.recommendedTests.forEach(testId => {
					const test = MODEL.catalog.labs.find(t => t.id === testId);
					if (test && !recommendations.labs.find(l => l.id === testId)) {
						// Check if adding this test would exceed credit limits
						if (totalCreditsUsed + test.credits <= maxLabCredits) {
							recommendations.labs.push({
								id: testId,
								title: test.name,
								credits: test.credits,
								reason: this.getLabReasoning(testId, area.area),
								priority: area.priority
							});
							totalCreditsUsed += test.credits;
						}
					}
				});
			});

			// Generate supplement recommendations (respecting plan limits)
			optimisationAreas.forEach(area => {
				area.recommendedSupplements.forEach(suppId => {
					const supplement = MODEL.catalog.supplements.find(s => s.id === suppId);
					if (supplement && !recommendations.supplements.find(s => s.id === suppId)) {
						// Check if we haven't exceeded supplement limit
						if (recommendations.supplements.length < maxSupplements) {
							recommendations.supplements.push({
								id: suppId,
								title: supplement.name,
								reason: this.getSupplementReasoning(suppId, area.area),
								priority: area.priority
							});
						}
					}
				});
			});

			// Generate coaching recommendations
			optimisationAreas.forEach(area => {
				area.recommendedCoaching.forEach(coachingId => {
					if (!recommendations.coaching.find(c => c.id === coachingId)) {
						recommendations.coaching.push({
							id: coachingId,
							title: this.getCoachingTitle(coachingId),
							reason: this.getCoachingReasoning(coachingId, area.area),
							priority: area.priority
						});
					}
				});
			});

			// Generate reasoning after all recommendations are populated
			recommendations.reasoning = this.generateClinicalReasoning(healthMetrics, riskFactors, recommendations);

			return recommendations;
		}

		recommendOptimalPlan() {
			// Use the selected plan tier from the user profile instead of determining it
			const selectedTier = this.userProfile.selectedPlanTier;
			console.log('Using selected plan tier for recommendations:', selectedTier);
			
			if (selectedTier) {
				const planNames = {
					'Base': 'Base Plan',
					'Standard': 'Standard Plan', 
					'Premium': 'Premium Plan'
				};
				return { 
					tier: selectedTier, 
					name: planNames[selectedTier] || `${selectedTier} Plan`, 
					reasoning: `Recommendations tailored for your ${selectedTier} plan selection` 
				};
			}
			
			// Fallback to original logic if no plan tier is selected
			const riskCount = this.riskFactors.length;
			const hasComplexMetrics = this.healthMetrics.cardiovascularRisk || this.healthMetrics.sleepOptimisation;
			
			if (riskCount >= 3 || hasComplexMetrics) {
				return { tier: 'Premium', name: 'Premium Plan', reasoning: 'Complex health profile requires comprehensive monitoring' };
			} else if (riskCount >= 1 || this.healthMetrics.baselineTestingRequired) {
				return { tier: 'Standard', name: 'Standard Plan', reasoning: 'Balanced approach for health optimization' };
			} else {
				return { tier: 'Base', name: 'Base Plan', reasoning: 'Essential monitoring for your current health status' };
			}
		}

		generateClinicalReasoning(healthMetrics, riskFactors, recommendations) {
			let reasoning = "Your personalised plan addresses ";
			
			if (riskFactors.length > 0) {
				const primaryRisk = riskFactors[0];
				reasoning += `${primaryRisk.description.toLowerCase()}`;
				
				if (riskFactors.length > 1) {
					reasoning += ` and ${riskFactors.length - 1} other risk factor${riskFactors.length > 2 ? 's' : ''}`;
				}
			} else {
				reasoning += "your health optimization goals";
			}
			
			reasoning += " through targeted lab testing to establish baseline biomarkers, ";
			
			if (recommendations.supplements && recommendations.supplements.length > 0) {
				reasoning += "evidence-based supplementation for targeted support, ";
			}
			
			reasoning += "and personalised coaching to optimise your specific health metrics. This integrated approach targets the interconnected nature of your current health profile.";
			
			return reasoning;
		}

		getKeyDataPoints(healthMetrics, riskFactors) {
			const insights = [];
			
			if (healthMetrics.whtr) {
				insights.push({
					label: 'Waist-to-Height Ratio',
					value: healthMetrics.whtr.toFixed(2),
					status: healthMetrics.whtr >= 0.53 ? 'elevated' : 'optimal',
					description: healthMetrics.whtr >= 0.53 ? 'Elevated cardiovascular risk factor' : 'Within optimal range'
				});
			}
			
			if (healthMetrics.sleepDuration) {
				insights.push({
					label: 'Sleep Duration',
					value: `${healthMetrics.sleepDuration.toFixed(1)} hours`,
					status: healthMetrics.sleepDuration < 7 ? 'suboptimal' : 'optimal',
					description: healthMetrics.sleepDuration < 7 ? 'Affects metabolic regulation' : 'Supports optimal health'
				});
			}
			
			if (healthMetrics.avgRHR) {
				insights.push({
					label: 'Resting Heart Rate',
					value: `${Math.round(healthMetrics.avgRHR)} bpm`,
					status: healthMetrics.avgRHR > 80 ? 'elevated' : 'optimal',
					description: healthMetrics.avgRHR > 80 ? 'Indicates cardiovascular stress' : 'Within healthy range'
				});
			}
			
			if (healthMetrics.baselineTestingRequired) {
				insights.push({
					label: 'Biomarker Status',
					value: 'Unknown',
					status: 'unknown',
					description: 'Comprehensive testing required for personalised optimisation'
				});
			}
			
			return insights;
		}

		calculateConfidenceScore() {
			let confidence = 50; // baseline

			// Increase confidence based on available data
			if (State.devices.connected.length > 0) confidence += 15;
			if (State.onboarding.completed) confidence += 20;
			if (State.labs?.hasRecentResults) confidence += 20;
			else confidence -= 10; // Decrease if no biomarkers

			// Adjust for risk factor clarity
			confidence += Math.min(this.riskFactors.length * 5, 15);

			// Adjust for data completeness
			if (this.healthMetrics.whtr) confidence += 10;
			if (this.healthMetrics.sleepDuration) confidence += 10;
			if (this.healthMetrics.avgRHR) confidence += 10;

			this.confidenceScore = Math.min(confidence, 95);
		}

		getLabReasoning(testId, area) {
			const reasoningMap = {
				'cardio': 'Comprehensive cardiovascular assessment to evaluate heart health and circulation',
				'metabolic': 'Metabolic panel to assess glucose regulation and metabolic efficiency',
				'complete-20': 'Comprehensive biomarker analysis to establish your health baseline',
				'thyroid': 'Thyroid function assessment for metabolic and energy optimization'
			};
			return reasoningMap[testId] || 'Targeted testing for health optimization';
		}

		getSupplementReasoning(suppId, area) {
			const reasoningMap = {
				'omega3': 'High-strength omega-3 for cardiovascular and anti-inflammatory support',
				'sleep': 'Sleep support formula to optimize rest and recovery',
				'multi': 'Comprehensive multivitamin to address potential nutritional gaps',
				'b12': 'B12 supplementation for energy and neurological function'
			};
			return reasoningMap[suppId] || 'Evidence-based supplementation for health optimization';
		}

		getCoachingTitle(coachingId) {
			const titleMap = {
				'metabolic_fitness': 'Metabolic Fitness & Weight Optimisation',
				'sleep_hygiene': 'Sleep Optimisation & Circadian Health',
				'stress_management': 'Stress Management & Resilience',
				'health_optimisation': 'Comprehensive Health Optimisation',
				'smoking_cessation': 'Smoking Cessation Support'
			};
			return titleMap[coachingId] || 'Personalised Health Coaching';
		}

		getCoachingReasoning(coachingId, area) {
			const reasoningMap = {
				'metabolic_fitness': 'Personalised strategy for metabolic health and sustainable weight management',
				'sleep_hygiene': 'Evidence-based techniques to improve sleep quality and duration',
				'stress_management': 'Comprehensive approach to stress reduction and resilience building',
				'health_optimisation': 'Holistic health strategy tailored to your specific goals',
				'smoking_cessation': 'Structured support program for successful smoking cessation'
			};
			return reasoningMap[coachingId] || 'Targeted coaching for your health goals';
		}
	}

	// Legacy PersonalisationEngine for backward compatibility
	class PersonalisationEngine {
		constructor(userData) {
			this.assessments = userData.assessments || [];
			this.wearablesData = userData.wearables || {};
			this.userInput = userData.preferences || {};
			this.coachingFrequency = userData.coaching?.frequency || 'monthly';
			this.currentPlan = userData.subscription?.plan || null;
		}
		
		generateRecommendations() {
			const baseRecommendations = this.calculateBaseRecommendations();
			const personalisedRecommendations = this.applyPersonalisation(baseRecommendations);
			const planOptimisedRecommendations = this.optimiseForPlan(personalisedRecommendations);
			
			return {
				labs: this.filterByAllowance(planOptimisedRecommendations.labs),
				supplements: this.filterByAllowance(planOptimisedRecommendations.supplements),
				coaching: this.filterByAllowance(planOptimisedRecommendations.coaching),
				removable: true // All recommendations can be removed post-personalisation
			};
		}
		
		calculateBaseRecommendations() {
			// Core recommendation logic based on assessment patterns
			const riskFactors = this.identifyRiskFactors();
			const healthGoals = this.extractHealthGoals();
			const currentMetrics = this.analyseCurrentMetrics();
			
			return {
				labs: this.recommendLabs(riskFactors, healthGoals),
				supplements: this.recommendSupplements(currentMetrics, healthGoals),
				coaching: this.recommendCoaching(riskFactors, this.coachingFrequency)
			};
		}
		
		applyPersonalisation(baseRecommendations) {
			// Apply wearables data insights
			if (this.wearablesData.sleepQuality < 7) {
				baseRecommendations.supplements.push('sleep-optimisation');
				baseRecommendations.coaching.push('sleep-hygiene');
			}
			
			if (this.wearablesData.averageHRV < 30) {
				baseRecommendations.labs.push('stress-biomarkers');
				baseRecommendations.coaching.push('stress-management');
			}
			
			return baseRecommendations;
		}
		
		optimiseForPlan(recommendations) {
			const planLimits = this.getPlanLimits();
			
			return {
				labs: this.prioritiseRecommendations(recommendations.labs, planLimits.labs),
				supplements: this.prioritiseRecommendations(recommendations.supplements, planLimits.supplements),
				coaching: this.prioritiseRecommendations(recommendations.coaching, planLimits.coaching)
			};
		}
		
		getPlanLimits() {
			const planConfigs = {
				'Base': { labs: 1, supplements: 1, coaching: 15 },
				'Standard': { labs: 2, supplements: 2, coaching: 30 },
				'Premium': { labs: 3, supplements: 3, coaching: 45 }
			};
			
			return planConfigs[this.currentPlan] || planConfigs['Base'];
		}
		
		identifyRiskFactors() {
			const factors = [];
			
			// Analyze assessment data
			if (State.onboarding.answers.smoker) factors.push('smoking');
			if (State.user.bmi > 30) factors.push('obesity');
			if (State.wearables.series.rhr?.length && 
				State.wearables.series.rhr.slice(-7).reduce((a, b) => a + b, 0) / 7 > 80) {
				factors.push('high-heart-rate');
			}
			
			return factors;
		}
		
		extractHealthGoals() {
			const goals = [];
			
			// Extract from user preferences and assessment answers
			if (State.preferences.weightLoss) goals.push('weight-management');
			if (State.preferences.energy) goals.push('energy-optimisation');
			if (State.preferences.sleep) goals.push('sleep-improvement');
			
			return goals;
		}
		
		analyseCurrentMetrics() {
			return {
				sleepQuality: State.wearables.series.sleep?.slice(-7).reduce((a, b) => a + b, 0) / 7 || 7,
				averageHRV: State.wearables.series.hrv?.slice(-7).reduce((a, b) => a + b, 0) / 7 || 30,
				activityLevel: State.wearables.series.steps?.slice(-7).reduce((a, b) => a + b, 0) / 7 || 8000
			};
		}
		
		recommendLabs(riskFactors, healthGoals) {
			const recommendations = [];
			
			if (riskFactors.includes('obesity') || healthGoals.includes('weight-management')) {
				recommendations.push({id: 'metabolic', title: 'Metabolic Health', personalisation_reason: 'Based on your weight management goals'});
			}
			
			if (riskFactors.includes('high-heart-rate')) {
				recommendations.push({id: 'cardio', title: 'Cardiovascular', personalisation_reason: 'Based on your heart rate patterns'});
			}
			
			return recommendations;
		}
		
		recommendSupplements(currentMetrics, healthGoals) {
			const recommendations = [];
			
			if (currentMetrics.sleepQuality < 7) {
				recommendations.push({id: 'sleep', title: 'Sleep Support', personalisation_reason: 'Based on your sleep patterns'});
			}
			
			if (healthGoals.includes('energy-optimisation')) {
				recommendations.push({id: 'multi', title: 'Multivitamin', personalisation_reason: 'Based on your energy goals'});
			}
			
			return recommendations;
		}
		
		recommendCoaching(riskFactors, frequency) {
			const recommendations = [];
			
			if (riskFactors.includes('smoking')) {
				recommendations.push({id: 'smoking-cessation', title: 'Smoking Cessation', personalisation_reason: 'Based on your smoking status'});
			}
			
			return recommendations;
		}
		
		prioritiseRecommendations(recommendations, limit) {
			// Simple prioritization - could be enhanced with ML scoring
			return recommendations.slice(0, limit);
		}
		
		filterByAllowance(recommendations) {
			// Filter based on current plan allowances
			return recommendations;
		}
	}
	
	// Dynamic Recommendation Display Functions
	function renderPersonalisedRecommendations(recommendations) {
		const container = document.getElementById('personalised-recommendations');
		if (!container) return;
		
		// Use enhanced recommendation engine if available
		if (recommendations.plan && recommendations.reasoning) {
			renderEnhancedRecommendationModal(recommendations);
		} else {
			// Fallback to simple recommendations
			const recommendationHTML = `
				<div class="personalisation-header">
					<h3>Your Personalised Plan</h3>
					<p class="personalisation-note">Based on your assessments, health data, and goals. <strong>All recommendations can be removed, replaced, or customized to your preferences.</strong></p>
					<div class="personalisation-controls">
						<button class="btn-ghost btn-small" onclick="resetRecommendations()">
							Reset to AI Recommendations
						</button>
						<button class="btn-ghost btn-small" onclick="clearAllRecommendations()">
							Start from Scratch
						</button>
					</div>
				</div>
				
				<div class="recommendation-sections">
					${renderLabRecommendations(recommendations.labs)}
					${renderSupplementRecommendations(recommendations.supplements)}
					${renderCoachingRecommendations(recommendations.coaching)}
				</div>
				
				<div class="recommendation-controls">
					<button class="btn" onclick="acceptRecommendations()">
						Continue with My Plan
					</button>
				</div>
			`;
			
			container.innerHTML = recommendationHTML;
		}
	}

	function renderEnhancedRecommendationModal(recommendations) {
		// Create modal overlay
		const modalOverlay = document.createElement('div');
		modalOverlay.className = 'enhanced-recommendation-overlay';
		modalOverlay.innerHTML = `
			<div class="enhanced-recommendation-modal">
				<div class="enhanced-modal-header">
					<h2 class="enhanced-modal-title">Your Personalised Health Plan</h2>
					<p class="enhanced-modal-subtitle">Based on your comprehensive health profile, here's a clinically-informed month-one strategy designed to optimise your specific biomarkers and health objectives.</p>
				</div>

				<div class="enhanced-modal-content">
					<div class="enhanced-plan-recommendation">
						<div class="enhanced-plan-badge">Optimised Match</div>
						<h3 class="enhanced-plan-title">${recommendations.plan.name} Recommended</h3>
						
						${renderEnhancedRecommendationItems(recommendations)}
					</div>

					<div class="enhanced-reasoning-section">
						<h4 class="enhanced-reasoning-title">
							<span>🎯</span>
							Clinical Reasoning & Data Integration
						</h4>
						
						<div class="enhanced-data-insights">
							${renderDataInsights(recommendations.dataInsights)}
						</div>

						<div class="enhanced-reasoning-explanation">
							<p class="enhanced-reasoning-text">${recommendations.reasoning}</p>
						</div>

						<div class="enhanced-confidence-indicator">
							<div class="enhanced-confidence-icon">✓</div>
							<div class="enhanced-confidence-text">
								<strong>${recommendations.confidenceScore || 85}% recommendation confidence</strong> based on current data. Confidence will increase post-biomarker analysis.
							</div>
						</div>
					</div>

					<div class="enhanced-customisation-options">
						<h5 class="enhanced-customisation-title">Customisation Options</h5>
						<div class="enhanced-customisation-controls">
							<button class="enhanced-customisation-btn active" onclick="toggleCustomisation(this, 'use-lab-now')">Use Lab Credit Now</button>
							<button class="enhanced-customisation-btn" onclick="toggleCustomisation(this, 'defer-lab')">Defer Lab Testing</button>
							<button class="enhanced-customisation-btn" onclick="toggleCustomisation(this, 'alternative-supplement')">Alternative Supplement</button>
							<button class="enhanced-customisation-btn" onclick="toggleCustomisation(this, 'different-coaching')">Focus Different Coaching Area</button>
						</div>
					</div>

					<div class="enhanced-clinical-note">
						<strong>Clinical Note:</strong> Recommendations are educational and for wellness optimisation. Medical conditions require professional healthcare consultation. Supplement pricing subject to separate approval.
					</div>

					<div class="enhanced-modal-actions">
						<button class="btn btn-secondary" onclick="closeEnhancedRecommendationModal()">
							Customise Plan
						</button>
						<button class="btn btn-primary" onclick="applyEnhancedRecommendations()">
							Apply Personalised Plan
						</button>
					</div>
				</div>
			</div>
		`;
		
		document.body.appendChild(modalOverlay);
	}

	function renderEnhancedRecommendationItems(recommendations) {
		let itemsHTML = '';
		
		// Lab recommendations
		recommendations.labs.forEach(lab => {
			itemsHTML += `
				<div class="enhanced-recommendation-item">
					<div class="enhanced-recommendation-details">
						<div class="enhanced-recommendation-type">Lab Testing</div>
						<div class="enhanced-recommendation-name">${lab.title}</div>
						<div class="enhanced-recommendation-meta">${lab.reason}</div>
					</div>
					<div class="enhanced-credit-indicator">${lab.credits} credit${lab.credits > 1 ? 's' : ''}</div>
				</div>
			`;
		});
		
		// Supplement recommendations
		recommendations.supplements.forEach(supp => {
			itemsHTML += `
				<div class="enhanced-recommendation-item">
					<div class="enhanced-recommendation-details">
						<div class="enhanced-recommendation-type">Supplement Protocol</div>
						<div class="enhanced-recommendation-name">${supp.title}</div>
						<div class="enhanced-recommendation-meta">${supp.reason}</div>
					</div>
				</div>
			`;
		});
		
		// Coaching recommendations
		recommendations.coaching.forEach(coach => {
			itemsHTML += `
				<div class="enhanced-recommendation-item">
					<div class="enhanced-recommendation-details">
						<div class="enhanced-recommendation-type">Coaching Focus</div>
						<div class="enhanced-recommendation-name">${coach.title}</div>
						<div class="enhanced-recommendation-meta">${coach.reason}</div>
					</div>
				</div>
			`;
		});
		
		return itemsHTML;
	}

	function renderDataInsights(insights) {
		return insights.map(insight => `
			<div class="enhanced-insight-card">
				<div class="enhanced-insight-icon ${insight.status}">
					${insight.status === 'elevated' ? '!' : insight.status === 'suboptimal' ? '⚠' : '?'}
				</div>
				<div class="enhanced-insight-text">
					<div class="enhanced-insight-label">${insight.label}: ${insight.value}</div>
					<div class="enhanced-insight-value">${insight.description}</div>
				</div>
			</div>
		`).join('');
	}

	function toggleCustomisation(button, option) {
		// Remove active class from all buttons
		document.querySelectorAll('.enhanced-customisation-btn').forEach(btn => {
			btn.classList.remove('active');
		});
		
		// Add active class to clicked button
		button.classList.add('active');
		
		// Update recommendations based on selection
		updateEnhancedRecommendationDisplay(option);
	}

	function updateEnhancedRecommendationDisplay(option) {
		// Dynamic recommendation adjustment based on user selections
		console.log('Updating enhanced recommendations based on:', option);
		// Implementation would adjust recommendations based on user preferences
	}

	function closeEnhancedRecommendationModal() {
		const modal = document.querySelector('.enhanced-recommendation-overlay');
		if (modal) {
			modal.remove();
		}
	}

	function applyEnhancedRecommendations() {
		// Apply the enhanced personalised recommendations
		console.log('Applying enhanced personalised health plan recommendations');
		showToast('Enhanced personalised plan applied successfully!');
		closeEnhancedRecommendationModal();
		
		// Clear all lab selections when user first lands on this page
		clearAllLabSelections();
		
		// Navigate to build first month page
		Router.go('build-first-month');
	}

	function getEnhancedPersonalisedRecommendations() {
		// Get the selected plan tier from the previous page
		const selectedPlanTier = State.plan.tier || HS.plan.tier;
		console.log('Getting personalized recommendations for plan tier:', selectedPlanTier);
		
		// Create enhanced recommendation engine with current user profile
		const userProfile = {
			age: State.user.age,
			sex: State.user.sex,
			height: State.user.height,
			weight: State.user.weight,
			waist: State.user.waist,
			smoker: State.onboarding.answers.smoker,
			hasWearableData: State.devices.connected.length > 0,
			assessmentCompleteness: State.onboarding.completed ? 100 : 0,
			hasRecentBiomarkers: State.labs?.hasRecentResults || false,
			selectedPlanTier: selectedPlanTier // Include the selected plan tier
		};
		
		// Generate enhanced recommendations
		const engine = new EnhancedRecommendationEngine(userProfile);
		const recommendations = engine.generatePersonalisedRecommendations();
		
		// Render the enhanced recommendation modal
		renderPersonalisedRecommendations(recommendations);
		
		// Log the recommendation generation
		logEvent('enhanced_recommendations_generated', {
			confidenceScore: recommendations.confidenceScore,
			planRecommended: recommendations.plan.tier,
			labCount: recommendations.labs.length,
			supplementCount: recommendations.supplements.length,
			coachingCount: recommendations.coaching.length
		});
	}

	function renderLabRecommendations(labs) {
		const planLimits = getCurrentPlanLimits();
		
		return `
			<div class="recommendation-section">
				<h4>Recommended Lab Tests <span class="allowance-badge">${labs.length}/${planLimits.labs} included</span></h4>
				<div class="recommendation-grid">
					${labs.map(lab => `
						<div class="recommendation-card removable" data-type="lab" data-id="${lab.id}">
							<div class="recommendation-content">
								<h5>${lab.title}</h5>
								<p class="recommendation-reason">${lab.personalisation_reason}</p>
								<div class="recommendation-actions">
									<button class="btn-ghost btn-small" onclick="removeRecommendation('lab', '${lab.id}')">
										Remove
									</button>
									<button class="btn-ghost btn-small" onclick="replaceRecommendation('lab', '${lab.id}')">
										Replace
									</button>
								</div>
							</div>
						</div>
					`).join('')}
				</div>
				<div class="add-custom-section">
					<button class="btn btn-secondary" onclick="showCustomLabSelector()">
						+ Add Custom Lab Test
					</button>
				</div>
			</div>
		`;
	}

	function renderSupplementRecommendations(supplements) {
		const planLimits = getCurrentPlanLimits();
		
		return `
			<div class="recommendation-section">
				<h4>Recommended Supplements <span class="allowance-badge">${supplements.length}/${planLimits.supplements} included</span></h4>
				<div class="recommendation-grid">
					${supplements.map(supp => `
						<div class="recommendation-card removable" data-type="supplement" data-id="${supp.id}">
							<div class="recommendation-content">
								<h5>${supp.title}</h5>
								<p class="recommendation-reason">${supp.personalisation_reason}</p>
								<div class="recommendation-actions">
									<button class="btn-ghost btn-small" onclick="removeRecommendation('supplement', '${supp.id}')">
										Remove
									</button>
									<button class="btn-ghost btn-small" onclick="replaceRecommendation('supplement', '${supp.id}')">
										Replace
									</button>
								</div>
							</div>
						</div>
					`).join('')}
				</div>
				<div class="add-custom-section">
					<button class="btn btn-secondary" onclick="showCustomSupplementSelector()">
						+ Add Custom Supplement
					</button>
				</div>
			</div>
		`;
	}

	function renderCoachingRecommendations(coaching) {
		const planLimits = getCurrentPlanLimits();
		
		return `
			<div class="recommendation-section">
				<h4>Recommended Coaching <span class="allowance-badge">${coaching.length} sessions included</span></h4>
				<div class="recommendation-grid">
					${coaching.map(coach => `
						<div class="recommendation-card removable" data-type="coaching" data-id="${coach.id}">
							<div class="recommendation-content">
								<h5>${coach.title}</h5>
								<p class="recommendation-reason">${coach.personalisation_reason}</p>
								<div class="recommendation-actions">
									<button class="btn-ghost btn-small" onclick="removeRecommendation('coaching', '${coach.id}')">
										Remove
									</button>
									<button class="btn-ghost btn-small" onclick="replaceRecommendation('coaching', '${coach.id}')">
										Replace
									</button>
								</div>
							</div>
						</div>
					`).join('')}
				</div>
				<div class="add-custom-section">
					<button class="btn btn-secondary" onclick="showCustomCoachingSelector()">
						+ Add Custom Coaching
					</button>
				</div>
			</div>
		`;
	}

	function getCurrentPlanLimits() {
		const currentPlan = State.plan.tier || 'Base';
		const planConfigs = {
			'Base': { labs: 1, supplements: 1, coaching: 15 },
			'Standard': { labs: 2, supplements: 2, coaching: 30 },
			'Premium': { labs: 3, supplements: 3, coaching: 45 }
		};
		
		return planConfigs[currentPlan] || planConfigs['Base'];
	}

	function removeRecommendation(type, id) {
		// Remove recommendation from current selections
		const card = document.querySelector(`[data-type="${type}"][data-id="${id}"]`);
		if (card) {
			card.remove();
		}
		
		// Update UI to reflect removal
		updateRecommendationCounts();
		showToast(`${type} recommendation removed`);
	}

	function replaceRecommendation(type, id) {
		// Show replacement options for the specific recommendation
		const replacementOptions = getReplacementOptions(type, id);
		showReplacementModal(type, id, replacementOptions);
	}

	function getReplacementOptions(type, currentId) {
		// Get available options excluding the current one
		const allOptions = {
			lab: MODEL.catalog.labs || [],
			supplement: MODEL.catalog.supplements || [],
			coaching: [
				{id: 'weight-management', title: 'Weight Management', description: 'Personalised weight loss coaching'},
				{id: 'sleep-optimization', title: 'Sleep Optimization', description: 'Improve sleep quality and duration'},
				{id: 'stress-management', title: 'Stress Management', description: 'Techniques for managing daily stress'},
				{id: 'nutrition-coaching', title: 'Nutrition Coaching', description: 'Personalised dietary guidance'},
				{id: 'fitness-coaching', title: 'Fitness Coaching', description: 'Exercise and activity planning'}
			]
		};
		
		return allOptions[type]?.filter(option => option.id !== currentId) || [];
	}

	function showReplacementModal(type, currentId, options) {
		const modal = document.createElement('div');
		modal.className = 'modal active';
		modal.innerHTML = `
			<div class="modal-content">
				<h3>Replace ${type} Recommendation</h3>
				<p>Choose a replacement for your current recommendation:</p>
				
				<div class="replacement-options">
					${options.map(option => `
						<div class="replacement-option" data-id="${option.id}" onclick="selectReplacement('${type}', '${currentId}', '${option.id}')">
							<h4>${option.title || option.name}</h4>
							<p>${option.description || option.personalisation_reason || 'Custom selection'}</p>
						</div>
					`).join('')}
				</div>
				
				<div class="modal-actions">
					<button class="btn btn-secondary" onclick="closeReplacementModal()">Cancel</button>
				</div>
			</div>
		`;
		
		document.body.appendChild(modal);
	}

	function selectReplacement(type, oldId, newId) {
		// Remove old recommendation
		removeRecommendation(type, oldId);
		
		// Add new recommendation
		const newOption = getReplacementOptions(type, oldId).find(opt => opt.id === newId);
		if (newOption) {
			addCustomRecommendation(type, newOption);
		}
		
		closeReplacementModal();
		showToast(`${type} recommendation replaced successfully`);
	}

	function closeReplacementModal() {
		const modal = document.querySelector('.modal');
		if (modal) {
			modal.remove();
		}
	}

	function addCustomRecommendation(type, option) {
		// Add the custom recommendation to the appropriate section
		const section = document.querySelector(`[data-type="${type}"]`).closest('.recommendation-section');
		const grid = section.querySelector('.recommendation-grid');
		
		const newCard = document.createElement('div');
		newCard.className = 'recommendation-card removable';
		newCard.setAttribute('data-type', type);
		newCard.setAttribute('data-id', option.id);
		newCard.innerHTML = `
			<div class="recommendation-content">
				<h5>${option.title || option.name}</h5>
				<p class="recommendation-reason">Custom selection</p>
				<div class="recommendation-actions">
					<button class="btn-ghost btn-small" onclick="removeRecommendation('${type}', '${option.id}')">
						Remove
					</button>
					<button class="btn-ghost btn-small" onclick="replaceRecommendation('${type}', '${option.id}')">
						Replace
					</button>
				</div>
			</div>
		`;
		
		grid.appendChild(newCard);
		updateRecommendationCounts();
	}

	function showCustomLabSelector() {
		showReplacementModal('lab', '', getReplacementOptions('lab', ''));
	}

	function showCustomSupplementSelector() {
		showReplacementModal('supplement', '', getReplacementOptions('supplement', ''));
	}

	function showCustomCoachingSelector() {
		showReplacementModal('coaching', '', getReplacementOptions('coaching', ''));
	}

	function clearAllRecommendations() {
		// Clear all personalised recommendations
		const container = document.getElementById('personalised-recommendations');
		if (container) {
			container.innerHTML = '<p class="muted">No personalised recommendations. Start fresh to build your plan.</p>';
		}
	}

	function acceptRecommendations() {
		// Accept current recommendations and proceed
		showToast('Recommendations accepted! Building your personalised plan...');
		// Clear all lab selections when user first lands on this page
		clearAllLabSelections();
		// Navigate to next step or update plan
		Router.go('build-first-month');
	}

	function resetRecommendations() {
		// Reset to show original recommendations
		const engine = new PersonalisationEngine(State);
		const recommendations = engine.generateRecommendations();
		renderPersonalisedRecommendations(recommendations);
	}

	function updateRecommendationCounts() {
		// Update allowance badges after removals
		const sections = document.querySelectorAll('.recommendation-section');
		sections.forEach(section => {
			const cards = section.querySelectorAll('.recommendation-card');
			const badge = section.querySelector('.allowance-badge');
			if (badge) {
				const currentCount = cards.length;
				const planLimits = getCurrentPlanLimits();
				const type = section.querySelector('h4').textContent.toLowerCase();
				
				let limit = 0;
				if (type.includes('lab')) limit = planLimits.labs;
				else if (type.includes('supplement')) limit = planLimits.supplements;
				else if (type.includes('coaching')) limit = planLimits.coaching;
				
				badge.textContent = `${currentCount}/${limit} included`;
			}
		});
	}
	
	// =============== PLAN RECOMMENDATION ENGINE ===============
	class PlanRecommendationEngine {
		constructor(userProfile, budgetPreference) {
			this.userProfile = userProfile;
			this.budgetPreference = budgetPreference;
			this.planTiers = this.loadPlanTiers();
		}
		
		recommendOptimalPlan() {
			const healthComplexity = this.assessHealthComplexity();
			const engagementLevel = this.assessEngagementLevel();
			const valueOptimisation = this.calculateValueOptimisation();
			
			const scoredPlans = this.planTiers.map(plan => ({
				...plan,
				score: this.calculatePlanScore(plan, healthComplexity, engagementLevel, valueOptimisation)
			}));
			
			return scoredPlans.sort((a, b) => b.score - a.score)[0];
		}
		
		calculatePlanScore(plan, healthComplexity, engagementLevel, valueOptimisation) {
			let score = 0;
			
			// Health complexity alignment (40% weight)
			if (healthComplexity >= 7 && plan.tier === 'Premium') score += 40;
			else if (healthComplexity >= 4 && plan.tier === 'Standard') score += 40;
			else if (healthComplexity < 4 && plan.tier === 'Base') score += 40;
			else score += Math.max(0, 40 - Math.abs(healthComplexity - plan.complexityTarget) * 5);
			
			// Budget alignment (30% weight)
			if (this.budgetPreference && plan.monthlyPrice <= this.budgetPreference) {
				score += 30;
			} else if (this.budgetPreference) {
				const overBudget = (plan.monthlyPrice - this.budgetPreference) / this.budgetPreference;
				score += Math.max(0, 30 - overBudget * 30);
			}
			
			// Engagement alignment (20% weight)
			const engagementFit = Math.abs(engagementLevel - plan.engagementTarget);
			score += Math.max(0, 20 - engagementFit * 3);
			
			// Value optimisation (10% weight)
			score += valueOptimisation * 10;
			
			return score;
		}
		
		loadPlanTiers() {
			return [
				{
					id: 'base',
					tier: 'Base',
					name: 'Base Plan',
					displayPrice: '£49',
					monthlyPrice: 49,
					complexityTarget: 2,
					engagementTarget: 3,
					allowances: { labs: 1, supplements: 1, coaching: 15 },
					features: ['Basic health monitoring', 'Essential supplements', 'Limited coaching']
				},
				{
					id: 'standard',
					tier: 'Standard',
					name: 'Standard Plan',
					displayPrice: '£99',
					monthlyPrice: 99,
					complexityTarget: 5,
					engagementTarget: 6,
					allowances: { labs: 2, supplements: 2, coaching: 30 },
					features: ['Comprehensive monitoring', 'Premium supplements', 'Regular coaching']
				},
				{
					id: 'premium',
					tier: 'Premium',
					name: 'Premium Plan',
					displayPrice: '£149',
					monthlyPrice: 149,
					complexityTarget: 8,
					engagementTarget: 9,
					allowances: { labs: 3, supplements: 3, coaching: 45 },
					features: ['Advanced monitoring', 'Premium supplements', 'Intensive coaching']
				}
			];
		}
		
		assessHealthComplexity() {
			let complexity = 0;
			
			// Risk factors
			if (State.onboarding.answers.smoker) complexity += 3;
			if (State.user.bmi > 30) complexity += 2;
			if (State.user.bmi > 25) complexity += 1;
			
			// Wearables data complexity
			if (State.wearables.series.rhr?.length) {
				const avgRHR = State.wearables.series.rhr.slice(-7).reduce((a, b) => a + b, 0) / 7;
				if (avgRHR > 80) complexity += 2;
			}
			
			// Sleep quality
			if (State.wearables.series.sleep?.length) {
				const avgSleep = State.wearables.series.sleep.slice(-7).reduce((a, b) => a + b, 0) / 7;
				if (avgSleep < 6) complexity += 2;
				else if (avgSleep < 7) complexity += 1;
			}
			
			return Math.min(10, complexity);
		}
		
		assessEngagementLevel() {
			let engagement = 5; // Base level
			
			// Device connections
			if (State.devices.connected.length > 0) engagement += 2;
			
			// Assessment completion
			if (State.onboarding.completed) engagement += 1;
			
			// Historical engagement (if available)
			if (State.assessments.length > 0) engagement += 1;
			
			return Math.min(10, engagement);
		}
		
		calculateValueOptimisation() {
			// Calculate value based on plan features vs user needs
			const userNeeds = this.assessUserNeeds();
			const planValue = this.planTiers.reduce((max, plan) => {
				const value = this.calculatePlanValue(plan, userNeeds);
				return Math.max(max, value);
			}, 0);
			
			return planValue / 10; // Normalize to 0-1
		}
		
		assessUserNeeds() {
			return {
				labs: this.userProfile.healthComplexity > 5 ? 3 : this.userProfile.healthComplexity > 2 ? 2 : 1,
				supplements: this.userProfile.engagementLevel > 7 ? 3 : this.userProfile.engagementLevel > 4 ? 2 : 1,
				coaching: this.userProfile.healthComplexity > 6 ? 45 : this.userProfile.healthComplexity > 3 ? 30 : 15
			};
		}
		
		calculatePlanValue(plan, userNeeds) {
			const labValue = Math.min(plan.allowances.labs, userNeeds.labs) / userNeeds.labs;
			const supplementValue = Math.min(plan.allowances.supplements, userNeeds.supplements) / userNeeds.supplements;
			const coachingValue = Math.min(plan.allowances.coaching, userNeeds.coaching) / userNeeds.coaching;
			
			return (labValue + supplementValue + coachingValue) / 3;
		}
		
		renderPlanRecommendation(recommendedPlan) {
			console.log('PlanRecommendationEngine.renderPlanRecommendation called with:', recommendedPlan);
			const recommendationCard = document.getElementById('budget-recommendation');
			if (!recommendationCard) {
				console.log('budget-recommendation element not found in PlanRecommendationEngine');
				return;
			}
			
			recommendationCard.innerHTML = `
				<div class="plan-recommendation-content">
					<div class="recommendation-badge">
						<span class="badge-icon"></span>
						<span class="badge-text">Best Match for You</span>
					</div>
					
					<div class="plan-highlight">
						<h4>${recommendedPlan.name}</h4>
						<div class="price-highlight">
							<span class="price">${recommendedPlan.displayPrice}</span>
							<span class="period">/month</span>
						</div>
					</div>
					
					<div class="recommendation-reasons">
						<h5>Why this plan?</h5>
						<ul class="reason-list">
							${this.generateRecommendationReasons(recommendedPlan).map(reason => 
								`<li class="reason-item">${reason}</li>`
							).join('')}
						</ul>
					</div>
					
					<button class="btn recommendation-cta" onclick="selectRecommendedPlan('${recommendedPlan.id}')">
						Select This Plan
					</button>
				</div>
			`;
			
			recommendationCard.style.display = 'block';
			console.log('PlanRecommendationEngine.renderPlanRecommendation completed, display set to block');
		}
		
		generateRecommendationReasons(plan) {
			console.log('generateRecommendationReasons called with plan:', plan);
			const reasons = [];
			const healthComplexity = this.assessHealthComplexity();
			const engagementLevel = this.assessEngagementLevel();
			console.log('healthComplexity:', healthComplexity, 'engagementLevel:', engagementLevel);
			
			if (healthComplexity >= 7) {
				reasons.push('Comprehensive health monitoring for complex needs');
			} else if (healthComplexity >= 4) {
				reasons.push('Balanced approach to health optimization');
			} else {
				reasons.push('Essential health monitoring for your lifestyle');
			}
			
			if (engagementLevel >= 7) {
				reasons.push('Maximum value with your high engagement level');
			} else if (engagementLevel >= 4) {
				reasons.push('Good fit for your engagement preferences');
			} else {
				reasons.push('Simple and effective for your needs');
			}
			
			if (this.budgetPreference && plan.monthlyPrice <= this.budgetPreference) {
				reasons.push('Fits within your budget preferences');
			}
			
			console.log('generateRecommendationReasons returning:', reasons);
			return reasons;
		}
	}
	
	
	// =============== ENHANCED NAVIGATION CONTROLLER ===============
	class NavigationController {
		constructor() {
			this.locks = new Map();
			this.completionStates = new Map();
			this.userProgress = this.loadUserProgress();
		}
		
		initializeNavigation() {
			this.setInitialLocks();
			this.bindNavigationEvents();
			this.updateNavigationDisplay();
		}
		
		setInitialLocks() {
			const navFlow = [
				{ route: 'onboarding', prerequisite: null },
				{ route: 'dashboard', prerequisite: 'onboarding' },
				{ route: 'plan', prerequisite: 'dashboard' },
				{ route: 'build-first-month', prerequisite: 'plan' },
				{ route: 'addons', prerequisite: 'build-first-month' },
				{ route: 'checkout', prerequisite: 'addons' }
			];
			
            // Relax gating for first-month and add-ons so the CTA always works
			navFlow.forEach(({ route, prerequisite }) => {
                if (route === 'build-first-month' || route === 'addons') {
                    this.setLock(route, false);
                    return;
                }
				if (prerequisite && !this.isStepCompleted(prerequisite)) {
					this.setLock(route, true);
				} else {
					this.setLock(route, false);
				}
			});
		}
		
		updateNavLocks(completedStep) {
			this.markStepCompleted(completedStep);
			
			const unlockRules = {
				'onboarding': ['dashboard'],
				'dashboard': ['plan'],
				'plan': ['build-first-month'],
				'build-first-month': ['addons'],
				'addons': ['checkout']
			};
			
			if (unlockRules[completedStep]) {
				unlockRules[completedStep].forEach(route => {
					this.setLock(route, false);
				});
			}
			
			this.updateNavigationDisplay();
		}
		
		setLock(route, isLocked) {
			this.locks.set(route, isLocked);
			const navElement = document.querySelector(`[data-route="${route}"]`);
			
			if (navElement) {
				navElement.classList.toggle('locked', isLocked);
				navElement.setAttribute('aria-disabled', isLocked.toString());
				
				if (isLocked) {
					navElement.addEventListener('click', this.handleLockedNavigation.bind(this));
				} else {
					navElement.removeEventListener('click', this.handleLockedNavigation.bind(this));
				}
			}
		}
		
		handleLockedNavigation(event) {
			event.preventDefault();
			const route = event.currentTarget.dataset.route;
			const prerequisite = this.getPrerequisite(route);
			
			showToast(`Please complete ${prerequisite} first`, 'warning');
		}
		
		getPrerequisite(route) {
			const prerequisites = {
				'dashboard': 'onboarding',
				'plan': 'dashboard assessment',
            // Do not block these routes with prerequisite copy
            'build-first-month': '',
            'addons': '',
				'checkout': 'add-ons selection'
			};
			
			return prerequisites[route] || 'previous step';
		}
		
		updateNavigationDisplay() {
			document.querySelectorAll('.nav-links a').forEach(link => {
				const route = link.dataset.route;
				const isLocked = this.locks.get(route);
				
				link.classList.toggle('locked', isLocked);
				
				if (isLocked) {
					link.style.opacity = '0.5';
					link.style.cursor = 'not-allowed';
					link.title = `Complete ${this.getPrerequisite(route)} first`;
				} else {
					link.style.opacity = '1';
					link.style.cursor = 'pointer';
					link.title = '';
				}
			});
		}
		
		isStepCompleted(step) {
			const completionChecks = {
				'onboarding': () => State.onboarding.completed,
				'dashboard': () => State.navUnlocked.dashboard,
				'plan': () => State.plan.tier !== null,
                // Always consider these steps complete to avoid blocking navigation
                'build-first-month': () => true,
                'addons': () => true
			};
			
			const check = completionChecks[step];
			return check ? check() : false;
		}
		
		markStepCompleted(step) {
			this.completionStates.set(step, true);
			this.saveUserProgress();
		}
		
		loadUserProgress() {
			return {
				completedSteps: read('navigation.completedSteps', []),
				lastAccessed: read('navigation.lastAccessed', null)
			};
		}
		
		saveUserProgress() {
			const completedSteps = Array.from(this.completionStates.keys());
			save({
				'navigation.completedSteps': completedSteps,
				'navigation.lastAccessed': new Date().toISOString()
			});
		}
		
		getProgressPercentage() {
			const totalSteps = 6; // onboarding, dashboard, plan, build-first-month, addons, checkout
			const completedSteps = Array.from(this.completionStates.keys()).length;
			return Math.round((completedSteps / totalSteps) * 100);
		}
		
		renderProgressIndicator() {
			const progressContainer = document.getElementById('navigation-progress');
			if (!progressContainer) return;
			
			const percentage = this.getProgressPercentage();
			
			progressContainer.innerHTML = `
				<div class="progress-header">
					<h4>Your Progress</h4>
					<span class="progress-percentage">${percentage}%</span>
				</div>
				<div class="progress-bar">
					<div class="progress-fill" style="width: ${percentage}%"></div>
				</div>
				<div class="progress-steps">
					${this.renderProgressSteps()}
				</div>
			`;
		}
		
		renderProgressSteps() {
			const steps = [
				{ id: 'onboarding', label: 'Assessment', icon: '📋' },
				{ id: 'dashboard', label: 'Dashboard', icon: '📊' },
				{ id: 'plan', label: 'Plan', icon: '💎' },
				{ id: 'build-first-month', label: 'First Month', icon: '🗓️' },
				{ id: 'addons', label: 'Add-ons', icon: '➕' },
				{ id: 'checkout', label: 'Checkout', icon: '💳' }
			];
			
			return steps.map(step => {
				const isCompleted = this.isStepCompleted(step.id);
				const isLocked = this.locks.get(step.id);
				
				return `
					<div class="progress-step ${isCompleted ? 'completed' : ''} ${isLocked ? 'locked' : ''}">
						<div class="step-icon">${step.icon}</div>
						<div class="step-label">${step.label}</div>
						${isCompleted ? '<div class="step-check">✓</div>' : ''}
					</div>
				`;
			}).join('');
		}
	}
	
	// Initialize navigation controller
	const navigationController = new NavigationController();
	
	// =============== ENHANCED ACTIVE PLAN DISPLAY ===============
	function renderActivePlanDisplay(activePlan) {
		const planDisplayContainer = document.getElementById('account-plan-details');
		if (!planDisplayContainer) return;
		
		if (!activePlan) {
			planDisplayContainer.innerHTML = '<p class="muted">No active plan</p>';
			return;
		}
		
		planDisplayContainer.innerHTML = `
			<div class="active-plan-card">
				<div class="plan-header">
					<div class="plan-tier-badge ${activePlan.tier.toLowerCase()}">
						${activePlan.tier.toUpperCase()}
					</div>
					<div class="plan-status active">
						<span class="status-indicator"></span>
						Active
					</div>
				</div>
				
				<div class="plan-details">
					<h4>${activePlan.name}</h4>
					<div class="plan-pricing">
						<span class="current-price">${activePlan.displayPrice}</span>
						<span class="billing-cycle">/${activePlan.billingCycle}</span>
					</div>
				</div>
				
				<div class="plan-allowances">
					<div class="allowance-grid">
						<div class="allowance-item">
							<span class="allowance-label">Lab Tests</span>
							<span class="allowance-value">${activePlan.allowances.labs} per month</span>
						</div>
						<div class="allowance-item">
							<span class="allowance-label">Supplements</span>
							<span class="allowance-value">${activePlan.allowances.supplements} per month</span>
						</div>
						<div class="allowance-item">
							<span class="allowance-label">Coaching</span>
							<span class="allowance-value">${activePlan.allowances.coaching} min/month</span>
						</div>
					</div>
				</div>
				
				<div class="plan-usage">
					<h5>This Month's Usage</h5>
					<div class="usage-bars">
						${renderUsageBars(activePlan)}
					</div>
				</div>
				
				<div class="plan-actions">
					<button class="btn btn-secondary" onclick="Router.go('build-first-month')">
						Modify Plan
					</button>
					<button class="btn-ghost" onclick="showPlanChangeModal()">
						Change Plan
					</button>
				</div>
			</div>
		`;
	}

	function renderUsageBars(activePlan) {
		const usage = getCurrentMonthUsage();
		
		return `
			<div class="usage-item">
				<div class="usage-header">
					<span class="usage-label">Lab Tests</span>
					<span class="usage-count">${usage.labs}/${activePlan.allowances.labs}</span>
				</div>
				<div class="usage-bar">
					<div class="usage-fill" style="width: ${(usage.labs / activePlan.allowances.labs) * 100}%"></div>
				</div>
			</div>
			
			<div class="usage-item">
				<div class="usage-header">
					<span class="usage-label">Supplements</span>
					<span class="usage-count">${usage.supplements}/${activePlan.allowances.supplements}</span>
				</div>
				<div class="usage-bar">
					<div class="usage-fill" style="width: ${(usage.supplements / activePlan.allowances.supplements) * 100}%"></div>
				</div>
			</div>
			
			<div class="usage-item">
				<div class="usage-header">
					<span class="usage-label">Coaching</span>
					<span class="usage-count">${usage.coaching}/${activePlan.allowances.coaching} min</span>
				</div>
				<div class="usage-bar">
					<div class="usage-fill" style="width: ${(usage.coaching / activePlan.allowances.coaching) * 100}%"></div>
				</div>
			</div>
		`;
	}

	function getCurrentMonthUsage() {
		// Get current month usage from State or calculate from available data
		const currentDate = new Date();
		const currentMonth = currentDate.getMonth();
		const currentYear = currentDate.getFullYear();
		
		// This would typically come from your backend or be calculated from user activity
		// For now, we'll use placeholder data
		return {
			labs: State.labs?.currentMonthUsage || 0,
			supplements: State.supplements?.currentMonthUsage || 0,
			coaching: State.coaching?.currentMonthUsage || 0
		};
	}

	function showPlanChangeModal() {
		// Show modal for plan changes
		const modal = document.createElement('div');
		modal.className = 'modal active';
		modal.innerHTML = `
			<div class="modal-content">
				<h3>Select Your Plan</h3>
				<p>Are you sure you want to change your plan? This will affect your next billing cycle.</p>
				
				<div class="plan-options">
					${renderPlanChangeOptions()}
				</div>
				
				<div class="modal-actions">
					<button class="btn btn-secondary" onclick="closePlanChangeModal()">Cancel</button>
					<button class="btn" onclick="confirmPlanChange()">Confirm Change</button>
				</div>
			</div>
		`;
		
		document.body.appendChild(modal);
	}

	function renderPlanChangeOptions() {
		const currentPlan = State.plan.tier || 'Base';
		const plans = [
			{ id: 'base', name: 'Base Plan', price: '£49', features: ['1 lab test', '1 supplement', '15 min coaching'] },
			{ id: 'standard', name: 'Standard Plan', price: '£99', features: ['2 lab tests', '2 supplements', '30 min coaching'] },
			{ id: 'premium', name: 'Premium Plan', price: '£149', features: ['4 lab tests', '3 supplements', '45 min coaching'] }
		];
		
		return plans.map(plan => `
			<div class="plan-option ${plan.id === currentPlan.toLowerCase() ? 'current' : ''}" data-plan="${plan.id}">
				<div class="plan-option-header">
					<h4>${plan.name}</h4>
					<span class="plan-price">${plan.price}/month</span>
				</div>
				<ul class="plan-features">
					${plan.features.map(feature => `<li>${feature}</li>`).join('')}
				</ul>
				${plan.id === currentPlan.toLowerCase() ? '<div class="current-badge">Current Plan</div>' : ''}
			</div>
		`).join('');
	}

	function closePlanChangeModal() {
		const modal = document.querySelector('.modal');
		if (modal) {
			modal.remove();
		}
	}

	function confirmPlanChange() {
		const selectedPlan = document.querySelector('.plan-option:not(.current)');
		if (selectedPlan) {
			const planId = selectedPlan.dataset.plan;
			const planMapping = {
				'base': 'Base',
				'standard': 'Standard',
				'premium': 'Premium'
			};
			
			const tier = planMapping[planId];
			if (tier) {
				selectPlanTier(tier);
				showToast(`Plan changed to ${tier}! Changes will take effect on your next billing cycle.`);
				closePlanChangeModal();
			}
		}
	}
	
	function logEvent(type, data={}){
		const e={type, data, ts:Date.now()};
		State.eventsLog.push(e);
		save({'_events':State.eventsLog});
		console.log('EVENT',e);
	}

	// =============== SERVICES CATALOGUE ===============
	const Services = [
		// Core Services
		{id:'coaching', name:'Health coaching', price:99, category:'Coaching', description:'Personalised guidance for sustainable health habits', badge:'Bundle', outcome:'Build lasting healthy habits in 8-12 weeks', features:'1:1 coaching, habit tracking, goal setting', gender:'any'},
		{id:'weight-mgmt', name:'Long-term weight management', price:129, category:'Metabolism', description:'Comprehensive weight loss programme with medication, coaching, and nutrition support', badge:'Bundle', outcome:'Sustainable weight loss of 5-10% in 6 months', features:'Medication, nutrition plan, weekly check-ins', gender:'any'},
		{id:'sleep', name:'Sleep optimisation', price:69, category:'Sleep', description:'Sleep tracking, CBT-I techniques, and a tailored wind-down protocol', badge:'Bundle', outcome:'Improve sleep quality in 8-12 weeks', features:'CBT-I, wind-down protocol, sleep tracking', gender:'any'},
		{id:'blood-tests', name:'Personalised blood tests', price:79, category:'Diagnostics', description:'Comprehensive biomarker analysis with GP review', badge:'Bundle', outcome:'Complete health picture in 2-3 days', features:'40+ biomarkers, GP review, action plan', gender:'any'},
		{id:'cognition', name:'Cognition support', price:79, category:'Cognition', description:'Sharpen focus with sleep, stress and activity strategies', badge:'Bundle', outcome:'Enhanced focus and mental clarity', features:'Brain training, stress management, sleep optimization', gender:'any'},
		{id:'supplements', name:'Enhanced supplements', price:49, category:'Nutrition', description:'Personalised vitamin and mineral support based on your needs', badge:'Bundle', outcome:'Optimize nutrient levels in 4-6 weeks', features:'Personalised formula, monthly adjustments', gender:'any'},
		
		// Clinical Services
		{id:'sexual-support', name:'Sexual support pathway', price:89, category:'Sexual Health', description:'Discreet treatment pathway with clinical oversight', outcome:'Improve sexual health and confidence', features:'Clinical assessment, treatment options, ongoing support', gender:'any'},
		{id:'testosterone', name:'Testosterone optimisation', price:149, category:'Hormones', description:'Clinical assessment for low testosterone — locked until bloods confirm eligibility', badge:'Clinical', gated:true, outcome:'Restore energy and vitality', features:'TRT, monitoring, lifestyle optimization', gender:'male'},
		
		// Add-on Services
		{id:'bp-optimisation', name:'Blood pressure optimisation', price:59, category:'Cardiovascular', description:'Home BP monitoring, targets, and lifestyle plan', outcome:'Lower BP to healthy range', features:'Home monitoring, lifestyle plan, medication if needed', gender:'any'},
		{id:'cholesterol-improvement', name:'Cholesterol check & improvement', price:69, category:'Cardiovascular', description:'Lipid profile, targets, and re-test plan', outcome:'Improve cholesterol profile', features:'Lipid testing, dietary plan, statins if needed', gender:'any'},
		{id:'prediabetes-prevention', name:'Prediabetes prevention', price:79, category:'Metabolism', description:'A1c tracking and goals to reduce diabetes risk', outcome:'Prevent progression to diabetes', features:'A1c monitoring, lifestyle intervention, medication if needed', gender:'any'},
		{id:'alcohol-smart', name:'Alcohol smart plan', price:49, category:'Lifestyle', description:'Safer-drinking goals and weekly coaching', outcome:'Reduce alcohol intake safely', features:'Weekly coaching, tracking, harm reduction', gender:'any'},
		{id:'stop-smoking', name:'Stop-smoking plan', price:59, category:'Lifestyle', description:'Quit plan matched to your readiness', outcome:'Quit smoking for good', features:'NRT, behavioral support, relapse prevention', gender:'any'},
		
		// Requestable Services (show as tiles with "Register interest")
		{id:'menopause-support', name:'Menopause support', price:99, category:'Women\'s Health', description:'Symptom review, treatment eligibility, and coaching around HRT & lifestyle', badge:'Requestable', gender:'female'},
		{id:'msk-physio', name:'MSK/Physio for back & joints', price:89, category:'MSK', description:'Digital physio plan, posture & mobility coaching, escalation if red flags', badge:'Requestable', gender:'any'},
		{id:'heart-risk-panel', name:'Advanced heart risk panel', price:129, category:'Cardiovascular', description:'apoB, Lp(a), hs-CRP with cardiometabolic coaching and targets', badge:'Requestable', gender:'any'},
		{id:'gut-health-test', name:'Gut health test (microbiome)', price:149, category:'Nutrition', description:'Food-first guidance; use "educational" positioning', badge:'Requestable', gender:'any'}
	];
	const BundleDefs = {
		metabolic: {name:'Metabolic Reset', ids:['weight-mgmt','coaching','blood-tests'], discountPct:20},
		sleep: {name:'Sleep & Focus', ids:['sleep','cognition','supplements'], discountPct:18},
	};
	// Legacy tier system removed - using new MODEL-based pricing
	// =============== SAVINGS ENGINE ===============
	// Legacy savings engine removed - using new pricing model
	
	// Stub functions for legacy compatibility
function priceQuote({ selectedIds = [], annual = false, coupon = '' } = {}) {
	// Compute plan base from State.plan.tier using same 10% annual rule
	const tier = State.plan.tier;
	if (!tier || !MODEL.plans[tier]) {
		return { rule: 'none', discountPct: 0, discountValue: 0, monthlySubtotal: 0, monthlyTotal: 0, effectiveMonthly: 0, breakdown: [] };
	}
	const baseMonthly = MODEL.plans[tier].price;
	const discountedMonthly = annual ? Math.round(baseMonthly * 0.9) : baseMonthly; // 10% discount

	// Add-ons: sum prices of selected add-ons (flat monthly), ignore shipping/fees per new rules
	const addOnsMonthly = (State.plan.selectedAddOns || []).reduce((sum, addOnId) => {
		for (const category of Object.values(MODEL.memberAddOns)) {
			for (const addon of Object.values(category)) {
				if (addon.id === addOnId) return sum + addon.price;
			}
		}
		return sum;
	}, 0);

	const monthlySubtotal = discountedMonthly + addOnsMonthly;
	const discountPct = annual ? 10 : 0;
	const discountValue = annual ? Math.round(baseMonthly * 0.1) : 0;
	const monthlyTotal = monthlySubtotal; // fees/shipping included
	const effectiveMonthly = annual ? discountedMonthly : monthlyTotal;

	return {
		rule: annual ? 'annual-10' : 'none',
		discountPct,
		discountValue,
		monthlySubtotal,
		monthlyTotal,
		effectiveMonthly,
		breakdown: [
			{ label: 'Plan', amount: discountedMonthly },
			{ label: 'Add-ons', amount: addOnsMonthly }
		]
	};
}

// Navigation helpers for inline summary actions
function goToAddons() {
    window.__onboardingLock = false; // safety: don't let the lock block navigation
    console.log('goToAddons called - saving first month picks');
    
    // Mark first-month step as started/completed to satisfy nav prerequisite
    try {
        const picks = {
            labs: HS.firstMonth?.labs || [],
            supplements: HS.firstMonth?.supplements || [],
            coaching: HS.firstMonth?.coaching || null,
        };
        
        console.log('🚀 goToAddons - Saving first month picks:', {
            from: HS.firstMonth,
            to: picks,
            labDetails: picks.labs.map(id => {
                const lab = MODEL.catalog.labs.find(l => l.id === id);
                return { id, name: lab?.name || 'Unknown' };
            }),
            supplementDetails: picks.supplements.map(id => {
                const supp = MODEL.catalog.supplements.find(s => s.id === id);
                return { id, name: supp?.name || 'Unknown' };
            }),
            coachingDetails: picks.coaching ? {
                id: picks.coaching,
                name: MODEL.catalog.coaching.find(c => c.id === picks.coaching)?.name || 'Unknown'
            } : null
        });
        
        State.plan.firstMonthPicks = picks;
        save({'plan.firstMonthPicks': picks});
    } catch(e) {
        console.error('Error saving first month picks:', e);
    }
    try { Router.go('addons'); } catch (e) { console.warn('Router.go failed', e); }
    // Fallback: if view didn't activate within 75ms, force it
    setTimeout(() => {
        const target = document.querySelector('[data-view="addons"]');
        if (!target || !target.classList.contains('active')) {
            console.warn('Forcing navigation to addons view');
            document.querySelectorAll('[data-view]').forEach(s => s.classList.remove('active'));
            if (target) target.classList.add('active');
            State.currentView = 'addons';
            try { updateAddonsFooter(); } catch(_){}
            try { updateNavLocks(); } catch(_){}
            window.scrollTo(0,0);
        }
        console.log('Router.go called');
    }, 75);
}

function goToCheckout() {
    // Synchronize first month picks before going to checkout
    const synchronizedPicks = {
        labs: HS.firstMonth?.labs || [],
        supplements: HS.firstMonth?.supplements || [],
        coaching: HS.firstMonth?.coaching || null
    };
    
    console.log('🚀 goToCheckout - Synchronizing first month picks for checkout:', {
        from: HS.firstMonth,
        to: synchronizedPicks,
        labDetails: synchronizedPicks.labs.map(id => {
            const lab = MODEL.catalog.labs.find(l => l.id === id);
            return { id, name: lab?.name || 'Unknown' };
        }),
        supplementDetails: synchronizedPicks.supplements.map(id => {
            const supp = MODEL.catalog.supplements.find(s => s.id === id);
            return { id, name: supp?.name || 'Unknown' };
        }),
        coachingDetails: synchronizedPicks.coaching ? {
            id: synchronizedPicks.coaching,
            name: MODEL.catalog.coaching.find(c => c.id === synchronizedPicks.coaching)?.name || 'Unknown'
        } : null
    });
    
    // Additional debugging for the specific items
    if (synchronizedPicks.labs && synchronizedPicks.labs.length > 0) {
        console.log('Synchronizing lab selections:', synchronizedPicks.labs.map(id => {
            const lab = MODEL.catalog.labs.find(l => l.id === id);
            return { id, name: lab?.name || 'Unknown' };
        }));
    }
    
    if (synchronizedPicks.supplements && synchronizedPicks.supplements.length > 0) {
        console.log('Synchronizing supplement selections:', synchronizedPicks.supplements.map(id => {
            const supp = MODEL.catalog.supplements.find(s => s.id === id);
            return { id, name: supp?.name || 'Unknown' };
        }));
    }
    
    if (synchronizedPicks.coaching) {
        const coach = MODEL.catalog.coaching.find(c => c.id === synchronizedPicks.coaching);
        console.log('Synchronizing coaching selection:', { id: synchronizedPicks.coaching, name: coach?.name || 'Unknown' });
    }
    
    State.plan.firstMonthPicks = synchronizedPicks;
    save({'plan.firstMonthPicks': State.plan.firstMonthPicks});
    
    Router.go('checkout');
}

// Export navigation helpers to window for inline handlers
Object.assign(window, {
    goToAddons,
    goToCheckout,
});

function applyBestDiscount() { return priceQuote({ annual: State.billing==='annual' }); }
	// =============== PLAN FUNCTIONS ===============
	function editPlan() {
		State.plan.editing = true;
		save({'plan.editing': true});
		renderNewPlanPage();
	}
	
	// =============== DATE FORMATTING ===============
	function formatDateInput(input) {
		// Only format if the input has content and doesn't already match the expected format
		if (!input.value) return;
		
		// If it already looks like YYYY-MM-DD, leave it alone
		if (/^\d{4}-\d{2}-\d{2}$/.test(input.value)) return;
		
		let value = input.value.replace(/\D/g, ''); // Remove non-digits
		
		// Format as YYYY-MM-DD
		if (value.length >= 4) {
			value = value.substring(0, 4) + '-' + value.substring(4);
		}
		if (value.length >= 7) {
			value = value.substring(0, 7) + '-' + value.substring(7, 9);
		}
		
		// Limit to 10 characters (YYYY-MM-DD)
		value = value.substring(0, 10);
		
		input.value = value;
	}
	
	// =============== PLAN VISIBILITY & GATING LOGIC ===============
	function visibilityForService(s, feat, user){
		const show = {visible:true, gated:false, reason:null, section:'more'}; // section: 'recommended'|'more'|'potential'|'requestable'

		// Requestables off the grid
		if (['menopause-support','msk-physio','heart-risk-panel','gut-health-test'].includes(s.id)) {
			return {visible:false, section:'requestable'};
		}

		// Demographic gates - make menopause support available to all genders
		if (s.id==='menopause-support') {
			// Available to all genders, but may have different recommendations based on gender
			return {visible:true, section:'requestable'};
		}
		
		// Symptom/assessment gates
		const hasSexSymptoms = feat?.symptoms?.current?.some(x=>x.key==='low-sex-drive');
		const riskyAUDIT = (feat.auditC?.total||0) >= 5 || (feat.alcohol?.units||0) > 14;
		const smokerReady = feat.smoking?.smoker && (feat.smoking?.readiness||0)>=3;
		const weightSignals = (feat.WHtR>=0.5) || (feat.findrisc?.total>=12) || (feat.steps7<6000);
		
		if (s.id==='alcohol-smart')  { if(!riskyAUDIT) return {visible:false}; }
		if (s.id==='stop-smoking')   { if(!smokerReady) return {visible:false}; }
		if (s.id==='weight-mgmt')    { if(!weightSignals) show.section='more'; }
		if (s.id==='cholesterol-improvement'){ if(!(user.age>=40 || feat?.history?.cholesterol || (feat.findrisc?.total>=12))) return {visible:false}; }
		if (s.id==='bp-optimisation'){ if(!(feat?.history?.bp || feat?.vitals?.systolicBP>=135)) return {visible:false}; }
		if (s.id==='prediabetes-prevention'){ if(!(feat.findrisc?.total>=12 || feat.WHtR>=0.5)) return {visible:false}; }

		// Clinical gating for TRT
		if (s.id==='testosterone'){
			const labsSayLowT = feat.labs?.testosteroneMorningLow===true;
			const clinicianOK = State.labs?.clinicianApproved===true;
			const bloodsSelected = State.plan.selectedIds?.includes('blood-tests') || false;
			if (labsSayLowT && clinicianOK && hasSexSymptoms) { show.section='recommended'; }
			else { return {visible:true, gated:true, section:'potential', reason:'Add blood tests to assess eligibility'}; }
		}

		// Default placements
		if (['coaching','sleep','blood-tests'].includes(s.id)) show.section='recommended';

		return show;
	}

	// Helper function to convert service ID to key
	function idToKey(id) {
		const idMap = {
			'health-coaching': 'coaching',
			'weight-mgmt': 'weight',
			'sleep': 'sleep',
			'blood-tests': 'bloods',
			'sexual-support': 'sexual',
			'testosterone': 'trt',
			'cognition': 'cognition',
			'supplements': 'supplements'
		};
		return idMap[id] || id;
	}

	function curateCatalogue(services, feat, user){
		console.log('curateCatalogue called with services:', services.length, 'feat:', feat, 'user:', user);
		const groups = {recommended:[], more:[], potential:[], requestable:[]};
		for(const s of services){
			const v = visibilityForService(s, feat, user);
			console.log('Service:', s.id, 'visibility:', v);
			if(!v.visible){ if(v.section) groups[v.section].push({...s, ...v}); continue; }
			groups[v.section].push({...s, ...v});
		}
		// rank within sections (your scorePackages + price as tiebreaker)
		const scores = scorePackages(feat);
		const scoreOf = id => scores[idToKey(id)]||0;
		for(const k of ['recommended','more','potential']) {
			groups[k].sort((a,b)=> (scoreOf(b.id)-scoreOf(a.id)) || (a.price-b.price));
		}
		return groups;
	}

	// Helper functions for the new plan design
	function toggleSection(sectionName) {
		const section = document.getElementById(sectionName + '-section');
		const toggle = document.getElementById(sectionName + '-toggle');
		if (section && toggle) {
			const isVisible = section.style.display !== 'none';
			section.style.display = isVisible ? 'none' : 'block';
			toggle.textContent = isVisible ? 
				`Show ${sectionName === 'more' ? 'more options' : 'potential options'}` : 
				'Hide';
		}
	}
	
	function toggleCollapsible(header) {
		const content = header.nextElementSibling;
		const arrow = header.querySelector('span');
		if (content && arrow) {
			const isVisible = content.classList.contains('show');
			if (isVisible) {
				content.classList.remove('show');
				arrow.textContent = '▼';
                header.setAttribute('aria-expanded', 'false');
			} else {
				content.classList.add('show');
				arrow.textContent = '▲';
                header.setAttribute('aria-expanded', 'true');
			}
		}
	}
	
	function showAllMore() {
		// Skip if using new pricing system
		if (State.plan.tier) {
			return;
		}
		
		// Show all remaining services in the more section
		const moreSection = document.getElementById('more-section');
		if (moreSection) {
			// Re-render with all services
			renderCatalogue();
		}
	}
	
	function showGatedPanel(serviceId) {
		const service = Services.find(s => s.id === serviceId);
		if (!service) return;
		
		// Show inline panel with next steps
		const panel = document.createElement('div');
		panel.className = 'gated-panel';
		panel.innerHTML = `
			<div style="padding:1rem; background:#fef3c7; border-radius:8px; margin-top:0.5rem">
				<h5 style="margin:0 0 0.5rem 0; color:#92400e">What to do next</h5>
				<p style="margin:0 0 0.75rem 0; color:#92400e; font-size:0.9rem">${service.gatedReason || 'Complete required assessments to unlock this service.'}</p>
				<div style="display:flex; gap:0.5rem">
					<button class="btn btn-small" onclick="addServiceToPlan('blood-tests')">Add blood tests</button>
					<button class="btn-ghost btn-small" onclick="openModal('clinician-message')">Message clinician</button>
				</div>
			</div>
		`;
		
		// Find the service card and append the panel
		const serviceCard = document.querySelector(`[onclick*="${serviceId}"]`);
		if (serviceCard) {
			// Remove existing panel if any
			const existingPanel = serviceCard.querySelector('.gated-panel');
			if (existingPanel) existingPanel.remove();
			
			serviceCard.appendChild(panel);
		}
	}
	
	function getServiceExplanations(serviceId, feat) {
		// Get the explanations from the recommendation system
		const explanations = State.plan.recommendation?.explanations || {};
		return explanations[serviceId] || [];
	}
	
	function addServiceToPlan(serviceId) {
		// Skip if using new pricing system
		if (State.plan.tier) {
			return;
		}
		
		if (!State.plan.selectedIds) State.plan.selectedIds = [];
		if (!State.plan.selectedIds.includes(serviceId)) {
			State.plan.selectedIds.push(serviceId);
			save({'plan.selectedIds': State.plan.selectedIds});
			renderCatalogue();
			updatePlanSummary();
			showToast('Added to your plan');
		}
	}
	
	// Analytics functions
	function logPlanCardSelected(serviceId, selected) {
		logEvent('plan_card_selected', {serviceId, selected});
	}
	
	function logBundleHintViewed() {
		logEvent('bundle_hint_viewed');
	}
	
	function logGatedServiceCTA(serviceId, action) {
		logEvent('gated_service_cta_clicked', {serviceId, action});
	}

	Object.assign(window,{visibilityForService, curateCatalogue, toggleSection, toggleCollapsible, toggleWearableAccordion, showAllMore, showGatedPanel, getServiceExplanations, addServiceToPlan, logPlanCardSelected, logBundleHintViewed, logGatedServiceCTA, buildGlobalReasons, updateNavLocks, setLock});

	// =============== EVIDENCE & CLAIMS REGISTRY ===============

	// =============== LANDING ===============
	function renderLandingTiles(){
		console.log('renderLandingTiles called');
		const tiles = [
			{id:'immunity', title:'Immunity', copy:'Vitamin D, sleep hygiene, activity plan'},
			{id:'inflammation', title:'Inflammation', copy:'Omega-3, resistance training, anti-inflammatory diet'},
			{id:'cognition', title:'Cognition', copy:'Sleep plan, nutrition pack, focus coaching'},
			{id:'sleep', title:'Sleep', copy:'Tracker habit, wind-down routine, supplement trial'},
			{id:'nutrition', title:'Nutrition', copy:'Personalised plan, protein target, microbiome choices'},
			{id:'hormones', title:'Hormones', copy:'Blood tests, clinical pathway if indicated'}
		];
		const grid = document.getElementById('landing-tiles');
		if (!grid) {
			console.error('landing-tiles element not found');
			return;
		}
		console.log('Found landing-tiles element, rendering', tiles.length, 'tiles');
		grid.innerHTML = tiles.map(t=>`
			<div class="service-card" role="button" tabindex="0" onclick="deepLinkToPlan('${t.id}')" onkeydown="if(event.key==='Enter'){deepLinkToPlan('${t.id}')}" aria-label="${t.title}">
				<div class="service-header"><h4>${t.title}</h4><span class="badge" style="background:var(--mint-50); color:var(--numan-teal)">Check status</span></div>
				<p class="muted">${t.copy}</p>
				<a href="#" style="color:var(--numan-teal); font-weight:700">See actions →</a>
			</div>
		`).join('');
		console.log('Landing tiles rendered successfully');
	}

	// =============== ONBOARDING ===============
	const OnboardingSteps = [
		{
		key:'consent',
		render:()=>`
			<h3>Consent</h3>
			<p class="muted">This application stores your data locally on your device (no network calls). Please confirm consent to proceed.</p>
			<label class="check-pill ${State.consent.health?'selected':''}">
				<input type="checkbox" id="consent-checkbox" ${State.consent.health?'checked':''} onchange="toggleConsent()">
				<span>I consent to health-data processing and optional assessments to help personalise my plan (stored locally on this device)</span>
			</label>
		`,
		validate:()=> !!State.consent.health
		},
		{
			key:'goals',
			render:()=>`
				<h3>What are your health goals?</h3>
				<small class="muted">Select all that apply</small>
				<div class="checkbox-grid" id="ob-goals">
					${['Weight loss','Metabolic health','Energy & sleep','Heart health','Sexual health','Healthy ageing'].map(g=>`
						<label class="check-pill ${State.onboarding.answers.goals?.includes(g)?'selected':''}">
							<input type="checkbox" ${State.onboarding.answers.goals?.includes(g)?'checked':''} onchange="toggleGoal('${g}')">
							<span>${g}</span>
						</label>
					`).join('')}
				</div>
			`,
			validate:()=> (State.onboarding.answers.goals?.length>0)
		},
		{
			key:'basics',
			render:()=>`
				<h3>Basic information</h3>
				<div class="card-grid">
					<div><label>Date of birth</label><input type="text" id="dob-input" value="${State.user.dob||''}" placeholder="YYYY-MM-DD" onblur="formatDateInput(this); setUser('dob', this.value); calculateAgeFromDOB(); updateBMIAndWTH()" maxlength="10"></div>
					<div><label>Gender</label>
						<select onchange="setUser('sex', this.value)">
							<option value="">Select…</option>
							<option value="male" ${State.user.sex==='male'?'selected':''}>Male</option>
							<option value="female" ${State.user.sex==='female'?'selected':''}>Female</option>
							<option value="non-binary" ${State.user.sex==='non-binary'?'selected':''}>Non-binary</option>
							<option value="prefer-not-to-say" ${State.user.sex==='prefer-not-to-say'?'selected':''}>Prefer not to say</option>
						</select>
					</div>
				</div>
				<div class="card-grid" style="margin-top:1rem;">
					<div><label>Height (cm)</label><input type="number" id="height-input" value="${State.user.height||''}" oninput="setUser('height', this.value); updateBMIAndWTH()" min="100" max="250"></div>
					<div><label>Weight (kg)</label><input type="number" id="weight-input" value="${State.user.weight||''}" oninput="setUser('weight', this.value); updateBMIAndWTH()" min="40" max="250"></div>
					<div><label>Waist (cm)</label><input type="number" id="waist-input" value="${State.user.waist||''}" oninput="setUser('waist', this.value); updateBMIAndWTH()" min="50" max="200"></div>
				</div>
				<small class="muted" style="display:block; margin-top:0.5rem; margin-bottom:1rem;">Measure waist at navel level</small>
				
				<!-- BMI and Waist-to-Height Ratio Display -->
				<div id="bmi-wth-display" style="display:none; margin-top:1rem;">
					<div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
						<div id="bmi-card" style="background:var(--canvas); padding:1rem; border-radius:8px; text-align:center;">
							<div style="font-size:1.5rem; font-weight:700; color:var(--numan-teal); margin-bottom:0.25rem;">BMI: <span id="bmi-value">--</span></div>
							<div id="bmi-status" style="font-size:0.9rem; color:var(--ink-60);"></div>
						</div>
						<div id="wth-card" style="background:var(--canvas); padding:1rem; border-radius:8px; text-align:center;">
							<div style="font-size:1.5rem; font-weight:700; color:var(--numan-teal); margin-bottom:0.25rem;">Waist-to-Height Ratio: <span id="wth-value">--</span></div>
							<div id="wth-status" style="font-size:0.9rem; color:var(--ink-60);"></div>
						</div>
					</div>
				</div>
				
				${State.user.dob ? `<div style="margin-top:1rem; padding:0.5rem; background:var(--canvas); border-radius:6px;"><small class="muted">Age: ${State.user.age || 'Calculating...'} years</small></div>` : ''}
			`,
			validate:()=> {
				// Clear any existing errors
				document.querySelectorAll('.error').forEach(el => el.remove());
				document.querySelectorAll('input.error').forEach(el => el.classList.remove('error'));
				
				let isValid = true;
				
				// Validate DOB
				if (!State.user.dob) {
					showError(document.getElementById('dob-input'), 'Date of birth is required');
					isValid = false;
				} else {
					const dob = new Date(State.user.dob);
					const age = new Date().getFullYear() - dob.getFullYear();
					if (age < 18 || age > 80) {
						showError(document.getElementById('dob-input'), 'Age must be between 18 and 80 years');
						isValid = false;
					}
				}
				
				// Validate height
				if (!State.user.height || State.user.height < 120 || State.user.height > 230) {
					showError(document.getElementById('height-input'), 'Height must be between 120-230 cm');
					isValid = false;
				}
				
				// Validate weight
				if (!State.user.weight || State.user.weight < 40 || State.user.weight > 250) {
					showError(document.getElementById('weight-input'), 'Weight must be between 40-250 kg');
					isValid = false;
				}
				
				// Validate waist
				if (!State.user.waist || State.user.waist < 40 || State.user.waist > 200) {
					showError(document.getElementById('waist-input'), 'Waist must be between 40-200 cm');
					isValid = false;
				}
				
				// Validate gender
				if (!State.user.sex) {
					showError(document.querySelector('select'), 'Please select your gender');
					isValid = false;
				}
				
				return isValid;
			}
		},
		{
			key:'wearables',
			render:()=>`
				<h3>Connect Your Wearables</h3>
				<p class="muted">Connect your device to get personalised insights and track your health progress. You control what data we access.</p>
				
				<div id="wearable-catalogue" class="card-grid" style="margin-top:1rem">
					${WearableBrands.map(b=>{
						const isConnected = State.devices.connected.some(d => d.brand === b);
						const isPrimary = State.devices.primaryId && State.devices.connected.find(d => d.id === State.devices.primaryId)?.brand === b;
						return `
							<div class="service-card ${isConnected ? 'connected' : ''} ${isPrimary ? 'primary' : ''}" role="button" tabindex="0" onclick="connectWearable('${b}')" onkeydown="if(event.key==='Enter'){connectWearable('${b}')}" aria-label="Connect ${b}">
								<h4>${b} ${isConnected ? '✓' : ''}</h4>
								<p class="muted">${isConnected ? 'Connected - Sync steps, sleep, heart rate and more' : 'Sync steps, sleep, heart rate and more'}</p>
								${isPrimary ? '<small style="color:var(--numan-teal); font-weight:600">Primary device</small>' : ''}
							</div>
						`;
					}).join('')}
				</div>
				
				
				
					<div style="display:flex; gap:.5rem; margin:.75rem 0; justify-content:flex-start">
					<div>
					<button class="btn-ghost btn-small" onclick="openModal('manage-devices', manageDevicesModal())">Manage devices</button>
						<button class="btn btn-small" onclick="openModal('request-device', requestDeviceModal())">Request another wearable</button>
					</div>
				</div>

				<!-- Onboarding wearable charts -->
				<div id="ob-wearable-charts" style="display:none">
					<h3>Insights from your device</h3>
					<p style="margin-bottom:1rem; color:var(--ink-60); font-size:0.9rem">Click on any metric below to view detailed charts</p>
					
					<!-- Steps Accordion -->
					<div class="collapsible" style="margin-bottom:1rem; border:1px solid var(--ink-10); border-radius:8px; background:white">
						<div class="collapsible-header" onclick="toggleWearableAccordion(this)" style="display:flex; justify-content:space-between; align-items:center; padding:1rem; cursor:pointer; border-bottom:1px solid var(--ink-05)">
							<div>
								<h4 style="margin:0; font-size:1.1rem; color:var(--ink)"><strong>Steps (28 days)</strong></h4>
								<div style="display:flex; align-items:center; gap:1rem; margin-top:0.25rem">
									<span class="chart-avg" id="ob-steps-avg" style="font-weight:600; color:var(--numan-teal)">--</span>
									<small class="muted" id="ob-steps-change" style="color:var(--ink-60)">--</small>
							</div>
						</div>
							<span style="font-size:1.2rem; color:var(--ink-40); transition:transform 0.2s ease">▼</span>
						</div>
						<div class="collapsible-content" style="display:none; padding:1rem">
						<canvas id="ob-steps-chart" width="900" height="300" aria-label="Steps chart"></canvas>
					</div>
					</div>
					
					<!-- Sleep Accordion -->
					<div class="collapsible" style="margin-bottom:1rem; border:1px solid var(--ink-10); border-radius:8px; background:white">
						<div class="collapsible-header" onclick="toggleWearableAccordion(this)" style="display:flex; justify-content:space-between; align-items:center; padding:1rem; cursor:pointer; border-bottom:1px solid var(--ink-05)">
							<div>
								<h4 style="margin:0; font-size:1.1rem; color:var(--ink)"><strong>Sleep hours (28 days)</strong></h4>
								<div style="display:flex; align-items:center; gap:1rem; margin-top:0.25rem">
									<span class="chart-avg" id="ob-sleep-avg" style="font-weight:600; color:var(--numan-teal)">--</span>
									<small class="muted" id="ob-sleep-change" style="color:var(--ink-60)">--</small>
							</div>
						</div>
							<span style="font-size:1.2rem; color:var(--ink-40); transition:transform 0.2s ease">▼</span>
						</div>
						<div class="collapsible-content" style="display:none; padding:1rem">
						<canvas id="ob-sleep-chart" width="900" height="300" aria-label="Sleep chart"></canvas>
					</div>
					</div>
					
					<!-- RHR Accordion -->
					<div class="collapsible" style="margin-bottom:1rem; border:1px solid var(--ink-10); border-radius:8px; background:white">
						<div class="collapsible-header" onclick="toggleWearableAccordion(this)" style="display:flex; justify-content:space-between; align-items:center; padding:1rem; cursor:pointer; border-bottom:1px solid var(--ink-05)">
							<div>
								<h4 style="margin:0; font-size:1.1rem; color:var(--ink)"><strong>Resting heart rate (28 days)</strong></h4>
								<div style="display:flex; align-items:center; gap:1rem; margin-top:0.25rem">
									<span class="chart-avg" id="ob-rhr-avg" style="font-weight:600; color:var(--numan-teal)">--</span>
									<small class="muted" id="ob-rhr-change" style="color:var(--ink-60)">--</small>
							</div>
						</div>
							<span style="font-size:1.2rem; color:var(--ink-40); transition:transform 0.2s ease">▼</span>
						</div>
						<div class="collapsible-content" style="display:none; padding:1rem">
						<canvas id="ob-rhr-chart" width="900" height="300" aria-label="RHR chart"></canvas>
					</div>
					</div>
					
					<!-- HRV Accordion -->
					<div class="collapsible" style="margin-bottom:1rem; border:1px solid var(--ink-10); border-radius:8px; background:white">
						<div class="collapsible-header" onclick="toggleWearableAccordion(this)" style="display:flex; justify-content:space-between; align-items:center; padding:1rem; cursor:pointer; border-bottom:1px solid var(--ink-05)">
							<div>
								<h4 style="margin:0; font-size:1.1rem; color:var(--ink)"><strong>HRV (28 days)</strong></h4>
								<div style="display:flex; align-items:center; gap:1rem; margin-top:0.25rem">
									<span class="chart-avg" id="ob-hrv-avg" style="font-weight:600; color:var(--numan-teal)">--</span>
									<small class="muted" id="ob-hrv-change" style="color:var(--ink-60)">--</small>
							</div>
						</div>
							<span style="font-size:1.2rem; color:var(--ink-40); transition:transform 0.2s ease">▼</span>
						</div>
						<div class="collapsible-content" style="display:none; padding:1rem">
						<canvas id="ob-hrv-chart" width="900" height="300" aria-label="HRV chart"></canvas>
						</div>
					</div>
				</div>

				
			`,
			validate:()=> State.devices.connected.length > 0
		},
		{
			key:'lifestyle',
			render:()=>`
				<h3>Lifestyle</h3>
				${State.devices.connected.length > 0 ? `
					<div style="margin-bottom:1rem; padding:0.75rem; background:var(--mint-50); border-radius:8px; border-left:4px solid var(--numan-teal)">
						<small style="color:var(--numan-teal); font-weight:600">📱 Data from ${State.devices.connected[0]?.brand || 'your device'}</small>
						<p style="margin:0.25rem 0 0 0; font-size:0.9rem; color:var(--ink-60)">Activity and sleep data below has been automatically filled from your connected wearable device.</p>
					</div>
				` : ''}
				<div class="card-grid">
					<div>
						<label>Activity mins/week</label>
						<input type="number" value="${State.onboarding.answers.activityMins||515}" oninput="setOb('activityMins', this.value)" placeholder="${State.devices.connected.length > 0 ? 'Auto-synced from ' + (State.devices.connected[0]?.brand || 'device') : 'Enter activity minutes per week'}">
						<small class="muted">Target: 150+ mins/week</small>
					</div>
					<div>
						<label>Average sleep (h)</label>
						<input type="number" step="0.1" value="${State.onboarding.answers.sleepHours||6.9}" oninput="setOb('sleepHours', this.value)" placeholder="${State.devices.connected.length > 0 ? 'Auto-synced from ' + (State.devices.connected[0]?.brand || 'device') : 'Enter average sleep hours'}">
						<small class="muted">Target: 7-9h</small>
					</div>
				</div>
				
				<div class="card" style="margin-top:1rem">
					<label>Alcohol consumption</label>
					<p class="muted" style="margin-bottom:1rem">How many drinks do you have per week?</p>
					
					<div class="card-grid" style="margin-bottom:1rem">
						<div>
							<label>Beer (pint)</label>
							<input type="number" id="beer-quantity" value="${State.onboarding.answers.beerQuantity||0}" min="0" style="width:100%" oninput="updateAlcoholUnits()">
							<small class="muted">2.3 units each</small>
						</div>
						<div>
							<label>Wine (glass)</label>
							<input type="number" id="wine-quantity" value="${State.onboarding.answers.wineQuantity||0}" min="0" style="width:100%" oninput="updateAlcoholUnits()">
							<small class="muted">2.1 units each</small>
						</div>
						<div>
							<label>Spirits (shot)</label>
							<input type="number" id="spirits-quantity" value="${State.onboarding.answers.spiritsQuantity||0}" min="0" style="width:100%" oninput="updateAlcoholUnits()">
							<small class="muted">1.0 unit each</small>
						</div>
					</div>
					
					<div id="alcohol-summary" style="margin-top:1rem; padding:1rem; background:var(--canvas); border-radius:8px; text-align:center">
						<div style="font-size:1.5rem; font-weight:700; color:var(--numan-teal); margin-bottom:0.5rem">
							<span id="alcohol-total-units">0.0</span> units/week
						</div>
						<div style="display:flex; justify-content:center; align-items:center; gap:0.5rem">
							<span id="alcohol-status" style="font-size:0.9rem; padding:0.25rem 0.75rem; border-radius:12px; background:var(--mint-50); color:var(--numan-teal)">Within recommended limits</span>
							<small class="muted">ℹ️ Target: ≤14 units/week</small>
						</div>
					</div>
				</div>
				
				<div class="card" style="margin-top:1rem">
					<label>Do you currently smoke?</label>
					<div style="display:flex; gap:1rem; margin:0.5rem 0">
							<label class="check-pill ${State.onboarding.answers.smoker === true ? 'selected' : ''}">
							<input type="radio" name="smoking-status" value="yes" ${State.onboarding.answers.smoker === true ? 'checked' : ''} onchange="setOb('smoker', true); toggleSmokingDetails(true)">
								<span>Yes</span>
							</label>
							<label class="check-pill ${State.onboarding.answers.smoker === false ? 'selected' : ''}">
							<input type="radio" name="smoking-status" value="no" ${State.onboarding.answers.smoker === false ? 'checked' : ''} onchange="setOb('smoker', false); toggleSmokingDetails(false)">
								<span>No</span>
							</label>
						</div>
					
					<div id="smoking-details" style="display:${State.onboarding.answers.smoker === true ? 'block' : 'none'}; margin-top:1rem">
						<div style="margin-bottom:1rem">
							<label>Cigarettes per day</label>
							<input type="number" value="${State.onboarding.answers.cigarettesPerDay||2}" oninput="setOb('cigarettesPerDay', this.value)" style="width:80px">
						</div>
						<div>
							<label>How ready to quit? (1-5 scale)</label>
							<div style="margin-top:0.5rem">
								<input type="range" min="1" max="5" value="${State.onboarding.answers.quitReadiness||2}" oninput="setOb('quitReadiness', this.value); updateQuitReadinessLabel(this.value)" style="width:100%">
								<div style="display:flex; justify-content:space-between; font-size:0.9rem; color:var(--ink-60); margin-top:0.25rem">
									<span>1</span><span>2</span><span>3</span><span>4</span><span>5</span>
								</div>
								<div id="quit-readiness-label" style="margin-top:0.5rem; font-weight:600; color:var(--numan-teal)">
									${State.onboarding.answers.quitReadiness === '1' ? '1 - Not ready' : 
									  State.onboarding.answers.quitReadiness === '2' ? '2 - Thinking about it' :
									  State.onboarding.answers.quitReadiness === '3' ? '3 - Preparing' :
									  State.onboarding.answers.quitReadiness === '4' ? '4 - Ready to act' :
									  State.onboarding.answers.quitReadiness === '5' ? '5 - Taking action' : '2 - Thinking about it'}
								</div>
							</div>
						</div>
					</div>
				</div>
			`,
			validate:()=> {
				// Clear any existing errors
				document.querySelectorAll('.error').forEach(el => el.remove());
				document.querySelectorAll('input.error').forEach(el => el.classList.remove('error'));
				
				let isValid = true;
				
				// Validate activity mins (optional - only validate if value is provided)
				const activityInput = document.querySelector('input[oninput*="activityMins"]');
				if (activityInput && activityInput.value && parseFloat(activityInput.value) < 0) {
					showError(activityInput, 'Please enter a valid number of activity minutes per week');
					isValid = false;
				}
				
				// Validate sleep hours (optional - only validate if value is provided)
				const sleepInput = document.querySelector('input[oninput*="sleepHours"]');
				if (sleepInput && sleepInput.value && parseFloat(sleepInput.value) < 0) {
					showError(sleepInput, 'Please enter a valid number of sleep hours');
					isValid = false;
				}
				
				// Validate alcohol consumption (optional - no validation required)
				// Alcohol consumption is now optional and doesn't block progression
				
				// Validate smoking status and cigarettes per day
				const smokingInputs = document.querySelectorAll('input[name="smoking-status"]');
				const smokingSelected = Array.from(smokingInputs).some(input => input.checked);
				const smokingYes = document.querySelector('input[name="smoking-status"][value="yes"]');
				
				if (smokingYes && smokingYes.checked) {
					const cigarettesInput = document.querySelector('input[oninput*="cigarettesPerDay"]');
					if (!cigarettesInput || !cigarettesInput.value || cigarettesInput.value <= 0) {
						showToast('Please enter the number of cigarettes you smoke per day', 'error');
						isValid = false;
					}
				}
				
				return isValid;
			}
		},
		{
			key:'symptoms',
			render:()=>{
				// Get saved symptoms state
				const savedSymptoms = State.onboarding.symptoms || { current: [], history: [], none: false, other: '' };
				const currentSymptoms = savedSymptoms.current || [];
				const historySymptoms = savedSymptoms.history || [];
				const isNoneSelected = savedSymptoms.none || false;
				const otherText = savedSymptoms.other || '';
				const isOtherSelected = otherText.length > 0;
				
				// Helper function to check if a symptom is selected
				const isCurrentSymptomSelected = (key) => currentSymptoms.some(s => s.key === key);
				const isHistorySymptomSelected = (key) => historySymptoms.includes(key);
				
				return `
					<h3>Symptoms</h3>
					<p class="muted">Help us understand your current health concerns. Select any symptoms you're experiencing.</p>
					
					<div style="margin-bottom:2rem">
						<h4>Current symptoms</h4>
						<div class="symptoms-grid" id="current-symptoms">
							${[
								{key: 'low-mood', label: 'Low mood', tooltip: 'Feeling down, sad, or hopeless most days'},
								{key: 'brain-fog', label: 'Brain fog', tooltip: 'Difficulty concentrating, memory problems, or mental clarity issues'},
								{key: 'snoring-sleep', label: 'Snoring/poor sleep', tooltip: 'Loud snoring, witnessed apnoea, non-restorative sleep ≥3 nights/wk'},
								{key: 'low-sex-drive', 
									label: 'Low sex drive', 
									tooltip: 'Reduced interest in sex or sexual satisfaction'},
								{key: 'low-energy', label: 'Low energy', tooltip: 'Feeling tired, fatigued, or lacking motivation'},
								{key: 'weight-gain', label: 'Weight gain', tooltip: 'Recent weight increase or difficulty losing weight'}
							].map(s => {
								const isSelected = isCurrentSymptomSelected(s.key);
								return `
									<button type="button" class="symptom-item ${isSelected ? 'selected' : ''}" data-symptom="${s.key}" onclick="selectSymptom('${s.key}')" aria-pressed="${isSelected}">
										<div class="symptom-label" title="${s.tooltip}">${s.label}</div>
									</button>
								`;
							}).join('')}
						</div>
					</div>
					
					<div style="margin-bottom:2rem">
						<h4>History/diagnoses</h4>
						<div class="symptoms-grid" id="history-symptoms">
							${[
								{key: 'high-bp-history', label: 'High BP (history)', tooltip: 'Previous diagnosis of high blood pressure'},
								{key: 'high-cholesterol-history', label: 'High cholesterol (history)', tooltip: 'Previous diagnosis of high cholesterol'},
								{key: 'diabetes-history', label: 'Diabetes (history)', tooltip: 'Previous diagnosis of diabetes or prediabetes'}
							].map(s => {
								const isSelected = isHistorySymptomSelected(s.key);
								return `
									<button type="button" class="symptom-item ${isSelected ? 'selected' : ''}" data-symptom="${s.key}" onclick="selectSymptom('${s.key}')" aria-pressed="${isSelected}">
										<div class="symptom-label" title="${s.tooltip}">${s.label}</div>
									</button>
								`;
							}).join('')}
						</div>
					</div>
					
					<div style="margin-bottom:2rem">
						<div class="symptoms-grid">
							<button type="button" class="symptom-item ${isNoneSelected ? 'selected' : ''}" data-symptom="none" onclick="selectSymptom('none')" aria-pressed="${isNoneSelected}">
								<div class="symptom-label">None of the above</div>
							</button>
							<button type="button" class="symptom-item ${isOtherSelected ? 'selected' : ''}" data-symptom="other" onclick="selectSymptom('other')" aria-pressed="${isOtherSelected}">
								<div class="symptom-label">Other...</div>
								<input type="text" id="other-symptoms" placeholder="Please describe" value="${otherText}" style="display:${isOtherSelected ? 'block' : 'none'}; margin-top:0.5rem; width:100%; padding:0.5rem; border:1px solid #e5e7eb; border-radius:6px;" oninput="setOtherSymptoms(this.value)" onclick="event.stopPropagation()">
							</button>
						</div>
					</div>
				`;
			},
			validate:()=> {
				// Clear any existing errors
				document.querySelectorAll('.error').forEach(el => el.remove());
				document.querySelectorAll('input.error').forEach(el => el.classList.remove('error'));
				
				return true;
			}
		},
		{
			key:'assessments',
			render:()=>`
				<h3>Clinical Assessments</h3>
				<p class="muted">These brief questionnaires help us personalise your health plan. They are optional and educational, not diagnostic.</p>
				
				<div style="margin-bottom:2rem">
					${renderOnboardingAssessments()}
				</div>
				
				
				
			`,
			validate:()=> true
		},
		{
			key:'biological-age',
			render:()=>`
				<h3>Your Biological Age</h3>
				<p class="muted">Based on your health data, we've calculated your biological age. This shows how your body is aging compared to your chronological age.</p>
				
				<!-- Biological Age Visualization (always visible) -->
				<div class="card" style="margin-top:1rem">
					<div style="text-align:center; padding:1rem 1rem 1.5rem">
						<div id="ob-bio-age-gauge-container"></div>
						<div id="ob-gauge-interpretation" class="gauge-interpretation-container" style="margin-top:1rem"></div>
						<div style="margin-top:1.5rem">
							<div id="ob-drivers-list"></div>
							<div style="margin-top:1rem">
								<button class="btn btn-secondary" onclick="openBiologicalAgeExplanation()" style="font-size:0.9rem; padding:0.5rem 1rem">How we calculate this</button>
						</div>
					</div>
				</div>
				</div>

				<!-- Compare with peers -->
				<div class="card" style="margin-top:1rem">
					<div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem">
						<div>
							<h4 style="margin:0">Compare with peers</h4>
							<small class="muted">See how your biological age compares to others with similar demographics</small>
						</div>
						<label class="toggle-switch">
							<input id="ob-peer-compare" type="checkbox" onchange="toggleOnboardingPeerComparison()">
							<span class="toggle-slider"></span>
						</label>
					</div>

					<div id="ob-peer-comparison" style="display:none">
						<h5>Your percentile ranking (age ±5y, similar BMI)</h5>
						<div id="ob-peer-bars" style="margin-top:1rem"></div>
					</div>
				</div>

				<!-- Inputs toggle moved beneath peers (default closed) -->
				<div class="card" style="margin-top:1rem">
					<div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem">
						<div>
							<h4 style="margin:0">Biological Age Inputs</h4>
							<small class="muted">Update the inputs used by the gauge</small>
						</div>
						<label class="toggle-switch">
							<input id="ob-bio-inputs-toggle" type="checkbox" onchange="toggleOnboardingBioInputs()">
							<span class="toggle-slider"></span>
						</label>
					</div>
					<div id="ob-bio-inputs-content" style="display:none; padding:1rem">
						<div class="card-grid">
							<div>
								<div class="form-group">
									<label>Age</label>
									<div style="display:flex; gap:0.5rem; align-items:center">
										<input type="number" id="ob-calc-age" value="${State.user.age || ''}" placeholder="Enter age" onchange="calculateBiologicalAge()" style="flex:1">
										<input type="text" id="ob-calc-dob" value="${State.user.dob || ''}" placeholder="YYYY-MM-DD" onchange="calculateAgeFromDOBInput()" onblur="formatDateInput(this)" style="flex:1; color-scheme: light">
									</div>
									<small class="muted">Enter either age or date of birth</small>
								</div>
								<div class="form-group"><label>Height (cm)</label><input type="number" id="ob-calc-height" value="${State.user.height || ''}" onchange="calculateBiologicalAge()"></div>
								<div class="form-group"><label>Weight (kg)</label><input type="number" id="ob-calc-weight" value="${State.user.weight || ''}" onchange="calculateBiologicalAge()"></div>
								<div class="form-group"><label>Waist (cm)</label><input type="number" id="ob-calc-waist" value="${State.user.waist || ''}" onchange="calculateBiologicalAge()"></div>
								<div class="form-group"><label>Steps/day</label><input type="number" id="ob-calc-steps" value="${State.onboarding.answers.stepsPerDay || ''}" onchange="calculateBiologicalAge()"></div>
								<div class="form-group"><label>Sleep hours</label><input type="number" step="0.1" id="ob-calc-sleep" value="${State.onboarding.answers.sleepHours || ''}" onchange="calculateBiologicalAge()"></div>
								<div class="form-group"><label>Resting HR</label><input type="number" id="ob-calc-rhr" value="${State.onboarding.answers.restingHR || ''}" onchange="calculateBiologicalAge()"></div>
								<div class="form-group"><label>Activity mins/week</label><input type="number" id="ob-calc-activity" value="${State.onboarding.answers.activityMins || ''}" onchange="calculateBiologicalAge()"></div>
							</div>
						</div>
					</div>
				</div>
				
			`,
			validate:()=> true
		},
		{
			key:'existing-plans',
			render:()=>`
				<h3>Are you already on any Numan plans?</h3>
				<p class="muted">This helps us personalize your Healthspan plan and avoid duplicating services you already have.</p>
				
				<div class="checkbox-grid" id="existing-plans-chips" style="margin-bottom:1rem">
					${['Hair loss', 'TRT/Testosterone', 'Weight loss'].map(planType => {
						const isSelected = State.activePlans?.some(p => p.type === planType.toLowerCase().replace(/[^a-z]/g, ''));
						return `
							<label class="check-pill ${isSelected ? 'selected' : ''}" onclick="toggleExistingPlan('${planType}')">
								<input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleExistingPlan('${planType}')">
								<span>${planType}</span>
							</label>
						`;
					}).join('')}
				</div>
				
				<div id="existing-plans-forms" style="margin-top:1rem">
					<!-- Forms will be dynamically added here -->
				</div>
			`,
			validate:()=> true
		},
		{
			key:'preferences',
			render:()=>`
				<h3>Preferences</h3>
				<div class="card-grid">
					<div>
						<label>Coach check-in frequency</label>
						<select onchange="setPref('coachCadence', this.value)">
							<option value="">Select…</option>
							<option ${State.preferences.coachCadence==='fortnightly'?'selected':''}>fortnightly</option>
							<option ${State.preferences.coachCadence==='monthly'?'selected':''}>monthly</option>
						</select>
					</div>
					<div>
						<label>Monthly budget</label>
						<select onchange="setPref('budget', this.value)">
							<option value="">Select…</option>
							<option ${State.preferences.budget==='under-50'?'selected':''}><£50</option>
							<option ${State.preferences.budget==='50-99'?'selected':''}>£50-99</option>
							<option ${State.preferences.budget==='100-plus'?'selected':''}>£100+</option>
						</select>
					</div>
				</div>
			`,
			validate:()=> true
		}
	];
	
	// =============== EXISTING PLANS LOGIC ===============
	
	function toggleExistingPlan(planType) {
		const typeKey = planType.toLowerCase().replace(/[^a-z]/g, '');
		const existingIndex = State.activePlans.findIndex(p => p.type === typeKey);
		
		if (existingIndex >= 0) {
			// Remove existing plan
			State.activePlans.splice(existingIndex, 1);
		} else {
			// Add new plan
			State.activePlans.push({
				type: typeKey,
				provider: 'numan',
				active: true,
				startISO: '',
				notes: ''
			});
		}
		
		save({ activePlans: State.activePlans });
		renderExistingPlanForms();
		
		// Update checkbox visual state
		const checkbox = document.querySelector(`input[onchange*="toggleExistingPlan('${planType}')"]`);
		if (checkbox) {
			const isSelected = State.activePlans.some(p => p.type === typeKey);
			checkbox.checked = isSelected;
			checkbox.closest('.check-pill').classList.toggle('selected', isSelected);
		}
	}
	
	function renderExistingPlanForms() {
		const formsContainer = document.getElementById('existing-plans-forms');
		if (!formsContainer) return;
		
		formsContainer.innerHTML = State.activePlans.map(plan => {
			const planTypeDisplay = {
				'weightloss': 'Weight loss',
				'trttestosterone': 'TRT/Testosterone', 
				'hairloss': 'Hair loss',
				'other': 'Other'
			}[plan.type] || plan.type;

			// Contextual placeholder per plan type
			const placeholderByType = {
				'hairloss': 'e.g., Finasteride, Minoxidil, Dutasteride',
				'trttestosterone': 'e.g., Testosterone cypionate, HCG, Anastrozole',
				'weightloss': 'e.g., Semaglutide, Tirzepatide, Orlistat',
				'other': 'e.g., Medication name and dose'
			};
			const notesPlaceholder = placeholderByType[plan.type] || placeholderByType['other'];
			
			return `
				<div class="card" style="margin-bottom:1rem; border-left:4px solid var(--numan-teal)">
					<h4 style="margin:0 0 1rem 0; color:var(--numan-teal)">${planTypeDisplay}</h4>
					
					<div class="card-grid" style="margin-bottom:1rem">
						<div>
							<label>Provider</label>
							<select onchange="updateExistingPlan('${plan.type}', 'provider', this.value)">
								<option value="numan" ${plan.provider === 'numan' ? 'selected' : ''}>Numan</option>
								<option value="other" ${plan.provider === 'other' ? 'selected' : ''}>Another provider</option>
							</select>
						</div>
						<div>
							<label>Start date (optional)</label>
							<input type="date" value="${plan.startISO ? plan.startISO.split('T')[0] : ''}" 
								   onchange="updateExistingPlan('${plan.type}', 'startISO', this.value ? new Date(this.value).toISOString() : '')">
						</div>
					</div>
					
					<div style="margin-bottom:1rem">
						<label>Plan name / meds</label>
						<input type="text" value="${plan.notes || ''}" 
					   placeholder="${notesPlaceholder}" 
							   onchange="updateExistingPlan('${plan.type}', 'notes', this.value)">
					</div>
					
					<div style="display:flex; align-items:center; gap:1rem">
						<label class="check-pill ${plan.active ? 'selected' : ''}">
							<input type="checkbox" ${plan.active ? 'checked' : ''} 
								   onchange="updateExistingPlan('${plan.type}', 'active', this.checked)">
							<span>Currently active?</span>
						</label>
						<button class="btn-ghost btn-small" onclick="removeExistingPlan('${plan.type}')">Remove</button>
					</div>
				</div>
			`;
		}).join('');
	}
	
	function updateExistingPlan(type, field, value) {
		const plan = State.activePlans.find(p => p.type === type);
		if (plan) {
			plan[field] = value;
			save({ activePlans: State.activePlans });
		}
	}
	
	function removeExistingPlan(type) {
		State.activePlans = State.activePlans.filter(p => p.type !== type);
		save({ activePlans: State.activePlans });
		renderExistingPlanForms();
		
		// Update the checkbox state
		const checkbox = document.querySelector(`input[onchange*="toggleExistingPlan"]`);
		if (checkbox) {
			checkbox.checked = false;
			checkbox.closest('.check-pill').classList.remove('selected');
		}
	}
	
	let obIndex = 0; // Initialize with default value
	function startOnboarding(){ 
		console.log('startOnboarding called - resetting all onboarding state');
		// Lock navigation so nothing can skip onboarding until it's completed
		window.__onboardingLock = true;
		
		// Always start from the beginning, regardless of previous completion status
		obIndex = 0; 
		State.onboarding.currentStep = 0;
		State.onboarding.completed = false; // Reset completion status
		State.consent.health = false; // Reset consent to ensure user goes through consent step
		
		// Also clear any existing onboarding answers to ensure fresh start
		State.onboarding.answers = {};
		
		save({'onboarding.currentStep': 0, 'onboarding.completed': false, 'consent': State.consent, 'onboarding.answers': {}});
		
		console.log('About to navigate to onboarding view');
		Router.go('onboarding'); 
		
		console.log('Logging quiz_started event');
		logEvent('quiz_started'); 
		
		console.log('About to render onboarding step 0 (consent)');
		renderOnboarding(); 
	}

	// Ensure inline onclick can access this
	window.startOnboarding = startOnboarding;

	function renderOnboarding(){
		console.log('renderOnboarding called with obIndex:', obIndex);
		
		const wrap = document.getElementById('ob-steps');
		if (!wrap) {
			console.error('ob-steps element not found');
			return;
		}
		
		const step = OnboardingSteps[obIndex] || OnboardingSteps[0];
		if (!step) {
			console.error('No onboarding step found for index:', obIndex);
			return;
		}
		
		console.log('Rendering onboarding step:', obIndex, step.key);
		console.log('Current State.currentView:', State.currentView);
		console.log('Current Router.current:', Router.current);
		
		wrap.innerHTML = step.render();
		const back = document.getElementById('ob-back');
		if(back) back.style.visibility = obIndex>0? 'visible':'hidden';
		
		// Auto-calculate biological age if on that step
		if (step.key === 'biological-age') {
			setTimeout(() => {
				renderOnboardingBiologicalAge();
				calculateBiologicalAge();
				// Update navigation locks to unlock biological age page
				updateNavLocks();
			}, 100);
		}
		
		// Add this for wearables step
		if (step.key === 'wearables') {
			setTimeout(() => {
				renderWearablesUI();
				if (State.devices.connected.length > 0) {
					updateWearableDataDisplayInOnboarding();
					updateMetricStats();
				}
			}, 100);
		}
		
		// Add this for lifestyle step
		if (step.key === 'lifestyle') {
			setTimeout(() => {
				populateLifestyleFromWearables();
				initAlcoholDisplay();
			}, 100);
		}
		
	}
	function obNext(){
		if(!OnboardingSteps[obIndex].validate()){
			showToast('Please complete this step'); return;
		}
		if(obIndex < OnboardingSteps.length-1){ 
			const currentStep = OnboardingSteps[obIndex];
			obIndex++; 
			const nextStep = OnboardingSteps[obIndex];
			State.onboarding.currentStep = obIndex;
			save({'onboarding.currentStep': obIndex});
			renderOnboarding(); 
			
			// Scroll to top when transitioning from biological-age to existing-plans
			if (currentStep.key === 'biological-age' && nextStep.key === 'existing-plans') {
				setTimeout(() => {
					window.scrollTo({ top: 0, behavior: 'smooth' });
				}, 100);
			}
		}
		else { 
			logEvent('quiz_completed'); 
			State.onboarding.completed = true;
			save({'onboarding.completed': true});
			// Unlock onboarding navigation so we can proceed to plan
			window.__onboardingLock = false;
			Router.go('plan');
			// Update navigation locks to unlock plan page
			setTimeout(() => {
				updateNavLocks();
			}, 100);
		}
		save({'onboarding.answers':State.onboarding.answers, 'user.profile':State.user, 'user.preferences':State.preferences, consent:State.consent});
	}
	function obPrev(){ 
		if(obIndex>0){ 
			obIndex--; 
			State.onboarding.currentStep = obIndex;
			save({'onboarding.currentStep': obIndex});
			renderOnboarding(); 
			
			// Scroll to top when navigating back to existing-plans step
			const currentStep = OnboardingSteps[obIndex];
			if (currentStep.key === 'existing-plans') {
				setTimeout(() => {
					window.scrollTo({ top: 0, behavior: 'smooth' });
				}, 100);
			}
		} 
	}
	function toggleGoal(g){ 
		State.onboarding.answers.goals=State.onboarding.answers.goals||[]; 
		const i=State.onboarding.answers.goals.indexOf(g); 
		if(i>-1) State.onboarding.answers.goals.splice(i,1); 
		else State.onboarding.answers.goals.push(g); 
		
		// Update the visual state of the label
		const checkbox = event.target;
		const label = checkbox.closest('.check-pill');
		if (checkbox.checked) {
			label.classList.add('selected');
		} else {
			label.classList.remove('selected');
		}
		
		renderOnboarding(); 
		save({'onboarding.answers':State.onboarding.answers}); 
	}
	
	function setOnboardingAnswer(key, value) {
		State.onboarding.answers = State.onboarding.answers || {};
		State.onboarding.answers[key] = value;
		
		// Also save to preferences for backward compatibility
		if (key === 'budget') {
			State.preferences.budget = value;
			save({'user.preferences': State.preferences});
		}
		
		save({'onboarding.answers': State.onboarding.answers});
	}
	
	function toggleSymptom(s){ 
		State.onboarding.symptoms=State.onboarding.symptoms||[]; 
		const i=State.onboarding.symptoms.indexOf(s); 
		if(i>-1) State.onboarding.symptoms.splice(i,1); 
		else State.onboarding.symptoms.push(s); 
		
		// Update the visual state of the label
		const checkbox = event.target;
		const label = checkbox.closest('.check-pill');
		if (checkbox.checked) {
			label.classList.add('selected');
		} else {
			label.classList.remove('selected');
		}
		
		renderOnboarding(); 
		save({'onboarding.answers':State.onboarding.answers}); 
	}
	// New symptoms functions
	function selectSymptom(symptomKey) {
		const item = document.querySelector(`[data-symptom="${symptomKey}"]`);
		if (!item) return;
		
		// Handle "none" selection - deselect all others
		if (symptomKey === 'none') {
			// Deselect all other symptoms
			document.querySelectorAll('.symptom-item').forEach(el => {
				if (el.dataset.symptom !== 'none') {
					el.classList.remove('selected');
					el.setAttribute('aria-pressed', 'false');
				}
			});
			
			// Hide the other input if it was visible
			const otherInput = document.getElementById('other-symptoms');
			if (otherInput) {
				otherInput.style.display = 'none';
			}
			
			State.onboarding.symptoms = { current: [], history: [], none: true, other: '' };
			// Keep "None of the above" visually selected
			item.classList.add('selected');
			item.setAttribute('aria-pressed', 'true');
		} else if (symptomKey === 'other') {
			// Toggle other input visibility and selection
			const isSelected = item.classList.contains('selected');
			item.classList.toggle('selected');
			item.setAttribute('aria-pressed', String(!isSelected));
			const otherInput = document.getElementById('other-symptoms');
			if (otherInput) {
				otherInput.style.display = !isSelected ? 'block' : 'none';
				if (!isSelected) {
					// Focus the input when it becomes visible
					setTimeout(() => otherInput.focus(), 100);
				} else {
					otherInput.value = '';
					setOtherSymptoms('');
				}
			}
			
			// Initialize symptoms object if needed
			if (!State.onboarding.symptoms || typeof State.onboarding.symptoms !== 'object') {
				State.onboarding.symptoms = { current: [], history: [], none: false, other: '' };
			}
			
			// If selecting "other", deselect "none"
			if (!isSelected) {
				const noneItem = document.querySelector('[data-symptom="none"]');
				if (noneItem) {
					noneItem.classList.remove('selected');
					noneItem.setAttribute('aria-pressed', 'false');
				}
				State.onboarding.symptoms.none = false;
			}
			
			// Update the other symptoms state
			if (!isSelected) {
				// Other is being selected - keep existing text if any
				State.onboarding.symptoms.other = State.onboarding.symptoms.other || '';
			} else {
				// Other is being deselected - clear the text
				State.onboarding.symptoms.other = '';
			}
		} else {
			// Toggle symptom selection
			const isSelected = item.classList.contains('selected');
			item.classList.toggle('selected');
			item.setAttribute('aria-pressed', String(!isSelected));
			
			// Initialize symptoms object if needed
			if (!State.onboarding.symptoms || typeof State.onboarding.symptoms !== 'object') {
				State.onboarding.symptoms = { current: [], history: [], none: false, other: '' };
			}
			
			// If selecting a symptom, deselect "none"
			if (!isSelected) {
				const noneItem = document.querySelector('[data-symptom="none"]');
				if (noneItem) {
					noneItem.classList.remove('selected');
					noneItem.setAttribute('aria-pressed', 'false');
				}
				State.onboarding.symptoms.none = false;
			}
			
			// Handle current symptoms
			const currentSymptoms = ['low-mood', 'brain-fog', 'snoring-sleep', 'low-sex-drive', 'low-energy', 'weight-gain'];
			if (currentSymptoms.includes(symptomKey)) {
				// Add/remove from current symptoms
				const currentIndex = State.onboarding.symptoms.current.findIndex(s => s.key === symptomKey);
				if (!isSelected) {
					if (currentIndex === -1) {
						State.onboarding.symptoms.current.push({ key: symptomKey });
					}
				} else {
					if (currentIndex > -1) {
						State.onboarding.symptoms.current.splice(currentIndex, 1);
					}
				}
			}
			
			// Handle history symptoms
			const historySymptoms = ['high-bp-history', 'high-cholesterol-history', 'diabetes-history'];
			if (historySymptoms.includes(symptomKey)) {
				const historyIndex = State.onboarding.symptoms.history.indexOf(symptomKey);
				if (item.classList.contains('selected')) {
					if (historyIndex === -1) {
						State.onboarding.symptoms.history.push(symptomKey);
					}
				} else {
					if (historyIndex > -1) {
						State.onboarding.symptoms.history.splice(historyIndex, 1);
					}
				}
			}
		}
		
		save({'onboarding.answers':State.onboarding.answers});
	}
	

	// Validation helper functions
	function showError(input, msg) {
		clearError(input);
		const error = document.createElement('small');
		error.className = 'error';
		error.textContent = msg;
		input.parentNode.appendChild(error);
		input.classList.add('error');
	}

	function clearError(input) {
		const existing = input.parentNode.querySelector('.error');
		if (existing) existing.remove();
		input.classList.remove('error');
	}

	function firstInvalid() {
		return document.querySelector('input.error');
	}

	// Individual validation functions
	function validateDOB(input) {
		clearError(input);
		if (!input.value) return;
		const dob = new Date(input.value);
		const age = new Date().getFullYear() - dob.getFullYear();
		if (age < 18 || age > 80) {
			showError(input, 'Age must be between 18 and 80 years');
		}
	}

	function validateHeight(input) {
		clearError(input);
		if (!input.value) return;
		const height = parseFloat(input.value);
		if (isNaN(height) || height < 120 || height > 230) {
			showError(input, 'Height must be between 120-230 cm');
		}
	}

	function validateWeight(input) {
		clearError(input);
		if (!input.value) return;
		const weight = parseFloat(input.value);
		if (isNaN(weight) || weight < 40 || weight > 250) {
			showError(input, 'Weight must be between 40-250 kg');
		}
	}

	function validateWaist(input) {
		clearError(input);
		if (!input.value) return;
		const waist = parseFloat(input.value);
		if (isNaN(waist) || waist < 40 || waist > 200) {
			showError(input, 'Waist must be between 40-200 cm');
		}
	}

	function validateAlcohol(input) {
		clearError(input);
		if (input.value === '') return; // allow empty (treated as 0)
		const units = parseFloat(input.value);
		if (units > 80) {
			// Show warning but don't block
			const existingWarning = input.parentNode.querySelector('.warning');
			if (!existingWarning) {
				const warning = document.createElement('small');
				warning.className = 'warning';
				warning.textContent = "That's above UK guidance";
				input.parentNode.appendChild(warning);
			}
		} else {
			const existingWarning = input.parentNode.querySelector('.warning');
			if (existingWarning) existingWarning.remove();
		}
	}
	
	function setOtherSymptoms(value) {
		if (!State.onboarding.symptoms) {
			State.onboarding.symptoms = { current: [], history: [], none: false, other: '' };
		}
		State.onboarding.symptoms.other = value;
		save({'onboarding.answers':State.onboarding.answers});
	}
	// Global Assessments array
	const Assessments = [
		{
			type: 'phq2',
			title: 'Mood Check (PHQ-2)',
			questions: [
				{
					text: 'Over the last 2 weeks, how often have you been bothered by little interest or pleasure in doing things?',
					options: [
						{value: 0, text: 'Not at all'},
						{value: 1, text: 'Several days'},
						{value: 2, text: 'More than half the days'},
						{value: 3, text: 'Nearly every day'}
					]
				},
				{
					text: 'Over the last 2 weeks, how often have you been bothered by feeling down, depressed, or hopeless?',
					options: [
						{value: 0, text: 'Not at all'},
						{value: 1, text: 'Several days'},
						{value: 2, text: 'More than half the days'},
						{value: 3, text: 'Nearly every day'}
					]
				}
			],
			threshold: 3,
			reflex: 'phq8'
		},
		{
			type: 'gad2',
			title: 'Anxiety Check (GAD-2)',
			questions: [
				{
					text: 'Over the last 2 weeks, how often have you been bothered by feeling nervous, anxious, or on edge?',
					options: [
						{value: 0, text: 'Not at all'},
						{value: 1, text: 'Several days'},
						{value: 2, text: 'More than half the days'},
						{value: 3, text: 'Nearly every day'}
					]
				},
				{
					text: 'Over the last 2 weeks, how often have you been bothered by not being able to stop or control worrying?',
					options: [
						{value: 0, text: 'Not at all'},
						{value: 1, text: 'Several days'},
						{value: 2, text: 'More than half the days'},
						{value: 3, text: 'Nearly every day'}
					]
				}
			],
			threshold: 3,
			reflex: 'gad7'
		},
		{
			type: 'isi',
			title: 'Insomnia Severity Index',
			questions: [
				{
					text: 'How would you rate your current sleep problem(s) with falling asleep?',
					options: [
						{value: 0, text: 'None'},
						{value: 1, text: 'Mild'},
						{value: 2, text: 'Moderate'},
						{value: 3, text: 'Severe'},
						{value: 4, text: 'Very severe'}
					]
				},
				{
					text: 'How would you rate your current sleep problem(s) with staying asleep?',
					options: [
						{value: 0, text: 'None'},
						{value: 1, text: 'Mild'},
						{value: 2, text: 'Moderate'},
						{value: 3, text: 'Severe'},
						{value: 4, text: 'Very severe'}
					]
				},
				{
					text: 'How would you rate your current sleep problem(s) with waking up too early?',
					options: [
						{value: 0, text: 'None'},
						{value: 1, text: 'Mild'},
						{value: 2, text: 'Moderate'},
						{value: 3, text: 'Severe'},
						{value: 4, text: 'Very severe'}
					]
				},
				{
					text: 'How satisfied/dissatisfied are you with your current sleep pattern?',
					options: [
						{value: 0, text: 'Very satisfied'},
						{value: 1, text: 'Satisfied'},
						{value: 2, text: 'Moderately satisfied'},
						{value: 3, text: 'Dissatisfied'},
						{value: 4, text: 'Very dissatisfied'}
					]
				},
				{
					text: 'How noticeable to others do you think your sleep problem is in terms of impairing the quality of your life?',
					options: [
						{value: 0, text: 'Not at all noticeable'},
						{value: 1, text: 'A little'},
						{value: 2, text: 'Somewhat'},
						{value: 3, text: 'Much'},
						{value: 4, text: 'Very much noticeable'}
					]
				},
				{
					text: 'How worried/distressed are you about your current sleep problem?',
					options: [
						{value: 0, text: 'Not at all worried'},
						{value: 1, text: 'A little'},
						{value: 2, text: 'Somewhat'},
						{value: 3, text: 'Much'},
						{value: 4, text: 'Very much worried'}
					]
				},
				{
					text: 'To what extent do you consider your sleep problem to interfere with your daily functioning?',
					options: [
						{value: 0, text: 'Not at all interfering'},
						{value: 1, text: 'A little'},
						{value: 2, text: 'Somewhat'},
						{value: 3, text: 'Much'},
						{value: 4, text: 'Very much interfering'}
					]
				}
			],
			threshold: 15,
			reflex: null
		}
	];



	// Function to toggle peer comparison
	function togglePeerComparison() {
		const checkbox = document.getElementById('peer-compare');
		const comparison = document.getElementById('peer-comparison');
		if (checkbox && comparison) {
			State.settings.peerComparison = checkbox.checked;
			save({'settings.peerComparison': State.settings.peerComparison});
			
			if (checkbox.checked) {
				comparison.style.display = 'block';
				renderPeerComparison();
			} else {
				comparison.style.display = 'none';
			}
		}
	}

	// Function to toggle biological age inputs
	function toggleBioInputs() {
		const checkbox = document.getElementById('bio-inputs-toggle');
		const content = document.getElementById('bio-inputs-content');
		if (checkbox && content) {
			State.settings.bioInputsOpen = checkbox.checked;
			save({'settings.bioInputsOpen': State.settings.bioInputsOpen});
			
			if (checkbox.checked) {
				content.style.display = 'block';
			} else {
				content.style.display = 'none';
			}
		}
	}

	// Function to toggle onboarding biological age inputs
	function toggleOnboardingBioInputs() {
		const checkbox = document.getElementById('ob-bio-inputs-toggle');
		const content = document.getElementById('ob-bio-inputs-content');
		if (checkbox && content) {
			State.settings.bioInputsOpen = checkbox.checked;
			save({'settings.bioInputsOpen': State.settings.bioInputsOpen});
			
			if (checkbox.checked) {
				content.style.display = 'block';
			} else {
				content.style.display = 'none';
			}
		}
	}
	
	function renderPeerComparison() {
		const bars = document.getElementById('peer-bars');
		if (!bars) return;
		
		// Mock peer comparison data
		const percentiles = [
			{label: 'Sleep Quality', value: 75, color: '#10b981'},
			{label: 'Activity Level', value: 60, color: '#fbbf24'},
			{label: 'Stress Management', value: 45, color: '#ef4444'},
			{label: 'Nutrition', value: 80, color: '#10b981'},
			{label: 'Cardiovascular Health', value: 70, color: '#10b981'}
		];
		
		bars.innerHTML = percentiles.map(p => `
			<div style="margin-bottom:1rem">
				<div style="display:flex; justify-content:space-between; margin-bottom:0.25rem">
					<span style="font-size:0.9rem">${p.label}</span>
					<span style="font-size:0.9rem; font-weight:600">${p.value}th percentile</span>
				</div>
				<div style="background:#e5e7eb; height:8px; border-radius:4px; overflow:hidden">
					<div style="background:${p.color}; height:100%; width:${p.value}%; transition:width 0.3s ease"></div>
				</div>
			</div>
		`).join('');
	}

	// Assessment functions
	function startAssessment(assessmentType) {
		const assessments = {
			phq2: {
				title: 'Mood Check (PHQ-2)',
				questions: [
					{
						text: 'Over the last 2 weeks, how often have you been bothered by little interest or pleasure in doing things?',
						options: [
							{value: 0, text: 'Not at all'},
							{value: 1, text: 'Several days'},
							{value: 2, text: 'More than half the days'},
							{value: 3, text: 'Nearly every day'}
						]
					},
					{
						text: 'Over the last 2 weeks, how often have you been bothered by feeling down, depressed, or hopeless?',
						options: [
							{value: 0, text: 'Not at all'},
							{value: 1, text: 'Several days'},
							{value: 2, text: 'More than half the days'},
							{value: 3, text: 'Nearly every day'}
						]
					}
				],
				threshold: 3,
				reflex: 'phq8'
			},
			gad2: {
				title: 'Anxiety Check (GAD-2)',
				questions: [
					{
						text: 'Over the last 2 weeks, how often have you been bothered by feeling nervous, anxious, or on edge?',
						options: [
							{value: 0, text: 'Not at all'},
							{value: 1, text: 'Several days'},
							{value: 2, text: 'More than half the days'},
							{value: 3, text: 'Nearly every day'}
						]
					},
					{
						text: 'Over the last 2 weeks, how often have you been bothered by not being able to stop or control worrying?',
						options: [
							{value: 0, text: 'Not at all'},
							{value: 1, text: 'Several days'},
							{value: 2, text: 'More than half the days'},
							{value: 3, text: 'Nearly every day'}
						]
					}
				],
				threshold: 3,
				reflex: 'gad7'
			},
			auditc: {
				title: 'Alcohol Use (AUDIT-C)',
				questions: [
					{
						text: 'How often do you have a drink containing alcohol?',
						options: [
							{value: 0, text: 'Never'},
							{value: 1, text: 'Monthly or less'},
							{value: 2, text: '2-4 times a month'},
							{value: 3, text: '2-3 times a week'},
							{value: 4, text: '4 or more times a week'}
						]
					},
					{
						text: 'How many drinks containing alcohol do you have on a typical day when you are drinking?',
						options: [
							{value: 0, text: '1 or 2'},
							{value: 1, text: '3 or 4'},
							{value: 2, text: '5 or 6'},
							{value: 3, text: '7 to 9'},
							{value: 4, text: '10 or more'}
						]
					},
					{
						text: 'How often do you have 6 or more drinks on one occasion?',
						options: [
							{value: 0, text: 'Never'},
							{value: 1, text: 'Less than monthly'},
							{value: 2, text: 'Monthly'},
							{value: 3, text: 'Weekly'},
							{value: 4, text: 'Daily or almost daily'}
						]
					}
				],
				threshold: 5,
				reflex: 'audit10'
			},
			who5: {
				title: 'Well-being (WHO-5)',
				questions: [
					{
						text: 'I have felt cheerful and in good spirits',
						options: [
							{value: 5, text: 'All of the time'},
							{value: 4, text: 'Most of the time'},
							{value: 3, text: 'More than half of the time'},
							{value: 2, text: 'Less than half of the time'},
							{value: 1, text: 'Some of the time'},
							{value: 0, text: 'At no time'}
						]
					},
					{
						text: 'I have felt calm and relaxed',
						options: [
							{value: 5, text: 'All of the time'},
							{value: 4, text: 'Most of the time'},
							{value: 3, text: 'More than half of the time'},
							{value: 2, text: 'Less than half of the time'},
							{value: 1, text: 'Some of the time'},
							{value: 0, text: 'At no time'}
						]
					},
					{
						text: 'I have felt active and vigorous',
						options: [
							{value: 5, text: 'All of the time'},
							{value: 4, text: 'Most of the time'},
							{value: 3, text: 'More than half of the time'},
							{value: 2, text: 'Less than half of the time'},
							{value: 1, text: 'Some of the time'},
							{value: 0, text: 'At no time'}
						]
					},
					{
						text: 'I woke up feeling fresh and rested',
						options: [
							{value: 5, text: 'All of the time'},
							{value: 4, text: 'Most of the time'},
							{value: 3, text: 'More than half of the time'},
							{value: 2, text: 'Less than half of the time'},
							{value: 1, text: 'Some of the time'},
							{value: 0, text: 'At no time'}
						]
					},
					{
						text: 'My daily life has been filled with things that interest me',
						options: [
							{value: 5, text: 'All of the time'},
							{value: 4, text: 'Most of the time'},
							{value: 3, text: 'More than half of the time'},
							{value: 2, text: 'Less than half of the time'},
							{value: 1, text: 'Some of the time'},
							{value: 0, text: 'At no time'}
						]
					}
				],
				threshold: 50,
				reflex: null
			},
			isi: {
				title: 'Sleep Assessment (ISI)',
				questions: [
					{
						text: 'How would you rate your current sleep problem(s) with falling asleep?',
						options: [
							{value: 0, text: 'None'},
							{value: 1, text: 'Mild'},
							{value: 2, text: 'Moderate'},
							{value: 3, text: 'Severe'},
							{value: 4, text: 'Very severe'}
						]
					},
					{
						text: 'How would you rate your current sleep problem(s) with staying asleep?',
						options: [
							{value: 0, text: 'None'},
							{value: 1, text: 'Mild'},
							{value: 2, text: 'Moderate'},
							{value: 3, text: 'Severe'},
							{value: 4, text: 'Very severe'}
						]
					},
					{
						text: 'How would you rate your current sleep problem(s) with waking up too early?',
						options: [
							{value: 0, text: 'None'},
							{value: 1, text: 'Mild'},
							{value: 2, text: 'Moderate'},
							{value: 3, text: 'Severe'},
							{value: 4, text: 'Very severe'}
						]
					},
					{
						text: 'How satisfied are you with your current sleep pattern?',
						options: [
							{value: 0, text: 'Very satisfied'},
							{value: 1, text: 'Satisfied'},
							{value: 2, text: 'Moderately satisfied'},
							{value: 3, text: 'Dissatisfied'},
							{value: 4, text: 'Very dissatisfied'}
						]
					},
					{
						text: 'How noticeable to others do you think your sleep problem is in terms of impairing the quality of your life?',
						options: [
							{value: 0, text: 'Not at all noticeable'},
							{value: 1, text: 'A little'},
							{value: 2, text: 'Somewhat'},
							{value: 3, text: 'Much'},
							{value: 4, text: 'Very much noticeable'}
						]
					},
					{
						text: 'How worried are you about your current sleep problem?',
						options: [
							{value: 0, text: 'Not at all worried'},
							{value: 1, text: 'A little'},
							{value: 2, text: 'Somewhat'},
							{value: 3, text: 'Much'},
							{value: 4, text: 'Very much worried'}
						]
					},
					{
						text: 'To what extent do you consider your sleep problem to interfere with your daily functioning?',
						options: [
							{value: 0, text: 'Not at all interfering'},
							{value: 1, text: 'A little'},
							{value: 2, text: 'Somewhat'},
							{value: 3, text: 'Much'},
							{value: 4, text: 'Very much interfering'}
						]
					}
				],
				threshold: 15,
				reflex: null
			}
		};
		
		const assessment = assessments[assessmentType];
		if (!assessment) return;
		
		// Store current assessment state
		State.currentAssessment = {
			type: assessmentType,
			title: assessment.title,
			questions: assessment.questions,
			answers: [],
			currentQuestion: 0,
			threshold: assessment.threshold,
			reflex: assessment.reflex
		};
		
		showAssessmentModal();
	}
	function showAssessmentModal() {
		const assessment = State.currentAssessment;
		if (!assessment) return;
		
		const currentQ = assessment.questions[assessment.currentQuestion];
		const progress = ((assessment.currentQuestion + 1) / assessment.questions.length) * 100;
		const isLastQuestion = assessment.currentQuestion === assessment.questions.length - 1;
		
		const content = `
			<div style="margin-bottom:1rem">
				<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.75rem">
					<h3 style="font-size:1.25rem; font-weight:700; color:var(--ink); text-align:left; margin:0">${assessment.title}</h3>
					<div style="text-align:right">
						<div style="font-size:0.8rem; color:var(--ink-60); margin-bottom:0.25rem">Question ${assessment.currentQuestion + 1} of ${assessment.questions.length}</div>
						<div style="background:#e5e7eb; height:4px; border-radius:2px; width:100px">
							<div style="background:var(--numan-teal); height:100%; width:${progress}%; border-radius:2px; transition:width 0.3s ease"></div>
						</div>
					</div>
				</div>
			</div>
			
			<div style="margin-bottom:1.5rem">
				<div style="background:linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); padding:1rem; border-radius:12px; margin-bottom:1rem; border-left:4px solid var(--numan-teal)">
					<h4 style="margin:0; font-size:1.1rem; font-weight:600; color:var(--ink); line-height:1.4; text-align:left; text-transform:none; font-family:'Inter',sans-serif">${currentQ.text}</h4>
				</div>
				<div style="display:flex; flex-direction:column; gap:0.5rem">
					${currentQ.options.map((option, index) => {
						const isSelected = assessment.answers[assessment.currentQuestion] === option.value;
						const selectedStyle = isSelected ? 'border-color:var(--numan-teal); background:#f8fafc' : '';
						const radioSelectedStyle = isSelected ? 'border-color:var(--numan-teal); background:#f0fdfa' : '';
						const dotSelectedStyle = isSelected ? 'transform:translate(-50%, -50%) scale(1)' : 'transform:translate(-50%, -50%) scale(0)';
						
						return `
						<label class="assessment-option" style="display:flex; align-items:center; padding:1rem; border:2px solid #e5e7eb; border-radius:12px; cursor:pointer; transition:all 0.3s ease; background:var(--paper); text-align:left; min-height:60px; position:relative; overflow:hidden; ${selectedStyle}" onmouseover="if(!this.querySelector('input').checked){this.style.borderColor='var(--numan-teal)'; this.style.background='#f8fafc'}" onmouseout="if(!this.querySelector('input').checked){this.style.borderColor='#e5e7eb'; this.style.background='var(--paper)'}">
							<div style="position:relative; margin-right:1rem; flex-shrink:0">
								<input type="radio" name="assessment-answer" value="${option.value}" onchange="selectAssessmentAnswer(${option.value})" ${isSelected ? 'checked' : ''} style="opacity:0; position:absolute; width:20px; height:20px; margin:0; cursor:pointer">
								<div class="custom-radio" style="width:20px; height:20px; border:2px solid #d1d5db; border-radius:50%; background:white; position:relative; transition:all 0.2s ease; ${radioSelectedStyle}">
									<div class="radio-dot" style="width:10px; height:10px; background:var(--numan-teal); border-radius:50%; position:absolute; top:50%; left:50%; transition:transform 0.2s ease; ${dotSelectedStyle}"></div>
								</div>
							</div>
							<span style="font-size:1rem; color:var(--ink); font-weight:500; text-align:left; line-height:1.4; flex:1">${option.text}</span>
						</label>
					`}).join('')}
				</div>
			</div>
			
			<div style="display:flex; gap:0.75rem; justify-content:space-between; padding-top:0.75rem; border-top:1px solid #e5e7eb">
				<button class="btn-ghost btn-small" onclick="closeAssessmentModal()" style="padding:0.5rem 1rem; font-weight:500; font-size:0.9rem">Cancel</button>
				<button class="btn btn-small" id="next-assessment-btn" onclick="nextAssessmentQuestion()" ${assessment.answers[assessment.currentQuestion] !== undefined ? '' : 'disabled'} style="padding:0.5rem 1rem; font-weight:600; background:var(--numan-teal); color:white; border:none; border-radius:8px; cursor:pointer; transition:all 0.2s ease; font-size:0.9rem" onmouseover="this.style.background='#0d9488'" onmouseout="this.style.background='var(--numan-teal)'">${isLastQuestion ? 'Finish' : 'Next'}</button>
			</div>
			
			<style>
				.assessment-option input[type="radio"]:checked + .custom-radio {
					border-color: var(--numan-teal);
					background: #f0fdfa;
				}
				.assessment-option input[type="radio"]:checked + .custom-radio .radio-dot {
					transform: translate(-50%, -50%) scale(1);
				}
				.assessment-option:hover .custom-radio {
					border-color: var(--numan-teal);
				}
				#next-assessment-btn:disabled {
					background: #d1d5db !important;
					color: #9ca3af !important;
					cursor: not-allowed !important;
				}
			</style>
		`;
		
		openModal('assessment', content);
	}
	
	function selectAssessmentAnswer(value) {
		State.currentAssessment.answers[State.currentAssessment.currentQuestion] = value;
		document.getElementById('next-assessment-btn').disabled = false;
		
		// Update visual state of all radio buttons
		const radioButtons = document.querySelectorAll('input[name="assessment-answer"]');
		radioButtons.forEach(radio => {
			const label = radio.closest('.assessment-option');
			const customRadio = label.querySelector('.custom-radio');
			const radioDot = customRadio.querySelector('.radio-dot');
			
			if (radio.value == value) {
				// Selected state
				customRadio.style.borderColor = 'var(--numan-teal)';
				customRadio.style.background = '#f0fdfa';
				radioDot.style.transform = 'translate(-50%, -50%) scale(1)';
				label.style.borderColor = 'var(--numan-teal)';
				label.style.background = '#f8fafc';
			} else {
				// Unselected state
				customRadio.style.borderColor = '#d1d5db';
				customRadio.style.background = 'white';
				radioDot.style.transform = 'translate(-50%, -50%) scale(0)';
				label.style.borderColor = '#e5e7eb';
				label.style.background = 'var(--paper)';
			}
		});
	}
	
	function nextAssessmentQuestion() {
		const assessment = State.currentAssessment;
		if (!assessment) return;
		
		assessment.currentQuestion++;
		
		if (assessment.currentQuestion >= assessment.questions.length) {
			// Complete assessment
			completeAssessment();
		} else {
			// Show next question
			showAssessmentModal();
		}
	}
	function completeAssessment() {
		const assessment = State.currentAssessment;
		if (!assessment) return;
		
		const total = assessment.answers.reduce((sum, answer) => sum + answer, 0);
		const score = assessment.type === 'who5' ? total * 4 : total; // WHO-5 is 0-25, multiply by 4 for 0-100
		
		// Store assessment result in onboarding
		if (!State.onboarding.answers.assessments) {
			State.onboarding.answers.assessments = [];
		}
		
		const result = {
			tool: assessment.type.toUpperCase(),
			version: 'v1',
			dateISO: new Date().toISOString(),
			items: assessment.answers,
			total: score,
			band: getAssessmentBand(assessment.type, score)
		};
		
		State.onboarding.answers.assessments.push(result);
		save({'onboarding.answers':State.onboarding.answers});
		
		// Store in assessment history for dashboard
		if (!State.assessments) {
			State.assessments = [];
		}
		
		const historyResult = {
			id: Date.now().toString(),
			type: assessment.type,
			title: assessment.title,
			score: score,
			band: getAssessmentBand(assessment.type, score),
			date: new Date().toISOString(),
			completed: true,
			answers: assessment.answers,
			interpretation: getAssessmentInterpretation(assessment.type, score)
		};
		
		State.assessments.push(historyResult);
		// Persist immediately so other views swap to "View result"
		save({'assessments': State.assessments});
		
		// Mark any scheduled assessment of the same type as completed
		const scheduledAssessment = State.assessments.find(a => a.id === assessment.type && !a.completed);
		if (scheduledAssessment) {
			scheduledAssessment.completed = true;
			scheduledAssessment.completedAt = new Date().toISOString();
			scheduledAssessment.score = score;
			scheduledAssessment.band = getAssessmentBand(assessment.type, score);
			
			// Schedule next assessment based on frequency
			const nextDate = new Date();
			if (scheduledAssessment.frequency === 'weekly') {
				nextDate.setDate(nextDate.getDate() + 7);
			} else if (scheduledAssessment.frequency === 'monthly') {
				nextDate.setMonth(nextDate.getMonth() + 1);
			} else if (scheduledAssessment.frequency === 'quarterly') {
				nextDate.setMonth(nextDate.getMonth() + 3);
			}
			
			// Create next scheduled assessment
			const nextAssessment = {
				...scheduledAssessment,
				id: scheduledAssessment.id + '-' + nextDate.getTime(),
				completed: false,
				completedAt: null,
				score: null,
				band: null,
				scheduledAt: nextDate.toISOString()
			};
			State.assessments.push(nextAssessment);
		}
		
		save({'assessments': State.assessments});
		
		// Update dashboard assessment cards and show result in modal
		finishAssessment(assessment.type, score, getAssessmentBand(assessment.type, score), [result.interpretation]);
		
		// Refresh current surface so buttons/labels update
		if (State.currentView === 'onboarding') {
			// Check if we're on the assessments step and refresh it specifically
			const currentStep = OnboardingSteps[State.onboarding.currentStep];
			if (currentStep && currentStep.key === 'assessments') {
				// Re-render the assessments step content immediately
				const wrap = document.getElementById('ob-steps');
				if (wrap) {
					wrap.innerHTML = currentStep.render();
				}
			} else {
				// Re-render entire onboarding for other steps
				setTimeout(() => { renderOnboarding(); }, 100);
			}
		}
		
		// Always refresh assessments display if visible (regardless of current view)
		// Use a small delay to ensure state is fully persisted
		setTimeout(() => {
			const listHost = document.getElementById('assessments-list');
			if (listHost) renderAssessments();
			
			// Also refresh any onboarding assessments that might be visible
			const obSteps = document.getElementById('ob-steps');
			if (obSteps) {
				const currentStep = OnboardingSteps[State.onboarding.currentStep];
				if (currentStep && currentStep.key === 'assessments') {
					obSteps.innerHTML = currentStep.render();
				}
			}
		}, 100);
		
		// Grant XP for completing assessment
		grantXPForAction('assessment_completed', 15);
		
		// Clear current assessment
		State.currentAssessment = null;
	}
	
	function getAssessmentInterpretation(type, score) {
		const interpretations = {
			'phq2': {
				0: 'No depression symptoms',
				1: 'Minimal depression symptoms',
				2: 'Mild depression symptoms',
				3: 'Moderate depression symptoms - follow-up advised',
				4: 'Moderately severe depression symptoms - follow-up advised',
				5: 'Severe depression symptoms - follow-up advised',
				6: 'Severe depression symptoms - follow-up advised'
			},
			'gad2': {
				0: 'No anxiety symptoms',
				1: 'Minimal anxiety symptoms',
				2: 'Mild anxiety symptoms',
				3: 'Moderate anxiety symptoms - follow-up advised',
				4: 'Moderately severe anxiety symptoms - follow-up advised',
				5: 'Severe anxiety symptoms - follow-up advised',
				6: 'Severe anxiety symptoms - follow-up advised'
			},
			'auditc': {
				0: 'No alcohol use disorder',
				1: 'Low risk',
				2: 'Low risk',
				3: 'Moderate risk',
				4: 'High risk - follow-up advised',
				5: 'High risk - follow-up advised',
				6: 'High risk - follow-up advised',
				7: 'High risk - follow-up advised',
				8: 'High risk - follow-up advised',
				9: 'High risk - follow-up advised',
				10: 'High risk - follow-up advised',
				11: 'High risk - follow-up advised',
				12: 'High risk - follow-up advised'
			},
			'who5': {
				0: 'Very poor wellbeing',
				25: 'Poor wellbeing',
				50: 'Fair wellbeing',
				75: 'Good wellbeing',
				100: 'Excellent wellbeing'
			},
			'isi': {
				0: 'No insomnia',
				7: 'Subthreshold insomnia',
				14: 'Moderate insomnia',
				21: 'Severe insomnia',
				28: 'Very severe insomnia'
			}
		};
		
		const typeInterpretations = interpretations[type];
		if (!typeInterpretations) return 'Assessment completed';
		
		// Find the closest interpretation
		const keys = Object.keys(typeInterpretations).map(Number).sort((a, b) => a - b);
		let closest = keys[0];
		for (const key of keys) {
			if (score >= key) closest = key;
			else break;
		}
		
		return typeInterpretations[closest] || 'Assessment completed';
	}
	
	function showAssessmentResultInModal(result) {
		const modal = document.querySelector('.modal.active');
		if (!modal) return;
		
		const modalContent = modal.querySelector('.modal-content');
		modalContent.innerHTML = `
			<div class="modal-header" style="position: sticky; top: 0; background: var(--paper); z-index: 1; padding-bottom: 1rem; border-bottom: 1px solid var(--border); margin-bottom: 1rem;">
				<div style="display:flex; justify-content:space-between; align-items:center">
					<h3 style="font-size:1.5rem; font-weight:700; color:var(--ink)">Assessment Complete</h3>
					<button class="btn-ghost btn-small" onclick="closeAssessmentModal()" style="padding:0.5rem; border-radius:50%; width:2rem; height:2rem; display:flex; align-items:center; justify-content:center">✕</button>
				</div>
			</div>
			
			<div class="modal-body" style="max-height: 60vh; overflow-y: auto; padding:1rem 0;">
				<div style="text-align:center; margin:2rem 0">
					<div style="font-size:4rem; font-weight:800; color:var(--numan-teal); margin-bottom:0.75rem; line-height:1">${result.score}</div>
					<div style="font-size:1.4rem; font-weight:600; margin-bottom:0.5rem; color:var(--ink)">${result.title}</div>
					<div style="color:var(--ink-60); margin-bottom:1.5rem; font-size:1.1rem; text-transform:capitalize">${result.band}</div>
					<div style="font-size:1rem; color:var(--ink-70); font-style:italic; line-height:1.5; max-width:400px; margin:0 auto">${result.interpretation}</div>
				</div>
				
				<div style="background:var(--canvas); padding:1.25rem; border-radius:12px; margin:1.5rem 0; border-left:4px solid var(--numan-teal)">
					<div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.5rem">
						<span style="font-size:0.9rem; color:var(--ink-60); font-weight:500">Score: ${result.score} (${result.band})</span>
					</div>
					<small style="color:var(--ink-50); font-style:italic">Educational only - not a medical diagnosis</small>
				</div>
			</div>
			
			<div class="modal-footer" style="position: sticky; bottom: 0; background: var(--paper); z-index: 1; padding-top: 1rem; border-top: 1px solid var(--border); display:flex; gap:0.75rem; justify-content:flex-end">
				<button class="btn-ghost" onclick="repeatAssessment('${result.type}')" style="padding:0.75rem 1.5rem; border-radius:8px; font-weight:500">Repeat</button>
				<button class="btn-primary" onclick="closeAssessmentModal()" style="padding:0.75rem 1.5rem; border-radius:8px; font-weight:600">Save & close</button>
			</div>
		`;
		
		// Announce result with aria-live
		const announcement = document.createElement('div');
		announcement.setAttribute('aria-live', 'polite');
		announcement.style.position = 'absolute';
		announcement.style.left = '-9999px';
		announcement.textContent = `Assessment complete. Score: ${result.score}, ${result.band}`;
		modal.appendChild(announcement);
		setTimeout(() => announcement.remove(), 1000);
	}
	
	
	function toggleAssessmentDropdown(assessmentId) {
		const dropdown = document.getElementById(`assessment-dropdown-${assessmentId}`);
		const button = dropdown.previousElementSibling;
		const isExpanded = dropdown.style.display !== 'none';
		
		if (isExpanded) {
			dropdown.style.display = 'none';
			button.setAttribute('aria-expanded', 'false');
			button.innerHTML = 'View result ▾';
		} else {
			dropdown.style.display = 'block';
			button.setAttribute('aria-expanded', 'true');
			button.innerHTML = 'View result ▴';
		}
	}
	
	function showAssessmentResult(result) {
		const modal = document.createElement('div');
		modal.className = 'modal active';
		modal.style.display = 'flex';
		
		// Get interpretation text, with fallback
		const interpretation = getAssessmentInterpretation(result.type, result.score) || 
			(result.interpretation || 'Assessment completed successfully.');
		
		modal.innerHTML = `
			<div class="modal-content" style="max-width:480px; padding:2rem; text-align:center; border-radius:12px; box-shadow:0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);">
				<!-- Header with title and close button -->
				<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem">
					<h3 style="margin:0; font-size:1.1rem; font-weight:700; color:var(--ink-80); text-transform:uppercase; letter-spacing:0.5px">Assessment Complete</h3>
					<button onclick="this.closest('.modal').remove()" style="
						width: 24px;
						height: 24px;
						border-radius: 50%;
						border: none;
						background: var(--ink-10);
						color: var(--ink-60);
						font-size: 14px;
						font-weight: 600;
						cursor: pointer;
						display: flex;
						align-items: center;
						justify-content: center;
						transition: all 0.2s ease;
					" onmouseover="this.style.background='var(--ink-20)'; this.style.color='var(--ink-80)'" onmouseout="this.style.background='var(--ink-10)'; this.style.color='var(--ink-60)'">✕</button>
				</div>
				
				<!-- Assessment Type -->
				<div style="margin-bottom:1.5rem">
					<div style="font-size:0.9rem; color:var(--ink-70); font-weight:600; text-transform:uppercase; letter-spacing:0.5px">${result.type || 'Assessment'}</div>
				</div>
				
				<!-- Score and Band -->
				<div style="margin-bottom:2rem">
					<div style="display:flex; align-items:center; justify-content:center; gap:1rem; margin-bottom:1rem">
						<div style="text-align:center">
							<div style="font-size:3rem; font-weight:800; color:var(--numan-teal); line-height:1">${result.score}</div>
						</div>
						<div style="text-align:center">
							<div style="font-size:0.9rem; color:var(--ink-60); text-transform:lowercase">${result.band || 'N/A'}</div>
						</div>
					</div>
					<div style="font-size:0.85rem; color:var(--ink-60); line-height:1.4; font-style:italic; max-width:320px; margin:0 auto">${interpretation}</div>
				</div>
				
				<!-- Action Buttons -->
				<div style="display:flex; gap:0.75rem; justify-content:center">
					<button onclick="this.closest('.modal').remove()" style="
						padding: 0.75rem 1.5rem;
						border: 2px solid var(--ink-20);
						border-radius: 8px;
						background: white;
						color: var(--ink-80);
						font-weight: 600;
						cursor: pointer;
						transition: all 0.2s ease;
						font-size: 0.9rem;
					" onmouseover="this.style.borderColor='var(--ink-40)'; this.style.background='var(--ink-05)'" onmouseout="this.style.borderColor='var(--ink-20)'; this.style.background='white'">Close</button>
					<button onclick="repeatAssessment('${result.type}'); this.closest('.modal').remove()" style="
						padding: 0.75rem 1.5rem;
						border: none;
						border-radius: 8px;
						background: var(--numan-teal);
						color: white;
						font-weight: 600;
						cursor: pointer;
						transition: all 0.2s ease;
						font-size: 0.9rem;
					" onmouseover="this.style.background='var(--numan-teal-dark)'" onmouseout="this.style.background='var(--numan-teal)'">Repeat</button>
					<button onclick="this.closest('.modal').remove()" style="
						padding: 0.75rem 1.5rem;
						border: 2px solid var(--numan-teal);
						border-radius: 8px;
						background: white;
						color: var(--numan-teal);
						font-weight: 600;
						cursor: pointer;
						transition: all 0.2s ease;
						font-size: 0.9rem;
					" onmouseover="this.style.background='var(--numan-teal)'; this.style.color='white'" onmouseout="this.style.background='white'; this.style.color='var(--numan-teal)'">Save & close</button>
				</div>
			</div>
		`;
		document.body.appendChild(modal);
	}
	
	
	function repeatAssessment(assessmentId) {
		console.log('repeatAssessment called with:', assessmentId);
		
		// Handle object parameters and different ID formats
		let baseId = assessmentId;
		if (typeof assessmentId === 'object' && assessmentId && assessmentId.type) {
			baseId = assessmentId.type;
		}
		if (typeof baseId === 'string' && baseId.includes('-')) {
			baseId = baseId.split('-')[0];
		}
		
		console.log('Starting assessment with baseId:', baseId);
		startAssessment(baseId);
	}
	
	function viewAssessmentHistory(assessmentId) {
		console.log('viewAssessmentHistory called with:', assessmentId);
		
		// Handle different ID formats
		let baseId = assessmentId;
		if (assessmentId.includes('-')) {
			baseId = assessmentId.split('-')[0];
		}
		console.log('baseId extracted:', baseId);
		
		// Find all completed assessments of this type
		const history = State.assessments.filter(a => {
			// Match by type or by ID starting with baseId
			return (a.type === baseId || a.id.startsWith(baseId)) && a.completed;
		}).sort((a, b) => new Date(b.date || b.completedAt) - new Date(a.date || a.completedAt));
		
		if (history.length === 0) {
			showToast('No history available for this assessment');
			return;
		}
		
		// Get the most recent assessment result
		const latestResult = history[0];
		const date = new Date(latestResult.date || latestResult.completedAt);
		
		const modal = document.createElement('div');
		modal.className = 'modal active';
		modal.id = 'assessment-history-modal';
		modal.innerHTML = `
			<div class="modal-content" style="max-width:400px; padding:2rem; text-align:center">
				<!-- Header with title and close button -->
				<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem">
					<h3 style="margin:0; font-size:1.1rem; font-weight:700; color:var(--ink-80); text-transform:uppercase; letter-spacing:0.5px">${latestResult.title || 'Assessment Result'}</h3>
					<button onclick="closeAssessmentHistoryModal()" style="
						width: 24px;
						height: 24px;
						border-radius: 50%;
						border: none;
						background: var(--ink-10);
						color: var(--ink-60);
						font-size: 14px;
						font-weight: 600;
						cursor: pointer;
						display: flex;
						align-items: center;
						justify-content: center;
						transition: all 0.2s ease;
					" onmouseover="this.style.background='var(--ink-20)'; this.style.color='var(--ink-80)'" onmouseout="this.style.background='var(--ink-10)'; this.style.color='var(--ink-60)'">✕</button>
				</div>
				
				<!-- Date and Time -->
				<div style="margin-bottom:1.5rem">
					<div style="font-size:0.9rem; color:var(--ink-70); margin-bottom:0.25rem">${date.toLocaleDateString('en-GB')}</div>
					<div style="font-size:0.9rem; color:var(--ink-70)">${date.toLocaleTimeString('en-GB', {hour: '2-digit', minute: '2-digit', second: '2-digit'})}</div>
				</div>
				
				<!-- Interpretation Text -->
				<div style="margin-bottom:2rem">
					<div style="font-size:0.85rem; color:var(--ink-60); line-height:1.4; font-style:italic">${latestResult.interpretation || 'Assessment completed'}</div>
				</div>
				
				<!-- Score Display -->
				<div style="display:flex; align-items:center; justify-content:center; gap:1rem; margin-bottom:2rem">
					<!-- Score -->
					<div style="text-align:center">
						<div style="font-size:3rem; font-weight:800; color:var(--numan-teal); line-height:1">${latestResult.score}</div>
					</div>
					
					<!-- Band/Severity -->
					<div style="text-align:center">
						<div style="font-size:0.9rem; color:var(--ink-60); text-transform:lowercase">${latestResult.band || 'N/A'}</div>
					</div>
				</div>
				
				<!-- Action Buttons -->
				<div style="display:flex; gap:0.75rem; justify-content:center">
					<button onclick="closeAssessmentHistoryModal()" style="
						padding: 0.75rem 1.5rem;
						border: 2px solid var(--ink-20);
						border-radius: 8px;
						background: white;
						color: var(--ink-80);
						font-weight: 600;
						cursor: pointer;
						transition: all 0.2s ease;
						font-size: 0.9rem;
					" onmouseover="this.style.borderColor='var(--ink-40)'; this.style.background='var(--ink-05)'" onmouseout="this.style.borderColor='var(--ink-20)'; this.style.background='white'">Close</button>
					<button onclick="repeatAssessment('${baseId}'); closeAssessmentHistoryModal()" style="
						padding: 0.75rem 1.5rem;
						border: none;
						border-radius: 8px;
						background: var(--numan-teal);
						color: white;
						font-weight: 600;
						cursor: pointer;
						transition: all 0.2s ease;
						font-size: 0.9rem;
					" onmouseover="this.style.background='#0d9488'" onmouseout="this.style.background='var(--numan-teal)'">Take Again</button>
				</div>
			</div>
		`;
		document.body.appendChild(modal);
	}
	
	function getAssessmentBand(type, score) {
		switch(type) {
			case 'phq2':
			case 'gad2':
				return score < 3 ? 'low' : 'moderate';
			case 'auditc':
				if (score <= 7) return 'low';
				if (score <= 15) return 'increasing';
				if (score <= 19) return 'higher';
				return 'possible-dependence';
			case 'who5':
				return score <= 28 ? 'likely-depression' : score <= 50 ? 'low-wellbeing' : 'good';
			case 'isi':
				if (score <= 7) return 'no-insomnia';
				if (score <= 14) return 'subthreshold';
				if (score <= 21) return 'moderate';
				return 'severe';
			default:
				return 'complete';
		}
	}
	
	
	
	// =============== PACKAGE RECOMMENDATION ENGINE ===============
	
	function getAssessment(toolId, list = []) {
		return list?.find(x => x.tool === toolId) || null;
	}
	
	function buildFeatures(state) {
		const { lifestyle, symptoms, preferences, assessments } = state.onboarding.answers || {};
		const series = state.wearables.series || {};
		const avg7 = key => {
			const data = series[key] || [];
			const last7 = data.slice(-7);
			return last7.length > 0 ? last7.reduce((a,b) => a + b, 0) / last7.length : 0;
		};

		// Derived metrics
		const steps7 = avg7('steps') || 0;
		const sleepHrs7 = avg7('sleep') || 0; // sleep is already in hours
		const rhr7 = avg7('rhr') || 0;
		const hrv7 = avg7('hrv') || 0;

		// Assessment scores
		const phq8 = getAssessment('PHQ8', assessments);
		const gad7 = getAssessment('GAD7', assessments);
		const who5 = getAssessment('WHO5', assessments);
		const auditC = getAssessment('AUDITC', assessments);
		const isi = getAssessment('ISI', assessments);
		const epworth = getAssessment('EPWORTH', assessments);
		const findrisc = getAssessment('FINDRISC', assessments);
		const iief5 = getAssessment('IIEF5', assessments);
		const fsfi6 = getAssessment('FSFI6', assessments);

		// Calculate WHtR if we have waist and height
		const WHtR = (State.user.waist && State.user.height) ? State.user.waist / State.user.height : 0;

		return { 
			steps7, sleepHrs7, rhr7, hrv7, WHtR,
			phq8, gad7, who5, auditC, isi, epworth, findrisc, iief5, fsfi6,
			...lifestyle, ...preferences, symptoms,
			// Additional derived features
			alcohol: { units: lifestyle?.alcoholUnits || 0 },
			smoking: { smoker: lifestyle?.smoker || false, readiness: 3 }, // Default readiness
			labs: { testosteroneMorningLow: false } // Will be updated when labs are available
		};
	}


	function scorePackages(feat) {
		const scores = { 
			coaching: 0, weight: 0, sleep: 0, bloods: 0, 
			sexual: 0, trt: 0, cognition: 0, supplements: 0 
		};

		// FINDRISC scoring
		if (feat.findrisc?.total >= 15) { 
			scores.weight += 3; 
			scores.bloods += 2; 
		}

		// WHtR scoring
		if (feat.WHtR >= 0.5) { 
			scores.weight += 2; 
		}

		// Activity scoring
		if (feat.steps7 < 6000) { 
			scores.coaching += 2; 
			scores.weight += 1; 
		}

		// Sleep scoring
		if (feat.isi?.total >= 15 || feat.epworth?.total >= 11) { 
			scores.sleep += 3; 
		}

		// Mental health scoring
		if (feat.phq8?.total >= 10) { 
			scores.coaching += 2; 
			scores.cognition += 1; 
		}
		if (feat.gad7?.total >= 10) { 
			scores.coaching += 2; 
			scores.cognition += 1; 
		}
		if (feat.who5?.total <= 50) { 
			scores.coaching += 1; 
		}

		// Alcohol scoring
		if ((feat.alcohol?.units ?? 0) > 14 || (feat.auditC?.total ?? 0) >= 5) { 
			scores.coaching += 2; 
		}

		// Smoking scoring
		if (feat.smoking?.smoker && (feat.smoking?.readiness || 0) >= 3) { 
			scores.coaching += 2; 
		}

		// Sexual health scoring
		if (feat.iief5?.total && feat.iief5.total <= 21) { 
			scores.sexual += 3; 
		}
		if (feat.fsfi6?.total && feat.fsfi6.total <= 19) { 
			scores.sexual += 3; 
		}
		// TRT eligibility (gated by labs)
		const labsSuggestLowT = feat.labs?.testosteroneMorningLow === true;
		if (labsSuggestLowT && feat.symptoms?.current?.some(x => x.key === 'low-sex-drive')) { 
			scores.trt += 3; 
		}

		// Supplements as enhancer
		if (feat.sleepHrs7 < 7 || feat.steps7 < 8000 || (feat.alcohol?.units ?? 0) > 14) { 
			scores.supplements += 1; 
		}

		// Blood tests for unknown biomarkers
		if (!feat.labs?.hasBloods) {
			scores.bloods += 2;
		}

		return scores;
	}

	// map service id -> score key used by scorePackages
	const SERVICE_KEY = {
		'coaching':'coaching',
		'weight-mgmt':'weight',
		'sleep':'sleep',
		'blood-tests':'bloods',
		'sexual-support':'sexual',
		'testosterone':'trt',
		'cognition':'cognition',
		'supplements':'supplements',
		'bp-optimisation':'bloods',
		'cholesterol-improvement':'bloods',
		'prediabetes-prevention':'bloods',
		'alcohol-smart':'coaching',
		'stop-smoking':'coaching',
	};

	// reasons for any one service (reuse your logic in explainSelections)
	function reasonsForService(serviceId, feat){
		const name = Services.find(s=>s.id===serviceId)?.name || serviceId;
		const reasonsMap = explainSelections([name], feat); // reuse existing
		return reasonsMap[name] || [];
	}

	// visibility + sectioning for each card
	// section: 'recommended' | 'more' | 'potential' | 'requestable'
	function visibilityForService(s, feat, user){
		const show = {visible:true, gated:false, reason:null, section:'more'};

		// Requestables off-grid into modal
		if (['msk-physio','heart-risk-panel','gut-health-test'].includes(s.id)){
			return {visible:false, section:'requestable'};
		}

		// Demographic gating - make menopause support available to all genders
		if (s.id==='menopause-support'){
			// Available to all genders, but may have different recommendations based on gender
			return {visible:false, section:'requestable'}; // always in Request a service
		}

		const hasSexSymptoms = feat?.symptoms?.current?.some(x=>x.key==='low-sex-drive');
		const riskyAUDIT = (feat.auditC?.total||0) >= 5 || (feat.alcohol?.units||0) > 14;
		const smokerReady = feat.smoking?.smoker && (feat.smoking?.readiness||0)>=3;
		const weightSignals = (feat.WHtR>=0.5) || (feat.findrisc?.total>=12) || (feat.steps7<6000);

		// Lifestyle contingent
		if (s.id==='alcohol-smart' && !riskyAUDIT) return {visible:false};
		if (s.id==='stop-smoking' && !smokerReady) return {visible:false};

		// Show only if signals present
		if (s.id==='weight-mgmt' && !weightSignals) show.section='more';
		if (s.id==='cholesterol-improvement'){
			const ok = (user.age>=40) || (feat?.history?.cholesterol) || ((feat.findrisc?.total||0)>=12);
			if (!ok) return {visible:false};
		}
		if (s.id==='bp-optimisation'){
			const ok = (feat?.history?.bp) || ((feat?.vitals?.systolicBP||0)>=135);
			if (!ok) return {visible:false};
		}
		if (s.id==='prediabetes-prevention'){
			const ok = (feat.WHtR>=0.5) || ((feat.findrisc?.total||0)>=12);
			if (!ok) return {visible:false};
		}

		// Clinical gating for TRT
		if (s.id==='testosterone'){
			const labsLowT = feat.labs?.testosteroneMorningLow===true;
			const clinicianOK = State.labs?.clinicianApproved===true;
			const bloodsSelected = State.plan.selectedIds?.includes('blood-tests') || false;
			if (labsLowT && clinicianOK && hasSexSymptoms) { show.section='recommended'; }
			else {
				return {visible:true, gated:true, section:'potential', reason:'What to do next → Add blood tests'};
			}
		}

		// Default: coaching/sleep/bloods often recommended
		if (['coaching','sleep','blood-tests'].includes(s.id)) show.section='recommended';

		return show;
	}

	// Build curated groups and ranking
	function curateCatalogue(services, feat, user){
		const groups = {recommended:[], more:[], potential:[], requestable:[]};
		const scores = scorePackages(feat);
		const scoreOf = id => scores[SERVICE_KEY[id]]||0;

		for (const s of services){
			const vis = visibilityForService(s, feat, user);
			if (!vis.visible) { if (vis.section) groups[vis.section].push({...s, ...vis}); continue; }
			groups[vis.section].push({...s, ...vis});
		}

		// rank within sections: score desc, price asc
		for (const k of ['recommended','more','potential']){
			groups[k].sort((a,b)=> (scoreOf(b.id)-scoreOf(a.id)) || (a.price-b.price));
		}
		return groups;
	}

	// Alias for buildFeatures
	function extractFeatures(state) {
		return buildFeatures(state);
	}

	function eligibleForTRT(state, feat) {
		const lowLab = feat?.labs?.testosteroneMorningLow === true;
		const hasSymptom = feat?.symptoms?.current?.some(x => x.key === 'low-sex-drive');
		const clinician = state?.labs?.clinicianApproved === true;
		return !!(lowLab && hasSymptom && clinician);
	}

	function assemblePlan(scores, budget, cadence, trtEligible = false) {
		// Rank by score then by clinical priority
		const ordered = Object.entries(scores)
			.sort((a, b) => b[1] - a[1])
			.map(([k]) => k);

		// Map keys to service names
		const serviceMap = {
			coaching: 'Health coaching',
			weight: 'Long-term weight management',
			sleep: 'Sleep optimisation',
			bloods: 'Personalised blood tests',
			sexual: 'Sexual support pathway',
			trt: 'Testosterone optimisation',
			cognition: 'Cognition support',
			supplements: 'Enhanced supplements'
		};

		// Determine max slots based on budget
		let maxSlots = 1;
		if (budget === '100-plus') {
			maxSlots = 3;
		} else if (budget === '50-99') {
			maxSlots = 2;
		} else if (budget === 'under-50') {
			maxSlots = 1;
		}
		const picked = [];

		for (const key of ordered) {
			if (scores[key] <= 0) continue;
			if (key === 'trt' && !trtEligible) continue; // Guard for TRT
			
			picked.push(serviceMap[key]);
			if (picked.length >= maxSlots) break;
		}

		return picked;
	}
	function explainSelections(picked, feat) {
		const explanations = {};

		picked.forEach(service => {
			const reasons = [];

			switch(service) {
				case 'Health coaching':
					if (feat.steps7 < 6000) reasons.push(`Low activity (~${Math.round(feat.steps7)} steps/day)`);
					if (feat.phq8?.total >= 10) reasons.push(`PHQ-8 ${feat.phq8.total} → mood support`);
					if (feat.gad7?.total >= 10) reasons.push(`GAD-7 ${feat.gad7.total} → anxiety tools`);
					if (feat.who5?.total <= 50) reasons.push(`WHO-5 ${feat.who5.total} → wellbeing support`);
					if ((feat.alcohol?.units ?? 0) > 14) reasons.push(`${feat.alcohol.units} alcohol units/week`);
					if (feat.smoking?.smoker) reasons.push('Smoker and ready to quit');
					break;

				case 'Long-term weight management':
					if (feat.findrisc?.total >= 15) reasons.push(`FINDRISC ${feat.findrisc.total} → reduce diabetes risk`);
					if (feat.WHtR >= 0.5) reasons.push(`Waist:height ${feat.WHtR.toFixed(2)} (elevated)`);
					if (feat.steps7 < 6000) reasons.push(`Low activity`);
					break;

				case 'Sleep optimisation':
					if (feat.isi?.total >= 15) reasons.push(`ISI ${feat.isi.total} → insomnia help`);
					if (feat.epworth?.total >= 11) reasons.push(`Epworth ${feat.epworth.total} → daytime sleepiness`);
					if (feat.sleepHrs7 < 7) reasons.push(`Short sleep (${feat.sleepHrs7.toFixed(1)}h)`);
					break;

				case 'Personalised blood tests':
					if (feat.findrisc?.total >= 15) reasons.push(`FINDRISC high → check A1c`);
					if (!feat.labs?.hasBloods) reasons.push('Key biomarkers unknown (LDL, A1c, BP)');
					break;

				case 'Sexual support pathway':
					if (feat.iief5?.total <= 21) reasons.push(`IIEF-5 ${feat.iief5.total} → erection support`);
					if (feat.fsfi6?.total <= 19) reasons.push(`FSFI-6 ${feat.fsfi6.total} → sexual function support`);
					break;

				case 'Cognition support':
					if (feat.sleepHrs7 < 7) reasons.push(`Sleep <7h affects focus`);
					if (feat.phq8?.total >= 10 || feat.gad7?.total >= 10) reasons.push(`PHQ-8/GAD-7 suggest cognitive load`);
					break;

				case 'Enhanced supplements':
					if (feat.sleepHrs7 < 7) reasons.push(`Short sleep (${feat.sleepHrs7.toFixed(1)}h)`);
					if (feat.steps7 < 8000) reasons.push(`Low activity`);
					if ((feat.alcohol?.units ?? 0) > 14) reasons.push(`Higher alcohol intake`);
					break;
			}

			explanations[service] = reasons.slice(0, 3); // Limit to top 3 reasons
		});

		return explanations;
	}

	function buildGlobalReasons(feat){
		const R = [];

		// Metabolic / weight
		if (feat.findrisc?.total >= 15) R.push(`FINDRISC ${feat.findrisc.total} → higher diabetes risk`);
		if (feat.WHtR >= 0.6) R.push(`Waist:height ${feat.WHtR.toFixed(2)} (very high)`);
		else if (feat.WHtR >= 0.5) R.push(`Waist:height ${feat.WHtR.toFixed(2)} (elevated)`);

		// Activity & sleep
		if (feat.steps7 && feat.steps7 < 6000) R.push(`Low activity (~${Math.round(feat.steps7)} steps/day)`);
		if (feat.sleepHrs7 && feat.sleepHrs7 < 7) R.push(`Short sleep (${feat.sleepHrs7.toFixed(1)}h avg)`);

		// Sleep screens
		if (feat.isi?.total >= 15) R.push(`ISI ${feat.isi.total} → moderate insomnia`);
		if (feat.epworth?.total >= 11) R.push(`Epworth ${feat.epworth.total} → excessive sleepiness`);

		// Mood / anxiety
		if (feat.phq8?.total >= 10) R.push(`PHQ-8 ${feat.phq8.total} → mood impacting habits`);
		if (feat.gad7?.total >= 10) R.push(`GAD-7 ${feat.gad7.total} → anxiety impacting focus`);

		// Alcohol / smoking
		if ((feat.alcohol?.units ?? 0) > 14) R.push(`${feat.alcohol.units} alcohol units/week`);
		if (feat.smoking?.smoker) R.push(`Current smoker (ready to quit)`);

		// Biomarkers unknown
		if (!feat.labs?.hasBloods) R.push(`Key biomarkers unknown (LDL, A1c, BP)`);

		// Sexual function screens
		if (feat.iief5?.total && feat.iief5.total <= 21) R.push(`IIEF-5 ${feat.iief5.total} → erection concerns`);
		if (feat.fsfi6?.total && feat.fsfi6.total <= 19) R.push(`FSFI-6 ${feat.fsfi6.total} → sexual function concerns`);

		return R;
	}

	function recommendPlan(state) {
		const feat = buildFeatures(state);
		const scores = scorePackages(feat);
		const budget = state.onboarding?.answers?.preferences?.budget || '';
		const cadence = state.onboarding?.answers?.preferences?.cadence || 'monthly';
		const trtOK = eligibleForTRT(state, feat);
		
		const picked = assemblePlan(scores, budget, cadence, trtOK);
		
		// Convert service names to IDs
		const selectedIds = picked.map(serviceNameToId);
		
		// Get pricing
		const quote = priceQuote({ 
			selectedIds, 
			annual: state.plan?.annual || false, 
			coupon: state.coupon || '' 
		});

		const why = explainSelections(picked, feat);

		return { picked, quote, why, scores, features: feat };
	}

	function serviceNameToId(serviceName) {
		const nameToIdMap = {
			'Health coaching': 'coaching',
			'Long-term weight management': 'weight-mgmt',
			'Sleep optimisation': 'sleep',
			'Personalised blood tests': 'blood-tests',
			'Sexual support pathway': 'sexual-support',
			'Testosterone optimisation': 'testosterone',
			'Cognition support': 'cognition',
			'Enhanced supplements': 'supplements'
		};
		return nameToIdMap[serviceName] || serviceName.toLowerCase().replace(/\s+/g, '-');
	}

	function checkSafetyFlags(state) {
		const feat = buildFeatures(state);
		const flags = [];

		// High alcohol risk warning removed

		// PHQ-9 item 9 (suicidal ideation) - if we ever implement PHQ-9
		// This would be checked if PHQ-9 is used instead of PHQ-8
		// Removed NHS 111/999 warning for high depression score

		// Sleep apnoea warning removed

		// High blood pressure warning removed

		return flags;
	}

	// Legacy showPersonalisedPlan function removed - using new recEngine

	// Legacy applyRecommendations function removed - using new recEngine
	function setUser(k,v){ 
		const numValue = isFinite(+v)? +v: v;
		State.user[k] = numValue; 
		save({'user.profile':State.user}); 
		
		// Special handling for gender to ensure proper values
		if (k === 'sex') {
			console.log('Gender set to:', v);
			// If user is on build first month page, refresh it to apply gender filtering
			if (State.currentView === 'build-first-month') {
				setTimeout(() => renderBuildFirstMonthPage(), 100);
			}
		}
	}

	// Fix gender values that might be stored as display text instead of proper values
	function fixGenderValues() {
		const gender = State.user.sex;
		if (gender) {
			// Map display text to proper values
			const genderMap = {
				'Male': 'male',
				'Female': 'female', 
				'Non-binary': 'non-binary',
				'Prefer not to say': 'prefer-not-to-say'
			};
			
			if (genderMap[gender]) {
				console.log(`Fixing gender from "${gender}" to "${genderMap[gender]}"`);
				State.user.sex = genderMap[gender];
				save({'user.profile': State.user});
			}
		}
	}
	
	// Clean up any invalid user data
	function cleanUserData() {
		const user = State.user;
		
		// Reset any invalid numeric values
		if (user.height && (isNaN(parseFloat(user.height)) || parseFloat(user.height) <= 0)) {
			user.height = null;
		}
		if (user.weight && (isNaN(parseFloat(user.weight)) || parseFloat(user.weight) <= 0)) {
			user.weight = null;
		}
		if (user.waist && (isNaN(parseFloat(user.waist)) || parseFloat(user.waist) <= 0)) {
			user.waist = null;
		}
		
		// Save cleaned data
		save({'user.profile': user});
	}
	
	function calculateAgeFromDOB(){
		if (!State.user.dob) return;
		
		// Handle YYYY-MM-DD format
		let birthDate;
		if (State.user.dob.length === 10 && /^\d{4}-\d{2}-\d{2}$/.test(State.user.dob)) {
			// YYYY-MM-DD format
			birthDate = new Date(State.user.dob);
		} else if (State.user.dob.length === 8 && /^\d{8}$/.test(State.user.dob)) {
			// YYYYMMDD format (fallback)
			const year = parseInt(State.user.dob.substring(0, 4));
			const month = parseInt(State.user.dob.substring(4, 6)) - 1; // Month is 0-indexed
			const day = parseInt(State.user.dob.substring(6, 8));
			birthDate = new Date(year, month, day);
		} else {
			// Try to parse as regular date
			birthDate = new Date(State.user.dob);
		}
		
		// Validate the date
		if (isNaN(birthDate.getTime())) {
			State.user.age = null;
			save({'user.profile':State.user});
			return;
		}
		
		const today = new Date();
		// Calculate precise age with decimal precision
		const ageInMilliseconds = today.getTime() - birthDate.getTime();
		const ageInYears = ageInMilliseconds / (365.25 * 24 * 60 * 60 * 1000); // Account for leap years
		const age = parseFloat(ageInYears.toFixed(1));
		
		// Validate age range
		if (age < 18 || age > 100) {
			State.user.age = null;
		} else {
			State.user.age = age;
		}
		
		save({'user.profile':State.user});
		// Re-render the onboarding step to show updated age
		if (document.getElementById('ob-steps')) {
			renderOnboarding();
		}
	}
	function updateBMIAndWTH(){
		const height = parseFloat(State.user.height);
		const weight = parseFloat(State.user.weight);
		const waist = parseFloat(State.user.waist);
		
		const display = document.getElementById('bmi-wth-display');
		const bmiValue = document.getElementById('bmi-value');
		const bmiStatus = document.getElementById('bmi-status');
		const wthValue = document.getElementById('wth-value');
		const wthStatus = document.getElementById('wth-status');
		
		if (!display || !bmiValue || !bmiStatus || !wthValue || !wthStatus) return;
		
		// Calculate BMI - only if we have valid numeric values
		if (height && weight && height > 0 && weight > 0 && !isNaN(height) && !isNaN(weight)) {
			const bmi = weight / Math.pow(height / 100, 2);
			bmiValue.textContent = bmi.toFixed(1);
			
			let bmiStatusText = '';
			let bmiStatusColor = '';
			if (bmi < 18.5) {
				bmiStatusText = 'Underweight';
				bmiStatusColor = '#6b7280'; // Gray for underweight
			} else if (bmi < 25) {
				bmiStatusText = 'Normal weight';
				bmiStatusColor = '#10b981'; // Green for normal/healthy
			} else if (bmi < 30) {
				bmiStatusText = 'Overweight';
				bmiStatusColor = '#f59e0b'; // Amber for overweight
			} else {
				bmiStatusText = 'Obese';
				bmiStatusColor = '#ef4444'; // Red for obese
			}
			bmiStatus.textContent = bmiStatusText;
			bmiStatus.style.color = bmiStatusColor;
		} else {
			bmiValue.textContent = '--';
			bmiStatus.textContent = '';
		}
		
		// Calculate Waist-to-Height Ratio - only if we have valid numeric values
		if (height && waist && height > 0 && waist > 0 && !isNaN(height) && !isNaN(waist)) {
			const wth = waist / height;
			wthValue.textContent = wth.toFixed(2);
			
			let wthStatusText = '';
			let wthStatusColor = '';
			if (wth < 0.4) {
				wthStatusText = 'Low risk';
				wthStatusColor = '#10b981'; // Green for low risk
			} else if (wth < 0.5) {
				wthStatusText = 'Moderate risk';
				wthStatusColor = '#f59e0b'; // Amber for moderate risk
			} else if (wth < 0.6) {
				wthStatusText = 'High risk';
				wthStatusColor = '#ef4444'; // Red for high risk
			} else {
				wthStatusText = 'Very high risk';
				wthStatusColor = '#dc2626'; // Darker red for very high risk
			}
			wthStatus.textContent = wthStatusText;
			wthStatus.style.color = wthStatusColor;
		} else {
			wthValue.textContent = '--';
			wthStatus.textContent = '';
		}
		// Show display only if we have valid calculations
		const hasValidBMI = height && weight && height > 0 && weight > 0 && !isNaN(height) && !isNaN(weight);
		const hasValidWTH = height && waist && height > 0 && waist > 0 && !isNaN(height) && !isNaN(waist);
		
		if (hasValidBMI || hasValidWTH) {
			display.style.display = 'block';
		} else {
			display.style.display = 'none';
		}
	}
	
	function calculateAgeFromDOBInput(){
		// Check if we're in onboarding mode (ob- prefix) or regular mode
		const isOnboarding = document.getElementById('ob-calc-dob');
		const dobInput = isOnboarding ? document.getElementById('ob-calc-dob') : document.getElementById('calc-dob');
		const ageInput = isOnboarding ? document.getElementById('ob-calc-age') : document.getElementById('calc-age');
		
		if (!dobInput.value) return;
		
		const today = new Date();
		const birthDate = new Date(dobInput.value);
		let age = today.getFullYear() - birthDate.getFullYear();
		const monthDiff = today.getMonth() - birthDate.getMonth();
		if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
			age--;
		}
		
		// Update the age input
		if (ageInput) {
			ageInput.value = age;
		}
		
		// Update State.user.age
		State.user.age = age;
		save({'user.profile': State.user});
		
		// Recalculate biological age
		calculateBiologicalAge(true);
	}
	function setOb(k,v){ State.onboarding.answers[k]=isFinite(+v)? +v: v; save({'onboarding.answers':State.onboarding.answers}); }
	function toggleSmoker(){ 
		State.onboarding.answers.smoker = !State.onboarding.answers.smoker; 
		save({'onboarding.answers':State.onboarding.answers}); 
		// Update the visual state of the label
		const checkbox = event.target;
		const label = checkbox.closest('.check-pill');
		if (State.onboarding.answers.smoker) {
			label.classList.add('selected');
		} else {
			label.classList.remove('selected');
		}
	}
	function setPref(k,v){ 
		State.preferences[k]=v; 
		// Also save to onboarding answers for recommendation engine
		if (k === 'budget') {
			State.onboarding.answers.budget = v;
			save({'user.preferences':State.preferences, 'onboarding.answers':State.onboarding.answers});
		} else {
			save({'user.preferences':State.preferences});
		}
		
		// Apply preferences to schedule when they change
		if (k === 'coachCadence' || k === 'budget') {
			applyPreferencesToSchedule();
		}
	}
	
	function applyPreferencesToSchedule() {
		const frequency = State.preferences.coachCadence;
		const budget = State.preferences.budget;
		
		// Initialize schedule if it doesn't exist
		if (!State.schedule) {
			State.schedule = { events: [] };
		}
		
		// Remove existing coach check-in events
		State.schedule.events = State.schedule.events.filter(event => event.type !== 'coach_checkin');
		
		// Add new coach check-in events based on frequency
		if (frequency && frequency !== 'none') {
			const cadenceDays = {
				weekly: 7,
				fortnightly: 14,
				monthly: 28
			}[frequency];
			
			if (cadenceDays) {
				const today = new Date();
				// Add events for the next 12 weeks
				for (let i = 1; i <= 12; i++) {
					const eventDate = new Date(today);
					eventDate.setDate(today.getDate() + (cadenceDays * i));
					
					State.schedule.events.push({
						id: `coach-${Date.now()}-${i}`,
						type: 'coach_checkin',
						title: 'Coach check-in',
						startISO: eventDate.toISOString(),
						cadence: frequency
					});
				}
			}
		} else if (frequency === 'none') {
			// Add monthly self-review task for self-guided users
			const today = new Date();
			for (let i = 1; i <= 3; i++) {
				const eventDate = new Date(today);
				eventDate.setMonth(today.getMonth() + i);
				
				State.schedule.events.push({
					id: `self-review-${Date.now()}-${i}`,
					type: 'self_review',
					title: 'Monthly self-review',
					startISO: eventDate.toISOString(),
					cadence: 'monthly'
				});
			}
		}
		
		// Save updated schedule
		save({'schedule': State.schedule});
	}
	function toggleConsent(){ 
		State.consent.health = document.getElementById('consent-checkbox').checked; 
		// Also set assessment consent to the same value since they're combined
		State.onboarding.answers.assessmentConsent = State.consent.health;
		save({consent:State.consent, 'onboarding.answers':State.onboarding.answers}); 
		// Update the visual state of the label
		const label = document.getElementById('consent-checkbox').closest('.check-pill');
		if (State.consent.health) {
			label.classList.add('selected');
		} else {
			label.classList.remove('selected');
		}
	}

	// =============== DEVICES & BADGES ===============
	const WearableBrands = ['Apple Health','Google Fit','Fitbit','Oura','Garmin'];
	function renderDeviceBadges(){
		const nav = document.getElementById('nav-device-chips');
		const now = new Date();
		nav.innerHTML = (State.devices.connected||[]).map(d=>{
			const last = d.lastSync? new Date(d.lastSync): now;
			const month = last.getMonth() + 1;
			const day = last.getDate();
			const dateStr = `${month}/${day}`;
			const isPrimary = State.devices.primaryId===d.id;
			return `<span class="device-chip ${isPrimary?'primary':''}" title="Connected ${dateStr}">
				<svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="10" fill="${isPrimary?'#1ecfc0':'#e5e7eb'}"/></svg>
				${d.brand} <small class="muted">${dateStr}</small>
			</span>`;
		}).join('');
	}
	function connectWearable(brand){
		// Check if device is already connected
		const alreadyConnected = State.devices.connected.some(d => d.brand === brand);
		if (alreadyConnected) {
			showToast(`${brand} is already connected`);
			return;
		}
		
		const id = brand.toLowerCase().replace(/\s+/g,'-')+'-'+Math.random().toString(36).slice(2,6);
		const device = {id, brand, lastSync: Date.now()};
		State.devices.connected.push(device);
		if(!State.devices.primaryId) State.devices.primaryId = id;
		save({'devices.connected':State.devices.connected,'devices.primaryId':State.devices.primaryId});
		
		// Also add to new wearables system
		const providerMap = { 'Apple Health': 'apple', 'Google Fit': 'google', 'Fitbit': 'fitbit', 'Garmin': 'garmin', 'Oura': 'oura' };
		const provider = providerMap[brand] || brand.toLowerCase();
		addWearableConnection(provider);
		syncWearableData(provider);
		
		generateWearableSeries();
		renderWearablesUI();
		renderDeviceBadges();
		updateNavLocks();
		
		// Re-render onboarding if on wearables step
		if (State.currentView === 'onboarding' && OnboardingSteps[obIndex]?.key === 'wearables') {
			renderOnboarding();
		// Update the data display after a short delay to ensure data is available
		setTimeout(() => {
			updateWearableDataDisplayInOnboarding();
			updateWearablesDataDisplay();
		}, 100);
		}
		
		// Auto-populate lifestyle data from wearable
		if (State.wearables.series.sleep?.length) {
			const avgSleep = State.wearables.series.sleep.slice(-7).reduce((a,b) => a + b, 0) / 7;
			State.onboarding.answers.sleepHours = Math.round(avgSleep * 10) / 10;
		}
		if (State.wearables.series.steps?.length) {
			const avgSteps = State.wearables.series.steps.slice(-7).reduce((a,b) => a + b, 0) / 7;
			// Convert steps to activity minutes (rough estimate: 100 steps = 1 minute of activity)
			State.onboarding.answers.activityMins = Math.round(avgSteps * 7 / 100);
		}
		save({'onboarding.answers':State.onboarding.answers});
		
		logEvent('device_connected',{brand});
		showToast(`${brand} connected - data synced`);
		
		// Grant XP for connecting device
		grantXPForAction('device_connected', 25);
	}
	function manageDevicesModal(){
		const list = State.devices.connected.map(d=>`
			<div class="service-card" style="display:flex; justify-content:space-between; align-items:center">
				<div>
					<strong>${d.brand}</strong>
					<div>
						<label class="check-pill ${State.devices.primaryId===d.id?'selected':''}">
							<input type="checkbox" ${State.devices.primaryId===d.id?'checked':''} onchange="setPrimaryDevice('${d.id}')">
							<span>Primary data source</span>
						</label>
					</div>
				</div>
				<div>
					<button class="btn-ghost btn-small" onclick="disconnectDevice('${d.id}')">Disconnect</button>
				</div>
			</div>
		`).join('');
		return `
			<h3>Manage devices</h3>
			${list || '<p class="muted">No devices connected.</p>'}
			<div style="margin-top:.75rem">
				<button class="btn btn-small" onclick="openModal('request-device')">Request another wearable</button>
				<button class="btn-ghost btn-small" onclick="closeModal()">Done</button>
			</div>
		`;
	}
	function setPrimaryDevice(id){ 
		State.devices.primaryId=id; 
		save({'devices.primaryId':id}); 
		renderDeviceBadges(); 
		// Refresh the manage devices modal if it's open
		const modal = document.querySelector('.modal.active');
		if (modal && modal.querySelector('h3')?.textContent === 'Manage devices') {
			modal.querySelector('.modal-content').innerHTML = manageDevicesModal();
		}
		showToast('Primary source updated'); 
	}
	function disconnectDevice(id){ 
		State.devices.connected = State.devices.connected.filter(d=>d.id!==id); 
		if(State.devices.primaryId===id){ 
			State.devices.primaryId = State.devices.connected[0]?.id||null; 
		} 
		save({'devices.connected':State.devices.connected,'devices.primaryId':State.devices.primaryId}); 
		renderDeviceBadges(); 
		renderWearablesUI(); 
		// Refresh the manage devices modal if it's open
		const modal = document.querySelector('.modal.active');
		if (modal && modal.querySelector('h3')?.textContent === 'Manage devices') {
			modal.querySelector('.modal-content').innerHTML = manageDevicesModal();
		}
		showToast('Device disconnected'); 
	}
	
	function updateWearableDataDisplay(){
		// Update the data display in the onboarding wearables step
		const dataContainer = document.querySelector('#wearable-catalogue + div');
		if (!dataContainer || State.devices.connected.length === 0) return;
		
		// Ensure wearable data is generated
		if (!State.wearables.series.steps || State.wearables.series.steps.length === 0) {
			generateWearableSeries();
		}
		
		// Get the latest data
		const latestSteps = State.wearables.series.steps.slice(-1)[0] || 0;
		const latestSleep = State.wearables.series.sleep.slice(-1)[0] || 0;
		const latestRHR = State.wearables.series.rhr.slice(-1)[0] || 0;
		const latestHRV = State.wearables.series.hrv.slice(-1)[0] || 0;
		
		// Update the data display
		const stepsEl = dataContainer.querySelector('div:nth-child(1) div:first-child');
		const sleepEl = dataContainer.querySelector('div:nth-child(2) div:first-child');
		const rhrEl = dataContainer.querySelector('div:nth-child(3) div:first-child');
		const hrvEl = dataContainer.querySelector('div:nth-child(4) div:first-child');
		
		if (stepsEl) stepsEl.textContent = latestSteps;
		if (sleepEl) sleepEl.textContent = `${latestSleep}h`;
		if (rhrEl) rhrEl.textContent = latestRHR;
		if (hrvEl) hrvEl.textContent = latestHRV;
	}
	
	function updateWearablesDataDisplay() {
		console.log('updateWearablesDataDisplay called');
		
		// Ensure we have wearable data
		if (!State.wearables.series || !State.wearables.series.steps || State.wearables.series.steps.length === 0) {
			console.log('No wearable data available');
			return;
		}
		
		const series = State.wearables.series;
		
		// Calculate averages for past week (last 7 days)
		const weekSteps = series.steps.slice(-7);
		const weekSleep = series.sleep.slice(-7);
		const weekRHR = series.rhr.slice(-7);
		const weekHRV = series.hrv.slice(-7);
		
		const avgSteps = Math.round(weekSteps.reduce((a, b) => a + b, 0) / weekSteps.length);
		const avgSleep = (weekSleep.reduce((a, b) => a + b, 0) / weekSleep.length).toFixed(1);
		const avgRHR = Math.round(weekRHR.reduce((a, b) => a + b, 0) / weekRHR.length);
		const avgHRV = Math.round(weekHRV.reduce((a, b) => a + b, 0) / weekHRV.length);
		
		// Calculate percentage change week on week (if we have 14+ days of data)
		let stepsChange = '--';
		let sleepChange = '--';
		let rhrChange = '--';
		let hrvChange = '--';
		
		if (series.steps.length >= 14) {
			const prevWeekSteps = series.steps.slice(-14, -7);
			const prevWeekSleep = series.sleep.slice(-14, -7);
			const prevWeekRHR = series.rhr.slice(-14, -7);
			const prevWeekHRV = series.hrv.slice(-14, -7);
			
			const prevAvgSteps = prevWeekSteps.reduce((a, b) => a + b, 0) / prevWeekSteps.length;
			const prevAvgSleep = prevWeekSleep.reduce((a, b) => a + b, 0) / prevWeekSleep.length;
			const prevAvgRHR = prevWeekRHR.reduce((a, b) => a + b, 0) / prevWeekRHR.length;
			const prevAvgHRV = prevWeekHRV.reduce((a, b) => a + b, 0) / prevWeekHRV.length;
			
			stepsChange = ((avgSteps - prevAvgSteps) / prevAvgSteps * 100).toFixed(1) + '%';
			sleepChange = ((avgSleep - prevAvgSleep) / prevAvgSleep * 100).toFixed(1) + '%';
			rhrChange = ((avgRHR - prevAvgRHR) / prevAvgRHR * 100).toFixed(1) + '%';
			hrvChange = ((avgHRV - prevAvgHRV) / prevAvgHRV * 100).toFixed(1) + '%';
		}
		
		// Update the display elements
		const stepsEl = document.getElementById('wearables-steps');
		const sleepEl = document.getElementById('wearables-sleep');
		const rhrEl = document.getElementById('wearables-rhr');
		const hrvEl = document.getElementById('wearables-hrv');
		
		if (stepsEl) stepsEl.textContent = `${avgSteps.toLocaleString()} steps`;
		if (sleepEl) sleepEl.textContent = `${avgSleep}h`;
		if (rhrEl) rhrEl.textContent = `${avgRHR} bpm`;
		if (hrvEl) hrvEl.textContent = `${avgHRV} ms`;
		
		// Update the percentage change elements (these should be in the HTML)
		const stepsChangeEl = document.getElementById('wearables-steps-change');
		const sleepChangeEl = document.getElementById('wearables-sleep-change');
		const rhrChangeEl = document.getElementById('wearables-rhr-change');
		const hrvChangeEl = document.getElementById('wearables-hrv-change');
		
		if (stepsChangeEl) stepsChangeEl.textContent = stepsChange;
		if (sleepChangeEl) sleepChangeEl.textContent = sleepChange;
		if (rhrChangeEl) rhrChangeEl.textContent = rhrChange;
		if (hrvChangeEl) hrvChangeEl.textContent = hrvChange;
		
		console.log('Wearable data updated:', {avgSteps, avgSleep, avgRHR, avgHRV, stepsChange, sleepChange, rhrChange, hrvChange});
		
		// Also refresh the charts to show updated data
		if (State.devices.connected.length > 0) {
			drawAllWearableCharts();
		}
	}
	
	function updateWearableDataDisplayInOnboarding(){
		// Update the data display in the onboarding wearables step
		if (State.devices.connected.length === 0) return;
		
		// Ensure wearable data is generated
		if (!State.wearables.series.steps || State.wearables.series.steps.length === 0) {
			generateWearableSeries();
		}
		
		// Get the latest data
		const latestSteps = State.wearables.series.steps.slice(-1)[0] || 0;
		const latestSleep = State.wearables.series.sleep.slice(-1)[0] || 0;
		const latestRHR = State.wearables.series.rhr.slice(-1)[0] || 0;
		const latestHRV = State.wearables.series.hrv.slice(-1)[0] || 0;
		
		// Find the data display container in the onboarding step
		const dataContainer = document.querySelector('[data-view="onboarding"] .card-grid + div');
		if (!dataContainer) return;

		// Also reveal onboarding charts and draw them
		const chartsHost = document.getElementById('ob-wearable-charts');
		if (chartsHost) {
			chartsHost.style.display = 'block';
			// Draw charts using the shared renderer
			drawMetricChart('ob-steps-chart', State.wearables.series.steps, 'steps', '#1ecfc0', {targetMin:8000});
			drawMetricChart('ob-sleep-chart', State.wearables.series.sleep, 'sleep', '#15b5a8', {targetMin:7, targetMax:9});
			drawMetricChart('ob-rhr-chart', State.wearables.series.rhr, 'rhr', '#ef4444', {targetMin:55, targetMax:64});
			drawMetricChart('ob-hrv-chart', State.wearables.series.hrv, 'hrv', '#10b981', {targetMin:60});
		}
		
		// Update onboarding wearables page using IDs
		const obStepsEl = document.getElementById('ob-wearables-steps');
		const obSleepEl = document.getElementById('ob-wearables-sleep');
		const obRhrEl = document.getElementById('ob-wearables-rhr');
		const obHrvEl = document.getElementById('ob-wearables-hrv');
		
		if (obStepsEl) obStepsEl.textContent = latestSteps;
		if (obSleepEl) obSleepEl.textContent = `${latestSleep}h`;
		if (obRhrEl) obRhrEl.textContent = latestRHR;
		if (obHrvEl) obHrvEl.textContent = latestHRV;
	}

	// =============== RECOMMENDATIONS SYSTEM ===============
	
	function getGoalPrimary(){ 
		return (load('onboarding.answers',{}).goals||['general'])[0]; 
	}

	function buildRecInput() {
		const answers = load('onboarding.answers', {});
		const user = State.user || {};
		
		return {
			preferences: {
				budgetPerMonth: answers.budget || ''
			},
			biomarkersUnknown: !answers.hasBloodTests,
			age: user.age || 35,
			goals: answers.goals || ['general'],
			whtr: answers.whtr || 0.45,
			sleep7: answers.sleepHours || 7.5
		};
	}

	// Legacy recommendation functions removed - using new recEngine

	// =============== ASSESSMENT MODAL LIFECYCLE ===============
	
	function renderAssessmentResult(tool, score, band, items) {
		// Get interpretation text for the assessment
		const interpretation = getAssessmentInterpretation(tool, score) || 'Assessment completed successfully.';
		
		return `
			<div class="assessment-result" style="padding:2rem; text-align:center; max-width:480px; margin:0 auto; border-radius:12px; box-shadow:0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);">
				<!-- Header with title and close button -->
				<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem">
					<h3 style="margin:0; font-size:1.1rem; font-weight:700; color:var(--ink-80); text-transform:uppercase; letter-spacing:0.5px">Assessment Complete</h3>
					<button onclick="closeAssessmentModal()" style="
						width: 24px;
						height: 24px;
						border-radius: 50%;
						border: none;
						background: var(--ink-10);
						color: var(--ink-60);
						font-size: 14px;
						font-weight: 600;
						cursor: pointer;
						display: flex;
						align-items: center;
						justify-content: center;
						transition: all 0.2s ease;
					" onmouseover="this.style.background='var(--ink-20)'; this.style.color='var(--ink-80)'" onmouseout="this.style.background='var(--ink-10)'; this.style.color='var(--ink-60)'">✕</button>
				</div>
				
				<!-- Assessment Type -->
				<div style="margin-bottom:1.5rem">
					<div style="font-size:0.9rem; color:var(--ink-70); font-weight:600; text-transform:uppercase; letter-spacing:0.5px">${tool}</div>
				</div>
				
				<!-- Score and Band -->
				<div style="margin-bottom:2rem">
					<div style="display:flex; align-items:center; justify-content:center; gap:1rem; margin-bottom:1rem">
						<div style="text-align:center">
							<div style="font-size:3rem; font-weight:800; color:var(--numan-teal); line-height:1">${score}</div>
						</div>
						<div style="text-align:center">
							<div style="font-size:0.9rem; color:var(--ink-60); text-transform:lowercase">${band || 'N/A'}</div>
						</div>
					</div>
					<div style="font-size:0.85rem; color:var(--ink-60); line-height:1.4; font-style:italic; max-width:320px; margin:0 auto">${interpretation}</div>
				</div>
				
				<!-- Action Buttons -->
				<div style="display:flex; gap:0.75rem; justify-content:center">
					<button onclick="closeAssessmentModal()" style="
						padding: 0.75rem 1.5rem;
						border: 2px solid var(--ink-20);
						border-radius: 8px;
						background: white;
						color: var(--ink-80);
						font-weight: 600;
						cursor: pointer;
						transition: all 0.2s ease;
						font-size: 0.9rem;
					" onmouseover="this.style.borderColor='var(--ink-40)'; this.style.background='var(--ink-05)'" onmouseout="this.style.borderColor='var(--ink-20)'; this.style.background='white'">Close</button>
					<button onclick="repeatAssessment('${tool}'); closeAssessmentModal()" style="
						padding: 0.75rem 1.5rem;
						border: none;
						border-radius: 8px;
						background: var(--numan-teal);
						color: white;
						font-weight: 600;
						cursor: pointer;
						transition: all 0.2s ease;
						font-size: 0.9rem;
					" onmouseover="this.style.background='var(--numan-teal-dark)'" onmouseout="this.style.background='var(--numan-teal)'">Repeat</button>
					<button onclick="closeAssessmentModal()" style="
						padding: 0.75rem 1.5rem;
						border: 2px solid var(--numan-teal);
						border-radius: 8px;
						background: white;
						color: var(--numan-teal);
						font-weight: 600;
						cursor: pointer;
						transition: all 0.2s ease;
						font-size: 0.9rem;
					" onmouseover="this.style.background='var(--numan-teal)'; this.style.color='white'" onmouseout="this.style.background='white'; this.style.color='var(--numan-teal)'">Save & close</button>
				</div>
			</div>
		`;
	}
	
	function finishAssessment(tool, score, band, items){
		// modal result
		const body = document.querySelector('#assessment-modal .modal-body');
		if (body) body.innerHTML = renderAssessmentResult(tool, score, band, items);

		// dashboard CTA swap
		const start = document.getElementById(`assess-${tool}-start`);
		const view  = document.getElementById(`assess-${tool}-view`);
		if (start && view){
			start.hidden = true;
			view.hidden = false;
			const summaryEl = view.querySelector('.assess-summary');
			if (summaryEl) {
				summaryEl.replaceChildren(document.createTextNode(`${score} (${band})`));
			}
		}
		
		// persist lightweight history
		const hist = load('assessments.history', []); 
		// Ensure hist is always an array
		const historyArray = Array.isArray(hist) ? hist : [];
		historyArray.push({tool,score,band,dateISO:new Date().toISOString()}); 
		save('assessments.history', historyArray);
		
		// rebind events if needed
		renderAssessments();
	}

	// =============== NAVIGATION LOCKING ===============
	
	function unlockNav(navType) {
		State.navUnlocked[navType] = true;
		save({'navUnlocked': State.navUnlocked});
		updateNavLocks();
	}

	// =============== EXPLAINER DRAWERS ===============
	// Functions removed - now using modal popup

	// =============== NEW WEARABLES INTEGRATION FUNCTIONS ===============
	
	function addWearableConnection(provider) {
		const map = { apple: 'Apple Health', fitbit: 'Fitbit', garmin: 'Garmin', google: 'Google Fit', oura: 'Oura' };
		const exists = (State.wearables.providers || []).some(p => p.provider === provider);
		if (exists) return;
		const conn = { provider, name: map[provider] || provider, connectedAt: new Date().toISOString() };
		State.wearables.providers = [...(State.wearables.providers || []), conn];
		saveWearables();
		showToast(`${map[provider]} connected`);
	}

	function removeWearableConnection(provider) {
		State.wearables.providers = (State.wearables.providers || []).filter(p => p.provider !== provider);
		saveWearables();
		showToast('Connection removed');
	}

	function syncWearableData(provider) {
		// Mock sync - in real app, call provider APIs
		const now = new Date();
		const today = now.toISOString().split('T')[0];
		const mock = {
			apple: { steps: 8500, sleep: 7.5, rhr: 58, hrv: 42 },
			fitbit: { steps: 9200, sleep: 7.2, rhr: 62, hrv: 38 },
			garmin: { steps: 7800, sleep: 8.1, rhr: 55, hrv: 45 },
			google: { steps: 8800, sleep: 7.8, rhr: 60, hrv: 40 },
			oura: { steps: 0, sleep: 7.6, rhr: 57, hrv: 43 }
		};
		const data = mock[provider] || mock.apple;
		
		// Append to series (keep last 30 days)
		const series = State.wearables.series || { steps: [], sleep: [], rhr: [], hrv: [] };
		series.steps.push(data.steps);
		series.sleep.push(data.sleep);
		series.rhr.push(data.rhr);
		series.hrv.push(data.hrv);
		
		// Trim to 30 days
		const keep = 30;
		series.steps = series.steps.slice(-keep);
		series.sleep = series.sleep.slice(-keep);
		series.rhr = series.rhr.slice(-keep);
		series.hrv = series.hrv.slice(-keep);
		
		State.wearables.series = series;
		saveWearables();
		
		// Update dashboard if on dashboard page
		if (State.currentView === 'dashboard') {
			renderDashboard();
		}
		
		showToast('Data synced');
	}

	function getWearableInsights() {
		const series = State.wearables.series || {};
		const steps = series.steps || [];
		const sleep = series.sleep || [];
		const rhr = series.rhr || [];
		const hrv = series.hrv || [];
		
		if (steps.length === 0) return { status: 'no_data', message: 'Connect a device to see insights' };
		
		// Use last 7 days for consistency with wearables page and biological age calculation
		const weekSteps = steps.slice(-7);
		const weekSleep = sleep.slice(-7);
		const weekRHR = rhr.slice(-7);
		const weekHRV = hrv.slice(-7);
		
		const avgSteps = weekSteps.reduce((a, b) => a + b, 0) / weekSteps.length;
		const avgSleep = weekSleep.reduce((a, b) => a + b, 0) / weekSleep.length; // sleep is already in hours
		const avgRHR = weekRHR.reduce((a, b) => a + b, 0) / weekRHR.length;
		const avgHRV = weekHRV.reduce((a, b) => a + b, 0) / weekHRV.length;
		
		const insights = [];
		if (avgSteps < 8000) insights.push('Consider increasing daily steps to 8,000+');
		if (avgSleep < 7) insights.push('Aim for 7-9 hours of sleep nightly');
		if (avgRHR > 70) insights.push('Resting heart rate could be improved with cardio');
		if (avgHRV < 30) insights.push('HRV suggests room for recovery optimization');
		
		return {
			status: 'active',
			metrics: { avgSteps: Math.round(avgSteps), avgSleep: avgSleep.toFixed(1), avgRHR: Math.round(avgRHR), avgHRV: Math.round(avgHRV) },
			insights: insights.length > 0 ? insights : ['Great job maintaining healthy metrics!']
		};
	}

	function updateStreaks() {
		const series = State.wearables.series || {};
		const steps = series.steps || [];
		const sleep = series.sleep || [];
		const rewards = State.rewards || { streak: { sleepDays: 0, stepsDays: 0 } };
		
		// Simple streak logic: consecutive days meeting targets
		let sleepStreak = 0;
		let stepsStreak = 0;
		
		for (let i = steps.length - 1; i >= 0; i--) {
			if (steps[i] >= 8000) stepsStreak++;
			else break;
		}
		
		for (let i = sleep.length - 1; i >= 0; i--) {
			if (sleep[i] >= 7) sleepStreak++; // 7 hours
			else break;
		}
		
		rewards.streak = { sleepDays: sleepStreak, stepsDays: stepsStreak };
		State.rewards = rewards;
		save({ 'rewards': rewards });
	}

	function getActiveQuests() {
		console.log('getActiveQuests called');
		// Ensure rewards state is properly initialized
		if (!State.rewards || !State.rewards.state) {
			console.log('Initializing rewards state in getActiveQuests');
			State.rewards = { 
				state: { xp: 0, level: 1, streak: {sleepDays:0, stepsDays:0, smokeFreeDays:0}, badgesEarned: [], activeQuests: [], completedQuests: [] }
			};
		}
		
		const series = State.wearables?.series || {};
		const steps = series.steps || [];
		const sleep = series.sleep || [];
		
		// Calculate current progress
		const stepsMet = steps.filter(s => s >= 8000).length;
		const sleepMet = sleep.filter(s => s >= 7).length;
		const dataDays = Math.min(7, steps.length);
		
		const quests = [
			{ 
				id: 'steps_week', 
				title: 'Walk 8,000 steps daily for a week', 
				target: 7, 
				current: Math.min(7, stepsMet), 
				reward: 50 
			},
			{ 
				id: 'sleep_week', 
				title: 'Sleep 7+ hours for a week', 
				target: 7, 
				current: Math.min(7, sleepMet), 
				reward: 50 
			},
			{ 
				id: 'consistency', 
				title: 'Sync data for 7 days', 
				target: 7, 
				current: dataDays, 
				reward: 100 
			}
		];
		
		// Update the rewards state
		State.rewards.state.activeQuests = quests;
		save({ 'rewards': State.rewards });
		return quests;
	}

	function completeQuest(questId) {
		// Ensure rewards state is properly initialized
		if (!State.rewards || !State.rewards.state) {
			State.rewards = { 
				state: { xp: 0, level: 1, streak: {sleepDays:0, stepsDays:0, smokeFreeDays:0}, badgesEarned: [], activeQuests: [], completedQuests: [] }
			};
		}
		
		const quest = State.rewards.state.activeQuests?.find(q => q.id === questId);
		if (!quest || quest.current < quest.target) return false;
		
		// Award XP and update level
		State.rewards.state.xp += quest.reward;
		State.rewards.state.level = Math.floor(State.rewards.state.xp / 200) + 1;
		
		// Move quest to completed
		State.rewards.state.activeQuests = State.rewards.state.activeQuests.filter(q => q.id !== questId);
		if (!State.rewards.state.completedQuests) {
			State.rewards.state.completedQuests = [];
		}
		State.rewards.state.completedQuests.push(questId);
		
		save({ 'rewards': State.rewards });
		showToast(`Quest completed! +${quest.reward} XP`);
		
		// Refresh the streaks page to show updated data
		if (State.currentView === 'streaks') {
			renderStreaksPage();
		}
		
		return true;
	}

	// =============== STREAKS & GOALS ===============
	
	function getStreakStatus() {
		console.log('getStreakStatus called');
		// Ensure rewards state is properly initialized
		if (!State.rewards || !State.rewards.state) {
			console.log('Initializing rewards state in getStreakStatus');
			State.rewards = { 
				state: { xp: 0, level: 1, streak: {sleepDays:0, stepsDays:0, smokeFreeDays:0}, badgesEarned: [], activeQuests: [], completedQuests: [] }
			};
		}
		
		const series = State.wearables?.series || {};
		const steps = series.steps || [];
		const sleep = series.sleep || [];
		console.log('Wearables data:', { steps: steps.length, sleep: sleep.length });
		
		const todaySteps = steps[steps.length - 1] || 0;
		const todaySleep = sleep[sleep.length - 1] || 0;
		
		const stepsTarget = 8000;
		const sleepTarget = 7; // 7 hours
		
		const stepsMet = todaySteps >= stepsTarget;
		const sleepMet = todaySleep >= sleepTarget;
		
		// Calculate streaks based on recent data
		const stepsStreak = calculateStreak(steps, stepsTarget);
		const sleepStreak = calculateStreak(sleep, sleepTarget);
		
		return {
			steps: { current: todaySteps, target: stepsTarget, met: stepsMet, streak: stepsStreak },
			sleep: { current: todaySleep, target: sleepTarget, met: sleepMet, streak: sleepStreak },
			overall: { met: stepsMet && sleepMet, streak: Math.min(stepsStreak, sleepStreak) }
		};
	}
	
	// Helper function to calculate streak from data array
	function calculateStreak(data, target) {
		if (!data || data.length === 0) return 0;
		
		let streak = 0;
		// Count backwards from the most recent data
		for (let i = data.length - 1; i >= 0; i--) {
			if (data[i] >= target) {
				streak++;
			} else {
				break;
			}
		}
		return streak;
	}

	function updateDailyGoals() {
		const series = State.wearables.series || {};
		const steps = series.steps || [];
		const sleep = series.sleep || [];
		const rewards = State.rewards || { streak: { sleepDays: 0, stepsDays: 0 } };
		
		// Update streaks based on recent data
		let stepsStreak = 0;
		let sleepStreak = 0;
		
		// Count consecutive days meeting targets from most recent
		for (let i = steps.length - 1; i >= 0; i--) {
			if (steps[i] >= 8000) stepsStreak++;
			else break;
		}
		
		for (let i = sleep.length - 1; i >= 0; i--) {
			if (sleep[i] >= 7) sleepStreak++;
			else break;
		}
		
		rewards.streak = { sleepDays: sleepStreak, stepsDays: stepsStreak };
		State.rewards = rewards;
		save({ 'rewards': rewards });
		
		return { stepsStreak, sleepStreak };
	}

	function getGoalProgress() {
		const series = State.wearables.series || {};
		const steps = series.steps || [];
		const sleep = series.sleep || [];
		const rhr = series.rhr || [];
		const hrv = series.hrv || [];
		
		const weekSteps = steps.slice(-7);
		const weekSleep = sleep.slice(-7);
		const weekRHR = rhr.slice(-7);
		const weekHRV = hrv.slice(-7);
		
		const goals = {
			steps: { target: 8000, current: weekSteps.length > 0 ? Math.round(weekSteps.reduce((a, b) => a + b, 0) / weekSteps.length) : 0 },
			sleep: { target: 7, current: weekSleep.length > 0 ? Math.round(weekSleep.reduce((a, b) => a + b, 0) / weekSleep.length * 10) / 10 : 0 },
			rhr: { target: 60, current: weekRHR.length > 0 ? Math.round(weekRHR.reduce((a, b) => a + b, 0) / weekRHR.length) : 0 },
			hrv: { target: 40, current: weekHRV.length > 0 ? Math.round(weekHRV.reduce((a, b) => a + b, 0) / weekHRV.length) : 0 }
		};
		
		// Calculate progress percentages
		Object.keys(goals).forEach(key => {
			const goal = goals[key];
			goal.progress = Math.min(100, Math.round((goal.current / goal.target) * 100));
			goal.met = goal.current >= goal.target;
		});
		
		return goals;
	}

	// =============== DASHBOARD INTEGRATION ===============
	
	function renderDashboardWearables() {
		const insights = getWearableInsights();
		const streaks = getStreakStatus();
		const goals = getGoalProgress();
		const quests = getActiveQuests();
		
		return `
			<div class="dashboard-section">
				<h3>Wearables & Health Data</h3>
				<div class="metrics-grid">
					<div class="metric-card">
						<h4>Steps</h4>
						<div class="metric-value">${insights.metrics?.avgSteps || 0}</div>
						<div class="metric-target">Target: 8,000</div>
					</div>
					<div class="metric-card">
						<h4>Sleep</h4>
						<div class="metric-value">${insights.metrics?.avgSleep || 0}h</div>
						<div class="metric-target">Target: 7-9h</div>
					</div>
					<div class="metric-card">
						<h4>Resting HR</h4>
						<div class="metric-value">${insights.metrics?.avgRHR || 0} bpm</div>
						<div class="metric-target">Target: <60</div>
					</div>
					<div class="metric-card">
						<h4>HRV</h4>
						<div class="metric-value">${insights.metrics?.avgHRV || 0} ms</div>
						<div class="metric-target">Target: >40</div>
					</div>
				</div>
				<div class="insights">
					<h4>Insights</h4>
					<ul>
						${insights.insights?.map(insight => `<li>${insight}</li>`).join('') || '<li>Connect a device to see insights</li>'}
					</ul>
				</div>
			</div>
		`;
	}

	
	function renderOnboardingAssessments(){
		const assessments = [
			{id: 'phq2', title: 'Mood Check (PHQ-2)', description: 'Quick screening for depression symptoms', questions: '2 questions • 1 minute'},
			{id: 'gad2', title: 'Anxiety Check (GAD-2)', description: 'Quick screening for anxiety symptoms', questions: '2 questions • 1 minute'},
			{id: 'auditc', title: 'Alcohol Use (AUDIT-C)', description: 'Brief alcohol consumption screening', questions: '3 questions • 1 minute'},
			{id: 'who5', title: 'Well-being (WHO-5)', description: 'General well-being and life satisfaction', questions: '5 questions • 2 minutes'},
			{id: 'isi', title: 'Sleep Assessment (ISI)', description: 'Insomnia severity screening', questions: '7 questions • 2 minutes'}
		];
		
		return assessments.map(assessment => {
			const completed = State.assessments?.find(a => a.type === assessment.id && a.completed);
			const score = completed?.score;
			const band = completed?.band;
			const latest = State.assessments?.filter(a => a.type === assessment.id && a.completed).sort((a, b) => new Date(b.date) - new Date(a.date))[0];
			
			return `
				<div class="assessment-item" data-assessment="${assessment.id}">
					<div class="assessment-header">
						<h4>${assessment.title}</h4>
						<small class="muted">${assessment.questions}</small>
					</div>
					<p class="muted">${assessment.description}</p>
					${completed ? `
						<div style="margin-top:0.5rem">
							<button class="btn btn-small" onclick="toggleAssessmentDropdown('${assessment.id}')" aria-expanded="false" aria-controls="assessment-dropdown-${assessment.id}">
								View result ▾
							</button>
							<div id="assessment-dropdown-${assessment.id}" style="display:none; margin-top:0.5rem; padding:0.75rem; background:var(--canvas); border-radius:6px; border:1px solid var(--border)">
								<div style="margin-bottom:0.5rem">
									<div style="color:var(--numan-teal); font-weight:600">Score: ${latest.score} (${latest.band})</div>
									<div style="color:var(--ink-60); font-size:0.8rem">Completed: ${new Date(latest.date).toLocaleDateString()}</div>
									<div style="color:var(--ink-60); font-size:0.8rem; font-style:italic; margin-top:0.25rem">${latest.interpretation}</div>
								</div>
								<div style="display:flex; gap:0.5rem">
									<button class="btn-ghost btn-small" onclick="viewAssessmentHistory('${assessment.id}')">View history</button>
									<button class="btn-ghost btn-small" onclick="repeatAssessment('${assessment.id}')">Repeat</button>
								</div>
							</div>
						</div>
					` : `
						<button class="btn btn-small" onclick="startAssessment('${assessment.id}')">Start assessment</button>
					`}
				</div>
			`;
		}).join('');
	}
	
	function skipWearables() {
		State.onboarding.wearablesSkipped = true;
		save({'onboarding.answers':State.onboarding.answers});
		showToast('Wearables skipped. You can connect devices later from your dashboard.');
		// Continue to next onboarding step or dashboard
		if (State.onboarding.currentStep < OnboardingSteps.length - 1) {
			obNext();
		} else {
			Router.go('dashboard');
		}
	}
	
	function populateLifestyleFromWearables() {
		// Auto-populate lifestyle data from wearable if available
		if (State.wearables.series.sleep?.length) {
			const avgSleep = State.wearables.series.sleep.slice(-7).reduce((a,b) => a + b, 0) / 7;
			State.onboarding.answers.sleepHours = Math.round(avgSleep * 10) / 10;
		}
		if (State.wearables.series.steps?.length) {
			const avgSteps = State.wearables.series.steps.slice(-7).reduce((a,b) => a + b, 0) / 7;
			// Convert steps to activity minutes (rough estimate: 100 steps = 1 minute of activity)
			State.onboarding.answers.activityMins = Math.round(avgSteps * 7 / 100);
		}
		save({'onboarding.answers':State.onboarding.answers});
		
		// Update the input fields if they exist
		const activityInput = document.querySelector('input[oninput*="activityMins"]');
		const sleepInput = document.querySelector('input[oninput*="sleepHours"]');
		
		if (activityInput && State.onboarding.answers.activityMins) {
			activityInput.value = State.onboarding.answers.activityMins;
		}
		if (sleepInput && State.onboarding.answers.sleepHours) {
			sleepInput.value = State.onboarding.answers.sleepHours;
		}
	}
	
	function renderWearablesUI(){
		const cat = document.getElementById('wearable-catalogue');
		if (!cat) return; // Exit if not on wearables page
		
		cat.innerHTML = WearableBrands.map(b=>{
			const isConnected = State.devices.connected.some(d => d.brand === b);
			const isPrimary = State.devices.primaryId && State.devices.connected.find(d => d.id === State.devices.primaryId)?.brand === b;
			return `
				<div class="service-card ${isConnected ? 'connected' : ''} ${isPrimary ? 'primary' : ''}" role="button" tabindex="0" onclick="connectWearable('${b}')" onkeydown="if(event.key==='Enter'){connectWearable('${b}')}" aria-label="Connect ${b}">
					<h4>${b} ${isConnected ? '✓' : ''}</h4>
					<p class="muted">${isConnected ? 'Connected - Sync steps, sleep, heart rate and more' : 'Sync steps, sleep, heart rate and more'}</p>
					${isPrimary ? '<small style="color:var(--numan-teal); font-weight:600">Primary device</small>' : ''}
				</div>
			`;
		}).join('');
		
		// Add data synced section if devices are connected
		if (State.devices.connected.length > 0) {
			// Check if data section already exists
			let existingGrid = document.getElementById('wearables-data-display');
			let dataSection = existingGrid?.parentElement;
			
			// If no data section exists, create it
			if (!dataSection) {
				dataSection = document.createElement('div');
			dataSection.style.cssText = 'margin-top:1.5rem; padding:1rem; background:var(--canvas); border-radius:8px; border-left:4px solid var(--numan-teal)';
			dataSection.innerHTML = `
				<h4 style="margin:0 0 0.5rem 0; color:var(--numan-teal)">✓ Data Synced</h4>
				<p style="margin:0; color:var(--ink-60); font-size:0.9rem">Your health data has been automatically imported and will be used to calculate your biological age.</p>
				<div id="wearables-data-display" style="margin-top:0.75rem; display:grid; grid-template-columns:repeat(auto-fit, minmax(140px, 1fr)); gap:0.75rem; font-size:0.85rem">
					<div style="text-align:center; padding:0.5rem; background:white; border-radius:6px">
						<div id="wearables-steps" style="font-weight:600; color:var(--numan-teal)">0</div>
						<div style="color:var(--ink-60)">Steps (avg/week)</div>
						<div id="wearables-steps-change" style="font-size:0.75rem; color:var(--ink-40); margin-top:0.25rem">--</div>
					</div>
					<div style="text-align:center; padding:0.5rem; background:white; border-radius:6px">
						<div id="wearables-sleep" style="font-weight:600; color:var(--numan-teal)">0h</div>
						<div style="color:var(--ink-60)">Sleep (avg/week)</div>
						<div id="wearables-sleep-change" style="font-size:0.75rem; color:var(--ink-40); margin-top:0.25rem">--</div>
					</div>
					<div style="text-align:center; padding:0.5rem; background:white; border-radius:6px">
						<div id="wearables-rhr" style="font-weight:600; color:var(--numan-teal)">0</div>
						<div style="color:var(--ink-60)">Resting HR (avg/week)</div>
						<div id="wearables-rhr-change" style="font-size:0.75rem; color:var(--ink-40); margin-top:0.25rem">--</div>
					</div>
					<div style="text-align:center; padding:0.5rem; background:white; border-radius:6px">
						<div id="wearables-hrv" style="font-weight:600; color:var(--numan-teal)">0</div>
						<div style="color:var(--ink-60)">HRV (avg/week)</div>
						<div id="wearables-hrv-change" style="font-size:0.75rem; color:var(--ink-40); margin-top:0.25rem">--</div>
					</div>
				</div>
			`;
				// Insert immediately after the catalogue
				cat.insertAdjacentElement('afterend', dataSection);
			}
			
			// Ensure data section is visible
			if (dataSection) {
				dataSection.style.display = 'block';
			}
			
			// Ensure we have wearable data, generate if needed
			if (!State.wearables.series || State.wearables.series.steps.length === 0) {
				generateWearableSeries();
			}
			
			// Always update the data display when devices are connected
			setTimeout(updateWearablesDataDisplay, 0);
		} else {
			// Hide data section if no devices connected
			const existingDataGrid = document.getElementById('wearables-data-display');
			if (existingDataGrid) {
				const dataSection = existingDataGrid.parentElement;
				if (dataSection) {
					dataSection.style.display = 'none';
				}
			}
		}
		// Show charts when any device is connected
		const chartsEl = document.getElementById('ob-wearable-charts');
		if (chartsEl) {
			const hasConnectedDevices = State.devices.connected.length > 0;
			chartsEl.style.display = hasConnectedDevices ? 'block' : 'none';
			
			if (hasConnectedDevices) {
				// Generate data if needed
				if (State.wearables.series.steps.length === 0) {
					generateWearableSeries();
				}
				// Draw the charts
				drawAllWearableCharts();
			}
		}
	}

	// =============== WEARABLE SERIES & CHARTS ===============
	function generateWearableSeries(){
		const series = {steps:[], sleep:[], rhr:[], hrv:[], weight:[]};
		let baseRHR = 65 + Math.random()*8;
		let baseHRV = 45 + Math.random()*15;
		let baseWeight = State.user.weight||80;
		for(let i=0;i<28;i++){
			const dow = i%7;
			const wknd = (dow===5||dow===6)? 1.15:1;
			const steps = Math.floor((Math.random()*4000+5000)*wknd);
			series.steps.push(steps);
			const sleepBase = 7 + Math.sin(i*2*Math.PI/7)*0.45;
			const sleep = clamp(sleepBase + (Math.random()-.5), 5.5, 8.5);
			series.sleep.push(+sleep.toFixed(2));
			const stepEff = (steps-7000)*-0.004;
			const sleepEff = (sleep-7)*-0.35;
			const rhr = clamp(baseRHR + stepEff + sleepEff + (Math.random()*2-1), 55, 85);
			series.rhr.push(Math.round(rhr));
			const hrv = clamp(baseHRV + (65 - rhr)*1.3 + (Math.random()*8-4), 15, 80);
			series.hrv.push(Math.round(hrv));
			if(State.plan.selectedIds?.includes('weight-management')) baseWeight -= 0.02;
			series.weight.push(+ (baseWeight + (Math.random()*.3-.15)).toFixed(2));
		}
		State.wearables.series = series; State.wearables.lastSync = Date.now();
		save({'wearables.series':series,'wearables.lastSync':State.wearables.lastSync});
		renderDeviceBadges();
		
		// Update dashboard if on dashboard page
		if (State.currentView === 'dashboard') {
			renderDashboard();
		}
	}
	function drawAllWearableCharts(){
		drawMetricChart('ob-steps-chart', State.wearables.series.steps, 'steps', '#1ecfc0', {targetMin:8000});
		drawMetricChart('ob-sleep-chart', State.wearables.series.sleep, 'sleep', '#15b5a8', {targetMin:7, targetMax:9});
		drawMetricChart('ob-rhr-chart', State.wearables.series.rhr, 'rhr', '#ef4444', {targetMin:55, targetMax:64});
		drawMetricChart('ob-hrv-chart', State.wearables.series.hrv, 'hrv', '#10b981', {targetMin:60});
		updateMetricStats();
	}
	function drawMetricChart(id, data, metricKey, color, targets={}){
		const c = document.getElementById(id); 
		if(!c) return; 
		const ctx=c.getContext('2d');
		const W=c.width,H=c.height,p=60; 
		ctx.clearRect(0,0,W,H);
		
		const min = Math.min(...data), max = Math.max(...data);
		const pad = (max-min)*.1 || 1; 
		const lo = min-pad, hi=max+pad; 
		const R=hi-lo;
		
		// Define units for each metric
		const units = {
			steps: '',
			sleep: 'hrs',
			rhr: 'bpm',
			hrv: ''
		};
		
		// grid
		ctx.strokeStyle='#e5e7eb'; ctx.lineWidth=1;
		for(let i=0;i<=4;i++){ 
			const y=p+(H-2*p)/4*i; 
			ctx.beginPath(); 
			ctx.moveTo(p,y); 
			ctx.lineTo(W-p,y); 
			ctx.stroke(); 
		}
		for(let i=0;i<=4;i++){ 
			const x=p+(W-2*p)/4*i; 
			ctx.beginPath(); 
			ctx.moveTo(x,p); 
			ctx.lineTo(x,H-p); 
			ctx.stroke(); 
		}
		
		// Y-axis labels with units
		ctx.fillStyle='#6b7280'; 
		ctx.font='11px sans-serif'; 
		ctx.textAlign='right';
		for(let i=0;i<=4;i++){
			const value = hi - (R/4)*i;
			const y = p + (H-2*p)/4*i;
			const label = metricKey === 'steps' ? Math.round(value).toLocaleString() : value.toFixed(1);
			ctx.fillText(label + units[metricKey], p-12, y+3);
		}
		
		// X-axis labels with dates
		ctx.textAlign='center';
		const today = new Date();
		for(let i=0;i<=4;i++){
			const dayOffset = Math.floor((data.length-1)/4)*i;
			const date = new Date(today);
			date.setDate(date.getDate() - (data.length-1) + dayOffset);
			const x = p + (W-2*p)/4*i;
			const dateStr = (date.getMonth()+1) + '/' + date.getDate();
			ctx.fillText(dateStr, x, H-p+16);
		}
		
		// target band
		if(targets.targetMin!=null || targets.targetMax!=null){
			const yMin = targets.targetMax!=null ? H-p - ((targets.targetMax-lo)/R)*(H-2*p) : p;
			const yMax = targets.targetMin!=null ? H-p - ((targets.targetMin-lo)/R)*(H-2*p) : H-p;
			ctx.fillStyle='rgba(30,207,192,.12)'; 
			ctx.fillRect(p, yMin, W-2*p, yMax-yMin);
		}
		
		// series
		ctx.strokeStyle=color; 
		ctx.lineWidth=2; 
		ctx.beginPath();
		data.forEach((v,i)=>{
			const x=p + (i/(data.length-1))*(W-2*p);
			const y=H-p - ((v-lo)/R)*(H-2*p);
			if(i===0) ctx.moveTo(x,y); 
			else ctx.lineTo(x,y);
		}); 
		ctx.stroke();
		
		// 7-day moving avg dashed
		const ma = []; 
		for(let i=0;i<data.length;i++){ 
			const s=Math.max(0,i-6); 
			const arr=data.slice(s,i+1); 
			ma.push(arr.reduce((a,b)=>a+b,0)/arr.length); 
		}
		ctx.strokeStyle='rgba(0,0,0,.35)'; 
		ctx.setLineDash([5,4]); 
		ctx.beginPath();
		ma.forEach((v,i)=>{ 
			const x=p+(i/(ma.length-1))*(W-2*p); 
			const y=H-p-((v-lo)/R)*(H-2*p); 
			if(i===0) ctx.moveTo(x,y); 
			else ctx.lineTo(x,y); 
		});
		ctx.stroke(); 
		ctx.setLineDash([]);
	}
	function updateMetricStats(){
		const keys=['steps','sleep','rhr','hrv'];
		const units = {
			steps: '',
			sleep: 'hrs',
			rhr: 'bpm',
			hrv: ''
		};
		keys.forEach(k=>{
			const arr = State.wearables.series[k]; 
			if(!arr?.length) return;
			const r7 = arr.slice(-7), p7=arr.slice(-14,-7);
			const ravg = r7.reduce((a,b)=>a+b,0)/r7.length;
			const pavg = p7.reduce((a,b)=>a+b,0)/Math.max(1,p7.length);
			const ch = p7.length? ((ravg-pavg)/pavg*100): 0;
			
			// Update average display
			const avgEl = document.getElementById(`${k}-avg`);
			const chEl = document.getElementById(`${k}-change`);
			const obAvgEl = document.getElementById(`ob-${k}-avg`);
			const obChEl = document.getElementById(`ob-${k}-change`);
			
			if(avgEl) {
				const value = k==='steps'? Math.round(ravg).toLocaleString(): ravg.toFixed(1);
				avgEl.textContent = value + units[k];
			}
			if(obAvgEl) {
				const value = k==='steps'? Math.round(ravg).toLocaleString(): ravg.toFixed(1);
				obAvgEl.textContent = value + units[k];
			}
			
			if(chEl){ 
				const up = (k==='rhr')? ch<0: ch>0; 
				chEl.innerHTML = `<span style="color:${up?'#10b981':'#ef4444'}">${up?'↑':'↓'} ${Math.abs(ch).toFixed(1)}%</span> vs prev week`; 
			}
			if(obChEl){ 
				const up = (k==='rhr')? ch<0: ch>0; 
				obChEl.innerHTML = `<span style="color:${up?'#10b981':'#ef4444'}">${up?'↑':'↓'} ${Math.abs(ch).toFixed(1)}%</span> vs prev week`; 
			}
			
			const impactEl = document.getElementById(`${k}-impact`);
			if(impactEl){
				let impact=0;
				if(k==='steps') impact = ravg>=8000? -2: ravg>=5000? -1: 0;
				if(k==='sleep') impact = (ravg>=7&&ravg<=9)? 0: ravg<6? 2: 1;
				if(k==='rhr') impact = ravg<=64? -1: ravg>=75? 3: 1;
				if(k==='hrv') impact = ravg>=60? -2: ravg>=40? -1: 1;
				impactEl.textContent = `Impact: ${impact>0?'+':''}${impact}y`;
				impactEl.style.background = impact<=0? '#10b981':'#ef4444'; 
				impactEl.style.color='#fff';
			}
		});
	}

	// =============== METABOLIC AGE ===============
	
	// Stub function to prevent errors from removed chart functions
	function drawAgeHistoryChart() { /* Function removed - charts no longer used */ }
	function drawOnboardingAgeChart() { /* Function removed - charts no longer used */ }
	
	function loadMetabolicAgeData(){
		console.log('loadMetabolicAgeData called');
		// Check if we're on the biological age page
		const ageInput = document.getElementById('calc-age');
		if (!ageInput) {
			console.log('Not on biological age page, exiting');
			return; // Exit if not on the biological age page
		}
		
		ageInput.value = State.user.age||'';
		const dobInput = document.getElementById('calc-dob');
		if (dobInput) dobInput.value = State.user.dob||'';
		
		const heightInput = document.getElementById('calc-height');
		if (heightInput) heightInput.value = State.user.height||'';
		
		const weightInput = document.getElementById('calc-weight');
		if (weightInput) weightInput.value = State.user.weight||'';
		
		const waistInput = document.getElementById('calc-waist');
		if (waistInput) waistInput.value = State.user.waist||'';
		
		// Initialize peer comparison toggle
		const peerToggle = document.getElementById('peer-compare');
		if (peerToggle) {
			peerToggle.checked = State.settings?.peerComparison || false;
			// Show/hide comparison based on current state
			const comparison = document.getElementById('peer-comparison');
			if (comparison) {
				comparison.style.display = peerToggle.checked ? 'block' : 'none';
				if (peerToggle.checked) {
					renderPeerComparison();
				}
			}
		}

		// Initialize bio inputs toggle
		const bioInputsToggle = document.getElementById('bio-inputs-toggle');
		if (bioInputsToggle) {
			bioInputsToggle.checked = State.settings?.bioInputsOpen || false;
			// Show/hide content based on current state
			const content = document.getElementById('bio-inputs-content');
			if (content) {
				content.style.display = bioInputsToggle.checked ? 'block' : 'none';
			}
		}
		
		// Prioritize wearable data over self-reported data
		if(State.wearables.series.sleep?.length){
			const avgSleep = State.wearables.series.sleep.slice(-7).reduce((a,b)=>a+b,0)/7;
			const sleepInput = document.getElementById('calc-sleep');
			if (sleepInput) sleepInput.value = Math.round(avgSleep * 10) / 10;
		} else {
			const sleepInput = document.getElementById('calc-sleep');
			if (sleepInput) sleepInput.value = State.onboarding.answers.sleepHours||'';
		}
		
		if(State.wearables.series.steps?.length){
			const avgSteps = Math.round(State.wearables.series.steps.slice(-7).reduce((a,b)=>a+b,0)/7);
			const stepsInput = document.getElementById('calc-steps');
			if (stepsInput) stepsInput.value = avgSteps;
			
			// Convert steps to activity minutes for activity field
			const activityInput = document.getElementById('calc-activity');
			if (activityInput) activityInput.value = Math.round(avgSteps * 7 / 100);
		} else {
			const activityInput = document.getElementById('calc-activity');
			if (activityInput) activityInput.value = State.onboarding.answers.activityMins||'';
		}
		
		if(State.wearables.series.rhr?.length){
			const avgRhr = Math.round(State.wearables.series.rhr.slice(-7).reduce((a,b)=>a+b,0)/7);
			const rhrInput = document.getElementById('calc-rhr');
			if (rhrInput) rhrInput.value = avgRhr;
		}
		
		console.log('About to call calculateBiologicalAge');
		calculateBiologicalAge();
		console.log('calculateBiologicalAge called');
		if(State.ageHistory.length===0){ generateAgeHistory(); }
	}
	
	// Function to refresh wearables data on biological age page
	function refreshBiologicalAgeData(){
    // Do not regenerate wearables when navigating; just use stored series
    // Reload the data from State to keep page consistent
		loadMetabolicAgeData();
		
		// Only recalculate biological age if it hasn't been set yet (first time)
		// or if onboarding is not completed (still in progress)
		if (!State.biologicalAge || !State.onboarding.completed) {
			console.log('Recalculating biological age - first time or onboarding not complete');
			calculateBiologicalAge();
		} else {
			console.log('Using existing biological age from onboarding:', State.biologicalAge);
			// Just update the display with the existing biological age
			updateBiologicalAgeDisplay();
		}
	}
	
	// Function to update biological age display without recalculating
	function updateBiologicalAgeDisplay() {
		if (!State.biologicalAge) return;
		
		const bio = State.biologicalAge;
		const age = State.user.age || 35;
		const ageDiff = bio - age;
		
		// Update the gauge display
		renderBiologicalAgeGauge(age, bio, 'bio-age-gauge-container');
		
		// Update age difference display
		const ageDiffEl = document.getElementById('age-difference');
		if (ageDiffEl) {
			const sign = ageDiff >= 0 ? '+' : '';
			ageDiffEl.textContent = `${sign}${ageDiff.toFixed(1)} vs your age`;
			
			// Set color based on delta range
			if (ageDiff <= -2) {
				ageDiffEl.style.color = '#10b981'; // Green
			} else if (ageDiff >= 2) {
				ageDiffEl.style.color = '#ef4444'; // Red
			} else {
				ageDiffEl.style.color = '#fbbf24'; // Amber/Yellow
			}
		}
		
		// Update driver chips display
		renderDriverChips('drivers-list');
		
		// Update UI based on subscription status
		updateBiologicalAgePageForSubscription();
	}
	
	// Function to update biological age page UI based on subscription status
	function updateBiologicalAgePageForSubscription() {
		const hasActiveSubscription = State.subscription?.active && State.subscription?.status === 'active';
		
		// Hide "View your plan" button if user has active subscription
		const viewPlanSection = document.getElementById('view-plan-section');
		if (viewPlanSection) {
			viewPlanSection.style.display = hasActiveSubscription ? 'none' : 'block';
		}
		
		// Remove any educational text that might be present
		const educationalTexts = document.querySelectorAll('[data-educational-text]');
		educationalTexts.forEach(el => {
			if (hasActiveSubscription) {
				el.style.display = 'none';
			} else {
				el.style.display = 'block';
			}
		});
		
		// Also check for any text containing "Educational estimate only" or similar
		const allElements = document.querySelectorAll('*');
		allElements.forEach(el => {
			if (el.textContent && (
				el.textContent.includes('Educational estimate only') ||
				el.textContent.includes('not a medical device') ||
				el.textContent.includes('educational service')
			)) {
				// Only hide if it's not in a form or consent section
				const isInForm = el.closest('form') || el.closest('[data-view="checkout"]');
				if (!isInForm && hasActiveSubscription) {
					el.style.display = 'none';
				}
			}
		});
	}
	
	// Function to ensure wearables data is always available
	function ensureWearablesData(){
    // Only ensure data exists once; do not regenerate on every visit
		if (State.devices.connected.length > 0 && (!State.wearables.series.steps?.length || !State.wearables.series.rhr?.length)) {
			generateWearableSeries();
        saveWearables();
		}
	}
	
	function renderOnboardingBiologicalAge(){
		// Load wearables data into onboarding biological age fields
		if(State.wearables.series.steps?.length){
			const avgSteps = Math.round(State.wearables.series.steps.slice(-7).reduce((a,b)=>a+b,0)/7);
			const stepsField = document.getElementById('ob-calc-steps');
			if (stepsField) stepsField.value = avgSteps;
			// Convert steps to activity minutes for activity field
			const activityField = document.getElementById('ob-calc-activity');
			if (activityField) activityField.value = Math.round(avgSteps * 7 / 100);
		}
		
		if(State.wearables.series.rhr?.length){
			const avgRhr = Math.round(State.wearables.series.rhr.slice(-7).reduce((a,b)=>a+b,0)/7);
			const rhrField = document.getElementById('ob-calc-rhr');
			if (rhrField) rhrField.value = avgRhr;
		}
		
		if(State.wearables.series.sleep?.length){
			const avgSleep = State.wearables.series.sleep.slice(-7).reduce((a,b)=>a+b,0)/7;
			const sleepField = document.getElementById('ob-calc-sleep');
			if (sleepField) sleepField.value = Math.round(avgSleep * 10) / 10;
		}
		
		if (!State.biologicalAge) return;
		
		const bio = State.biologicalAge;
		const age = State.user.age || 35;
		
		// Update age display
		const ageDisplay = document.getElementById('ob-age-display');
		const ageDiff = document.getElementById('ob-age-diff');
		const statusChip = document.getElementById('ob-status-chip');
		
		if (ageDisplay) ageDisplay.textContent = bio;
		if (ageDiff) {
			const diff = bio - age;
			if (diff > 0) {
				ageDiff.textContent = `${diff.toFixed(1)} years older`;
				ageDiff.style.color = '#ef4444';
			} else if (diff < 0) {
				ageDiff.textContent = `${Math.abs(diff).toFixed(1)} years younger`;
				ageDiff.style.color = '#10b981';
			} else {
				ageDiff.textContent = 'Same age';
				ageDiff.style.color = '#6b7280';
			}
		}
		
		// Update status chip
		if (statusChip) {
			const diff = bio - age;
			if (diff > 0) {
				statusChip.textContent = 'Above average';
				statusChip.style.background = '#ef4444';
			} else if (diff < 0) {
				statusChip.textContent = 'Below average';
				statusChip.style.background = '#10b981';
			} else {
				statusChip.textContent = 'Average';
				statusChip.style.background = '#6b7280';
			}
		}
		
		// Render working gauge on onboarding
		renderBiologicalAgeGauge(age, bio, 'ob-bio-age-gauge-container');
		
		// Calculate and display drivers
		const weight = State.user.weight || 80;
		const waist = State.user.waist || 90;
		const sleep = State.onboarding.answers.sleepHours || 7;
		const activity = State.onboarding.answers.activityMins || 150;
		const alcohol = State.onboarding.answers.alcoholUnits || 0;
		const smoker = State.onboarding.answers.smoker ? 1 : 0;
		
		const drivers = [
			{name: 'Weight', value: (weight > 80) ? 2 : 0},
			{name: 'Waist', value: (waist > 90) ? 3 : 0},
			{name: 'Sleep', value: (sleep < 7) ? 2 : (sleep > 8) ? 1 : 0},
			{name: 'Activity', value: (activity < 150) ? 3 : (activity > 300) ? -1 : 0},
			{name: 'Alcohol', value: (alcohol > 14) ? 2 : 0},
			{name: 'Smoking', value: smoker * 5}
		].filter(d => d.value !== 0);
		
		// Render driver chips instead of old drivers list
		renderDriverChips('ob-drivers-list');
		
		
		// Initialize peer comparison toggle
		const peerToggle = document.getElementById('ob-peer-compare');
		if (peerToggle) {
			peerToggle.checked = State.settings?.peerComparison || false;
			// Show/hide comparison based on current state
			const comparison = document.getElementById('ob-peer-comparison');
			if (comparison) {
				comparison.style.display = peerToggle.checked ? 'block' : 'none';
				if (peerToggle.checked) {
					renderOnboardingPeerComparison();
				}
			}
		}

		// Initialize onboarding bio inputs toggle
		const obBioInputsToggle = document.getElementById('ob-bio-inputs-toggle');
		if (obBioInputsToggle) {
			obBioInputsToggle.checked = State.settings?.bioInputsOpen || false;
			// Show/hide content based on current state
			const content = document.getElementById('ob-bio-inputs-content');
			if (content) {
				content.style.display = obBioInputsToggle.checked ? 'block' : 'none';
			}
		}
	}
	
	function toggleOnboardingPeerComparison(){
		const toggle = document.getElementById('ob-peer-compare');
		const comparison = document.getElementById('ob-peer-comparison');
		if (!toggle || !comparison) return;
		
		// Update the global settings state
		State.settings.peerComparison = toggle.checked;
		save({'settings.peerComparison': State.settings.peerComparison});
		
		if (toggle.checked) {
			comparison.style.display = 'block';
			renderOnboardingPeerComparison();
		} else {
			comparison.style.display = 'none';
		}
	}
	function renderOnboardingPeerComparison(){
		const bars = document.getElementById('ob-peer-bars');
		if (!bars) return;
		
		// Mock peer comparison data
		const percentiles = [
			{label: 'Sleep Quality', value: 75, color: '#10b981'},
			{label: 'Activity Level', value: 60, color: '#fbbf24'},
			{label: 'Stress Management', value: 45, color: '#ef4444'},
			{label: 'Nutrition', value: 80, color: '#10b981'},
			{label: 'Overall Health', value: 65, color: '#fbbf24'}
		];
		
		bars.innerHTML = percentiles.map(p => `
			<div style="display:flex; align-items:center; margin-bottom:0.5rem">
				<div style="min-width:120px; font-size:0.9rem">${p.label}</div>
				<div style="flex:1; height:20px; background:#e5e7eb; border-radius:10px; margin:0 0.5rem; position:relative">
					<div style="width:${p.value}%; height:100%; background:${p.color}; border-radius:10px; transition:width 0.3s"></div>
				</div>
				<div style="min-width:40px; text-align:right; font-weight:600; color:${p.color}">${p.value}%</div>
			</div>
		`).join('');
	}
	
	function computeDrivers(age, height, weight, waist, steps, sleep, rhr, activity){
		let delta=0; const drivers=[];
		const bmi = weight/Math.pow(height/100,2);
		if(bmi>=25 && bmi<30){ delta+=2; drivers.push({name:'BMI',value:2}); }
		else if(bmi>=30){ delta+=5; drivers.push({name:'BMI',value:5}); }
		else if(bmi<18.5){ delta+=1; drivers.push({name:'BMI',value:1}); }
		if(waist && height){
			const whtr = waist/height;
			if(whtr>=0.5 && whtr<0.6){ delta+=2; drivers.push({name:'Waist-to-Height',value:2}); }
			else if(whtr>=0.6){ delta+=5; drivers.push({name:'Waist-to-Height',value:5}); }
		}
		if(rhr){
			if(rhr<=54){ delta-=3; drivers.push({name:'Low RHR',value:-3}); }
			else if(rhr<=64){ delta-=1; drivers.push({name:'Good RHR',value:-1}); }
			else if(rhr<=74){ delta+=1; drivers.push({name:'Heart Rate',value:1}); }
			else if(rhr<=84){ delta+=3; drivers.push({name:'High RHR',value:3}); }
			else { delta+=5; drivers.push({name:'Very High RHR',value:5}); }
		}
		// Prefer weekly activity minutes over steps-based drivers when activity is available
		const hasWeeklyActivity = activity != null;
		if(steps && !hasWeeklyActivity){
			if(steps>=8000){ delta-=2; drivers.push({name:'Active',value:-2}); }
			else if(steps>=5000){ delta-=1; drivers.push({name:'Moderate Activity',value:-1}); }
			else if(steps<3000){ delta+=2; drivers.push({name:'Low Steps',value:2}); }
		}
		if(sleep){
			if(sleep<5){ delta+=4; drivers.push({name:'Very Poor Sleep',value:4}); }
			else if(sleep<6){ delta+=2; drivers.push({name:'Poor Sleep',value:2}); }
			else if(sleep<7){ delta+=1; drivers.push({name:'Sleep',value:1}); }
			else if(sleep>9){ delta+=1; drivers.push({name:'Oversleep',value:1}); }
		}
		if(activity!=null){
			// Use same thresholds as DRIVER_RULES for consistency
			if(activity<1){ delta+=2; drivers.push({name:'No Activity',value:2}); }
			else if(activity<60){ /* no change - low activity */ }
			else if(activity<150){ delta-=1; drivers.push({name:'Active',value:-1}); }
			else { delta-=2; drivers.push({name:'Very Active',value:-2}); }
		}
		if(State.onboarding.answers.smoker){ 
			const cigarettesPerDay = State.onboarding.answers.cigarettesPerDay || 0;
			let smokingImpact = 0;
			if (cigarettesPerDay < 0.5) smokingImpact = 0;
			else if (cigarettesPerDay < 5) smokingImpact = 2;
			else if (cigarettesPerDay < 10) smokingImpact = 3;
			else if (cigarettesPerDay < 20) smokingImpact = 4;
			else smokingImpact = 5;
			
			
			if (smokingImpact > 0) {
				delta += smokingImpact; 
				drivers.push({name:'Smoking',value:smokingImpact}); 
			}
		}
		if(State.onboarding.answers.alcoholUnits>=14 && State.onboarding.answers.alcoholUnits<28){ delta+=2; drivers.push({name:'Alcohol',value:2}); }
		else if(State.onboarding.answers.alcoholUnits>=28){ delta+=5; drivers.push({name:'Alcohol',value:5}); }
		// HRV influence if available - use same thresholds as DRIVER_RULES for consistency
		if(State.wearables.series.hrv?.length){
			const hrv = State.wearables.series.hrv.slice(-7).reduce((a,b)=>a+b,0)/7;
			if(hrv<20){ delta+=2; drivers.push({name:'Poor HRV',value:2}); }
			else if(hrv<30){ delta+=1; drivers.push({name:'Below Average HRV',value:1}); }
			else if(hrv<50){ /* no change - average range */ }
			else if(hrv<100){ delta-=1; drivers.push({name:'Good HRV',value:-1}); }
			else { delta-=2; drivers.push({name:'Excellent HRV',value:-2}); }
		}
		return {delta,drivers};
	}
	function computeBiologicalAge(inputs){
		console.log('computeBiologicalAge called with inputs:', inputs);
		const {age,height,weight,waist,steps,sleep,rhr,activity} = inputs;
		const {delta, drivers} = computeDrivers(age,height,weight,waist,steps,sleep,rhr,activity);
		console.log('computeDrivers returned:', {delta, drivers});
		const bio = parseFloat(clamp(age+delta, 18, 95).toFixed(1));
		console.log('Final biological age:', bio);
		return {bio, drivers};
	}
	function calculateBiologicalAge(forceRecalculate = false){
		console.log('calculateBiologicalAge called, forceRecalculate:', forceRecalculate);
		
		// If onboarding is completed and we have a biological age, don't recalculate unless forced
		if (State.onboarding.completed && State.biologicalAge && !forceRecalculate) {
			console.log('Onboarding completed and biological age exists, skipping recalculation');
			updateBiologicalAgeDisplay();
			return;
		}
		
		// Check if we're in onboarding mode (ob- prefix) or regular mode
		const isOnboarding = document.getElementById('ob-calc-age');
		console.log('isOnboarding:', isOnboarding);
		
		try {
		
		const age = isOnboarding ? 
			+document.getElementById('ob-calc-age').value || State.user.age || 35 :
			+document.getElementById('calc-age').value || State.user.age || 35;
		console.log('age:', age);
		const height = isOnboarding ?
			+document.getElementById('ob-calc-height').value || State.user.height || 175 :
			+document.getElementById('calc-height').value || State.user.height || 175;
		const weight = isOnboarding ?
			+document.getElementById('ob-calc-weight').value || State.user.weight || 80 :
			+document.getElementById('calc-weight').value || State.user.weight || 80;
		const waist = isOnboarding ?
			+document.getElementById('ob-calc-waist').value || State.user.waist || 90 :
			+document.getElementById('calc-waist').value || State.user.waist || 90;
		// Get steps - prioritize wearable data, then manual input
		let steps = 0;
		const stepsData = getWearablesData('steps');
		if (stepsData) {
			steps = stepsData.average;
		} else {
			// Fall back to manual input
			steps = isOnboarding ?
				+document.getElementById('ob-calc-steps')?.value || 0 :
				+document.getElementById('calc-steps')?.value || 0;
		}
		
		// Get sleep - prioritize wearable data, then manual input
		let sleep = 0;
		const sleepData = getWearablesData('sleep');
		if (sleepData) {
			sleep = sleepData.average;
		} else {
			// Fall back to manual input
			sleep = isOnboarding ?
				+document.getElementById('ob-calc-sleep')?.value || 0 :
				+document.getElementById('calc-sleep')?.value || 0;
		}
			
		// Get resting HR - prioritize wearable data, then manual input
		let rhr = 0;
		const rhrData = getWearablesData('rhr');
		if (rhrData) {
			rhr = rhrData.average;
		} else {
			// Fall back to manual input
			rhr = isOnboarding ?
				+document.getElementById('ob-calc-rhr')?.value || 0 :
				+document.getElementById('calc-rhr')?.value || 0;
		}
		
		const activity = isOnboarding ?
			+document.getElementById('ob-calc-activity').value || 0 :
			+document.getElementById('calc-activity').value || 0;

		const {bio, drivers} = computeBiologicalAge({age,height,weight,waist,steps,sleep,rhr,activity});
		State.biologicalAge = bio; save({biologicalAge:bio});

		// Update age history
		const ageEntry = {
			biological: bio,
			chronological: age,
			date: new Date().toISOString()
		};
		if (!State.ageHistory || State.ageHistory.length === 0) {
			State.ageHistory = [ageEntry];
		} else {
			// Update the latest entry or add new one
			State.ageHistory[State.ageHistory.length - 1] = ageEntry;
		}
		save({ageHistory: State.ageHistory});

		// Update display elements based on mode
		if (isOnboarding) {
			// Onboarding mode
			const ageDisplay = document.getElementById('ob-age-display');
			const ageDiffEl = document.getElementById('ob-age-diff');
			const statusChip = document.getElementById('ob-status-chip');
			
			if (ageDisplay) ageDisplay.textContent = bio;
			
			if (ageDiffEl) {
				const ageDiff = bio - age;
				const sign = ageDiff >= 0 ? '+' : '';
				ageDiffEl.textContent = `${sign}${ageDiff.toFixed(1)} vs your age`;
				
				// Set color based on delta range (same as gauge)
				if (ageDiff <= -2) {
					ageDiffEl.style.color = '#10b981'; // Green
				} else if (ageDiff >= 2) {
					ageDiffEl.style.color = '#ef4444'; // Red
				} else {
					ageDiffEl.style.color = '#fbbf24'; // Amber/Yellow
				}
			}
			
			if (statusChip) {
				const status = (bio<=age-2)? 'Below average': (bio>=age+2)? 'Above average': 'Average';
				statusChip.textContent = status;
				statusChip.style.background = (bio<=age-2)? '#10b981': (bio>=age+2)? '#ef4444': '#6b7280';
			}
			
			// Render the new working gauge
			renderBiologicalAgeGauge(age, bio, 'ob-bio-age-gauge-container');
			
			// Render driver chips instead of old drivers list
			renderDriverChips('ob-drivers-list');
			
		} else {
			// Regular mode
			console.log('Regular mode - updating elements');
			const ageDisplay = document.getElementById('age-display');
			console.log('age-display element:', ageDisplay);
			if (ageDisplay) ageDisplay.textContent = bio;
			
			// Calculate and display age difference
			const ageDiff = bio - age;
			const ageDiffEl = document.getElementById('age-difference');
			if (ageDiffEl) {
				const sign = ageDiff >= 0 ? '+' : '';
			ageDiffEl.textContent = `${sign}${ageDiff.toFixed(1)} vs your age`;
				
				// Set color based on delta range (same as gauge)
				if (ageDiff <= -2) {
					ageDiffEl.style.color = '#10b981'; // Green
				} else if (ageDiff >= 2) {
					ageDiffEl.style.color = '#ef4444'; // Red
				} else {
					ageDiffEl.style.color = '#fbbf24'; // Amber/Yellow
				}
			}
			
			// Remove redundant status chip - the age difference text is sufficient
			const chip = document.getElementById('status-chip'); 
			if (chip) chip.style.display = 'none';
		// Render the new working gauge
		renderBiologicalAgeGauge(age, bio, 'bio-age-gauge-container');

		// Update display values in collapsible section
		updateBiologicalAgeDisplayValues(age, height, weight, waist, steps, sleep, rhr, activity);

		// Render driver chips instead of old drivers list
		console.log('About to render driver chips for drivers-list');
		renderDriverChips('drivers-list');
		console.log('Driver chips rendered');
		}

		// Ensure we always have exactly one data point for the current calculation
		const today = new Date();
		const todayStr = today.toISOString().split('T')[0]; // Get just the date part
		
		// Check if we already have data for today
		const existingToday = State.ageHistory.find(d => d.date.startsWith(todayStr));
		
		if (existingToday) {
			// Update existing data point for today with latest values
			existingToday.chronological = age;
			existingToday.biological = bio;
			existingToday.date = today.toISOString(); // Update to latest timestamp
		} else {
			// Add new data point for today
			State.ageHistory.push({
				week: State.ageHistory.length, 
				chronological: age, 
				biological: bio,
				date: today.toISOString()
			});
		}
		
		// Remove any duplicate data points for the same date (keep only the latest)
		const uniqueByDate = {};
		State.ageHistory.forEach(point => {
			const dateKey = point.date.split('T')[0];
			if (!uniqueByDate[dateKey] || new Date(point.date) > new Date(uniqueByDate[dateKey].date)) {
				uniqueByDate[dateKey] = point;
			}
		});
		State.ageHistory = Object.values(uniqueByDate);
		
		// Keep only the most recent data point for demo purposes
		if (State.ageHistory.length > 1) {
			State.ageHistory = [State.ageHistory[State.ageHistory.length - 1]];
		}
		
		// Ensure we always have at least one data point
		if (State.ageHistory.length === 0) {
			State.ageHistory.push({
				week: 0,
				chronological: age,
				biological: bio,
				date: today.toISOString()
			});
		}
		
		save({ageHistory:State.ageHistory});
		// riskScan(); // Disabled to remove NHS 111/999 messages
		cleanupAlertBanners(); // Clean up any existing alert banners
		
		// Update dashboard if we're on the dashboard view
		if (State.currentView === 'dashboard') {
			renderDashboard();
		}
		
		return { bio, drivers };
		} catch (error) {
			console.error('Error in calculateBiologicalAge:', error);
			return null;
		}
	}
	function drawGauge(canvasId, bioAge, chronoAge){
		console.log('drawGauge called with:', {canvasId, bioAge, chronoAge});
		
		// Use the new working gauge for biological age displays
		if (canvasId === 'age-gauge' || canvasId === 'ob-age-gauge') {
			console.log('Using new working gauge for:', canvasId);
			
			// Render the new working gauge instead
			const containerId = canvasId === 'age-gauge' ? 'bio-age-gauge-container' : 'ob-bio-age-gauge-container';
			
			try {
				const result = renderBiologicalAgeGauge(chronoAge, bioAge, containerId);
				if (result) {
					console.log('New working gauge rendered successfully for:', canvasId);
					return;
				}
			} catch (error) {
				console.error('Error rendering new working gauge:', error);
			}
			return;
		}
		
		// Handle dashboard gauge - use the new working gauge approach
		if (canvasId === 'dashboard-gauge') {
			console.log('Rendering dashboard gauge with new working gauge approach');
			
			// Create a container for the new gauge if it doesn't exist
		const canvas = document.getElementById(canvasId);
			if (canvas) {
				// Hide the canvas and create a container for the new gauge
				canvas.style.display = 'none';
				
				// Create or find the container for the new gauge
				let container = document.getElementById('dashboard-bio-gauge-container');
				if (!container) {
					container = document.createElement('div');
					container.id = 'dashboard-bio-gauge-container';
					container.style.cssText = 'width: 220px; height: 110px; margin: 0 auto;';
					canvas.parentNode.insertBefore(container, canvas);
				}
				
				try {
					const result = renderBiologicalAgeGauge(chronoAge, bioAge, 'dashboard-bio-gauge-container');
					if (result) {
						console.log('Dashboard new working gauge rendered successfully');
						return;
					}
				} catch (error) {
					console.error('Error rendering dashboard new working gauge:', error);
				}
			}
			return;
		}
		
		const canvas = document.getElementById(canvasId);
		if(!canvas) {
			console.error('Canvas not found:', canvasId);
			return;
		}
		console.log('Canvas found:', canvas);
		const ctx = canvas.getContext('2d');
		if(!ctx) {
			console.error('Canvas context not available');
			return;
		}
		const W = canvas.width, H = canvas.height;
		console.log('Canvas dimensions:', {W, H});
		console.log('Canvas computed style:', window.getComputedStyle(canvas));
		const cx = W/2, cy = H - 10;
		const rOuter = Math.min(W, H*2)/2 - 6;
		const rTrack = rOuter - 10;
		console.log('Gauge parameters:', {cx, cy, rOuter, rTrack});
		ctx.clearRect(0,0,W,H);
	
		// Calculate delta - no clamping, let it be the actual value
		const delta = bioAge - chronoAge;
		console.log('Delta calculated:', delta);
		
		// Fixed range for consistent gauge appearance
		const minRange = -10;
		const maxRange = 10;
		const step = 2;
		
		// Ensure delta is within the fixed range for display
		const clampedDelta = Math.max(minRange, Math.min(maxRange, delta));
		
		// Map delta to 180° sweep: [minRange, maxRange] -> [270°, 450°] in radians (180° sweep)
		const toAngle = (value) => {
			const normalized = (value - minRange) / (maxRange - minRange); // [0, 1]
			return (3 * Math.PI / 2) + (normalized * Math.PI); // 270° to 450° (180° sweep)
		};
		
		// Define segments based on delta thresholds - fix overlapping ranges
		const segments = [
			{from: minRange, to: -2, color: '#10b981', label: 'Green'},      // ≤ -2 years
			{from: -2, to: 2, color: '#fbbf24', label: 'Yellow'},           // -2 to +2 years
			{from: 2, to: maxRange, color: '#ef4444', label: 'Red'}         // ≥ +2 years
		];
		
		// Draw subtle backdrop
		ctx.beginPath();
		ctx.arc(cx, cy, rTrack, 3 * Math.PI / 2, 3 * Math.PI / 2 + Math.PI);
		ctx.strokeStyle = 'rgba(17,17,17,0.08)';
		ctx.lineWidth = 16;
		ctx.stroke();
		console.log('Backdrop drawn');
	
		// Draw colored segments with proper arc drawing
		segments.forEach((s, index) => {
			const fromAngle = toAngle(s.from);
			const toAngleValue = toAngle(s.to);
			
			ctx.beginPath();
			ctx.arc(cx, cy, rTrack, fromAngle, toAngleValue, false);
			ctx.strokeStyle = s.color;
			ctx.lineWidth = 14;
			ctx.lineCap = 'round';
			ctx.stroke();
			console.log(`Segment ${index} drawn:`, {from: s.from, to: s.to, color: s.color});
		});
	
		// Draw tick marks for delta values
		ctx.save();
		ctx.strokeStyle = '#cbd5e1';
		ctx.lineWidth = 1;
		for(let d = minRange; d <= maxRange; d += step){
			const a = toAngle(d);
			const x1 = cx + Math.cos(a)*(rTrack-2);
			const y1 = cy + Math.sin(a)*(rTrack-2);
			const x2 = cx + Math.cos(a)*(rTrack-18);
			const y2 = cy + Math.sin(a)*(rTrack-18);
			ctx.beginPath(); 
			ctx.moveTo(x1,y1); 
			ctx.lineTo(x2,y2); 
			ctx.stroke();
			
			// Add labels for key values (0 and endpoints)
			if (d === 0 || d === minRange || d === maxRange) {
				ctx.fillStyle = '#6b7280';
				ctx.font = '10px sans-serif';
				ctx.textAlign = 'center';
				const labelX = cx + Math.cos(a)*(rTrack-25);
				const labelY = cy + Math.sin(a)*(rTrack-25) + 3;
				ctx.fillText(d.toString(), labelX, labelY);
			}
		}
		ctx.restore();
	
		// Draw needle to current delta (use clamped value for positioning)
		const needleAngle = toAngle(clampedDelta);
		const nx = cx + Math.cos(needleAngle)*(rTrack-6);
		const ny = cy + Math.sin(needleAngle)*(rTrack-6);
		console.log('Needle position:', {nx, ny, needleAngle, clampedDelta});
		
		// Draw needle with proper styling
		ctx.beginPath();
		ctx.moveTo(cx, cy);
		ctx.lineTo(nx, ny);
		ctx.strokeStyle = '#0ea5e9';
		ctx.lineWidth = 4;
		ctx.lineCap = 'round';
		ctx.stroke();
		console.log('Needle drawn');
		
		// Draw needle tip (small circle at the end)
		ctx.beginPath();
		ctx.arc(nx, ny, 3, 0, Math.PI*2);
		ctx.fillStyle = '#0ea5e9';
		ctx.fill();
	
		// Draw hub (center circle)
		ctx.beginPath();
		ctx.arc(cx, cy, 6, 0, Math.PI*2);
		ctx.fillStyle = '#0ea5e9';
		ctx.fill();
		
		// Update the gauge label with color based on range (use actual delta, not clamped)
		const gaugeLabel = document.getElementById(canvasId.replace('-gauge', '-label')) || 
		                  document.getElementById(canvasId.replace('-gauge', '-diff')) || 
		                 document.getElementById(canvasId.replace('-gauge', '-age-diff')) ||
		                 document.getElementById(canvasId.replace('-gauge', '-difference'));
		if (gaugeLabel) {
			const sign = delta >= 0 ? '+' : '';
			gaugeLabel.textContent = `${sign}${delta.toFixed(1)} vs your age`;
			
			// Set color based on delta range
			if (delta <= -2) {
				gaugeLabel.style.color = '#10b981'; // Green
			} else if (delta >= 2) {
				gaugeLabel.style.color = '#ef4444'; // Red
			} else {
				gaugeLabel.style.color = '#fbbf24'; // Amber/Yellow
			}
		}
	}
	
	// Enhanced gauge animation and interactivity
	function enhanceGaugeDisplay(currentAge, chronologicalAge) {
		const gauge = document.querySelector('.bio-gauge');
		if (!gauge) return;
		
		// Add contextual information display
		const infoPanel = document.createElement('div');
		infoPanel.className = 'gauge-info-panel';
		infoPanel.innerHTML = `
			<div class="age-comparison">
				<div class="biological-age">
					<span class="label">Biological Age</span>
					<span class="value">${currentAge}</span>
				</div>
				<div class="chronological-age">
					<span class="label">Chronological Age</span>
					<span class="value">${chronologicalAge}</span>
				</div>
				<div class="age-delta ${currentAge < chronologicalAge ? 'positive' : 'negative'}">
					<span class="delta-value">${Math.abs(currentAge - chronologicalAge)} years</span>
					<span class="delta-direction">${currentAge < chronologicalAge ? 'younger' : 'older'}</span>
				</div>
			</div>
		`;
		
		gauge.parentNode.insertBefore(infoPanel, gauge.nextSibling);
	}
	
	function updatePlan(){
		// Check if plan has changed
		const currentPlan = State.subscription.plan || [];
		const newPlan = State.plan.selectedIds || [];
		
		// Get current subscription pricing
		const currentPricing = State.plan.pricing || {monthlyTotal: 0};
		
		// Calculate new pricing
		updatePlanSummary();
		const newPricing = State.plan.pricing || {monthlyTotal: 0};
		
		// Check if plan actually changed
		const planChanged = JSON.stringify(currentPlan.sort()) !== JSON.stringify(newPlan.sort());
		const priceChanged = currentPricing.monthlyTotal !== newPricing.monthlyTotal;
		
		if (!planChanged && !priceChanged) {
			showToast('No changes detected. Plan remains the same.');
			State.plan.editing = false;
			renderNewPlanPage();
			return;
		}
		
		// Show confirmation popup for price changes
		if (priceChanged) {
			showPriceUpdateConfirmation(currentPricing.monthlyTotal, newPricing.monthlyTotal, () => {
				confirmPlanUpdate(newPlan, newPricing);
			});
		} else {
			confirmPlanUpdate(newPlan, newPricing);
		}
	}
	
	function confirmPlanUpdate(newPlan, newPricing){
		// Update subscription with new plan
		State.subscription.plan = newPlan;
		State.plan.pricing = newPricing;
		State.plan.editing = false;
		
		// Save changes
		save({
			'subscription.plan': newPlan,
			'plan.pricing': newPricing,
			'plan.editing': false
		});
		
		// Re-render plan page
		renderNewPlanPage();
		
		showToast('Plan updated successfully! Your subscription has been modified.');
		logEvent('plan_updated', {newPlan: newPlan, newPrice: newPricing.monthlyTotal});
	}
	
	function showPriceUpdateConfirmation(currentPrice, newPrice, onConfirm){
		const modal = document.createElement('div');
		modal.className = 'modal active';
		modal.innerHTML = `
			<div class="modal-content" style="max-width:500px">
				<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem">
					<h3>Confirm Plan Update</h3>
					<button class="btn-ghost btn-small" onclick="this.closest('.modal').remove()">✕</button>
				</div>
				
				<div style="background:var(--canvas); padding:1rem; border-radius:8px; margin:1rem 0">
					<h4 style="margin:0 0 0.5rem 0">Price Change Confirmation</h4>
					<p style="margin:0; color:var(--ink-60)">We will update your subscription price automatically using your stored payment method.</p>
				</div>
				
				<div style="display:flex; justify-content:space-between; align-items:center; padding:1rem; background:#f8fafc; border-radius:8px; margin:1rem 0">
					<div>
						<div style="font-weight:600; color:var(--ink-60)">Current Price</div>
						<div style="font-size:1.2rem; font-weight:800; color:var(--numan-teal)">£${currentPrice}/month</div>
					</div>
					<div style="font-size:1.5rem; color:var(--ink-40)">→</div>
					<div>
						<div style="font-weight:600; color:var(--ink-60)">New Price</div>
						<div style="font-size:1.2rem; font-weight:800; color:var(--numan-teal)">£${newPrice}/month</div>
					</div>
				</div>
				
				<div style="display:flex; gap:0.5rem; justify-content:flex-end; margin-top:1rem">
					<button class="btn-ghost" onclick="this.closest('.modal').remove()">Cancel</button>
					<button class="btn" onclick="onConfirm(); this.closest('.modal').remove()">Confirm Update</button>
				</div>
			</div>
		`;
		document.body.appendChild(modal);
	}
	
	function renderRecommendationExplanations() {
		if (!State.plan.recommendation?.why) return;
		
		const explanations = State.plan.recommendation.why;
		const selectedServices = State.plan.selectedIds.map(id => Services.find(s => s.id === id)?.name).filter(Boolean);
		
		// Add explanation panels to each selected service card
		selectedServices.forEach(serviceName => {
			const serviceId = serviceNameToId(serviceName);
			const serviceCard = document.querySelector(`[onclick*="toggleService('${serviceId}')"]`);
			if (serviceCard && explanations[serviceName]) {
				// Remove existing explanation if any
				const existingExplanation = serviceCard.querySelector('.service-explanation');
				if (existingExplanation) {
					existingExplanation.remove();
				}
				
				// Add new explanation
				const explanationDiv = document.createElement('div');
				explanationDiv.className = 'service-explanation';
				explanationDiv.style.cssText = 'margin-top:0.5rem; padding:0.5rem; background:#f0f9ff; border-radius:6px; font-size:0.9rem; color:#1e40af';
				explanationDiv.innerHTML = `
					<div style="font-weight:600; margin-bottom:0.25rem">Why this service:</div>
					<ul style="margin:0; padding-left:1rem">
						${explanations[serviceName].map(reason => `<li>${reason}</li>`).join('')}
					</ul>
				`;
				serviceCard.appendChild(explanationDiv);
			}
		});
	}
	
	// Legacy renderTierGrid removed - using new pricing system
	
function renderPlanTilesInto(el) {
		if (!el) return;
		const isAnnual = State.billing === 'annual';
		el.innerHTML = Object.entries(MODEL.plans).map(([planKey, plan]) => {
			const price = isAnnual ? calcPlanMonthly(planKey, true) : plan.price;
			const isSelected = State.plan.tier === planKey;
			
			return `
				<div class="tier ${isSelected ? 'anchor' : ''}">
					<div class="row">
						<strong>${planKey}</strong> 
						<span>${money(price)}${isAnnual ? '/year' : '/month'}</span>
					</div>
					<div style="margin:0.5rem 0; font-size:0.9rem; color:var(--ink-60)">
						<div>${plan.labCreditsPerYear} lab credits/year</div>
						<div>${plan.supplementQuantityPerMonth} supplement${plan.supplementQuantityPerMonth > 1 ? 's' : ''}/month</div>
						<div>Coaching: ${plan.coachingMinutesPerMonth} min/month</div>
						<div>GP: ${plan.gpConsultsPerYear} consults/year</div>
					</div>
					<div style="margin-top:.5rem">
						<button class="btn btn-small" onclick="selectNewPlan('${planKey}')" ${isSelected?'disabled':''}>
							${isSelected?'Selected':'Select'}
						</button>
					</div>
					${isAnnual ? '<div style="font-size:0.8rem; color:var(--numan-teal); margin-top:0.25rem">Annual (10% off)</div>' : ''}
				</div>
			`;
		}).join('');
		
		// Add credit info tooltip
		el.innerHTML += `
			<div style="grid-column:1/-1; margin-top:1rem; padding:0.75rem; background:var(--mint-50); border-radius:8px; font-size:0.85rem; color:var(--ink-60)">
				<strong>Lab Credits:</strong> Each test uses different credit amounts based on complexity.
			</div>
		`;
		
		// Show member add-ons section
		renderMemberAddOns();
	}
	
	function renderMemberAddOns() {
		const card = document.getElementById('member-addons-card');
		const list = document.getElementById('member-addons-list');
		
		if (!card || !list) return;
		
		// Only show if new pricing is enabled
		if (!State.useNewPricing) {
			card.style.display = 'none';
			return;
		}
		
		card.style.display = 'block';
		
		let html = '';
		
		// Tests section
		html += '<h4 style="margin:0 0 1rem 0; color:var(--ink)">Blood Tests</h4>';
		Object.entries(MODEL.memberAddOns.tests).forEach(([key, item]) => {
			const qty = State.cart?.addOns?.[key]?.qty || 0;
			html += `
				<div style="display:flex; justify-content:space-between; align-items:center; padding:0.75rem; border:1px solid #e5e7eb; border-radius:8px; margin-bottom:0.5rem">
					<div>
						<div style="font-weight:600">${item.title}</div>
						<div style="font-size:0.9rem; color:var(--ink-60)">${money(item.memberPrice)}</div>
					</div>
					<div style="display:flex; align-items:center; gap:0.5rem">
						<button class="btn-ghost btn-small" onclick="updateAddOnQty('${key}', ${qty - 1})" ${qty <= 0 ? 'disabled' : ''}>-</button>
						<span style="min-width:2rem; text-align:center">${qty}</span>
						<button class="btn-ghost btn-small" onclick="updateAddOnQty('${key}', ${qty + 1})">+</button>
					</div>
				</div>
			`;
		});
		
		// Supplements section
		html += '<h4 style="margin:1.5rem 0 1rem 0; color:var(--ink)">Supplements</h4>';
		Object.entries(MODEL.memberAddOns.supplements).forEach(([key, item]) => {
			const qty = State.cart?.addOns?.[key]?.qty || 0;
			html += `
				<div style="display:flex; justify-content:space-between; align-items:center; padding:0.75rem; border:1px solid #e5e7eb; border-radius:8px; margin-bottom:0.5rem">
					<div>
						<div style="font-weight:600">${item.title}</div>
						<div style="font-size:0.9rem; color:var(--ink-60)">${money(item.memberPrice)}</div>
					</div>
					<div style="display:flex; align-items:center; gap:0.5rem">
						<button class="btn-ghost btn-small" onclick="updateAddOnQty('${key}', ${qty - 1})" ${qty <= 0 ? 'disabled' : ''}>-</button>
						<span style="min-width:2rem; text-align:center">${qty}</span>
						<button class="btn-ghost btn-small" onclick="updateAddOnQty('${key}', ${qty + 1})">+</button>
					</div>
				</div>
			`;
		});
		
		// Services section
		html += '<h4 style="margin:1.5rem 0 1rem 0; color:var(--ink)">Services</h4>';
		Object.entries(MODEL.memberAddOns.services).forEach(([key, item]) => {
			const qty = State.cart?.addOns?.[key]?.qty || 0;
			html += `
				<div style="display:flex; justify-content:space-between; align-items:center; padding:0.75rem; border:1px solid #e5e7eb; border-radius:8px; margin-bottom:0.5rem">
					<div>
						<div style="font-weight:600">${item.title}</div>
						<div style="font-size:0.9rem; color:var(--ink-60)">${money(item.memberPrice)}</div>
					</div>
					<div style="display:flex; align-items:center; gap:0.5rem">
						<button class="btn-ghost btn-small" onclick="updateAddOnQty('${key}', ${qty - 1})" ${qty <= 0 ? 'disabled' : ''}>-</button>
						<span style="min-width:2rem; text-align:center">${qty}</span>
						<button class="btn-ghost btn-small" onclick="updateAddOnQty('${key}', ${qty + 1})">+</button>
					</div>
				</div>
			`;
		});
		
		list.innerHTML = html;
	}
	
	function updateAddOnQty(key, newQty) {
		if (newQty < 0) return;
		
		if (!State.cart.addOns) State.cart.addOns = {};
		
		// Find the item in MODEL.memberAddOns
		let item = null;
		for (const category of Object.values(MODEL.memberAddOns)) {
			if (category[key]) {
				item = category[key];
				break;
			}
		}
		
		if (!item) return;
		
		if (newQty === 0) {
			delete State.cart.addOns[key];
		} else {
			State.cart.addOns[key] = {
				qty: newQty,
				unitPrice: item.memberPrice,
				label: item.title
			};
		}
		
		// Update kits to ship if it's a test
		if (key.includes('Test') || key.includes('test')) {
			State.cart.kitsToShip = Object.entries(State.cart.addOns)
				.filter(([k, v]) => k.includes('Test') || k.includes('test'))
				.reduce((sum, [k, v]) => sum + v.qty, 0);
		}
		
		save({cart: State.cart});
		renderMemberAddOns();
		updatePlanSummary();
	}
	function applyTier(id){
		// Legacy function - use new pricing system instead
		console.log('Legacy applyTier called - use new pricing system');
	}
	
	function selectNewPlan(planKey) {
		selectPlanTier(planKey);
		renderNewPlanPage();
	}
	function arrayEqualIgnoreOrder(a,b){ if(a.length!==b.length) return false; const x=[...a].sort(), y=[...b].sort(); return x.every((v,i)=>v===y[i]); }

	function renderCatalogue(){
		// Skip rendering old catalogue when using new pricing system
		if (State.plan.tier) {
			return;
		}
		
		const host = document.getElementById('service-list');
		const feat = buildFeatures(State);
		const userGender = State.user.sex;
		
    // For catalogue display, show all services when gender is unspecified; otherwise filter
    const availableServices = (!userGender || userGender==='prefer-not-to-say' || userGender==='non-binary')
        ? Services
        : filterByGender(Services, userGender);
		
		const groups = curateCatalogue(availableServices, feat, State.user || {});
		const scores = scorePackages(feat);
		const idSelected = id => State.plan.selectedIds?.includes(id) || false;

		function cardHTML(s, section){
			const sel = idSelected(s.id);
			const inRecommended = (section==='recommended');
			const reasons = inRecommended ? reasonsForService(s.id, feat).slice(0,3) : [];

			// outcome + feature copy (≤120 chars)
			const outcome = {
				'coaching':'Build durable habits in 8–12 weeks',
				'sleep':'Improve sleep quality in 8–12 weeks',
				'blood-tests':'Know your key biomarkers this month',
				'supplements':'Cover common gaps; recheck in 12 weeks',
				'weight-mgmt':'Lose weight safely and keep it off',
				'cognition':'Sharpen focus and daytime energy',
				'sexual-support':'Resolve sexual health concerns discreetly',
				'bp-optimisation':'Lower BP with home monitoring',
				'cholesterol-improvement':'Improve lipids with plan + re-test',
				'prediabetes-prevention':'Reduce diabetes risk markers',
				'alcohol-smart':'Cut weekly units safely',
				'stop-smoking':'Quit with a coach-backed plan',
				'testosterone':'Assess and treat low T if eligible'
			}[s.id] || '';

			const feature = s.category+': '+s.description;

			// gated inline panel for potential/clinical
			const gatedUI = (s.gated && section==='potential') ? `
				<div style="margin-top:.5rem; padding:.5rem; background:#fff7ed; border:1px solid #fed7aa; border-radius:8px; font-size:.9rem">
					${s.reason || 'Requires confirmed eligibility.'}
					<div style="margin-top:.4rem; display:flex; gap:.5rem">
						<button class="btn btn-small" onclick="ensureBloodsThen('${s.id}')">Add blood tests</button>
						<button class="btn-ghost btn-small" onclick="checkSubscriptionAndMessage()">Message a clinician</button>
					</div>
				</div>` : '';

			return `
			<div class="service-card ${sel?'selected':''} ${s.gated&&section!=='recommended'?'gated':''}" 
				 role="button" tabindex="0" aria-pressed="${sel}" 
				 onclick="${s.gated && section!=='recommended' ? '' : `toggleService('${s.id}')`}" 
				 onkeydown="if(event.key==='Enter'){ ${s.gated && section!=='recommended' ? '' : `toggleService('${s.id}')`} }">
				<div class="tick">✓</div>
				<div class="service-header">
					<div>
						<h4>${s.name}</h4>
						<div class="badges">
							${Object.values(BundleDefs).some(b=>b.ids.includes(s.id))? '<span class="badge bundle">Bundle</span>':''}
							${s.badge==='Clinical'?'<span class="badge clinical">Clinical</span>':''}
						</div>
					</div>
					<div class="service-price">£${s.price}</div>
				</div>
				<div class="service-category"><strong>${outcome}</strong></div>
				<div class="muted" style="margin-top:.25rem">${feature}</div>
				${inRecommended && reasons.length ? `
					<div style="margin-top:.5rem; background:#f0f9ff; border:1px solid #dbeafe; border-radius:8px; padding:.5rem .6rem">
						${reasons.map(r=>`<div style="font-size:.9rem">• ${r}</div>`).join('')}
						<div><a href="#" onclick="openWhyDrawer(event)" style="font-weight:600; color:#2563eb">How this was picked</a></div>
					</div>` : ''}
				${gatedUI}
			</div>`;
		}

		function sectionHTML(title, key, items, opts={}){
			const count = items.length;
			if (!count) return '';
			const collapsed = !!opts.collapsed;
			const id = `section-${key}`;
			const show = !collapsed;
			const bodyAttr = show? '' : 'class="section-body collapsed"';

			// limit more options to first 6, expandable
			const visibleItems = (key==='more' && count>6) ? items.slice(0,6) : items;
			const hiddenCount = (key==='more' && count>6) ? (count-6) : 0;

			return `
				<div class="catalog-section">
					<div class="catalog-header">
						<h4>${title} ${opts.badge? `<span class="badge">${opts.badge}</span>`:''}</h4>
						${opts.collapsible? `<button class="btn-ghost btn-small" onclick="toggleSection('${id}')">${collapsed?'Show':'Hide'}</button>`:''}
					</div>
					<div id="${id}" ${bodyAttr}>
						<div class="card-grid">
							${visibleItems.map(s=>cardHTML(s,key)).join('')}
						</div>
						${hiddenCount? `<div style="margin-top:.5rem"><button class="btn-ghost btn-small" onclick="expandMore()">Show ${hiddenCount} more</button></div>`:''}
					</div>
				</div>
			`;
		}

		host.innerHTML = [
			`<div id="bundle-hint" class="muted" style="margin:.25rem 0 .5rem">Save 10% with 2 services or 15% with 3+.</div>`,
			sectionHTML('Recommended for you','recommended', groups.recommended.slice(0,4)),
			sectionHTML('More options','more', groups.more, {}),
			sectionHTML('Potential / clinical','potential', groups.potential, {collapsible:true, collapsed:true}),
		].join('');

		// wire expanders
		window.expandMore = function(){
			// Skip if using new pricing system
			if (State.plan.tier) {
				return;
			}
			
			logEvent('bundle_hint_viewed');
			// re-render without limiting
			const userGender = State.user.sex;
        const availableServices = (!userGender || userGender==='prefer-not-to-say' || userGender==='non-binary')
            ? Services
            : filterByGender(Services, userGender);
			const allMore = curateCatalogue(availableServices, buildFeatures(State), State.user).more;
			document.querySelector('#section-more').classList.remove('collapsed');
			document.querySelector('#section-more .card-grid').innerHTML = allMore.map(s=>cardHTML(s,'more')).join('');
		};
		window.toggleSection = function(id){
			// Skip if using new pricing system
			if (State.plan.tier) {
				return;
			}
			
			const el = document.getElementById(id);
			el.classList.toggle('collapsed');
		}
	}

	function ensureBloodsThen(targetId){
		if (!State.plan.selectedIds) State.plan.selectedIds = [];
		if (!State.plan.selectedIds.includes('blood-tests')){
			State.plan.selectedIds.push('blood-tests');
			save({'plan.selectedIds':State.plan.selectedIds});
			showToast('Added blood tests');
		}
		renderPlan();
		logEvent('gated_service_cta_clicked', {id: targetId, action:'add_bloods'});
	}
	function openWhyDrawer(e){
		e.preventDefault();
		// Open the new recommendation modal
		const sig = recEngine.readSignals();
		const rec = recEngine.buildRecommendations(sig);
		recEngine.renderModal(rec);
		recEngine.open();
	}
	
	function renderServiceCard(s, feat){
		if (!State.plan.selectedIds) State.plan.selectedIds = [];
		const sel = State.plan.selectedIds.includes(s.id);
		const isGated = s.gated && !State.plan.selectedIds.includes('blood-tests');
		const explanations = getServiceExplanations(s.id, feat);
		
		return `
		<div class="service-card ${sel?'selected':''} ${isGated?'gated':''}" tabindex="0" role="button" aria-pressed="${sel}" 
			onclick="${isGated ? 'showGatedToast(\'' + s.id + '\')' : 'toggleService(\'' + s.id + '\')'}" 
			onkeydown="if(event.key==='Enter'){${isGated ? 'showGatedToast(\'' + s.id + '\')' : 'toggleService(\'' + s.id + '\')'}}"
			style="min-height:44px; position:relative; ${isGated ? 'opacity:0.6; pointer-events:none;' : ''}">
			${sel ? '<div class="selected-indicator">✓</div>' : ''}
			${isGated ? '<div style="position:absolute; top:0.5rem; right:0.5rem; background:#fbbf24; color:#92400e; padding:0.25rem 0.5rem; border-radius:4px; font-size:0.75rem; font-weight:600;">🔒</div>' : ''}
			<div class="service-header">
				<div>
					<h4>${s.name}</h4>
					<p class="service-outcome">${s.outcome || 'Improve your health'}</p>
					<p class="service-features">${s.features || 'Personalised approach'}</p>
					${explanations.length > 0 ? `
						<div class="service-reasons">
							${explanations.slice(0, 2).map(r => `<small class="reason">• ${r}</small>`).join('')}
						</div>
					` : ''}
				</div>
				<div class="service-price">£${s.price}</div>
			</div>
			<div class="service-category">
				<strong>${s.category}:</strong> ${s.description}
			</div>
			${isGated ? '<div class="gated-message" style="margin-top:0.5rem; padding:0.5rem; background:#fef3c7; border-radius:6px; font-size:0.9rem; color:#92400e">Unlocks after blood tests confirm eligibility</div>' : ''}
		</div>`;
	}
	
	function eligibleForService(serviceId) {
		// Check eligibility for gated services
		if (serviceId === 'testosterone') {
			// Check if user has completed blood tests and has symptoms
			const hasBloods = State.onboarding.answers?.assessments?.some(a => a.tool === 'BLOODS');
			const hasSymptoms = State.onboarding.answers?.symptoms?.current?.some(s => s.key === 'low-sex-drive');
			return hasBloods && hasSymptoms;
		}
		return true; // Default to eligible
	}
	
	function showGatedMessage(serviceId) {
		const service = Services.find(s => s.id === serviceId);
		showToast(`${service.name} requires completing blood tests and clinician review first.`);
	}

	function showGatedToast(serviceId) {
		showToast('Please add Blood tests first.');
	}
	
	function registerInterest(serviceId) {
		const service = Services.find(s => s.id === serviceId);
		showToast(`Interest registered for ${service.name}. We'll notify you when it becomes available.`);
		logEvent('service_interest_registered', {serviceId, serviceName: service.name});
	}
	function toggleService(id){
		if (!State.plan.selectedIds) State.plan.selectedIds = [];
		const i = State.plan.selectedIds.indexOf(id);
		const wasSelected = i > -1;
		
		if(wasSelected){ 
			State.plan.selectedIds.splice(i,1); 
			logEvent('service_removed',{id});
			logPlanCardSelected(id, false);
		} else { 
			State.plan.selectedIds.push(id); 
			logEvent('service_added',{id});
			logPlanCardSelected(id, true);
			
			// Log bundle hint when user hits 2 services
			if (State.plan.selectedIds.length === 2) {
				logBundleHintViewed();
			}
		}
		
		save({'plan.selectedIds':State.plan.selectedIds});
		renderPlan();
	}
	function clearPlan(){ State.plan.selectedIds=[]; save({'plan.selectedIds':[]}); renderPlan(); }
	function quickAddBundle(key){
		const b = BundleDefs[key]; if(!b) return;
		if (!State.plan.selectedIds) State.plan.selectedIds = [];
		b.ids.forEach(id=>{ if(!State.plan.selectedIds.includes(id)) State.plan.selectedIds.push(id); });
		save({'plan.selectedIds':State.plan.selectedIds}); renderPlan();
	}

	// Legacy updatePlanSummary removed - using new pricing system
	
	function updateNewPlanSummary(annual) {
		if (!State.plan.tier || !MODEL.plans[State.plan.tier]) return;
		
		const totals = calcCartTotal(State.plan.tier, annual);
		
		// Update selected count (show plan tier instead)
		const selectedCountEl = document.getElementById('selected-count');
		if (selectedCountEl) {
			selectedCountEl.textContent = State.plan.tier;
		}
		
		// Update total price
		const totalPriceEl = document.getElementById('total-price');
		if (totalPriceEl) {
			totalPriceEl.textContent = Math.round(totals.total);
		}
		
		// Update breakdown
		const breakdownEl = document.getElementById('savings-breakdown');
		if (breakdownEl) {
			const lines = [
				`Plan: ${money(totals.base)}${annual ? '/year' : '/month'}`,
				totals.addOns > 0 ? `Add-ons: ${money(totals.addOns)}` : '',
				totals.fees > 0 ? `Payment fees: ${money(totals.fees)}` : '',
				totals.shipping > 0 ? `Shipping: ${money(totals.shipping)}` : '',
				`Total: ${money(totals.total)}`
			].filter(line => line !== '');
			
			breakdownEl.innerHTML = lines.map(l=>`<div style="margin-bottom:0.25rem">${l}</div>`).join('');
			breakdownEl.style.minHeight = '120px';
		}
		
		// Annual helper line
		const priceContainer = document.querySelector('.summary-price');
		if (priceContainer && annual) {
			let helper = priceContainer.nextElementSibling && priceContainer.nextElementSibling.classList && priceContainer.nextElementSibling.classList.contains('annual-helper') ? priceContainer.nextElementSibling : null;
			if (!helper) {
				helper = document.createElement('div');
				helper.className = 'muted annual-helper';
				helper.style.fontSize = '.85rem';
				priceContainer.parentNode.insertBefore(helper, priceContainer.nextSibling);
			}
			helper.textContent = `Billed annually; 10% off (effective £${Math.round(totals.base / 12)}/mo)`;
		}
		
		// CTA enable/disable
		const btn = document.getElementById('plan-continue-btn');
		if (btn) {
			btn.disabled = false; // Always enabled with new pricing
			btn.setAttribute('aria-disabled', 'false');
		}
	}

		// Ensure plan view renders catalogue and summary
	function renderPlan(){
		// Update plan state first
		updatePlanState();
		
		// Handle active subscription display
		if (State.subscription?.active && State.subscription?.status === 'active') {
			// User has an active subscription - ensure plan tier is set correctly
			if (State.subscription.tier && State.subscription.tier !== State.plan.tier) {
				State.plan.tier = State.subscription.tier;
				HS.plan.tier = State.subscription.tier;
				save({'plan.tier': State.plan.tier});
				commit();
			}
			
			// Show active plan display
			updateActivePlanDisplay();
			
			// If in edit mode, allow plan changes
			if (HS.editMode) {
				renderNewPlanPage();
			} else {
				// Show active subscription with option to change
				renderNewTierGrid();
				updatePlanSummary();
			}
		} else {
			// No active subscription - show plan selection
			renderNewPlanPage();
		}
		
		// Always update the edit mode button text when rendering the plan page
		const updateBtn = document.querySelector('button[onclick="togglePlanEditMode()"]');
		if (updateBtn) {
			updateBtn.textContent = HS.editMode ? 'Cancel' : 'Update Plan';
			updateBtn.className = HS.editMode ? 'btn btn-secondary btn-small' : 'btn btn-secondary btn-small';
		}
	}
	// Legacy toggleBilling removed - using new pricing system
	function onCouponChange(){
		const v = document.getElementById('coupon-input').value.trim();
		State.coupon = v; save({coupon:v});
		updatePlanSummary();
	}
	
	function onEmployerCodeChange(){
		const v = document.getElementById('employer-code-input').value.trim();
		State.employerCode = v; save({employerCode:v});
		updatePlanSummary();
	}
	function onCrossSellChange(){
		const v = document.getElementById('cross-sell-select').value;
		State.crossSell.currentCategory = v; save({'crossSell.currentCategory':v});
		renderDashboardChips();
		renderCrossSellChips();
	}
	
	function renderCrossSellChips(){
		const cat = State.crossSell?.currentCategory || 'None';
		const slot = document.getElementById('cross-sell-nudge');
		if (!slot) return;
		if (cat==='None'){ slot.style.display='none'; return; }
		const chips = {
			'TRT':['Energy & mood','Sleep support','Coach accountability'],
			'Weight loss':['Hunger management','Sleep for appetite','Bloods for safety'],
			'Menopause':['Sleep & focus','Mood support','Bone health']
		}[cat] || [];
		slot.style.display='block';
		slot.innerHTML = `
			<strong>Add Healthspan as an add-on</strong>
			<div class="muted">We preselected a combo; you'll see savings.</div>
		`;
	}
	function applyCrossSell(){
		// Preselect for add-on
		const preset = ['coaching-lite','supplements','blood-tests','sleep-optimisation'];
		if (!State.plan.selectedIds) State.plan.selectedIds = [];
		preset.forEach(id=>{ if(!State.plan.selectedIds.includes(id)) State.plan.selectedIds.push(id); });
		save({'plan.selectedIds':State.plan.selectedIds});
		renderPlan();
		showToast('Add-on applied');
	}
	function dismissCrossSell(){ document.getElementById('cross-sell-nudge').style.display='none'; }

	// =============== REQUESTS (Services & Devices) ===============
	// SERVICE REQUESTS
	function requestServiceModal(){
		const categories = ["Men's health","Women's health","Metabolic","Mental wellbeing","Sleep","MSK/Physio","Diagnostics","Other"];
		return `
			<h3>Request a service</h3>
			<div class="form-group"><label>Title</label><input id="req-title" placeholder="e.g., Menopause support"></div>
			<div class="form-group"><label>Category</label><select id="req-cat">${categories.map(c=>`<option>${c}</option>`).join('')}</select></div>
			<div class="form-group"><label>Problem</label><textarea id="req-prob" rows="3" placeholder="Describe your need"></textarea></div>
			<div class="form-group"><label>Frequency</label>
				<select id="req-freq"><option>One-off</option><option>Monthly</option><option>Quarterly</option></select>
			</div>
			<div class="form-group"><label>Budget</label>
				<select id="req-bud"><option><£20</option><option>£20–£60</option><option>£60–£120</option><option>£120+</option></select>
			</div>
			<div class="form-group"><label>Email (optional)</label><input id="req-email" type="email" placeholder="you@example.com"></div>
			<label class="check-pill"><input type="checkbox" id="req-consent"> I consent to contact</label>
			<div style="display:flex; gap:.5rem; margin-top:.75rem">
				<button class="btn btn-small" onclick="submitServiceRequest()">Submit</button>
				<button class="btn-ghost btn-small" onclick="closeModal()">Cancel</button>
			</div>
			<hr style="margin:.75rem 0">
			<h4>My requests</h4>
			<div id="req-list"></div>
		`;
	}
	function submitServiceRequest(){
		const t = document.getElementById('req-title').value.trim();
		if(!t){ showToast('Title is required'); return; }
		const req = {
			id: 'req-'+Math.random().toString(36).slice(2,8),
			title: t,
			category: document.getElementById('req-cat').value,
			problem: document.getElementById('req-prob').value,
			frequency: document.getElementById('req-freq').value,
			budget: document.getElementById('req-bud').value,
			email: document.getElementById('req-email').value,
			consent: document.getElementById('req-consent').checked,
			status:'Under review'
		};
		State.requests.services.push(req); save({'requests.services':State.requests.services});
		renderRequestsList();
		// fuzzy match
		const match = Services.find(s=> s.name.toLowerCase().includes(t.toLowerCase().split(' ')[0]));
		if(match){
			const list=document.getElementById('req-list');
			const hint=document.createElement('div');
			hint.className='card';
			hint.innerHTML = `<div><strong>Closest we offer now:</strong> ${match.name} — £${match.price}/mo</div>
				<button class="btn btn-small" onclick="quickAddService('${match.id}')">Quick add</button>`;
			list.prepend(hint);
		}
		showToast('Request submitted');
	}
	function quickAddService(id){
		if (!State.plan.selectedIds) State.plan.selectedIds = [];
		if(!State.plan.selectedIds.includes(id)) State.plan.selectedIds.push(id);
		save({'plan.selectedIds':State.plan.selectedIds});
		closeModal(); Router.go('plan'); renderPlan();
	}
	function renderRequestsList(){
		const host = document.getElementById('req-list');
		if (!host) return;
		
		const services = State.requests?.services || [];
		host.innerHTML = services.length > 0 ? services.map(r=>`
			<div class="service-card"><strong>${r.title}</strong> <span class="muted">— ${r.status}</span>
				<div class="muted">${r.category} • ${r.frequency || ''} • ${r.budget || ''}</div>
			</div>
		`).join('') : '<small class="muted">No requests yet.</small>';
	}
	// DEVICE REQUESTS & BADGES
	function requestDeviceModal(){
		const brands = ['Polar','Whoop','Withings','Suunto','Coros'];
		return `
			<h3>Request another wearable</h3>
			<div class="checkbox-grid" id="dev-req-chips">
				${brands.map(b=>`<label class="check-pill" onclick="toggleDeviceReq('${b}', this)"><input type="checkbox"> ${b}</label>`).join('')}
			</div>
			<div class="form-group"><label>Other device</label><input id="dev-req-other" placeholder="Enter device name"></div>
			<div style="display:flex; gap:.5rem; margin-top:.75rem">
				<button class="btn btn-small" onclick="submitDeviceRequest()">Submit</button>
				<button class="btn-ghost btn-small" onclick="closeModal()">Cancel</button>
			</div>
			<div id="dev-req-list" style="margin-top:.75rem"></div>
		`;
	}
	const _deviceReqSel = new Set();
	function toggleDeviceReq(b, el){ const checked = !_deviceReqSel.has(b); if(checked) _deviceReqSel.add(b); else _deviceReqSel.delete(b); el.classList.toggle('selected', checked); }
	function submitDeviceRequest(){
		const other = document.getElementById('dev-req-other').value.trim();
		const list = Array.from(_deviceReqSel); if(other) list.push(other);
		
		if (list.length === 0) {
			showToast('Please select at least one device or enter a device name');
			return;
		}
		
		list.forEach(x=> State.deviceRequests.push({id:'dr-'+Math.random().toString(36).slice(2,6), brand:x}));
		save({deviceRequests:State.deviceRequests});
		
		// Show thank you message and close modal
		showToast('Thanks! We\'ll let you know when this device is added or your request is being reviewed.');
		closeModal();
		renderDeviceRequestsList();
		logEvent('device_requested',{list});
	}
	function renderDeviceRequestsList(){
		const host = document.getElementById('dev-req-list'); if(!host) return;
		host.innerHTML = State.deviceRequests.map(r=>`<span class="badge" style="background:var(--mint-50); color:var(--numan-teal); margin:.15rem">Requested: ${r.brand}</span>`).join('');
	}

	// =============== TRIAGE & GUARDRAILS ===============
	function cleanupAlertBanners(){
		// Remove any existing alert banners that might have been created by riskScan
		const containers = document.querySelectorAll('[data-view] .container');
		containers.forEach(container => {
			const alertBanners = container.querySelectorAll('.card');
			alertBanners.forEach(banner => {
				if (banner.innerHTML.includes('NHS 111/999') || 
					banner.innerHTML.includes('High resting HR detected') ||
					banner.innerHTML.includes('Message a clinician')) {
					banner.remove();
				}
			});
		});
	}

	function riskScan(){
		// Risk scanning disabled to remove NHS 111/999 warnings
		return;
	}
	
	function avg(a){ return a.reduce((x,y)=>x+y,0)/a.length; }

	// =============== REFERRAL, PARTNERSHIPS & CMS ===============
	function referModal(){
		const refCode = Math.random().toString(36).slice(2,8).toUpperCase();
		const link = `https://numan.com/healthspan?ref=${refCode}`;
		const conversions = State.referrals?.conversions || 0;
		const credits = State.referrals?.credits || 0;
		return `
			<h3>Refer a friend</h3>
			<p>Give £50, Get £50. Share your link:</p>
			<input id="ref-link" value="${link}" readonly>
			<div style="margin-top:.5rem">
				<button class="btn btn-small" onclick="copyReferral()">Copy link</button>
				<button class="btn-ghost btn-small" onclick="closeModal()">Close</button>
			</div>
			<div id="ref-stats" class="muted" style="margin-top:.5rem">
				<div>Conversions: ${conversions}</div>
				<div>Credits earned: £${credits}</div>
				<div>Your referral code: ${refCode}</div>
			</div>
		`;
	}
	function copyReferral(){
		const el=document.getElementById('ref-link'); el.select(); document.execCommand('copy');
		logEvent('referral_link_copied'); showToast('Link copied');
		// Note: Conversions and credits are tracked when someone actually subscribes using the referral link
	}
	function applyPartnerCode(){
		const v = document.getElementById('partner-code').value.trim().toUpperCase();
		if(/^EMP-\w{4}$/.test(v)){ State.partner.channel='employer'; State.partner.code=v; save({'partner.channel':State.partner.channel,'partner.code':v}); showToast('Employer code applied'); logEvent('code_applied',{v}); }
		else if(/^GYM-\w{4}$/.test(v)){ State.partner.channel='gym'; State.partner.code=v; save({'partner.channel':State.partner.channel,'partner.code':v}); showToast('Gym code applied'); logEvent('code_applied',{v}); }
		else if(v===''){ State.partner.channel=''; State.partner.code=''; save({'partner.channel':'','partner.code':''}); }
		updateCheckout();
	}

	// =============== CALENDAR & COACH CHAT ===============
	function initCalendar(){
		if(State.calendar.events.length===0){
			const t=new Date();
			State.calendar.events = [
				{id:1,title:'Blood test kit dispatch', date:new Date(t.getFullYear(), t.getMonth(), t.getDate()+3).toISOString(), time:'10:00'},
				{id:2,title:'Monthly check-in call', date:new Date(t.getFullYear(), t.getMonth(), t.getDate()+7).toISOString(), time:'16:00'},
				{id:3,title:'Progress review', date:new Date(t.getFullYear(), t.getMonth(), t.getDate()+14).toISOString(), time:'14:00'},
				{id:4,title:'Sleep CBT-I session', date:new Date(t.getFullYear(), t.getMonth(), t.getDate()+10).toISOString(), time:'19:00'},
				{id:5,title:'Nutrition consultation', date:new Date(t.getFullYear(), t.getMonth(), t.getDate()+21).toISOString(), time:'15:30'},
				{id:6,title:'Follow-up blood test', date:new Date(t.getFullYear(), t.getMonth(), t.getDate()+28).toISOString(), time:'09:00'},
				{id:7,title:'Health coaching session', date:new Date(t.getFullYear(), t.getMonth(), t.getDate()+35).toISOString(), time:'17:00'}
			];
			save({'calendar.events':State.calendar.events});
		}
		renderCalendar();
	}
	let _calMonth = new Date();
	function renderCalendar(){
		const monthEl = document.getElementById('calendar-month');
		const grid = document.getElementById('calendar-grid');
		
		// Check if elements exist
		if (!monthEl || !grid) {
			console.log('Calendar elements not found');
			return;
		}
		
		const y=_calMonth.getFullYear(), m=_calMonth.getMonth();
		monthEl.textContent = `${_calMonth.toLocaleString('en-GB',{month:'long'})} ${y}`;
		grid.innerHTML='';
		const weekdays = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
		weekdays.forEach(w=>{ const d=document.createElement('div'); d.className='calendar-weekday'; d.textContent=w; grid.appendChild(d); });
		const first = new Date(y,m,1).getDay(); const days = new Date(y,m+1,0).getDate();
		for(let i=0;i<first;i++) grid.appendChild(document.createElement('div'));
		const todayStr = new Date().toDateString();
		for(let d=1; d<=days; d++){
			const el=document.createElement('div'); el.className='calendar-day'; el.textContent=d;
			const date = new Date(y,m,d);
			if(date.toDateString()===todayStr) el.classList.add('today');
			
			// Check for both calendar events and assessments
			const hasEvent = State.calendar.events.some(e=> new Date(e.date).toDateString()===date.toDateString());
			const hasAssessment = State.assessments.some(a=> new Date(a.scheduledAt).toDateString()===date.toDateString());
			
			if(hasEvent || hasAssessment) el.classList.add('has-event');
			el.onclick = ()=> showDayEvents(date);
			grid.appendChild(el);
		}
		renderEventsList();
	}
	function renderEventsList(){
		const host=document.getElementById('calendar-events'); const now=Date.now();
		
		// Get upcoming calendar events
		const upcomingEvents = State.calendar.events.filter(e=> new Date(e.date).getTime()>=now).sort((a,b)=>new Date(a.date)-new Date(b.date));
		
		// Get upcoming assessments
		const upcomingAssessments = State.assessments.filter(a=> new Date(a.scheduledAt).getTime()>=now && a.optedIn).sort((a,b)=>new Date(a.scheduledAt)-new Date(b.scheduledAt));
		
		// Combine and sort all upcoming items
		const allUpcoming = [
			...upcomingEvents.map(e => ({...e, type: 'event'})),
			...upcomingAssessments.map(a => ({...a, type: 'assessment', date: a.scheduledAt, time: 'Scheduled'}))
		].sort((a,b)=>new Date(a.date)-new Date(b.date)).slice(0,5);
		
		host.innerHTML = allUpcoming.map(item=>{
			const isAssessment = item.type === 'assessment';
			const isCompleted = item.completed;
			const scheduledDate = new Date(item.date);
			const today = new Date();
			today.setHours(0, 0, 0, 0); // Reset time to start of day for accurate comparison
			const isDue = scheduledDate <= today;
			const canComplete = isAssessment && isDue && !isCompleted;
			
			return `
			<div class="service-card" style="display:flex; justify-content:space-between; align-items:center">
				<div>
					<strong>${item.title}</strong>
					${item.recommended? '<span class="badge" style="background:#fbbf24; margin-left:0.5rem">Recommended</span>':''}
					${item.completed? '<span class="badge" style="background:#10b981; color:#fff; margin-left:0.5rem">✓ Completed</span>':''}
					<div class="muted">${new Date(item.date).toLocaleDateString()} ${item.time ? '@ ' + item.time : ''}</div>
			</div>
				<div>
					${item.type === 'event' ? `<button class="btn-ghost btn-small" onclick="rescheduleEvent('${item.id}')">Reschedule</button>` : ''}
					${canComplete ? `<button class="btn btn-small" onclick="completeScheduledAssessment('${item.id}')">Complete</button>` : ''}
					${isAssessment && !isCompleted && !isDue ? `<button class="btn-ghost btn-small" disabled>Not due yet</button>` : ''}
				</div>
			</div>
		`}).join('') || '<small class="muted">No upcoming events or assessments.</small>';
	}
	function changeMonth(d){ _calMonth.setMonth(_calMonth.getMonth()+d); renderCalendar(); }
	function showDayEvents(date){
		const events = State.calendar.events.filter(e=> new Date(e.date).toDateString()===date.toDateString());
		const assessments = State.assessments.filter(a=> new Date(a.scheduledAt).toDateString()===date.toDateString());
		
		if(!events.length && !assessments.length) return;
		
		let content = `<h3>${date.toDateString()}</h3>`;
		
		if(events.length) {
			content += `<h4>Events</h4>${events.map(e=>`<div><strong>${e.title}</strong> — ${e.time}</div>`).join('')}`;
		}
		
		if(assessments.length) {
			content += `<h4>Assessments</h4>${assessments.map(a=>`<div><strong>${a.title}</strong> ${a.recommended? '<span class="badge" style="background:#fbbf24">Recommended</span>':''} ${a.completed? '<span class="badge" style="background:#10b981; color:#fff">✓ Completed</span>':''}</div>`).join('')}`;
		}
		
		content += `<div style="margin-top:.5rem"><button class="btn btn-small" onclick="closeModal()">Close</button></div>`;
		openModal('events', content);
	}
	function rescheduleEvent(id){
		const e = State.calendar.events.find(x=>String(x.id)===String(id)); if(!e) return;
		openModal('reschedule', `
			<h3>Reschedule: ${e.title}</h3>
			<div class="form-group"><label>Date</label><input id="rs-date" type="date" value="${new Date(e.date).toISOString().slice(0,10)}"></div>
			<div class="form-group"><label>Time</label><input id="rs-time" type="time" value="${e.time}"></div>
			<div class="form-group"><label>Reason</label><input id="rs-reason" placeholder="Optional"></div>
			<div style="display:flex; gap:.5rem">
				<button class="btn btn-small" onclick="confirmReschedule('${e.id}')">Confirm</button>
				<button class="btn-ghost btn-small" onclick="closeModal()">Cancel</button>
			</div>
		`);
	}
	function confirmReschedule(id){
		const d=document.getElementById('rs-date').value, t=document.getElementById('rs-time').value;
		const e = State.calendar.events.find(x=>String(x.id)===String(id)); if(!e||!d||!t) return;
		e.date = new Date(d).toISOString(); e.time = t;
		save({'calendar.events':State.calendar.events}); closeModal(); renderCalendar(); showToast('Event rescheduled'); logEvent('event_rescheduled',{id});
	}
	function addCoachSession(){
		openModal('add-session', `
			<h3>Add coach session</h3>
			<div style="background:#f0f9ff; border:1px solid #bae6fd; border-radius:8px; padding:1rem; margin-bottom:1rem">
				<div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.5rem">
					<strong style="color:#0369a1">£30 for 20 minutes</strong>
				</div>
				<div style="font-size:0.9rem; color:#0369a1">
					• Automatically billed when attended<br>
					• Cancellation refundable 24 hours in advance
				</div>
			</div>
			<div class="form-group"><label>Date</label><input id="session-date" type="date"></div>
			<div class="form-group"><label>Time</label><input id="session-time" type="time"></div>
			<div class="form-group"><label>Type</label>
				<select id="session-type">
					<option>Health coaching</option>
					<option>Nutrition review</option>
					<option>Exercise planning</option>
					<option>Sleep consultation</option>
				</select>
			</div>
			<div style="display:flex; gap:.5rem">
				<button class="btn btn-small" onclick="confirmAddSession()">Add Session</button>
				<button class="btn-ghost btn-small" onclick="closeModal()">Cancel</button>
			</div>
		`);
	}
	function confirmAddSession(){
		const d=document.getElementById('session-date').value, t=document.getElementById('session-time').value, type=document.getElementById('session-type').value;
		if(!d||!t) { showToast('Pick date/time'); return; }
		State.calendar.events.push({id:Date.now(), title:type, date:new Date(d).toISOString(), time:t});
		save({'calendar.events':State.calendar.events}); closeModal(); renderCalendar(); showToast('Coach session added');
		State.coach.messages.push({from:'coach', text:`Tentatively scheduled ${type} on ${new Date(d).toLocaleDateString()} at ${t}`});
		save({'coach.messages':State.coach.messages}); renderCoachMessages();
	}
	// Assessments
	function renderAssessments(){
		const host=document.getElementById('assessments-list');
		const today = new Date();
		
		// Show completed assessments with history
		const completedAssessments = State.assessments.filter(a => a.completed);
		const scheduledAssessments = State.assessments.filter(a => !a.completed);
		
		let html = '';
		
		// Show completed assessments with history
		if (completedAssessments.length > 0) {
			html += '<h4 style="margin:0 0 0.5rem 0; color:var(--ink-60)">Assessment History</h4>';
			html += completedAssessments.map(a => {
				const completedDate = new Date(a.completedAt || a.date || new Date());
				const hasScore = a.score !== undefined && a.score !== null;
				return `
					<div class="service-card" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem">
						<div>
							<strong>${a.title}</strong>
							<div class="muted">Completed: ${completedDate.toLocaleDateString()}</div>
							${hasScore ? `<div style="color:var(--numan-teal); font-weight:600">Score: ${a.score} (${a.band || 'N/A'})</div>` : ''}
						</div>
						<div>
							<button class="btn-ghost btn-small" onclick="viewAssessmentHistory('${a.id}')">View History</button>
							<button class="btn btn-small" onclick="repeatAssessment('${a.id}')">Repeat</button>
						</div>
					</div>
				`;
			}).join('');
		}
		
		// Show scheduled assessments
		if (scheduledAssessments.length > 0) {
			html += '<h4 style="margin:1rem 0 0.5rem 0; color:var(--ink-60)">Scheduled Assessments</h4>';
			html += scheduledAssessments.map(a=>{
				const scheduledDate = new Date(a.scheduledAt);
				const isDue = scheduledDate <= today;
				const isCompleted = a.completed;
				const isOptedIn = a.optedIn;
				
				// Allow completion if:
				// 1. Assessment is due and opted in, OR
				// 2. It's a clinical assessment (has a type that matches clinical assessments) and opted in
				const isClinicalAssessment = ['phq2', 'gad2', 'auditc', 'who5', 'isi'].includes(a.type);
				const canComplete = !isCompleted && isOptedIn && (isDue || isClinicalAssessment);
				
				return `
				<div class="service-card" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem">
				<div>
					<strong>${a.title}</strong> ${a.recommended? '<span class="badge" style="background:#fbbf24">Recommended</span>':''}
						<div class="muted">${scheduledDate.toLocaleDateString()} @ Scheduled</div>
					${!isCompleted ? '<div><label class="check-pill" onclick="toggleAssessmentOpt(\'' + a.id + '\', this)"><input type="checkbox" ' + (a.optedIn?'checked':'') + '> Opt-in</label></div>' : ''}
				</div>
					<div>
						${isCompleted ? 
							'<span class="badge" style="background:#10b981; color:#fff">Complete</span>' :
							canComplete ? 
								`<button class="btn btn-small" onclick="startClinicalAssessment('${a.type}')">Complete Now</button>` :
								!isOptedIn ?
									`<button class="btn-ghost btn-small" disabled>Opt-in required</button>` :
								`<button class="btn-ghost btn-small" disabled>Not due yet</button>`
						}
			</div>
				</div>
				`;
			}).join('');
		}
		
		host.innerHTML = html || '<p class="muted">No assessments yet. Complete some during onboarding to see your history here.</p>';
	}
	function toggleAssessmentOpt(id, el){
		const a=State.assessments.find(x=>x.id===id); if(!a) return; a.optedIn = !a.optedIn; el.classList.toggle('selected', a.optedIn);
		save({'assessments':State.assessments});
	}
	
	function startClinicalAssessment(assessmentType) {
		console.log('startClinicalAssessment called with:', assessmentType);
		
		// Find the assessment definition
		const assessmentDef = Assessments.find(a => a.type === assessmentType);
		if (assessmentDef) {
			console.log('Found clinical assessment definition:', assessmentDef);
			startAssessment(assessmentDef);
		} else {
			console.log('Clinical assessment definition not found for:', assessmentType);
			showToast('Assessment not found');
		}
	}
	function addSuggestedAssessment(){
		openModal('add-assessment', `
			<h3>Add Assessment</h3>
			<p class="muted">Choose from suggested assessments or clinical questionnaires to add to your schedule.</p>
			
			<!-- Suggested Assessments -->
			<div style="margin-bottom:2rem">
				<h4>Suggested Assessments</h4>
				<div class="assessment-option" onclick="addQuickAssessment('metabolic-panel')" style="display:flex; justify-content:space-between; align-items:center; padding:1rem; border:1px solid var(--mint-50); border-radius:8px; margin-bottom:0.5rem; cursor:pointer; transition:all 0.2s ease">
					<div>
						<strong>Metabolic Panel</strong>
						<div class="muted" style="font-size:0.9rem">Comprehensive blood work for health optimization</div>
					</div>
					<button class="btn btn-small">Add</button>
				</div>
				<div class="assessment-option" onclick="addQuickAssessment('hormone-panel')" style="display:flex; justify-content:space-between; align-items:center; padding:1rem; border:1px solid var(--mint-50); border-radius:8px; margin-bottom:0.5rem; cursor:pointer; transition:all 0.2s ease">
					<div>
						<strong>Hormone Panel</strong>
						<div class="muted" style="font-size:0.9rem">Testosterone, cortisol, and key hormones</div>
					</div>
					<button class="btn btn-small">Add</button>
				</div>
			</div>
			
			<!-- Clinical Assessments Accordion -->
			<div class="collapsible" style="border:1px solid var(--mint-50); border-radius:8px; background:white">
				<div class="collapsible-header" onclick="toggleClinicalAssessmentsAccordion(this)" style="display:flex; justify-content:space-between; align-items:center; padding:1rem; cursor:pointer; border-bottom:1px solid var(--mint-50)">
					<div>
						<h4 style="margin:0; font-size:1.1rem; color:var(--ink)"><strong>Clinical Questionnaires</strong></h4>
						<div class="muted" style="font-size:0.9rem">Quick health screenings and assessments</div>
					</div>
					<span style="font-size:1.2rem; color:var(--ink-40); transition:transform 0.2s ease">▼</span>
				</div>
				<div class="collapsible-content" style="display:none; padding:1rem">
					${renderClinicalAssessmentOptions()}
				</div>
			</div>
			
			<div style="margin-top:1.5rem; text-align:right">
				<button class="btn btn-secondary" onclick="closeModal()">Close</button>
			</div>
		`);
	}
	
	function renderClinicalAssessmentOptions(){
		const clinicalAssessments = [
			{id: 'phq2', title: 'Mood Check (PHQ-2)', description: 'Quick screening for depression symptoms', questions: '2 questions • 1 minute'},
			{id: 'gad2', title: 'Anxiety Check (GAD-2)', description: 'Quick screening for anxiety symptoms', questions: '2 questions • 1 minute'},
			{id: 'auditc', title: 'Alcohol Use (AUDIT-C)', description: 'Brief alcohol consumption screening', questions: '3 questions • 1 minute'},
			{id: 'who5', title: 'Well-being (WHO-5)', description: 'General well-being and life satisfaction', questions: '5 questions • 2 minutes'},
			{id: 'isi', title: 'Sleep Assessment (ISI)', description: 'Insomnia severity screening', questions: '7 questions • 2 minutes'}
		];
		
		return clinicalAssessments.map(assessment => {
			const alreadyScheduled = State.assessments?.some(a => a.type === assessment.id);
			
			return `
				<div class="assessment-option" onclick="${alreadyScheduled ? '' : `addClinicalAssessment('${assessment.id}')`}" style="display:flex; justify-content:space-between; align-items:center; padding:1rem; border:1px solid var(--mint-50); border-radius:8px; margin-bottom:0.5rem; cursor:${alreadyScheduled ? 'default' : 'pointer'}; transition:all 0.2s ease; opacity:${alreadyScheduled ? '0.6' : '1'}">
					<div>
						<strong>${assessment.title}</strong>
						<div class="muted" style="font-size:0.9rem">${assessment.description}</div>
						<div class="muted" style="font-size:0.8rem">${assessment.questions}</div>
					</div>
					<div>
						${alreadyScheduled ? 
							'<span class="badge" style="background:#10b981; color:#fff">Already Scheduled</span>' : 
							'<button class="btn btn-small">Add</button>'
						}
					</div>
				</div>
			`;
		}).join('');
	}
	
	function addQuickAssessment(type){
		const assessments = {
			'metabolic-panel': {title: 'Metabolic Panel', description: 'Comprehensive blood work for health optimization'},
			'hormone-panel': {title: 'Hormone Panel', description: 'Testosterone, cortisol, and key hormones'}
		};
		
		const assessment = assessments[type];
		if (!assessment) return;
		
		const a = {
			id: 'ass-' + Math.random().toString(36).slice(2,6), 
			title: assessment.title, 
			recommended: false, 
			optedIn: true, 
			scheduledAt: new Date(Date.now() + 7 * 864e5).toISOString()
		};
		
		State.assessments.push(a); 
		save({'assessments': State.assessments}); 
		renderAssessments();
		closeModal();
		showToast(`${assessment.title} added to your schedule`);
	}
	
	function addClinicalAssessment(assessmentId){
		const clinicalAssessments = {
			'phq2': {title: 'Mood Check (PHQ-2)', description: 'Quick screening for depression symptoms'},
			'gad2': {title: 'Anxiety Check (GAD-2)', description: 'Quick screening for anxiety symptoms'},
			'auditc': {title: 'Alcohol Use (AUDIT-C)', description: 'Brief alcohol consumption screening'},
			'who5': {title: 'Well-being (WHO-5)', description: 'General well-being and life satisfaction'},
			'isi': {title: 'Sleep Assessment (ISI)', description: 'Insomnia severity screening'}
		};
		
		const assessment = clinicalAssessments[assessmentId];
		if (!assessment) return;
		
		const a = {
			id: 'ass-' + Math.random().toString(36).slice(2,6), 
			title: assessment.title,
			type: assessmentId,
			recommended: true, 
			optedIn: true, 
			scheduledAt: new Date(Date.now() + 3 * 864e5).toISOString()
		};
		
		State.assessments.push(a); 
		save({'assessments': State.assessments}); 
		renderAssessments();
		closeModal();
		showToast(`${assessment.title} added to your schedule`);
	}
	
	function toggleClinicalAssessmentsAccordion(header) {
		const content = header.nextElementSibling;
		const arrow = header.querySelector('span');
		
		if (!content || !arrow) return;
		
		const isVisible = content.style.display !== 'none';
		
		if (isVisible) {
			// Close the accordion
			content.style.display = 'none';
			arrow.textContent = '▼';
			arrow.style.transform = 'rotate(0deg)';
			header.setAttribute('aria-expanded', 'false');
		} else {
			// Open the accordion
			content.style.display = 'block';
			arrow.textContent = '▲';
			arrow.style.transform = 'rotate(0deg)';
			header.setAttribute('aria-expanded', 'true');
		}
	}
	
	function updateSignInOutButton() {
		const signInButton = document.getElementById('nav-signin');
		if (!signInButton) return;
		
		const hasActiveSubscription = State.subscription?.active && State.subscription?.status === 'active';
		
		if (hasActiveSubscription) {
			signInButton.textContent = 'Sign out';
			signInButton.onclick = handleSignOut;
		} else {
			signInButton.textContent = 'Sign in';
			signInButton.onclick = handleSignIn;
		}
	}
	
	function handleSignInOut() {
		const hasActiveSubscription = State.subscription?.active && State.subscription?.status === 'active';
		
		if (hasActiveSubscription) {
			handleSignOut();
		} else {
			handleSignIn();
		}
	}
	
	function handleSignIn() {
		openModal('signin');
	}
	
	function handleSignOut() {
		// Reset subscription state
		State.subscription = {active: false, plan: null, startDate: null};
		save({'subscription': State.subscription});
		
		// Update navigation locks
		updateNavLocks();
		
		// Update the sign in/out button
		updateSignInOutButton();
		
		// Show confirmation
		showToast('Signed out successfully');
		
		// Navigate to landing page
		Router.go('landing');
	}
	function completeScheduledAssessment(id){
		const assessment = State.assessments.find(a => a.id === id);
		if (!assessment) return;
		
		// Mark as completed with completion date
		assessment.completed = true;
		assessment.completedAt = new Date().toISOString();
		
		// Create next assessment based on frequency
		const now = new Date();
		let nextDate = new Date(now);
		
		switch(assessment.frequency) {
			case 'weekly':
				nextDate.setDate(now.getDate() + 7);
				break;
			case 'monthly':
				nextDate.setMonth(now.getMonth() + 1);
				break;
			case 'quarterly':
				nextDate.setMonth(now.getMonth() + 3);
				break;
		}
		
		// Add new assessment
		const newAssessment = {
			id: assessment.id + '-' + Date.now(),
			title: assessment.title,
			recommended: assessment.recommended,
			optedIn: assessment.optedIn,
			scheduledAt: nextDate.toISOString(),
			frequency: assessment.frequency,
			completed: false
		};
		
		State.assessments.push(newAssessment);
		save({'assessments':State.assessments});
		
		// Update dashboard assessment cards immediately
		finishAssessment(assessment.type, assessment.score || 0, assessment.band || 'Complete', []);
		
		renderAssessments();
		showToast('Assessment completed — great work! Next one scheduled.');
	}

	// Coach chat
	function toggleCoachChat(){ 
		// Check subscription before opening chat
		if (!State.subscription?.active) {
			showToast('To message a health coach, you need an active subscription to our health plan');
			return;
		}
		document.getElementById('coach-panel').classList.toggle('open');
		// Update plan info when opening chat
		updateCoachPlanInfo();
	}

	function updateCoachPlanInfo() {
		const planInfoEl = document.getElementById('coach-plan-info');
		if (!planInfoEl) return;
		
		// Get current plan details
		const currentPlanTier = State.subscription?.tier || State.plan.tier || 'Base';
		const plan = MODEL.plans[currentPlanTier];
		
		if (!plan) {
			planInfoEl.innerHTML = '<div style="text-align:center; color:var(--ink-60); font-size:0.9rem">No active plan</div>';
			return;
		}
		
		// Calculate remaining minutes for this month
		const now = new Date();
		const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
		const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
		const daysInMonth = endOfMonth.getDate();
		const daysPassed = now.getDate();
		const daysRemaining = daysInMonth - daysPassed;
		
		// Calculate used minutes (simplified - in real app this would come from actual usage data)
		const usedMinutes = Math.floor((daysPassed / daysInMonth) * plan.coachingMinutesPerMonth * 0.3); // Assume 30% usage
		const remainingMinutes = Math.max(0, plan.coachingMinutesPerMonth - usedMinutes);
		
		// Calculate remaining GP consults
		const usedConsults = Math.floor((now.getMonth() / 12) * plan.gpConsultsPerYear * 0.2); // Assume 20% usage
		const remainingConsults = Math.max(0, plan.gpConsultsPerYear - usedConsults);
		
		planInfoEl.innerHTML = `
			<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem">
				<div style="font-size:0.9rem; font-weight:600; color:var(--ink)">${currentPlanTier} Plan</div>
				<div style="font-size:0.8rem; color:var(--ink-60)">This month</div>
			</div>
			
			<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.75rem">
				<div style="display:flex; align-items:center; gap:0.5rem">
					<div style="width:8px; height:8px; background:var(--numan-teal); border-radius:50%"></div>
					<span style="font-size:0.85rem; color:var(--ink-80)">Coaching minutes</span>
				</div>
				<span style="font-size:0.85rem; font-weight:600; color:var(--numan-teal)">${remainingMinutes} remaining</span>
			</div>
			
			<div style="display:flex; gap:0.5rem">
				<button class="btn btn-small" onclick="openGPBookingModal()" style="flex:1; background:var(--numan-teal); color:white; border:none; padding:0.5rem; border-radius:6px; font-size:0.8rem; font-weight:600">
					Book GP Appointment
				</button>
				<div style="display:flex; align-items:center; gap:0.25rem; padding:0.5rem; background:white; border-radius:6px; border:1px solid #e5e7eb; font-size:0.8rem; color:var(--ink-60)">
					<span>${remainingConsults} consults left</span>
				</div>
			</div>
		`;
	}

	function openGPBookingModal() {
		// Check if user has remaining GP consults
		const currentPlanTier = State.subscription?.tier || State.plan.tier || 'Base';
		const plan = MODEL.plans[currentPlanTier];
		
		if (!plan) {
			showToast('No active plan found');
			return;
		}
		
		// Calculate remaining GP consults
		const now = new Date();
		const usedConsults = Math.floor((now.getMonth() / 12) * plan.gpConsultsPerYear * 0.2);
		const remainingConsults = Math.max(0, plan.gpConsultsPerYear - usedConsults);
		
		if (remainingConsults <= 0) {
			showToast('No GP consultations remaining this year. Consider upgrading your plan.');
			return;
		}
		
		openModal('gp-booking', `
			<h3>Book GP Appointment</h3>
			<p>Schedule a consultation with one of our qualified GPs.</p>
			
			<div style="background:var(--mint-50); padding:1rem; border-radius:8px; margin:1rem 0; border-left:4px solid var(--numan-teal)">
				<div style="font-weight:600; color:var(--numan-teal); margin-bottom:0.5rem">Your Plan Includes:</div>
				<div style="font-size:0.9rem; color:var(--ink-80)">
					• ${plan.gpConsultsPerYear} GP consultations per year<br>
					• ${remainingConsults} consultations remaining this year<br>
					• 15-minute consultation slots
				</div>
			</div>
			
			<div class="form-group">
				<label>Preferred Date</label>
				<input type="date" id="gp-date" min="${new Date().toISOString().split('T')[0]}">
			</div>
			
			<div class="form-group">
				<label>Preferred Time</label>
				<select id="gp-time">
					<option value="">Select time...</option>
					<option value="09:00">9:00 AM</option>
					<option value="10:00">10:00 AM</option>
					<option value="11:00">11:00 AM</option>
					<option value="14:00">2:00 PM</option>
					<option value="15:00">3:00 PM</option>
					<option value="16:00">4:00 PM</option>
				</select>
			</div>
			
			<div class="form-group">
				<label>Reason for consultation</label>
				<select id="gp-reason">
					<option value="">Select reason...</option>
					<option value="general">General health check</option>
					<option value="symptoms">Discuss symptoms</option>
					<option value="medication">Medication review</option>
					<option value="results">Test results review</option>
					<option value="other">Other</option>
				</select>
			</div>
			
			<div style="display:flex; gap:0.75rem; margin-top:1.5rem">
				<button class="btn btn-primary" onclick="bookGPAppointment()">Book Appointment</button>
				<button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
			</div>
		`);
	}

	function bookGPAppointment() {
		const date = document.getElementById('gp-date').value;
		const time = document.getElementById('gp-time').value;
		const reason = document.getElementById('gp-reason').value;
		
		if (!date || !time || !reason) {
			showToast('Please fill in all fields');
			return;
		}
		
		// In a real app, this would make an API call to book the appointment
		showToast('GP appointment booked successfully! You will receive a confirmation email shortly.');
		closeModal();
		
		// Update remaining consults (simplified)
		const currentPlanTier = State.subscription?.tier || State.plan.tier || 'Base';
		const plan = MODEL.plans[currentPlanTier];
		if (plan) {
			// In a real app, this would be tracked in a separate appointments/usage system
			logEvent('gp_appointment_booked', {date, time, reason, plan: currentPlanTier});
		}
		
		// Refresh the coach plan info to show updated remaining consults
		updateCoachPlanInfo();
	}

	function updateCoachButtonVisibility() {
		const coachButton = document.querySelector('.coach-button');
		if (coachButton) {
			coachButton.style.display = State.subscription?.active ? 'flex' : 'none';
		}
	}
	function sendCoachMessage(){
		// Check subscription before sending message
		if (!State.subscription?.active) {
			showToast('To message a health coach, you need an active subscription to our health plan');
			return;
		}
		
		const inp=document.getElementById('coach-input'); 
		const msg=inp.value.trim(); 
		if(!msg) return;

		const now = new Date();
		const timeStr = now.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });

		// Add user message with timestamp
		State.coach.messages.push({
			from: 'user', 
			text: msg, 
			timestamp: timeStr,
			date: now.toISOString()
		}); 
		save({'coach.messages':State.coach.messages});
		renderCoachMessages(); 
		inp.value='';

		// Simulate coach response with varied responses and delay
		const coachResponses = [
			"That's great to hear! Keep up the good work.",
			"I'm here to support you. Let me know if you need any adjustments to your plan.",
			"Excellent progress! Your dedication is really showing in your metrics.",
			"Thanks for sharing that. I'll make a note and we can discuss it in our next session.",
			"That's exactly the kind of positive change we want to see. Well done!",
			"I appreciate you reaching out. Let's focus on consistency this week.",
			"Great question! I'll send you some resources to help with that.",
			"Your commitment to your health journey is inspiring. Keep it up!",
			"I can see you're making real progress. Let's build on this momentum.",
			"Thanks for the update. I'm here whenever you need support."
		];
		
		const response = coachResponses[Math.floor(Math.random() * coachResponses.length)];
		const responseTime = 1000 + Math.random() * 2000; // 1-3 second delay
		
		setTimeout(() => { 
			const responseTimestamp = new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
			State.coach.messages.push({
				from: 'coach', 
				text: response, 
				timestamp: responseTimestamp,
				date: new Date().toISOString()
			}); 
			save({'coach.messages':State.coach.messages}); 
			renderCoachMessages(); 
		}, responseTime);
		
		logEvent('coach_message_sent');
	}
	function renderCoachMessages(){
		const host=document.getElementById('coach-messages');
		if(State.coach.messages.length===0){
			State.coach.messages=[{
				from:'coach', 
				text:"Hi! I'm here to support your health journey. How can I help today?",
				timestamp: new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" }),
				date: new Date().toISOString()
			}];
		}
		host.innerHTML = State.coach.messages.map(m => {
			const timestamp = m.timestamp || new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
			const senderName = m.from === 'coach' ? 'Dr. Sarah (Your Health Coach)' : 'You';
			
			return `
				<div class="coach-message ${m.from === 'user' ? 'user' : ''}">
					<div class="message-header">
						<strong>${senderName}</strong>
						<span class="muted">${timestamp}</span>
					</div>
					<div class="message-content">${m.text}</div>
				</div>
			`;
		}).join('');
		host.scrollTop = host.scrollHeight;
	}

	// =============== COACH CHAT FUNCTIONS ===============
	function appendCoachMessage(text, from = "coach") {
		const host = document.getElementById('coach-messages');
		if (!host) return;
		
		const now = new Date();
		const timeStr = now.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
		
		State.coach.messages.push({
			from: from,
			text: text,
			timestamp: timeStr,
			date: now.toISOString()
		});
		save({'coach.messages': State.coach.messages});
		renderCoachMessages();
	}

	// =============== CHECKOUT ===============
	function populateDemoCheckoutData() {
		// Populate user details with demo data based on gender
		const isFemale = State.user.sex === 'female';
		const firstName = isFemale ? 'Jane' : 'James';
		const email = isFemale ? 'jane.smith@example.com' : 'james.smith@example.com';
		
		const demoData = {
			firstname: firstName,
			lastname: 'Smith',
			email: email,
			phone: '+44 7123 456789',
			card: '4532 1234 5678 9012',
			expiry: '12/26',
			cvc: '123'
		};

		// Fill in the form fields
		const firstnameEl = document.getElementById('checkout-firstname');
		const lastnameEl = document.getElementById('checkout-lastname');
		const emailEl = document.getElementById('checkout-email');
		const phoneEl = document.getElementById('checkout-phone');
		const cardEl = document.getElementById('checkout-card');
		const expiryEl = document.getElementById('checkout-expiry');
		const cvcEl = document.getElementById('checkout-cvc');

		if (firstnameEl) firstnameEl.value = demoData.firstname;
		if (lastnameEl) lastnameEl.value = demoData.lastname;
		if (emailEl) emailEl.value = demoData.email;
		if (phoneEl) phoneEl.value = demoData.phone;
		if (cardEl) cardEl.value = demoData.card;
		if (expiryEl) expiryEl.value = demoData.expiry;
		if (cvcEl) cvcEl.value = demoData.cvc;

		// Also check the consent checkboxes
		const consentEls = document.querySelectorAll('input[type="checkbox"]');
		consentEls.forEach(el => el.checked = true);
		
		// Show a toast to indicate demo data was filled
		showToast('Demo data filled for testing purposes');
	}
	
	function clearFirstMonthSelections() {
		// Clear all first month selections
		HS.firstMonth.labs = [];
		HS.firstMonth.supplements = [];
		HS.firstMonth.coaching = null;
		HS.firstMonth.lab = null;
		
		// Clear State.plan.firstMonthPicks as well
		State.plan.firstMonthPicks = { labs: [], supplements: [], coaching: null };
		
		// Save the cleared state
		commit();
		save({'plan.firstMonthPicks': State.plan.firstMonthPicks});
		
		// Show a toast
		showToast('First month selections cleared');
		
		// Log the cleared state
		console.log('First month selections cleared:', {
			hsFirstMonth: HS.firstMonth,
			stateFirstMonthPicks: State.plan.firstMonthPicks
		});
	}

	function loadCheckoutSummary(){
		// Populate demo data for checkout form
		populateDemoCheckoutData();
		
		// Use State.plan.firstMonthPicks as the source of truth for checkout summary
		// This ensures we show the user's actual selections that were saved when they left the build-first-month page
		const firstMonthPicks = State.plan.firstMonthPicks || {
			labs: HS.firstMonth?.labs || [],
			supplements: HS.firstMonth?.supplements || [],
			coaching: HS.firstMonth?.coaching || null
		};
		
		// Debug logging to verify correct data is being used
		console.log('💰 loadCheckoutSummary - Checkout summary loading with:', {
			firstMonthPicks,
			hsFirstMonth: HS.firstMonth,
			stateFirstMonthPicks: State.plan.firstMonthPicks,
			planTier: HS.plan.tier,
			statePlanTier: State.plan.tier,
			labIds: firstMonthPicks.labs,
			supplementIds: firstMonthPicks.supplements,
			coachingId: firstMonthPicks.coaching,
			areEqual: {
				labs: JSON.stringify(firstMonthPicks.labs) === JSON.stringify(HS.firstMonth.labs),
				supplements: JSON.stringify(firstMonthPicks.supplements) === JSON.stringify(HS.firstMonth.supplements),
				coaching: firstMonthPicks.coaching === HS.firstMonth.coaching
			}
		});
		
		// Additional debugging to show what items will be displayed
		console.log('Items that will be displayed in checkout:');
		if (firstMonthPicks.labs && firstMonthPicks.labs.length > 0) {
			firstMonthPicks.labs.forEach(labId => {
				const lab = MODEL.catalog.labs.find(l => l.id === labId);
				console.log(`- Lab: ${lab?.name || labId}`);
			});
		}
		if (firstMonthPicks.supplements && firstMonthPicks.supplements.length > 0) {
			firstMonthPicks.supplements.forEach(suppId => {
				const supp = MODEL.catalog.supplements.find(s => s.id === suppId);
				console.log(`- Supplement: ${supp?.name || suppId}`);
			});
		}
		if (firstMonthPicks.coaching) {
			const coach = MODEL.catalog.coaching.find(c => c.id === firstMonthPicks.coaching);
			console.log(`- Coaching: ${coach?.name || firstMonthPicks.coaching}`);
		}
		
		// Additional debugging for the specific items the user mentioned
		if (firstMonthPicks.labs && firstMonthPicks.labs.length > 0) {
			console.log('Lab selections:', firstMonthPicks.labs.map(id => {
				const lab = MODEL.catalog.labs.find(l => l.id === id);
				return { id, name: lab?.name || 'Unknown' };
			}));
		}
		
		if (firstMonthPicks.supplements && firstMonthPicks.supplements.length > 0) {
			console.log('Supplement selections:', firstMonthPicks.supplements.map(id => {
				const supp = MODEL.catalog.supplements.find(s => s.id === id);
				return { id, name: supp?.name || 'Unknown' };
			}));
		}
		
		if (firstMonthPicks.coaching) {
			const coach = MODEL.catalog.coaching.find(c => c.id === firstMonthPicks.coaching);
			console.log('Coaching selection:', { id: firstMonthPicks.coaching, name: coach?.name || 'Unknown' });
		}
		
		// Use new HS state and quote system
		const q = quote(HS.plan.tier);
		const items = [];
		
		// Add plan with entitlements
		const plan = MODEL.plans[HS.plan.tier];
		items.push(`
			<div class="service-card" style="display:flex; justify-content:space-between; padding:1rem; border:2px solid var(--numan-teal); border-radius:8px; margin-bottom:1rem; background:var(--mint-50)">
				<div>
					<strong style="color:var(--numan-teal); font-size:1.1rem">${HS.plan.tier} Plan</strong>
					<div style="font-size:0.9rem; color:var(--ink-60); margin-top:0.5rem; line-height:1.4">
						<strong>Your monthly subscription includes:</strong><br>
						• ${plan.labCreditsPerYear} lab credit${plan.labCreditsPerYear > 1 ? 's' : ''} per year<br>
						• ${plan.supplementQuantityPerMonth} supplement${plan.supplementQuantityPerMonth > 1 ? 's' : ''} per month<br>
						• ${plan.coachingMinutesPerMonth} minutes of 1:1 coaching per month<br>
						• ${plan.gpConsultsPerYear} GP consultation${plan.gpConsultsPerYear > 1 ? 's' : ''} per year
					</div>
				</div>
				<div style="text-align:right">
					<div style="font-weight:700; font-size:1.2rem; color:var(--numan-teal)">${money(q.base)}${State.plan.billingCycle === 'annual' ? '/year' : '/mo'}</div>
					<div style="font-size:0.8rem; color:var(--ink-60)">subscription</div>
					${State.plan.billingCycle === 'annual' ? '<div style="font-size:0.7rem; color:var(--numan-teal); font-weight:600">Annual billing (10% OFF)</div>' : ''}
				</div>
			</div>
		`);
		
		// Add first month selections with clear categorization using actual selections
		let hasFirstMonthItems = false;
		
		// Lab Kit Section
		if (firstMonthPicks.labs && firstMonthPicks.labs.length > 0 && !HS.firstMonth.useLabLater) {
			hasFirstMonthItems = true;
			items.push(`
				<div style="margin-bottom:1rem">
					<h4 style="color:var(--ink); margin:0 0 0.5rem 0; font-size:1rem; font-weight:600">Lab Kit${firstMonthPicks.labs.length > 1 ? 's' : ''} (First Month)</h4>
			`);
			
			firstMonthPicks.labs.forEach(labId => {
				const lab = MODEL.catalog.labs.find(l => l.id === labId);
				if (lab) {
					items.push(`
						<div class="service-card" style="display:flex; justify-content:space-between; padding:0.75rem; border:1px solid #e5e7eb; border-radius:6px; background:white; margin-bottom:0.5rem">
							<div>
								<strong>${lab.name}</strong>
								<div style="font-size:0.85rem; color:var(--ink-60); margin-top:0.25rem">
									Uses ${lab.credits} lab credit${lab.credits > 1 ? 's' : ''} • At-home finger prick test
								</div>
							</div>
							<div style="text-align:right; color:var(--success); font-weight:600">Included</div>
						</div>
					`);
				}
			});
			
			items.push(`</div>`);
		}
		
		// Supplements Section
		if (firstMonthPicks.supplements && firstMonthPicks.supplements.length > 0) {
			hasFirstMonthItems = true;
			items.push(`
				<div style="margin-bottom:1rem">
					<h4 style="color:var(--ink); margin:0 0 0.5rem 0; font-size:1.2rem; font-weight:600">Supplements (First Month)</h4>
			`);
			
			firstMonthPicks.supplements.forEach(suppId => {
				const supp = MODEL.catalog.supplements.find(s => s.id === suppId);
				if (supp) {
					items.push(`
						<div class="service-card" style="display:flex; justify-content:space-between; padding:0.75rem; border:1px solid #e5e7eb; border-radius:6px; background:white; margin-bottom:0.5rem">
							<div>
								<strong>${supp.name}</strong>
								<div style="font-size:0.85rem; color:var(--ink-60); margin-top:0.25rem">
									30-day supply
								</div>
							</div>
							<div style="text-align:right; color:var(--success); font-weight:600">Included</div>
						</div>
					`);
				}
			});
			
			items.push(`</div>`);
		}
		
		// Coaching Section
		if (firstMonthPicks.coaching) {
			const coach = MODEL.catalog.coaching.find(c => c.id === firstMonthPicks.coaching);
			if (coach) {
				hasFirstMonthItems = true;
				items.push(`
					<div style="margin-bottom:1rem">
						<h4 style="color:var(--ink); margin:0 0 0.5rem 0; font-size:1.2rem; font-weight:600">Coaching Focus (First Month)</h4>
						<div class="service-card" style="display:flex; justify-content:space-between; padding:0.75rem; border:1px solid #e5e7eb; border-radius:6px; background:white">
							<div>
								<strong>${coach.name}</strong>
								<div style="font-size:0.85rem; color:var(--ink-60); margin-top:0.25rem">
									${plan.coachingMinutesPerMonth} minutes • 1:1 video call
								</div>
							</div>
							<div style="text-align:right; color:var(--success); font-weight:600">Included</div>
						</div>
					</div>
				`);
			}
		}
		
		// Add-ons Section
		const addonItems = [];
		Object.entries(HS.addons).forEach(([addonId, qty]) => {
			if (qty > 0) {
				const all = { ...MODEL.memberAddOns.tests, ...MODEL.memberAddOns.supplements, ...MODEL.memberAddOns.services };
				const addon = Object.values(all).find(x => x.id === addonId);
				if (addon) {
					addonItems.push(`
						<div class="service-card" style="display:flex; justify-content:space-between; padding:0.75rem; border:1px solid #e5e7eb; border-radius:6px; background:white; margin-bottom:0.5rem">
							<div>
								<strong>${addon.title}</strong>
								<div style="font-size:0.85rem; color:var(--ink-60); margin-top:0.25rem">
									Quantity: ${qty} • ${addon.category || 'Add-on service'}
								</div>
							</div>
							<div style="text-align:right; color:var(--ink); font-weight:600">${money(addon.price * qty)}</div>
						</div>
					`);
				}
			}
		});
		
		if (addonItems.length > 0) {
			items.push(`
				<div style="margin-bottom:1rem">
					<h4 style="color:var(--ink); margin:0 0 0.5rem 0; font-size:1.2rem; font-weight:600">➕ Add-ons</h4>
					${addonItems.join('')}
				</div>
			`);
		}
		
		// If no first month items, show a message
		if (!hasFirstMonthItems) {
			items.push(`
				<div style="padding:1rem; background:#f9fafb; border:1px solid #e5e7eb; border-radius:6px; margin-bottom:1rem; text-align:center">
					<p style="margin:0; color:var(--ink-60)">No first month items selected yet</p>
					<small style="color:var(--ink-40)">Go back to "Build your first month" to select lab kit, supplements, and coaching focus</small>
				</div>
			`);
		}
		
		document.getElementById('checkout-summary').innerHTML = items.join('') || '<p class="muted">No items selected</p>';
		
		// Update totals
		const totalsEl = document.getElementById('checkout-totals');
		if (totalsEl) {
			totalsEl.innerHTML = `
				<div style="display:flex; justify-content:space-between; margin-bottom:0.5rem">
					<span>Plan (${HS.plan.tier})</span>
					<span>${money(q.base)}</span>
				</div>
				${q.addOns > 0 ? `
					<div style="display:flex; justify-content:space-between; margin-bottom:0.5rem">
						<span>Add-ons</span>
						<span>${money(q.addOns)}</span>
					</div>
				` : ''}
				<div style="display:flex; justify-content:space-between; margin-bottom:0.5rem">
					<span style="text-decoration: line-through; color: #9ca3af;">Fees (1.9% + £0.20)</span>
					<span style="text-decoration: line-through; color: #9ca3af;">${money(q.fees)}</span>
				</div>
				${q.ship > 0 ? `
					<div style="display:flex; justify-content:space-between; margin-bottom:0.5rem">
						<span style="text-decoration: line-through; color: #9ca3af;">Shipping (kit)</span>
						<span style="text-decoration: line-through; color: #9ca3af;">${money(q.ship)}</span>
					</div>
				` : ''}
				<div style="display:flex; justify-content:space-between; margin-bottom:0.5rem; padding:0.5rem; background:var(--mint-50); border-radius:6px; font-size:0.9rem; color:var(--numan-teal)">
					<span>Fees & shipping included with subscription</span>
				</div>
				<div style="display:flex; justify-content:space-between; margin-bottom:0.5rem; padding-top:0.5rem; border-top:1px solid #e5e7eb">
					<strong>Total today</strong>
					<strong style="color:var(--numan-teal)">${money(q.base + q.addOns)}</strong>
				</div>
				<div style="display:flex; justify-content:space-between; margin-bottom:0.5rem">
					<span>From next month</span>
					<span>${money(q.base)}</span>
				</div>
			`;
		}
	}
	
	function loadNewCheckoutSummary() {
		const totals = calcCartTotal(State);
		const plan = MODEL.plans[State.plan.tier];
		
		let items = `
			<div class="service-card" style="display:flex; justify-content:space-between">
				<div>
					<div style="font-weight:600">${State.plan.tier} Plan</div>
					<div style="font-size:0.9rem; color:var(--ink-60)">
						${plan.labCreditsPerYear} lab credits/year • ${plan.supplementQuantityPerMonth} supplement${plan.supplementQuantityPerMonth > 1 ? 's' : ''}/month • ${plan.coachingMinutesPerMonth} min coaching/month • ${plan.gpConsultsPerYear} GP consults/year
					</div>
				</div>
				<div>${money(totals.base)}/month</div>
			</div>
		`;
		
		// Add selected add-ons
		State.plan.selectedAddOns.forEach(addOnId => {
			// Find addon in memberAddOns
			let addOn = null;
			for (const category of Object.values(MODEL.memberAddOns)) {
				for (const addon of Object.values(category)) {
					if (addon.id === addOnId) {
						addOn = addon;
						break;
					}
				}
				if (addOn) break;
			}
			items += `
				<div class="service-card" style="display:flex; justify-content:space-between">
					<div>${addOn.name}</div>
					<div>${money(addOn.price)}/month</div>
				</div>
			`;
		});
		
		// Add cart items (add-ons, etc.)
		Object.entries(State.cart?.addOns || {}).forEach(([key, item]) => {
			if (item.qty > 0) {
				items += `
					<div class="service-card" style="display:flex; justify-content:space-between">
						<div>${item.label || key} × ${item.qty}</div>
						<div>${money(item.qty * item.unitPrice)}</div>
					</div>
				`;
			}
		});
		
		// Add fees and shipping
		if (totals.fees > 0) {
			items += `
				<div class="service-card" style="display:flex; justify-content:space-between">
					<div>Payment fees</div>
					<div>${money(totals.fees)}</div>
				</div>
			`;
		}
		
		if (totals.shipping > 0) {
			items += `
				<div class="service-card" style="display:flex; justify-content:space-between">
					<div>Shipping</div>
					<div>${money(totals.shipping)}</div>
				</div>
			`;
		}
		
		document.getElementById('checkout-summary').innerHTML = `
			<h3>Order summary</h3>
			${items}
			<div style="border-top:1px solid var(--border); padding-top:1rem; margin-top:1rem; display:flex; justify-content:space-between; font-weight:600; font-size:1.1rem">
				<div>Total</div>
				<div>${money(totals.total)}</div>
			</div>
		`;
		updateCheckout();
	}
	function updateCheckout(){
		const annual = State.billing==='annual';
		const coupon = State.coupon||'';
		const q = priceQuote({selectedIds:State.plan.selectedIds, annual, coupon});
		const intro = document.getElementById('intro-price-toggle')?.checked;
		const effective = annual? q.effectiveMonthly: q.monthlyTotal;
		const month1 = intro? 49: effective;
		const el = document.getElementById('checkout-totals');
		if (!el) return;
		el.innerHTML = `
			<div style="display:flex; justify-content:space-between"><span>Plan ${annual? '(annual -10%)':''}</span><strong>£${q.breakdown[0].amount}/mo</strong></div>
			${q.breakdown[1].amount ? `<div style="display:flex; justify-content:space-between"><span>Add-ons</span><strong>£${q.breakdown[1].amount}/mo</strong></div>`:''}
			<div style="border-top:1px solid var(--border); margin-top:.5rem; padding-top:.5rem; display:flex; justify-content:space-between"><span>Total</span><strong>£${q.monthlyTotal}/mo</strong></div>
			<div class="muted">Month 1 preview: £${month1} ${intro? '(intro price)':''}</div>
		`;
	}
	function toggleCheckoutBilling(){
		const checkbox = document.getElementById('checkout-billing');
		State.billing = checkbox.checked ? 'annual' : 'monthly';
		save({billing:State.billing});
		updateCheckout();
	}
	
	function initializeToggles(){
		// Initialize billing toggles to reflect current state
		const checkoutToggle = document.getElementById('checkout-billing');
		
		if (checkoutToggle) {
			checkoutToggle.checked = State.billing === 'annual';
		}
		
		// Initialize peer comparison toggle
		const peerToggle = document.getElementById('peer-compare');
		if (peerToggle) {
			peerToggle.checked = State.settings.peerComparison || false;
			// Show/hide comparison based on current state
			const comparison = document.getElementById('peer-comparison');
			if (comparison) {
				comparison.style.display = peerToggle.checked ? 'block' : 'none';
				if (peerToggle.checked) {
					renderPeerComparison();
				}
			}
		}

		// Initialize bio inputs toggle
		const bioInputsToggle = document.getElementById('bio-inputs-toggle');
		if (bioInputsToggle) {
			bioInputsToggle.checked = State.settings.bioInputsOpen || false;
			// Show/hide content based on current state
			const content = document.getElementById('bio-inputs-content');
			if (content) {
				content.style.display = bioInputsToggle.checked ? 'block' : 'none';
			}
		}
		
		// Initialize onboarding peer comparison toggle
		const obPeerToggle = document.getElementById('ob-peer-compare');
		if (obPeerToggle) {
			obPeerToggle.checked = State.settings.peerComparison || false;
			// Show/hide comparison based on current state
			const obComparison = document.getElementById('ob-peer-comparison');
			if (obComparison) {
				obComparison.style.display = obPeerToggle.checked ? 'block' : 'none';
				if (obPeerToggle.checked) {
					renderOnboardingPeerComparison();
				}
			}
		}
	}
	function confirmCheckout() {
		// Check if consent checkbox is checked
		const consentChecked = document.getElementById('consent-checkbox')?.checked;
		if (!consentChecked) {
			showToast('Please confirm you understand this is an educational service');
			return;
		}
		
		// Call the existing completeCheckout function
		completeCheckout();
	}

	function completeCheckout(){
		// Validate account creation fields
		const firstnameEl = document.getElementById('checkout-firstname');
		const lastnameEl = document.getElementById('checkout-lastname');
		const emailEl = document.getElementById('checkout-email');
		const phoneEl = document.getElementById('checkout-phone');
		const termsEl = document.getElementById('checkout-terms');
		
		const firstname = firstnameEl ? firstnameEl.value.trim() : '';
		const lastname = lastnameEl ? lastnameEl.value.trim() : '';
		const email = emailEl ? emailEl.value.trim() : '';
		const phone = phoneEl ? phoneEl.value.trim() : '';
		const terms = termsEl ? termsEl.checked : false;
		
		if (!firstname || !lastname || !email || !phone) {
			showToast('Please fill in all required account fields');
			return;
		}
		
		if (!terms) {
			showToast('Please agree to the Terms of Service and Privacy Policy');
			return;
		}
		
		// Save account information
		State.user.firstName = firstname;
		State.user.lastName = lastname;
		State.user.email = email;
		State.user.phone = phone;
		const marketingCheckbox = document.getElementById('checkout-marketing');
		State.user.marketing = marketingCheckbox ? marketingCheckbox.checked : false;
		save({'user.profile': State.user});
		
		// Activate subscription
		State.subscription = {
			active: true,
			status: 'active',
			tier: State.plan.tier,
			selectedAddOns: State.plan.selectedAddOns || [],
			billingCycle: State.plan.billingCycle || 'monthly',
			startDate: new Date().toISOString()
		};
		
		// Store plan pricing
		State.plan.pricing = calcCartTotal(State);
		
		// Reset edit mode to lock the plan
		HS.editMode = false;
		commit();
		
		save({subscription: State.subscription, 'plan.pricing': State.plan.pricing});
		
		// Check for referral code in URL and track conversion
		const urlParams = new URLSearchParams(window.location.search);
		const refCode = urlParams.get('ref');
		if (refCode) {
			// In a real app, this would track the conversion for the referrer
			// For demo purposes, we'll simulate a conversion
			State.referrals.conversions += 1;
			State.referrals.credits += 50;
			save({referrals: State.referrals});
			logEvent('referral_conversion', {refCode, amount: 50});
		}
		
		logEvent('checkout_confirmed',{ids:State.plan.selectedIds, pricing:State.plan.pricing});
		
		// Grant XP for completing checkout
		grantXPForAction('checkout_completed', 50);
		
		// Unlock all navigation after successful checkout
		State.navUnlocked = {
			wearables: true,
			bioAge: true,
			plan: true,
			dashboard: true,
			streaks: true,
			account: true
		};
		updateNavLocks();
		updateSignInOutButton(); // Update sign in/out button after subscription activation
		save({'navUnlocked': State.navUnlocked});
		
		// Get plan details for the success modal
		const planTier = State.plan.tier || State.subscription.tier || 'Base';
		const plan = MODEL.plans[planTier];
		const planName = planTier;
		const planPrice = plan ? money(plan.price) : '£49';
		
		// Show welcome message only for first-time checkout
		if (State.firstTimeCheckout) {
		openModal('success', `
			<h3>🎉 Welcome to Numan, ${firstname}!</h3>
			<p>Your account has been created and your <strong>${planName} Plan</strong> is now active.</p>
			
			<div style="background:var(--mint-50); padding:1rem; border-radius:8px; margin:1rem 0; border-left:4px solid var(--numan-teal)">
				<h4 style="margin:0 0 0.5rem 0; color:var(--numan-teal)">Your ${planName} Plan includes:</h4>
				<ul style="margin:0; padding-left:1.2rem">
					<li>${plan?.labCreditsPerYear || 2} lab credits per year</li>
					<li>${plan?.supplementQuantityPerMonth || 2} supplement${plan?.supplementQuantityPerMonth !== 1 ? 's' : ''} per month</li>
					<li>${plan?.coachingMinutesPerMonth || 30} minutes coaching per month</li>
					<li>${plan?.gpConsultsPerYear || 2} GP consultations per year</li>
				</ul>
			</div>
			
			<h4 style="margin:1rem 0 0.5rem 0; color:var(--ink)">What happens next:</h4>
			<ul style="margin:0 0 1rem 0; padding-left:1.2rem">
				<li><strong>Your schedule, assessments, and health tracking</strong> are now available on your dashboard</li>
				<li><strong>Check out Streaks & Goals</strong> to start building healthy habits and earn rewards</li>
				<li>Welcome pack arriving in 3 days</li>
				<li>First coach call scheduled this week</li>
				<li>Blood test kit shipped if applicable</li>
			</ul>
			
			<div style="display:flex; gap:0.75rem; margin-top:1.5rem">
				<button class="btn btn-primary" onclick="closeModal(); Router.go('dashboard')">Go to Dashboard</button>
				<button class="btn btn-secondary" onclick="closeModal(); Router.go('streaks')">View Streaks & Goals</button>
			</div>
		`);
			
			// Mark as no longer first-time checkout
			State.firstTimeCheckout = false;
			save({'firstTimeCheckout': false});
		} else {
			// Show simple confirmation for returning users
			showToast('Checkout completed successfully!');
			Router.go('dashboard');
		}
	}

	// =============== OUTCOMES & EVENTS ===============
	function renderDashboard(){
		// Ensure we have the correct plan tier
		ensureCorrectPlanTier();
		
		// Update dashboard plan display with actual checked out plan
		const dashboardPlan = document.getElementById('dashboard-plan');
		if (dashboardPlan) {
			// Use the actual plan from subscription if available, otherwise current plan
			const actualPlan = State.subscription?.tier || State.plan.tier || 'Standard';
			dashboardPlan.textContent = actualPlan;
		}
		
		// plan chips
		renderDashboardChips();
		
		// Wearables section moved to streaks page
		
		// Update streaks and quests data
		updateStreaks();
		getActiveQuests();
		
		// age widgets
		if(State.biologicalAge){ 
			const bio = State.biologicalAge;
			const age = State.user.age||35;
			document.getElementById('dashboard-age').textContent=bio; 
			
			// Only draw the gauge - it already displays the age difference
			drawGauge('dashboard-gauge', bio, age); 
		}
		// Initialize calendar with a small delay to ensure DOM is ready
		setTimeout(() => {
			// Reset calendar to current month
			_calMonth = new Date();
			initCalendar();
		}, 100);
		renderAssessments();
		renderCoachMessages();
		updateCoachButtonVisibility();
		// Enhanced triage/guardrails
		renderRiskFlags();
		renderTrends();
		// riskScan(); // Disabled to remove NHS 111/999 messages
		cleanupAlertBanners(); // Clean up any existing alert banners
	}
	
	function renderRiskFlags() {
		const flags = checkSafetyFlags(State);
		const card = document.getElementById('risk-flags-card');
		const content = document.getElementById('risk-flags-content');
		
		if (flags.length === 0) {
			card.style.display = 'none';
			return;
		}
		
		card.style.display = 'block';
		content.innerHTML = flags.map(flag => `
			<div style="background:${flag.severity === 'high' ? '#fef2f2' : '#fef3c7'}; border:1px solid ${flag.severity === 'high' ? '#fecaca' : '#fde68a'}; padding:1rem; border-radius:8px; margin-bottom:0.75rem">
				<div style="display:flex; align-items:flex-start; gap:0.75rem">
					<div style="color:${flag.severity === 'high' ? '#dc2626' : '#d97706'}; font-size:1.25rem">⚠️</div>
					<div style="flex:1">
						<div style="font-weight:600; color:${flag.severity === 'high' ? '#dc2626' : '#d97706'}; margin-bottom:0.25rem">${flag.message}</div>
						<div style="display:flex; gap:0.5rem; margin-top:0.5rem">
							<button class="btn btn-small" onclick="handleRiskFlagAction('${flag.type}', '${flag.action}')">${flag.action}</button>
						</div>
					</div>
				</div>
			</div>
		`).join('');
	}
	function renderTrends() {
		const trends = [];
		
		// Check logging completeness (simplified - would need real data)
		const loggingCompleteness = calculateLoggingCompleteness();
		if (loggingCompleteness < 40) {
			trends.push({
				type: 'logging',
				title: 'Logging Activity',
				status: 'declining',
				message: 'Your logging completeness is below 40% over the last 14 days',
				trend: 'down',
				value: `${Math.round(loggingCompleteness)}%`
			});
		}
		
		// Check steps drop (simplified)
		const stepsDrop = calculateStepsDrop();
		if (stepsDrop > 25) {
			trends.push({
				type: 'activity',
				title: 'Daily Steps',
				status: 'declining',
				message: `Steps dropped ${Math.round(stepsDrop)}% vs prior week`,
				trend: 'down',
				value: `${Math.round(stepsDrop)}%`
			});
		}
		
		// Check sleep trends
		const sleepTrend = calculateSleepTrend();
		if (sleepTrend < 6) {
			trends.push({
				type: 'sleep',
				title: 'Sleep Quality',
				status: 'poor',
				message: 'Average sleep duration below 6 hours this week',
				trend: 'down',
				value: `${sleepTrend.toFixed(1)}h`
			});
		}
		
		const card = document.getElementById('trends-card');
		const content = document.getElementById('trends-content');
		
		if (trends.length === 0) {
			card.style.display = 'none';
			return;
		}
		
		card.style.display = 'block';
		content.innerHTML = `
			<div style="display:grid; gap:1rem">
				${trends.map(trend => `
					<div style="background:white; border:1px solid #e5e7eb; border-radius:12px; padding:1.25rem; border-left:4px solid ${trend.status === 'declining' ? '#ef4444' : '#fbbf24'}">
						<div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:0.75rem">
							<div>
								<h4 style="margin:0 0 0.25rem 0; font-size:1rem; font-weight:600; color:#1f2937">${trend.title}</h4>
								<p style="margin:0; color:#6b7280; font-size:0.9rem">${trend.message}</p>
							</div>
							<div style="text-align:right">
								<div style="font-size:1.25rem; font-weight:700; color:${trend.status === 'declining' ? '#ef4444' : '#fbbf24'}">${trend.value}</div>
								<div style="font-size:0.75rem; color:#6b7280">${trend.trend === 'down' ? '↓ Declining' : '↑ Improving'}</div>
							</div>
						</div>
						<div style="display:flex; gap:0.5rem; flex-wrap:wrap">
							<button class="btn btn-small" onclick="bookQuickCall()" style="background:var(--numan-teal); border:none; color:white; padding:0.5rem 1rem; border-radius:6px; font-size:0.85rem">Get Support</button>
							<button class="btn-ghost btn-small" onclick="resetGoals()" style="border:1px solid #d1d5db; color:#374151; padding:0.5rem 1rem; border-radius:6px; background:white; font-size:0.85rem">Adjust Goals</button>
						</div>
					</div>
				`).join('')}
			</div>
		`;
	}
	
	function calculateLoggingCompleteness() {
		// Simplified calculation - in real app would check actual logging data
		return Math.random() * 100; // Random for demo
	}
	
	function calculateStepsDrop() {
		// Simplified calculation - in real app would compare actual step data
		return Math.random() * 50; // Random for demo
	}
	
	function calculateSleepTrend() {
		// Simplified calculation - in real app would check actual sleep data
		return 5 + Math.random() * 3; // Random between 5-8 hours for demo
	}
	
	function handleRiskFlagAction(type, action) {
		if (action.includes('NHS 111/999')) {
			showToast('Please contact NHS 111/999 for urgent concerns');
		} else if (action.includes('Message a clinician')) {
			checkSubscriptionAndMessage();
		} else {
			showToast(`Action: ${action}`);
		}
		logEvent('risk_flag_action', {type, action});
	}
	
	function bookQuickCall() {
		showToast('Quick call booking feature would open here');
		logEvent('quick_call_requested');
	}
	
	function resetGoals() {
		showToast('Goals reset feature would open here');
		logEvent('goals_reset_requested');
	}
	
	function snoozeAlerts() {
		showToast('Alerts snoozed for 7 days');
		logEvent('alerts_snoozed');
	}
	
	function renderDashboardChips(){
		const host=document.getElementById('dashboard-chips');
		host.innerHTML = `<span class="badge" style="background:var(--mint-50); color:var(--numan-teal)">Healthspan</span>` +
			(State.crossSell.currentCategory && State.crossSell.currentCategory!=='None'? ` <span class="badge" style="background:#e0f2fe; color:#0369a1">${State.crossSell.currentCategory}</span>`: '');
	}
	function drawDashboardMiniAge(){
		const c=document.getElementById('dashboard-age-chart'); if(!c) return; const ctx=c.getContext('2d'); const W=c.width,H=c.height,p=30; ctx.clearRect(0,0,W,H);
		const pts = State.ageHistory; if(!pts.length) return;
		const vals = pts.map(p=>p.biological); const max=Math.max(...vals)+1, min=Math.min(...vals)-1, R=max-min;
		
		// Draw grid lines
		ctx.strokeStyle='#f3f4f6'; ctx.lineWidth=1;
		for(let i=0;i<=4;i++){
			const y = p + (H-2*p)/4*i;
			ctx.beginPath(); ctx.moveTo(p,y); ctx.lineTo(W-p,y); ctx.stroke();
		}
		
		// Draw y-axis labels
		ctx.fillStyle='#6b7280'; ctx.font='10px sans-serif'; ctx.textAlign='right';
		for(let i=0;i<=4;i++){
			const value = max - (R/4)*i;
			const y = p + (H-2*p)/4*i;
			const label = key === 'steps' ? Math.round(value).toLocaleString() : value.toFixed(1);
			ctx.fillText(label + units[key], p-8, y+3);
		}
		
		// Draw x-axis labels (weeks)
		ctx.textAlign='center';
		for(let i=0;i<pts.length;i++){
			const x = p + (i/(pts.length-1))*(W-2*p);
			ctx.fillText(`W${i+1}`, x, H-p+12);
		}
		
		// Draw the line
		ctx.strokeStyle='#1ecfc0'; ctx.lineWidth=3; ctx.beginPath();
		vals.forEach((v,i)=>{ const x=p+(i/(vals.length-1))*(W-2*p); const y=H-p-((v-min)/R)*(H-2*p); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
		ctx.stroke();
		
		// Draw data points
		ctx.fillStyle='#1ecfc0';
		vals.forEach((v,i)=>{ const x=p+(i/(vals.length-1))*(W-2*p); const y=H-p-((v-min)/R)*(H-2*p); ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill(); });
	}

	// =============== MODALS ===============
	
	function updateBiologicalAgeModalContent() {
		const currentAge = State.user.age || 33;
		const bioAge = State.biologicalAge || 31;
		const delta = bioAge - currentAge;
		
		// Update the dynamic content
		const chronologicalEl = document.getElementById('modal-chronological-age');
		const biologicalEl = document.getElementById('modal-biological-age');
		const differenceEl = document.getElementById('modal-difference');
		
		if (chronologicalEl) chronologicalEl.textContent = `${currentAge.toFixed(1)} years`;
		if (biologicalEl) biologicalEl.textContent = `${bioAge.toFixed(1)} years`;
		if (differenceEl) {
			differenceEl.textContent = `${delta > 0 ? '+' : ''}${delta.toFixed(1)} years`;
			differenceEl.style.color = delta > 0 ? '#ef4444' : delta < 0 ? '#10b981' : '#6b7280';
		}
		
		// Update the detailed driver breakdown
		updateDriverBreakdownInModal();
	}
	
	function updateDriverBreakdownInModal() {
		// Get current user data to match biological age calculation
		const age = State.user.age || 33;
		const height = State.user.height || 175;
		const weight = State.user.weight || 80;
		const waist = State.user.waist || 90;
		
		// Get wearable data
		let steps = 0;
		if (State.wearables.series.steps && State.wearables.series.steps.length > 0) {
			const last7Steps = State.wearables.series.steps.slice(-7);
			steps = last7Steps.reduce((sum, val) => sum + val, 0) / last7Steps.length;
		}
		
		let sleep = 0;
		if (State.wearables.series.sleep && State.wearables.series.sleep.length > 0) {
			const last7Sleep = State.wearables.series.sleep.slice(-7);
			sleep = last7Sleep.reduce((sum, val) => sum + val, 0) / last7Sleep.length;
		}
		
		let rhr = 0;
		if (State.wearables.series.rhr && State.wearables.series.rhr.length > 0) {
			const last7RHR = State.wearables.series.rhr.slice(-7);
			rhr = last7RHR.reduce((sum, val) => sum + val, 0) / last7RHR.length;
		}
		
		const activity = State.onboarding.answers.activityMins || 0;
		
		// Use the same computeDrivers function that calculates biological age for consistency
		const { delta, drivers } = computeDrivers(age, height, weight, waist, steps, sleep, rhr, activity);
		
		// Update the calculation grid with consistent driver impacts
		const calculationGrid = document.querySelector('.calculation-grid');
		if (calculationGrid) {
			calculationGrid.innerHTML = drivers.map(driver => {
				const impactColor = driver.value > 0 ? '#ef4444' : driver.value < 0 ? '#10b981' : '#6b7280';
				const impactSign = driver.value > 0 ? '+' : '';
				return `
					<div class="calculation-item">
						<span>${driver.name}</span>
						<span class="badge" style="background: ${impactColor}">
							${impactSign}${driver.value}y
						</span>
					</div>
				`;
			}).join('');
			
			// Add total at the end using the delta from computeDrivers (same as biological age calculation)
			calculationGrid.innerHTML += `
				<div class="calculation-item" style="border-top: 1px solid #e5e7eb; margin-top: 0.5rem; padding-top: 0.5rem; font-weight: 600;">
					<span>Total Impact</span>
					<span class="badge" style="background: ${delta > 0 ? '#ef4444' : delta < 0 ? '#10b981' : '#6b7280'}">
						${delta > 0 ? '+' : ''}${delta.toFixed(1)}y
					</span>
				</div>
			`;
		}
	}

	function openBiologicalAgeExplanation() {
		updateBiologicalAgeModalContent();
		const modal = document.getElementById('bio-age-explanation-modal');
		if (modal) {
			modal.classList.add('active');
			// Focus the modal content for accessibility
			const modalContent = modal.querySelector('.modal-content');
			if (modalContent) modalContent.focus();
		}
	}
	
	function openBiologicalAgeExplanationFromPopup() {
		// Close the current modal first
		closeModal();
		// Small delay to ensure the modal closes before opening the new one
		setTimeout(() => {
			openBiologicalAgeExplanation();
		}, 100);
	}
	
	function openBiologicalAgePopup() {
		if (!State.biologicalAge) {
			showToast('Complete onboarding to see your biological age');
			return;
		}
		
		const age = State.user.age || 35;
		const bioAge = State.biologicalAge;
		const delta = bioAge - age;
		
		// Create the popup content
		const content = `
			<div style="position: relative;">
				<button onclick="closeModal()" style="position: absolute; top: -10px; right: -10px; background: #f3f4f6; border: none; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px; color: #6b7280; z-index: 10;" title="Close">
					×
				</button>
			</div>
			
			<div style="text-align:center; padding:1rem 0">
				<div id="popup-bio-gauge-container" style="max-width: 300px; margin: 0 auto;">
					<!-- Gauge will be rendered here -->
				</div>
				<div style="margin-top: 1rem;">
					<div style="font-size: 2.5rem; font-weight: 800; color: var(--numan-teal); margin-bottom: 0.5rem;">
						${bioAge.toFixed(1)}
					</div>
					<div style="font-size: 1.1rem; font-weight: 600; color: var(--orange);">
						${delta >= 0 ? '+' : ''}${delta.toFixed(1)} vs your age
					</div>
				</div>
			</div>
			
			<div style="margin-top:1.5rem">
				<div id="popup-drivers-list" style="margin-bottom:1.5rem">
					<!-- Driver chips will be rendered here -->
				</div>
				
				<div style="display:flex; gap:0.75rem; justify-content:center; margin-top:1.5rem">
					<button class="btn btn-secondary" onclick="openBiologicalAgeExplanationFromPopup()" style="font-size:0.9rem; padding:0.5rem 1rem">
						How we calculate this
					</button>
				</div>
			</div>
		`;
		
		// Open the modal
		openModal('biological-age-popup', content);
		
		// Render the gauge and driver chips after the modal is open
		setTimeout(() => {
			renderBiologicalAgeGauge(age, bioAge, 'popup-bio-gauge-container');
			renderDriverChips('popup-drivers-list');
		}, 100);
	}
	
	function saveOb(){ 
		save({'onboarding.answers':State.onboarding.answers}); 
	}
	
	function updateAlcoholUnits(){
		// Get all drink quantities
		const beerQty = Math.max(0, Number(document.getElementById('beer-quantity')?.value || 0));
		const wineQty = Math.max(0, Number(document.getElementById('wine-quantity')?.value || 0));
		const spiritsQty = Math.max(0, Number(document.getElementById('spirits-quantity')?.value || 0));
		
		// Calculate total units (beer: 2.3, wine: 2.1, spirits: 1.0)
		const totalUnits = (beerQty * 2.3) + (wineQty * 2.1) + (spiritsQty * 1.0);
		
		// Save to state
		setOb('beerQuantity', beerQty);
		setOb('wineQuantity', wineQty);
		setOb('spiritsQuantity', spiritsQty);
		setOb('alcoholUnits', totalUnits);
		
		// Update display
		const totalUnitsEl = document.getElementById('alcohol-total-units');
		const statusEl = document.getElementById('alcohol-status');
		
		if (totalUnitsEl) {
			totalUnitsEl.textContent = totalUnits.toFixed(1);
		}
		
		if (statusEl) {
			if (totalUnits <= 14) {
				statusEl.textContent = 'Within recommended limits';
				statusEl.style.background = 'var(--mint-50)';
				statusEl.style.color = 'var(--numan-teal)';
			} else if (totalUnits <= 21) {
				statusEl.textContent = 'Above recommended limits';
				statusEl.style.background = '#fef3c7';
				statusEl.style.color = '#d97706';
			} else {
				statusEl.textContent = 'High risk consumption';
				statusEl.style.background = '#fef2f2';
				statusEl.style.color = '#dc2626';
			}
		}
		
		saveOb();
	}	
	
	// Initialize alcohol display on page load
	function initAlcoholDisplay() {
		updateAlcoholUnits();
	}
	
	function toggleSmokingDetails(show) {
		const details = document.getElementById('smoking-details');
		if (details) {
			details.style.display = show ? 'block' : 'none';
		}
	}
	
	function updateQuitReadinessLabel(value) {
		const labels = {
			'1': '1 - Not ready',
			'2': '2 - Thinking about it',
			'3': '3 - Preparing',
			'4': '4 - Ready to act',
			'5': '5 - Taking action'
		};
		const labelEl = document.getElementById('quit-readiness-label');
		if (labelEl) {
			labelEl.textContent = labels[value] || '2 - Thinking about it';
		}
	}
	Object.assign(window, { setOb, saveOb, updateAlcoholUnits, initAlcoholDisplay, toggleSmokingDetails, updateQuitReadinessLabel, showError, clearErrorsNearby });
	function openModal(type, content){
		// Handle assessment modal specifically
		if(type==='assessment'){
			const body = document.getElementById('assessment-body');
			if(body){
				body.innerHTML = content || '';
				document.getElementById('assessment-modal').classList.add('active');
				body.focus();
				// focus trap
				const focusable = body.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
				const first = focusable[0], last = focusable[focusable.length-1];
				body.onkeydown = (e)=>{ if(e.key!=='Tab'||!focusable.length) return; if(e.shiftKey && document.activeElement===first){ e.preventDefault(); last.focus(); } else if(!e.shiftKey && document.activeElement===last){ e.preventDefault(); first.focus(); } if(e.key==='Escape'){ closeModal(); } };
			}
			return;
		}
		
		const body=document.getElementById('modal-content');
		if(type==='signin'){
			body.innerHTML = `
				<h3>Sign in</h3>
				<div class="form-group"><label>Email</label><input type="email" placeholder="you@domain.com"></div>
				<div class="form-group"><label>Password</label><input type="password" placeholder="Password"></div>
				<button class="btn btn-small" onclick="closeModal(); showToast('Demo mode — no auth')">Sign in</button>
			`;
		}else if(type==='request-service'){
			body.innerHTML = requestServiceModal(); setTimeout(renderRequestsList,0);
		}else if(type==='request-device'){
			body.innerHTML = requestDeviceModal(); setTimeout(renderDeviceRequestsList,0);
		}else if(type==='manage-devices'){
			body.innerHTML = manageDevicesModal(); setTimeout(renderDeviceRequestsList,0);
		}else if(type==='message-clinician'){
			body.innerHTML = `
				<h3>Message a clinician</h3>
				<textarea id="clinician-msg" rows="4" placeholder="Describe your concern"></textarea>
				<div style="margin-top:.5rem"><button class="btn btn-small" onclick="submitClinicianMsg()">Send</button></div>
			`;
		}else if(type==='refer'){
			body.innerHTML = referModal();
		}else if(type==='nps'){
			body.innerHTML = `
				<h3>Feedback</h3>
				<div>How likely are you to recommend Numan? (0–10)</div>
				<input type="number" id="nps-score" min="0" max="10" value="${State.nps.score??''}">
				<div class="form-group"><label>Comments (optional)</label><textarea id="nps-comment">${State.nps.comment||''}</textarea></div>
				<div style="display:flex; gap:.5rem">
					<button class="btn btn-small" onclick="submitNPS()">Submit</button>
					<button class="btn-ghost btn-small" onclick="closeModal()">Close</button>
				</div>
			`;
		}else if(type==='report-issue'){
			body.innerHTML = `
				<h3>Report an issue</h3>
				<input id="issue-title" placeholder="Issue title">
				<textarea id="issue-desc" rows="4" placeholder="Describe the problem"></textarea>
				<div style="display:flex; gap:.5rem; margin-top:.5rem">
					<button class="btn btn-small" onclick="submitIssue()">Submit</button>
					<button class="btn-ghost btn-small" onclick="closeModal()">Cancel</button>
				</div>
			`;
		}else if(type==='reschedule'){
			body.innerHTML = `
				<h3>Request schedule change</h3>
				<div class="form-group"><label>What would you like to change?</label>
					<select id="change-type">
						<option value="assessment">Assessment timing</option>
						<option value="coaching">Coaching session</option>
						<option value="blood-test">Blood test appointment</option>
						<option value="other">Other</option>
					</select>
				</div>
				<div class="form-group"><label>Preferred new date/time</label><input id="new-datetime" type="datetime-local"></div>
				<div class="form-group"><label>Reason for change</label><textarea id="change-reason" rows="3" placeholder="Please explain why you need to reschedule..."></textarea></div>
				<div style="display:flex; gap:.5rem">
					<button class="btn btn-small" onclick="submitScheduleChange()">Submit request</button>
					<button class="btn-ghost btn-small" onclick="closeModal()">Cancel</button>
				</div>
			`;
		}else{
			body.innerHTML = content||'';
		}
		document.getElementById('modal').classList.add('active');
		body.focus();
		// focus trap
		const focusable = body.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
		const first = focusable[0], last = focusable[focusable.length-1];
		body.onkeydown = (e)=>{ if(e.key!=='Tab'||!focusable.length) return; if(e.shiftKey && document.activeElement===first){ e.preventDefault(); last.focus(); } else if(!e.shiftKey && document.activeElement===last){ e.preventDefault(); first.focus(); } if(e.key==='Escape'){ closeModal(); } };
	}
	function closeAssessmentModal() {
		document.getElementById('assessment-modal').classList.remove('active');
		// Clear current assessment state when modal is closed
		State.currentAssessment = null;
	}
	
	function closeModal(ev){ 
		if(!ev || ev.target.id==='modal'){ 
			document.getElementById('modal').classList.remove('active'); 
		}
		// Also close recommendations modal if clicking outside or on the modal itself
		if(!ev || ev.target.id==='recsModal'){ 
			document.getElementById('recsModal').classList.remove('active'); 
		}
		// Also close driver playbook modal if clicking outside or on the modal itself
		if(!ev || ev.target.id==='driver-playbook-modal'){ 
			document.getElementById('driver-playbook-modal').style.display = 'none'; 
		}
		// Also close assessment modal if clicking outside or on the modal itself
		if(!ev || ev.target.id==='assessment-modal'){ 
			closeAssessmentModal();
		}
		// Also close assessment history modal if clicking outside or on the modal itself
		if(!ev || ev.target.id==='assessment-history-modal'){ 
			const historyModal = document.getElementById('assessment-history-modal');
			if (historyModal) {
				historyModal.classList.remove('active');
				historyModal.remove();
			}
		}
		
		// Close any dynamically created modals (like assessment history modals)
		const activeModals = document.querySelectorAll('.modal.active');
		activeModals.forEach(modal => {
			// Only close if it's not one of the main modals we handle above
			if (!modal.id || !['modal', 'recsModal', 'driver-playbook-modal', 'assessment-modal'].includes(modal.id)) {
				modal.classList.remove('active');
				// Also remove from DOM if it was dynamically created
				if (modal.parentNode === document.body) {
					modal.remove();
				}
			}
		});
	}
	
	function closeDriverPlaybookModal() {
		document.getElementById('driver-playbook-modal').style.display = 'none';
	}
	
	function closeAssessmentHistoryModal() {
		const historyModal = document.getElementById('assessment-history-modal');
		if (historyModal) {
			historyModal.classList.remove('active');
			historyModal.remove();
		}
	}
	
	function closeAssessmentModal() {
		document.getElementById('assessment-modal').classList.remove('active');
	}
	function checkSubscriptionAndMessage(){
		if (!State.subscription.active) {
			openModal('subscription-required', `
				<h3>Subscription Required</h3>
				<p>To message a clinician, you need an active subscription to our health plan.</p>
				<div style="display:flex; gap:.5rem; margin-top:1rem">
					<button class="btn btn-small" onclick="closeModal(); Router.go('onboarding')">Continue onboarding</button>
					<button class="btn-ghost btn-small" onclick="closeModal()">Maybe later</button>
				</div>
			`);
			return;
		}
		openModal('message-clinician');
	}
	function submitClinicianMsg(){ 
		closeModal(); 
		showToast('Message sent! A clinician will get back to you within 24 hours.'); 
	}
	function submitScheduleChange(){
		const changeType = document.getElementById('change-type').value;
		const newDateTime = document.getElementById('new-datetime').value;
		const reason = document.getElementById('change-reason').value;
		
		if (!newDateTime || !reason.trim()) {
			showToast('Please fill in all required fields');
			return;
		}
		
		closeModal();
		showToast('Schedule change request submitted! We\'ll contact you to confirm the new time.');
		logEvent('schedule_change_requested', {changeType, newDateTime, reason});
	}

	// =============== NPS & ISSUES ===============
	function submitNPS(){
		const score = +document.getElementById('nps-score').value;
		const comment = document.getElementById('nps-comment').value;
		State.nps.score=score; State.nps.comment=comment; save({'nps.score':score,'nps.comment':comment}); logEvent('nps_submitted',{score});
		showToast('Thanks for your feedback'); closeModal();
	}
	function submitIssue(){
		const title=document.getElementById('issue-title').value.trim();
		const desc=document.getElementById('issue-desc').value.trim();
		if(!title){ showToast('Title required'); return; }
		State.issues.push({id:'iss-'+Math.random().toString(36).slice(2,6), title, desc, ts:Date.now()});
		save({'issues':State.issues}); logEvent('issue_reported',{title});
		showToast('Issue reported'); closeModal();
	}

	// =============== EVENTS HELPERS ===============
	function toggleAction(checkbox){ 
		const label = checkbox.closest('.check-pill');
		label.classList.toggle('selected', checkbox.checked); 
		showToast(checkbox.checked? 'Done!':'Undone'); 
	}

	// =============== NAVIGATION ===============
	function updateNavigationVisibility(){
		// Apply from State.navUnlocked directly
		const mapping = {
			'nav-wearables': State.navUnlocked?.wearables,
			'nav-plan': State.navUnlocked?.plan,
			'nav-dashboard': State.navUnlocked?.dashboard,
			'nav-streaks': State.navUnlocked?.streaks,
			'nav-account': State.navUnlocked?.account
		};
		
		// Debug logging
		console.log('updateNavigationVisibility called:', {
			navUnlocked: State.navUnlocked,
			mapping: mapping
		});
		
		Object.entries(mapping).forEach(([id, unlocked]) => {
			const link = document.getElementById(id);
			if (!link) {
				console.warn('Navigation link not found:', id);
				return;
			}
			console.log(`Setting ${id}: unlocked=${unlocked}, opacity=${unlocked ? '1' : '0.5'}, pointerEvents=${unlocked ? 'auto' : 'none'}`);
			link.style.opacity = unlocked ? '1' : '0.5';
			link.style.pointerEvents = unlocked ? 'auto' : 'none';
					const span = link.querySelector('span');
			if (span) span.style.display = unlocked ? 'none' : 'inline';
			
			console.log(`Navigation ${id}: unlocked=${unlocked}, pointerEvents=${link.style.pointerEvents}`);
		});
	}

	// Central nav lock/unlock function
	function updateNavLocks() {
		console.log('updateNavLocks called');
		// Initialize navUnlocked if it doesn't exist
		if (!State.navUnlocked) {
			State.navUnlocked = {
				wearables: false,
				bioAge: false,
				plan: false,
				dashboard: false,
				streaks: false,
				account: false
			};
		}
		
		// Check if user has completed checkout - if so, unlock everything
		// User must have both completed the personalised plan flow AND have an active subscription
		const hasPersonalisedPlan = State.plan.tier && (State.plan.selectedIds?.length > 0 || HS.plan.tier);
		const hasSubscribed = hasPersonalisedPlan && State.subscription?.active && State.subscription?.status === 'active';
		
		console.log('Navigation unlock check:', {
			hasPersonalisedPlan,
			hasSubscribed,
			planTier: State.plan.tier,
			selectedIds: State.plan.selectedIds,
			hsPlanTier: HS.plan.tier,
			subscriptionActive: State.subscription?.active,
			subscriptionStatus: State.subscription?.status
		});
		
		if (hasSubscribed) {
			// After checkout, unlock dashboard, streaks & goals, and account; keep plan accessible
			// Don't lock wearables and bioAge - keep them unlocked if they were already unlocked
			State.navUnlocked.plan = true;
			State.navUnlocked.dashboard = true;
			State.navUnlocked.streaks = true;
			State.navUnlocked.account = true;
		} else {
			// Reset locks but preserve wearables and bioAge if they were already unlocked
			const wearablesWasUnlocked = State.navUnlocked.wearables;
			const bioAgeWasUnlocked = State.navUnlocked.bioAge;
			
			State.navUnlocked.plan = false;
			State.navUnlocked.dashboard = false;
			State.navUnlocked.streaks = false; // Keep streaks locked until checkout completion
			State.navUnlocked.account = false;
			
			// Restore unlocked states if they were previously unlocked
			if (wearablesWasUnlocked) {
				State.navUnlocked.wearables = true;
			}
			if (bioAgeWasUnlocked) {
				State.navUnlocked.bioAge = true;
			}
			
			// Check onboarding progress to determine unlocks based on correct sequence:
			// 1. Homepage (what we treat) - always unlocked
			// 2. Consent - still only "what we treat" unlocked
			// 3. Goals - still only "what we treat" unlocked  
			// 4. Connect your wearables - wearables page now unlocked
			// 5-7. Lifestyle, Symptoms, Assessments - wearables remains unlocked
			// 8. Biological Age - biological age page now unlocked
			// 9. Existing Plans - biological age remains unlocked
			// 10. Preferences - biological age remains unlocked
			// 11. Select Your Plan - plan page unlocked, wearables and bio age get locked
			// 12-14. Build first month, Add-ons, Checkout - dashboard, streaks, account unlocked after checkout
			
			const currentStep = State.onboarding.currentStep || 0;
			const currentStepKey = OnboardingSteps[currentStep]?.key;
			
			// Step 3: Connect your wearables - unlock wearables page
			if (currentStep >= 3 || State.currentView === 'wearables') {
				State.navUnlocked.wearables = true;
			}
			
			// Step 7: Biological Age - unlock biological age page
			if (currentStep >= 7 || State.currentView === 'metabolic-age') {
				State.navUnlocked.bioAge = true;
			}
			
			// Always keep wearables and biological age unlocked once they've been unlocked
			// This prevents them from being re-locked during plan selection flow
			// Check if user has ever accessed these pages - if so, keep them unlocked
			if (State.navUnlocked.wearables || State.user?.hasAccessedWearables) {
				State.navUnlocked.wearables = true;
				State.user = State.user || {};
				State.user.hasAccessedWearables = true;
			}
			if (State.navUnlocked.bioAge || State.user?.hasAccessedBioAge) {
				State.navUnlocked.bioAge = true;
				State.user = State.user || {};
				State.user.hasAccessedBioAge = true;
			}
			
			// Step 8: Existing Plans - unlock plan page (keep wearables/bio age unlocked if already unlocked)
			if (currentStep >= 8 || State.currentView === 'plan' || State.onboarding.completed) {
				State.navUnlocked.plan = true;
				// Keep wearables and bio age unlocked if they were already unlocked
				// Don't lock them again once they've been unlocked
			}
			
			// Step 8+: Plan selection flow - keep plan unlocked and maintain unlocked status for wearables/bio age
			if (State.currentView === 'plan' || State.currentView === 'build-first-month' || State.currentView === 'addons') {
				State.navUnlocked.plan = true;
				// Keep wearables and bio age unlocked if they were already unlocked
				// Don't lock them again once they've been unlocked
			}
		}
		
		// Apply locks/unlocks to navigation elements using data-nav attributes
		const navItems = document.querySelectorAll('[data-nav]');
		navItems.forEach(item => {
			const navType = item.getAttribute('data-nav');
			let isUnlocked = false;
			
			// Map data-nav values to State.navUnlocked keys
			switch (navType) {
				case 'wearables':
					isUnlocked = State.navUnlocked.wearables;
					break;
				case 'plan':
					isUnlocked = State.navUnlocked.plan;
					break;
				case 'dashboard':
					isUnlocked = State.navUnlocked.dashboard;
					break;
				case 'streaks':
					isUnlocked = State.navUnlocked.streaks;
					break;
				case 'account':
					isUnlocked = State.navUnlocked.account;
					break;
			}
			
			// Apply lock state
			item.classList.toggle('locked', !isUnlocked);
			item.style.pointerEvents = isUnlocked ? 'auto' : 'none';
			item.setAttribute('aria-disabled', !isUnlocked ? 'true' : 'false');
			
			// Add/remove lock badge
			if (!isUnlocked) {
				// Check if lock badge already exists (either as .lock-badge or as a span with 🔒)
				const existingLockBadge = item.querySelector('.lock-badge') || item.querySelector('span');
				if (!existingLockBadge) {
					const lockBadge = document.createElement('span');
					lockBadge.className = 'lock-badge';
					lockBadge.textContent = ' 🔒';
					item.appendChild(lockBadge);
				} else if (existingLockBadge && !existingLockBadge.textContent.includes('🔒')) {
					// If there's a span but it doesn't have the lock emoji, add it
					existingLockBadge.textContent = ' 🔒';
				}
			} else {
				// Remove lock badge
				const lockBadge = item.querySelector('.lock-badge') || item.querySelector('span');
				if (lockBadge && lockBadge.textContent.includes('🔒')) {
					lockBadge.remove();
				}
			}
		});
		
		// Save nav state
		save({'navUnlocked': State.navUnlocked});
		
		// Update navigation visibility to ensure consistency
		updateNavigationVisibility();
		
		// Force update navigation visibility to ensure streaks is properly unlocked
		setTimeout(() => {
			updateNavigationVisibility();
		}, 100);
	}
	
	function setLock(selector, locked) {
		const el = document.querySelector(selector);
		if (!el) {
			console.warn('setLock: element not found for selector:', selector);
			return;
		}
		console.log('setLock:', selector, 'locked:', locked);
		el.classList.toggle('locked', locked);
		el.style.pointerEvents = locked ? 'none' : 'auto';
		el.setAttribute('aria-disabled', locked ? 'true' : 'false');
		
		if (locked) {
			el.style.opacity = '0.5';
			// Add lock badge if not present
			if (!el.querySelector('.lock-badge')) {
				const lockBadge = document.createElement('span');
				lockBadge.className = 'lock-badge';
				lockBadge.innerHTML = '🔒';
				lockBadge.style.marginLeft = '0.25rem';
				lockBadge.style.fontSize = '0.8rem';
				el.appendChild(lockBadge);
			}
		} else {
			el.style.opacity = '1';
			// Remove lock badge if present
			const lockBadge = el.querySelector('.lock-badge');
			if (lockBadge) lockBadge.remove();
		}
	}
	// =============== ROUTING SIDE EFFECTS ===============
	Router.onChange(view=>{
		// Update navigation locks
		updateNavLocks();
		
		// Show/hide sticky summary only on plan/checkout
		const showSummary = (view==='plan' || view==='checkout');
		
		// Router gating (Plan Builder only on Plan view)
		const planSection = document.querySelector('section[data-view="plan"]');
		const planSummary = document.getElementById('plan-summary');
		if (planSection) planSection.style.display = (view==='plan') ? 'block' : 'none';
		if (planSummary) planSummary.style.display = (view==='plan' || view==='checkout') ? '' : 'none';
		const summaryEl = document.getElementById('sticky-plan-summary');
		if (summaryEl) {
			summaryEl.classList.toggle('hidden', !showSummary);
		}
		
		if(view==='landing'){ 
			renderLandingTiles(); 
			// Ensure we're at the top of the page when landing
			setTimeout(() => {
				window.scrollTo(0, 0);
				document.documentElement.scrollTop = 0;
				document.body.scrollTop = 0;
			}, 50);
		}
		if(view==='wearables'){ 
			renderWearablesUI(); 
			// Mark that user has accessed wearables page
			State.user = State.user || {};
			State.user.hasAccessedWearables = true;
			save({'user.profile': State.user});
			
			// Ensure data exists and is displayed
			if (State.devices.connected.length > 0) {
				if (!State.wearables.series || State.wearables.series.steps.length === 0) {
					generateWearableSeries();
				}
				setTimeout(updateWearablesDataDisplay, 50);
			}
			// Ensure wearables data consistency
			ensureWearablesDataConsistency();
		}
		if(view==='metabolic-age'){ 
			ensureWearablesData();
			setTimeout(refreshBiologicalAgeData, 50); 
			// Ensure wearables data consistency
			ensureWearablesDataConsistency();
			// Update UI based on subscription status
			setTimeout(updateBiologicalAgePageForSubscription, 100);
			// Ensure driver chips are rendered when navigating back to the page
			setTimeout(() => {
				const driversList = document.getElementById('drivers-list');
				if (driversList && driversList.innerHTML.trim() === '') {
					renderDriverChips('drivers-list');
				}
			}, 100);
		}
		if(view==='plan'){ 
			renderPlan(); 
			logEvent('plan_viewed');
			// Update plan state when viewing plan page
			updatePlanState();
			// Initialize billing toggle
			setTimeout(updateBillingToggle, 100);
		}
		if(view==='build-first-month'){ 
			renderBuildFirstMonthPage(); 
			// Render the standardized checkout footer for build first month page
			setTimeout(() => {
				renderStandardizedCheckoutFooter('coaching');
                // (Re)bind the Continue button after footer DOM is replaced
                const btn = document.getElementById('build-month-continue-btn');
                if (btn) {
                    // Ensure it isn't locked by any prior logic
                    btn.classList.remove('locked');
                    btn.style.pointerEvents = 'auto';
                    btn.setAttribute('aria-disabled', 'false');
                    btn.style.opacity = '1';
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        window.__onboardingLock = false;
                        window.__bootGuardUntil = 0;
                        try { goToAddons(); } catch(_) {}
                        // Fallback: force activate if needed
                        setTimeout(() => {
                            const target = document.querySelector('[data-view="addons"]');
                            if (!target || !target.classList.contains('active')) {
                                document.querySelectorAll('[data-view]').forEach(s => s.classList.remove('active'));
                                if (target) target.classList.add('active');
                                State.currentView = 'addons';
                                try { updateAddonsFooter(); } catch(_){}
                                try { updateNavLocks(); } catch(_){}
                                window.scrollTo(0,0);
                            }
                        }, 60);
                    }, { once: true });
                }
                const backBtn = document.getElementById('build-month-back-btn');
                if (backBtn) {
                    backBtn.classList.remove('locked');
                    backBtn.style.pointerEvents = 'auto';
                    backBtn.setAttribute('aria-disabled','false');
                    backBtn.style.opacity = '1';
                    backBtn.addEventListener('click', (e)=>{
                        e.preventDefault();
                        try { Router.go('plan'); } catch(_) {}
                    }, { once: true });
                }
            }, 120);
			logEvent('build_first_month_viewed'); 
		}
		if(view==='addons'){ 
			console.log('Navigating to addons page'); 
			renderAddonsPage(); 
            // Ensure the page is visible at the top for clarity
            setTimeout(()=>{ try{ window.scrollTo(0,0); }catch(_){} }, 0);
			logEvent('addons_viewed'); 
		}
		if(view==='dashboard'){ renderDashboard(); }
		if(view==='streaks'){ 
			console.log('Navigating to streaks page, navUnlocked.streaks:', State.navUnlocked?.streaks);
			if (State.navUnlocked?.streaks) {
				renderStreaksPage(); 
				logEvent('streaks_viewed'); 
			} else {
				console.log('Streaks page is locked, showing locked message');
				// Show a message that the page is locked
				const container = document.querySelector('section[data-view="streaks"] .container');
				if (container) {
					container.innerHTML = `
						<div class="hero">
							<h1>Streaks & Goals</h1>
							<p>Complete your plan setup to unlock streaks and goals tracking</p>
						</div>
						<div class="card" style="text-align:center; padding:2rem">
							<h3>🔒 Locked</h3>
							<p>Streaks & Goals will be available after you complete your plan setup and checkout.</p>
							<button class="btn" onclick="Router.go('plan')">Continue Setup</button>
						</div>
					`;
				}
			}
		}
		if(view==='checkout'){ loadCheckoutSummary(); logEvent('checkout_started'); }
		if(view==='account'){ 
			renderAccountPage(); 
			logEvent('account_viewed');
			// Ensure wearables data consistency
			ensureWearablesDataConsistency();
		}
		// Always show reset demo button on all pages
		const resetBtn = document.getElementById('reset-demo-btn');
		if (resetBtn) {
			resetBtn.style.display = 'block';
		}
		// Update navigation visibility
		updateNavigationVisibility();
		updateNavLocks();
		// Initialize toggles whenever view changes
		setTimeout(initializeToggles, 100);
		
		// Pricing toggle removed
	});
	// =============== TESTS (minimal) ===============
	function runTests(){
		const failures=[];
		let total=0, passed=0; function t(name, fn){ total++; try{ fn(); passed++; }catch(e){ failures.push(name+': '+e.message); } }
		// 1) Router
		t('Router exists', ()=>{ if(!window.Router) throw new Error('Router missing'); });
		t('Router.go landing', ()=>{ Router.go('landing'); const active=document.querySelector('[data-view].active'); if(!active || active.getAttribute('data-view')!=='landing') throw new Error('Landing not shown'); });
		// 2) Pricing
		t('Pricing mix 10% (2 items)', ()=>{
			const q=priceQuote({selectedIds:['coaching','supplements']});
			if(q.rule!=='mix' || q.discountPct!==10) throw new Error('Expected 10% mix');
		});
		t('Pricing mix 15% (3 items)', ()=>{
			const q=priceQuote({selectedIds:['coaching','supplements','sleep']});
			if(q.rule!=='mix' || q.discountPct!==15) throw new Error('Expected 15% mix');
		});
		t('Bundle Metabolic 20%', ()=>{
			const q=priceQuote({selectedIds:['weight-mgmt','coaching','blood-tests']});
			if(q.rule!=='bundle' || q.discountPct!==20) throw new Error('Expected 20% bundle');
		});
		t('Bundle Sleep&Focus 18%', ()=>{
			const q=priceQuote({selectedIds:['sleep','cognition','supplements']});
			if(q.rule!=='bundle' || q.discountPct!==18) throw new Error('Expected 18% bundle');
		});
		t('Coupon beats none but not better bundle', ()=>{
			const q1=priceQuote({selectedIds:['coaching'], coupon:'SAVE10'}); if(q1.rule!=='coupon') throw new Error('Coupon should apply');
			const q2=priceQuote({selectedIds:['sleep','cognition','supplements'], coupon:'SAVE10'});
			if(q2.rule!=='bundle') throw new Error('Bundle should beat coupon');
		});
		t('Annual effective monthly', ()=>{
			const q=priceQuote({selectedIds:['coaching','supplements'], annual:true});
			if(q.effectiveMonthly !== Math.round(q.monthlyTotal*10/12)) throw new Error('Annual calc mismatch');
		});
		// 3) Devices: primary exists when multiple
		t('Devices primary selection', ()=>{
			// simulate - but don't persist to actual state
			const testDevices = [{id:'a',brand:'Fitbit'},{id:'b',brand:'Oura'}];
			const testPrimaryId = 'a';
			// Test the logic without affecting real state
			if(testDevices.length !== 2) throw new Error('Test setup failed');
		});
		State.tests={total,passed,failures}; 
		updateTestsBadge();
	}
	function updateTestsBadge(){
		const b=document.getElementById('tests-badge');
		if(!State.tests) {
			// Initialize tests for new pricing system
			State.tests = { passed: 0, total: 0, failures: [] };
		}
		
		// Only show on landing (homepage) - check both State.currentView and DOM
		const onLanding = State.currentView === 'landing' || !!document.querySelector('section[data-view="landing"].active');
		if (b) {
			b.style.display = onLanding ? 'block' : 'none';
		}

		// Test new pricing system and recommendation engine
		const tests = [
			{ name: 'MODEL exists', test: () => !!MODEL && !!MODEL.plans },
			{ name: 'Base plan price', test: () => MODEL.plans.Base.price === 49 },
			{ name: 'Standard plan price', test: () => MODEL.plans.Standard.price === 99 },
			{ name: 'Premium plan price', test: () => MODEL.plans.Premium.price === 149 },
			{ name: 'Quote function works', test: () => {
				const q = quote('Base');
				return q && typeof q.total === 'number' && q.total > 0;
			}},
			{ name: 'Add-ons calculation', test: () => {
				HS.addons = { 'addon-test-standard': 1 };
				const q = quote('Base');
				return q.addOns === 59; // Standard test price
			}},
			{ name: 'RecEngine signals', test: () => {
				const sig = recEngine.readSignals();
				return sig && typeof sig.whtr === 'number' && typeof sig.sleepHours === 'number';
			}},
			{ name: 'RecEngine recommendations', test: () => {
				const sig = recEngine.readSignals();
				const rec = recEngine.buildRecommendations(sig);
				return rec && rec.picks && rec.picks.labs && rec.picks.supplements && rec.picks.coaching;
			}},
			{ name: 'RecEngine apply to HS', test: () => {
				const sig = recEngine.readSignals();
				const rec = recEngine.buildRecommendations(sig);
				if (rec && rec.plan) {
				recEngine.apply(true); // Suppress toast for test
				return HS.plan.tier && HS.firstMonth.lab && HS.firstMonth.supplements && HS.firstMonth.supplements.length > 0 && HS.firstMonth.coaching;
				} else {
					// No plan selected - this is valid behavior
					return true;
				}
			}}
		];
		
		State.tests.passed = 0;
		State.tests.total = tests.length;
		State.tests.failures = [];
		
		tests.forEach(test => {
			try {
				if (test.test()) {
					State.tests.passed++;
				} else {
					State.tests.failures.push(test.name);
				}
			} catch (e) {
				State.tests.failures.push(`${test.name}: ${e.message}`);
			}
		});
		
		b.textContent = `Tests: ${State.tests.passed}/${State.tests.total}`;
		if(State.tests.failures.length) b.title = State.tests.failures.join('\n'); else b.title = 'All tests passed';
	}

	// =============== INIT ===============
	function seedDemoOnce(){
		// Only clear devices on the very first initialization (when no user data AND no wearables exist)
		// This prevents clearing devices on subsequent page loads or when user has connected wearables
		const hasUserData = State.user.firstName || State.user.lastName || State.user.email || State.user.phone;
		const hasWearablesData = State.devices.connected.length > 0 || State.wearables.providers.length > 0 || 
								 State.onboarding.answers.age || State.onboarding.answers.activityMins;
		const isFirstInitialization = !hasUserData && !hasWearablesData;
		
		if (isFirstInitialization && State.devices.connected.length > 0) {
			State.devices.connected = [];
			State.devices.primaryId = null;
			save({'devices.connected': State.devices.connected, 'devices.primaryId': State.devices.primaryId});
		}

		// Seed demo user profile data if not already set
		if (!State.user.firstName && !State.user.lastName && !State.user.email && !State.user.phone) {
			const isFemale = State.user.sex === 'female';
			State.user.firstName = isFemale ? 'Jane' : 'James';
			State.user.lastName = 'Smith';
			State.user.email = isFemale ? 'jane.smith@example.com' : 'james.smith@example.com';
			State.user.phone = '+44 7123 456789';
			save({'user.profile': State.user});
		}

		// Ensure subscription is only active if user has completed onboarding and checkout
		const hasCompletedOnboarding = State.user.age && State.user.sex && State.user.height && 
			State.user.weight && State.user.waist && State.onboarding.answers?.goals?.length > 0;
		const hasCompletedCheckout = State.user.firstName && State.user.email;
		
		if (!hasCompletedOnboarding || !hasCompletedCheckout) {
			State.subscription = {active: false, plan: null, startDate: null};
			save({'subscription': State.subscription});
		}

		// seed sample service requests
		if(State.requests.services.length===0){
			State.requests.services = [
				{ id:'req-01', title:'Menopause support', category:"Women's health", status:'Under review' },
				{ id:'req-02', title:'Physio for runners', category:'MSK/Physio', status:'Under review' },
				{ id:'req-03', title:'Gut microbiome test', category:'Diagnostics', status:'Under review' },
			];
			save({'requests.services':State.requests.services});
		}
	}
	function deepLinkToPlan(marker){
		// Check if onboarding is completed
		const isOnboardingComplete = State.user.age && State.user.sex && State.user.height && 
			State.user.weight && State.user.waist && State.onboarding.answers.goals?.length > 0;
		
		if (!isOnboardingComplete) {
			// Show popup asking for more info
			openModal('onboarding-required', `
				<h3>We need a bit more info first</h3>
				<p>To provide you with a personalised action plan, we need to gather some basic information about your health goals and measurements.</p>
				<div style="display:flex; gap:.5rem; margin-top:1rem">
					<button class="btn btn-small" onclick="closeModal(); startOnboarding()">Start assessment</button>
					<button class="btn-ghost btn-small" onclick="closeModal()">Maybe later</button>
				</div>
			`);
			return;
		}
		
		const m = {
			immunity: ['blood-tests','supplements'],
			inflammation: ['supplements','coaching'],
			cognition: ['cognition-support','sleep-optimisation'],
			sleep: ['sleep-optimisation'],
			nutrition: ['supplements','coaching'],
			hormones: ['blood-tests','testosterone']
		}[marker] || [];
		State.plan.selectedIds = m; save({'plan.selectedIds':m});
		Router.go('plan');
	}
	function resetDemo(){
		console.log('resetDemo called - clearing all state and returning to landing');
		
		// Clear all localStorage data
		Object.keys(localStorage).filter(k=>k.startsWith(LS_PREFIX)).forEach(k=>localStorage.removeItem(k));
		['hs','assessments.history','navigation.completedSteps','navigation.lastAccessed'].forEach(k=>localStorage.removeItem(k));

		// Clear all State and HS objects
		const createDefaultUserProfile = () => ({ age: null, sex: null, height: null, weight: null, waist: null, dob: null, firstName: null, lastName: null, email: null, phone: null });
		const createEmptyWearableSeries = () => ({ steps: [], sleep: [], rhr: [], hrv: [], weight: [] });
		const createDefaultNavUnlocked = () => ({ wearables: false, bioAge: false, plan: false, dashboard: false, streaks: false, account: false });
		const createDefaultPlanState = () => ({ hasActiveSubscription: false, activePlanTier: null, selectedPlanTier: null, newPlanTier: null, isEditingPlan: false, canProceedToBuildMonth: false });
		const createDefaultPlan = () => ({ tier: null, selectedIds: [], selectedAddOns: [], billingCycle: 'monthly', editing: false, firstMonthPicks: null, pricing: null });
		const createDefaultCart = () => ({ planKey: null, annual: false, addOns: {}, kitsToShip: 0 });
		const createDefaultSubscription = () => ({ active: false, status: 'inactive', tier: null, plan: null, startDate: null, billingCycle: 'monthly' });
		const createDefaultRewardsState = () => ({ xp: 0, level: 1, streak: { sleepDays: 0, stepsDays: 0, smokeFreeDays: 0 }, badgesEarned: [], activeQuests: [], completedQuests: [] });
		const createDefaultSchedule = () => ({ events: [] });
		const createDefaultOutcomes = () => ({ weight: null, rhr: null, sleep: null });
		const createDefaultLabs = () => ({ orders: [], results: [], nextDue: null, preferences: { shareWithCoach: true } });
		const createDefaultReferrals = () => ({ conversions: 0, credits: 0 });
		const createDefaultAssessments = () => ([
			{id:'weekly-checkin', title:'Weekly check-in', recommended:true, optedIn:true, scheduledAt:new Date().toISOString(), frequency:'weekly', completed:false},
			{id:'bloods', title:'Monthly bloods', recommended:true, optedIn:true, scheduledAt:new Date(Date.now()+14*864e5).toISOString(), frequency:'monthly', completed:false},
			{id:'q-review', title:'Quarterly review', recommended:false, optedIn:false, scheduledAt:new Date(Date.now()+42*864e5).toISOString(), frequency:'quarterly', completed:false}
		]);

		// Reset all State properties
		State.wearables = { providers: [], series: createEmptyWearableSeries(), lastSync: null };
		State.devices = { connected: [], primaryId: null };
		State.deviceRequests = [];
		State.plan = createDefaultPlan();
		State.planState = createDefaultPlanState();
		State.cart = createDefaultCart();
		State.schedule = createDefaultSchedule();
		State.onboarding = { currentStep: 0, completed: false, answers: {} };
		State.consent = { health: false };
    State.currentView = 'landing';
		State.navUnlocked = createDefaultNavUnlocked();
		State.user = createDefaultUserProfile();
		State.preferences = {};
		State.activePlans = [];
		State.subscription = createDefaultSubscription();
		State.requests = { services: [] };
		State.calendar = { events: [] };
		State.coach = { messages: [] };
		State.eventsLog = [];
		State.issues = [];
		State.assessments = createDefaultAssessments();
		State.biologicalAge = null;
		State.ageHistory = [];
		State.billing = 'monthly';
		State.referrals = createDefaultReferrals();
		State.tests = { total: 0, passed: 0, failures: [] };
		State.crossSell = { currentCategory: 'None' };
		State.coupon = '';
		State.employerCode = '';
		State.partner = { channel: '', code: '' };
		State.rewards.mode = 'soft';
		State.rewards.state = createDefaultRewardsState();
		State.outcomes = { baseline: createDefaultOutcomes(), current: createDefaultOutcomes() };
		State.nps = { score: null, comment: '' };
		State.settings = { peerComparison: false };
		State.useNewPricing = false;
		State.firstTimeCheckout = true;
		State.labs = createDefaultLabs();

		// Reset HS object
		HS.plan = { tier: null };
		HS.firstMonth = { labs: [], supplements: [], coaching: null, useLabLater: false };
		HS.addons = {};
		
		// Clear recommendation engine
    if (window.recEngine && window.recEngine.current) {
        window.recEngine.current = null;
    }

		// Save the reset state
		commit();

		console.log('resetDemo completed - state cleared, reloading page');
		
		// Reload the page to ensure clean state
		window.location.reload();
	}

// Ensure onboarding launcher is globally available
if (typeof startOnboarding === 'function') {
  Object.assign(window, { startOnboarding });
	}

	// Modal helpers for quick entry points
	function openModalType(type){ openModal(type); }

	// =============== ACCOUNT PAGE FUNCTIONS ===============
	function renderAccountPage() {
		// Populate personal information
		document.getElementById('account-name').value = `${State.user.firstName || ''} ${State.user.lastName || ''}`.trim() || 'Not provided';
		document.getElementById('account-email').value = State.user.email || 'Not provided';
		document.getElementById('account-phone').value = State.user.phone || 'Not provided';
		document.getElementById('account-dob').value = State.user.dob || '';
		
		// Populate current plan with actual checked out plan
		const planDetails = document.getElementById('account-plan-details');
		const currentPlanTier = State.subscription?.tier || State.plan.tier; // Prioritize subscription tier
		if (currentPlanTier && MODEL.plans[currentPlanTier]) {
			const plan = MODEL.plans[currentPlanTier];
			const billingCycle = State.subscription?.billingCycle || State.plan.billingCycle || 'monthly';
			const isAnnual = billingCycle === 'annual';
			const displayPrice = isAnnual ? plan.price * 12 * 0.9 : plan.price; // 10% discount for annual
			const priceLabel = isAnnual ? '/year' : '/month';
			
			planDetails.innerHTML = `
				<div style="text-align:center; padding:1rem 0">
					<div style="font-size:1.5rem; font-weight:700; color:var(--numan-teal); margin-bottom:0.5rem">
						${currentPlanTier}
					</div>
					<div style="font-size:1.8rem; font-weight:800; color:var(--numan-teal); margin-bottom:1rem">
						${money(displayPrice)}${priceLabel}
					</div>
					${isAnnual ? '<div style="font-size:0.9rem; color:var(--numan-teal); font-weight:600; margin-bottom:1rem">Annual (10% OFF)</div>' : ''}
					<div style="background:var(--mint-50); border-radius:12px; padding:1rem; margin-bottom:1rem">
						<div style="font-size:0.9rem; color:var(--ink-80); line-height:1.6">
							<div style="margin-bottom:0.5rem"><strong>${plan.labCreditsPerYear}</strong> lab credits/year</div>
							<div style="margin-bottom:0.5rem"><strong>${plan.supplementQuantityPerMonth}</strong> supplement${plan.supplementQuantityPerMonth > 1 ? 's' : ''}/month</div>
							<div style="margin-bottom:0.5rem"><strong>${plan.coachingMinutesPerMonth} min</strong> coaching/month</div>
							<div><strong>${plan.gpConsultsPerYear}</strong> GP consults/year</div>
						</div>
					</div>
					<div style="font-size:0.8rem; color:var(--ink-60); text-align:center">
						Active subscription
					</div>
				</div>
			`;
		} else {
			planDetails.innerHTML = `
				<div style="text-align:center; padding:2rem 0">
					<div style="font-size:1.2rem; color:var(--ink-60); margin-bottom:1rem">No active plan</div>
					<div style="font-size:0.9rem; color:var(--ink-60)">Choose a plan to get started with your health journey</div>
				</div>
			`;
		}
		
		// Generate and populate referral code if not exists
		if (!State.user.referralCode) {
			State.user.referralCode = generateReferralCode();
			save({'user.profile': State.user});
		}
		
		document.getElementById('referral-code').value = State.user.referralCode;
		document.getElementById('referral-link').value = `https://numan.healthspan.com?ref=${State.user.referralCode}`;
		
	}
	
	function generateReferralCode() {
		// Generate a simple referral code
		const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
		let result = '';
		for (let i = 0; i < 8; i++) {
			result += chars.charAt(Math.floor(Math.random() * chars.length));
		}
		return result;
	}
	
	function copyReferralCode() {
		const code = document.getElementById('referral-code').value;
		navigator.clipboard.writeText(code).then(() => {
			showToast('Referral code copied to clipboard!');
		});
	}
	
	function copyReferralLink() {
		const link = document.getElementById('referral-link').value;
		navigator.clipboard.writeText(link).then(() => {
			showToast('Referral link copied to clipboard!');
		});
	}
	
	function openFeedbackModal() {
		openModal('feedback', `
			<h3>Give Feedback</h3>
			<p>Help us improve your experience by sharing your thoughts.</p>
			<div class="form-group">
				<label>Rating</label>
				<div style="display:flex; gap:0.5rem; margin:0.5rem 0">
					${[1,2,3,4,5].map(i => `
						<button class="btn-ghost btn-small" onclick="selectRating(${i})" id="rating-${i}">${i}</button>
					`).join('')}
				</div>
			</div>
			<div class="form-group">
				<label>Comments</label>
				<textarea id="feedback-comments" placeholder="Tell us what you think..." style="width:100%; min-height:100px; padding:0.75rem; border:1px solid #e5e7eb; border-radius:6px; font-family:inherit"></textarea>
			</div>
			<div style="display:flex; gap:0.5rem; margin-top:1rem">
				<button class="btn" onclick="submitFeedback()">Submit Feedback</button>
				<button class="btn btn-secondary" onclick="closeModal()" style="background:var(--mint-50); border-color:var(--numan-teal); color:var(--numan-teal); font-weight:600">Cancel</button>
			</div>
		`);
	}
	
	function openSupportModal() {
		openModal('support', `
			<h3>Get Support</h3>
			<p>Need help? Our support team is here to assist you.</p>
			<div style="display:flex; flex-direction:column; gap:0.75rem; margin:1rem 0">
				<button class="btn-ghost" onclick="checkSubscriptionAndMessage()" style="text-align:left; padding:0.75rem; border:1px solid #e5e7eb; border-radius:8px; background:white">
					<div style="font-weight:600; margin-bottom:0.25rem">💬 Message Clinician</div>
					<div style="font-size:0.9rem; color:var(--ink-60)">Chat with your health coach</div>
				</button>
				<button class="btn-ghost" onclick="closeModal()" style="text-align:left; padding:0.75rem; border:1px solid #e5e7eb; border-radius:8px; background:white">
					<div style="font-weight:600; margin-bottom:0.25rem">📧 Email Support</div>
					<div style="font-size:0.9rem; color:var(--ink-60)">support@numan.com</div>
				</button>
			</div>
			<div style="margin-top:1.5rem; text-align:right">
				<button class="btn btn-secondary" onclick="closeModal()" style="background:var(--mint-50); border-color:var(--numan-teal); color:var(--numan-teal); font-weight:600">Close</button>
			</div>
		`);
	}
	
	function openManageSubscriptionModal() {
		const currentPlanTier = State.subscription?.tier || State.plan.tier;
		const plan = MODEL.plans[currentPlanTier];
		// Use the actual subscription billing cycle, fallback to plan billing cycle, default to monthly
		const billingCycle = State.subscription?.billingCycle || State.plan.billingCycle || 'monthly';
		const isAnnual = billingCycle === 'annual';
		// Only apply annual discount if actually on annual billing
		const displayPrice = isAnnual ? plan?.price * 12 * 0.9 : plan?.price;
		const priceLabel = isAnnual ? '/year' : '/month';
		
		openModal('manage-subscription', `
			<h3>Manage Subscription</h3>
			${currentPlanTier && plan ? `
				<div style="background:var(--mint-50); border-radius:12px; padding:1.5rem; margin:1rem 0; border-left:4px solid var(--numan-teal)">
					<h4 style="margin:0 0 0.5rem 0; color:var(--numan-teal)">Current Plan: ${currentPlanTier}</h4>
					<div style="font-size:1.2rem; font-weight:700; color:var(--ink); margin-bottom:0.5rem">
						${money(displayPrice)}${priceLabel}
					</div>
					<div style="font-size:0.8rem; color:var(--ink-60); margin-bottom:0.5rem">
						Billing: ${billingCycle} | Base price: £${plan.price}/month
					</div>
					<div style="font-size:0.9rem; color:var(--ink-80)">
						<div style="margin-bottom:0.25rem">• ${plan.labCreditsPerYear} lab credits per year</div>
						<div style="margin-bottom:0.25rem">• ${plan.supplementQuantityPerMonth} supplement${plan.supplementQuantityPerMonth > 1 ? 's' : ''} per month</div>
						<div style="margin-bottom:0.25rem">• ${plan.coachingMinutesPerMonth} minutes coaching per month</div>
						<div>• ${plan.gpConsultsPerYear} GP consults per year</div>
					</div>
					${isAnnual ? '<div style="font-size:0.8rem; color:var(--numan-teal); font-weight:600; margin-top:0.5rem">Annual billing (10% OFF)</div>' : ''}
				</div>
			` : `
				<div style="background:#f9fafb; border-radius:12px; padding:1.5rem; margin:1rem 0; border-left:4px solid var(--ink-40)">
					<h4 style="margin:0 0 0.5rem 0; color:var(--ink-60)">No Active Plan</h4>
					<p style="margin:0; color:var(--ink-60)">You don't have an active subscription yet.</p>
				</div>
			`}
			
			<div style="display:flex; flex-direction:column; gap:0.75rem; margin-top:1.5rem">
				<button class="btn" onclick="Router.go('plan'); closeModal()">Change Plan</button>
				<button class="btn btn-secondary" onclick="openSupportModal(); closeModal()">Contact Support</button>
				<button class="btn btn-secondary" onclick="checkSubscriptionAndMessage(); closeModal()" style="background:var(--mint-50); border-color:var(--numan-teal); color:var(--numan-teal); font-weight:600">💬 Message Clinician</button>
			</div>
			
			<div class="modal-actions" style="margin-top:2rem; padding-top:1rem; border-top:1px solid #e5e7eb">
				<button class="btn btn-secondary" onclick="closeModal()" style="background:var(--mint-50); border-color:var(--numan-teal); color:var(--numan-teal); font-weight:600">Close</button>
			</div>
		`);
	}
	
	function selectRating(rating) {
		// Remove previous selections
		document.querySelectorAll('[id^="rating-"]').forEach(btn => {
			btn.classList.remove('selected');
			btn.style.background = '';
		});
		
		// Highlight selected rating
		const selectedBtn = document.getElementById(`rating-${rating}`);
		selectedBtn.classList.add('selected');
		selectedBtn.style.background = 'var(--numan-teal)';
		selectedBtn.style.color = 'white';
		
		State.feedback = State.feedback || {};
		State.feedback.rating = rating;
	}
	
	function submitFeedback() {
		const rating = State.feedback?.rating;
		const comments = document.getElementById('feedback-comments').value;
		
		if (!rating) {
			showToast('Please select a rating');
			return;
		}
		
		// Save feedback
		State.feedback = {
			rating: rating,
			comments: comments,
			date: new Date().toISOString()
		};
		save({feedback: State.feedback});
		
		showToast('Thank you for your feedback!');
		closeModal();
	}

	// =============== GAMIFICATION SYSTEM ===============
	function grantXP(amount, reason) {
		if (!State.rewards.state) return;
		
		State.rewards.state.xp += amount;
		const oldLevel = State.rewards.state.level;
		State.rewards.state.level = levelFromXP(State.rewards.state.xp);
		
		save({'rewards.state': State.rewards.state});
		logEvent('xp_granted', {amount, reason, newXP: State.rewards.state.xp});
		
		// Level up animation
		if (State.rewards.state.level > oldLevel) {
			logEvent('level_up', {newLevel: State.rewards.state.level});
			showToast(`Level up! You're now level ${State.rewards.state.level}!`);
		}
	}
	
	function levelFromXP(xp) {
		const levels = State.rewards.levels;
		for (let i = levels.length - 1; i >= 0; i--) {
			if (xp >= levels[i].xp) return levels[i].level;
		}
		return 1;
	}
	
	function getXPProgress() {
		// Ensure rewards state is properly initialized
		if (!State.rewards || !State.rewards.state) {
			return 0;
		}
		
		const currentLevel = State.rewards.state.level || 1;
		const currentXP = State.rewards.state.xp || 0;
		const nextLevel = currentLevel + 1;
		
		// Calculate XP thresholds
		const currentLevelXP = (currentLevel - 1) * 200;
		const nextLevelXP = currentLevel * 200;
		
		if (nextLevelXP === currentLevelXP) return 100;
		
		const progress = ((currentXP - currentLevelXP) / (nextLevelXP - currentLevelXP)) * 100;
		return Math.min(100, Math.max(0, progress));
	}
	
	function getXPToNextLevel() {
		// Ensure rewards state is properly initialized
		if (!State.rewards || !State.rewards.state) {
			return 200;
		}
		
		const currentLevel = State.rewards.state.level || 1;
		const currentXP = State.rewards.state.xp || 0;
		const nextLevelXP = currentLevel * 200;
		
		return Math.max(0, nextLevelXP - currentXP);
	}
	
	function checkStreaks() {
		// Update streaks based on actual wearable data
		if (State.wearables?.series?.sleep?.length > 0) {
			const recentSleep = State.wearables.series.sleep.slice(-30); // Check last 30 days
			let currentStreak = 0;
			
			// Count consecutive days with ≥7h sleep from most recent
			for (let i = recentSleep.length - 1; i >= 0; i--) {
				if (recentSleep[i].value >= 7) {
					currentStreak++;
				} else {
					break; // Streak broken
				}
			}
			
			State.rewards.state.streak.sleepDays = currentStreak;
		}
		
		if (State.wearables?.series?.steps?.length > 0) {
			const recentSteps = State.wearables.series.steps.slice(-30); // Check last 30 days
			let currentStreak = 0;
			
			// Count consecutive days with ≥8k steps from most recent
			for (let i = recentSteps.length - 1; i >= 0; i--) {
				if (recentSteps[i].value >= 8000) {
					currentStreak++;
				} else {
					break; // Streak broken
				}
			}
			
			State.rewards.state.streak.stepsDays = currentStreak;
		}
		
		// Check for smoke-free streak if user is a non-smoker
		if (State.user?.smoking === 'no') {
			const daysSinceOnboarding = Math.floor((Date.now() - new Date(State.onboarding?.startedAt || Date.now())) / (1000 * 60 * 60 * 24));
			State.rewards.state.streak.smokeFreeDays = Math.max(0, daysSinceOnboarding);
		}
		
		save({'rewards.state': State.rewards.state});
	}
	
	function evaluateQuests() {
		State.rewards.quests.forEach(quest => {
			const isActive = State.rewards.state.activeQuests.some(aq => aq.id === quest.id);
			const isCompleted = State.rewards.state.completedQuests.includes(quest.id);
			
			if (!isActive && !isCompleted) {
				// Start new quest
				State.rewards.state.activeQuests.push({
					id: quest.id,
					startedAt: new Date().toISOString()
				});
				logEvent('quest_started', {id: quest.id});
			}
		});
		
		// Check quest progress
		State.rewards.state.activeQuests.forEach(activeQuest => {
			const quest = State.rewards.quests.find(q => q.id === activeQuest.id);
			if (!quest) return;
			
			const progress = calculateQuestProgress(quest);
			logEvent('quest_progress', {id: quest.id, progress});
			
			if (progress >= 100) {
				// Complete quest
				State.rewards.state.activeQuests = State.rewards.state.activeQuests.filter(aq => aq.id !== quest.id);
				State.rewards.state.completedQuests.push(quest.id);
				grantXP(quest.rewardXP, `Quest completed: ${quest.title}`);
				logEvent('quest_completed', {id: quest.id, rewardXP: quest.rewardXP});
			}
		});
		
		save({'rewards.state': State.rewards.state});
	}
	
	function calculateQuestProgress(quest) {
		// Calculate quest progress based on actual wearable data
		if (!State.wearables?.series) return 0;
		
		const now = new Date();
		const questStart = State.rewards.state.activeQuests.find(aq => aq.id === quest.id)?.startedAt;
		if (!questStart) return 0;
		
		const daysSinceStart = Math.floor((now - new Date(questStart)) / (1000 * 60 * 60 * 24));
		const totalDays = quest.durationDays;
		
		if (daysSinceStart >= totalDays) {
			// Check if quest goals were met
			let goalMet = false;
			
			switch (quest.driver) {
				case 'sleep':
					if (State.wearables.series.sleep?.length > 0) {
						const recentSleep = State.wearables.series.sleep.slice(-7);
						const avgSleep = recentSleep.reduce((sum, day) => sum + day.value, 0) / recentSleep.length;
						goalMet = quest.goal.kind === 'avgSleep>=' && avgSleep >= quest.goal.value;
					}
					break;
				case 'steps':
					if (State.wearables.series.steps?.length > 0) {
						const recentSteps = State.wearables.series.steps.slice(-7);
						const avgSteps = recentSteps.reduce((sum, day) => sum + day.value, 0) / recentSteps.length;
						goalMet = quest.goal.kind === 'stepsAvg>=' && avgSteps >= quest.goal.value;
					}
					break;
				case 'rhr':
					if (State.wearables.series.rhr?.length > 0) {
						const recentRHR = State.wearables.series.rhr.slice(-7);
						const avgRHR = recentRHR.reduce((sum, day) => sum + day.value, 0) / recentRHR.length;
						goalMet = quest.goal.kind === 'rhrAvg<' && avgRHR < quest.goal.value;
					}
					break;
			}
			
			return goalMet ? 100 : Math.min(90, (daysSinceStart / totalDays) * 100);
		}
		
		// Return progress based on days elapsed
		return Math.min(90, (daysSinceStart / totalDays) * 100);
	}
	
	function awardBadge(badgeId) {
		if (State.rewards.state.badgesEarned.includes(badgeId)) return;
		
		State.rewards.state.badgesEarned.push(badgeId);
		save({'rewards.state': State.rewards.state});
		
		const badge = State.rewards.badges.find(b => b.id === badgeId);
		if (badge) {
			logEvent('badge_earned', {id: badgeId});
			showToast(`Badge earned: ${badge.name}! ${badge.icon}`);
		}
	}
	
	function checkBadges() {
		State.rewards.badges.forEach(badge => {
			if (!State.rewards.state.badgesEarned.includes(badge.id) && badge.criteriaFn(State)) {
				awardBadge(badge.id);
			}
		});
	}
	
	function renderActiveQuests() {
		if (State.rewards.state.activeQuests.length === 0) {
			return '<p class="muted">No active quests. Complete your health goals to unlock new quests!</p>';
		}
		
		return State.rewards.state.activeQuests.map(activeQuest => {
			const quest = State.rewards.quests.find(q => q.id === activeQuest.id);
			if (!quest) return '';
			
			const progress = calculateQuestProgress(quest);
			return `
				<div class="service-card" style="margin-bottom:1rem">
					<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem">
						<h4 style="margin:0">${quest.title}</h4>
						<span class="badge" style="background:var(--numan-teal); color:white">${quest.rewardXP} XP</span>
					</div>
					<div style="background:#e5e7eb; height:6px; border-radius:3px; overflow:hidden; margin-bottom:0.5rem">
						<div style="background:var(--numan-teal); height:100%; width:${progress}%; transition:width 0.3s ease"></div>
					</div>
					<p class="muted" style="margin:0">${Math.round(progress)}% complete</p>
				</div>
			`;
		}).join('');
	}
	
	function renderBadges() {
		// Ensure badges are properly initialized
		if (!State.rewards || !State.rewards.state || !State.rewards.state.badgesEarned) {
			return '<p class="muted">No badges earned yet. Keep working on your health goals!</p>';
		}
		
		// Ensure badges array exists
		if (!State.rewards.badges) {
			State.rewards.badges = [
				{id:'first-sync', name:'First Sync', icon:'📱', description:'Connect a wearable device'},
				{id:'consistency', name:'Consistency', icon:'🔥', description:'7-day sleep streak'},
				{id:'momentum', name:'Momentum', icon:'🚶', description:'7-day steps streak'},
				{id:'alcohol-smart', name:'Alcohol Smart', icon:'🍷', description:'≤14 units this week'},
				{id:'smoke-free-start', name:'Smoke-Free Start', icon:'🚭', description:'7 smoke-free days'}
			];
		}
		
		if (State.rewards.state.badgesEarned.length === 0) {
			return '<p class="muted">No badges earned yet. Keep working on your health goals!</p>';
		}
		
		return State.rewards.state.badgesEarned.map(badgeId => {
			const badge = State.rewards.badges.find(b => b.id === badgeId);
			if (!badge) return '';
			
			return `
				<div class="service-card" style="text-align:center; padding:1.5rem; border-radius:12px; background:var(--mint-50); border:2px solid var(--numan-teal); margin-bottom:1rem">
					<div style="font-size:2.5rem; margin-bottom:1rem">${badge.icon}</div>
					<h4 style="margin:0 0 0.5rem 0; color:var(--ink); font-size:1.2rem; font-weight:700">${badge.name}</h4>
					<p class="muted" style="margin:0; font-size:0.9rem; color:var(--ink-60)">${badge.description}</p>
				</div>
			`;
		}).join('');
	}

	// =============== LABS SYSTEM ===============
	function upsertLabResult(resultObj) {
		const existingIndex = State.labs.results.findIndex(r => r.id === resultObj.id);
		if (existingIndex >= 0) {
			State.labs.results[existingIndex] = resultObj;
		} else {
			State.labs.results.push(resultObj);
		}
		save({'labs.results': State.labs.results});
	}
	
	function calculateLabFlag({code, value, unit, refLow, refHigh}) {
		if (value < refLow) return 'low';
		if (value > refHigh) return 'high';
		return 'normal';
	}
	
	function renderLabTimeline(el, labs) {
		// Implementation for lab timeline visualization
	}
	
	function scheduleNextTest(panel, weeks) {
		const nextDate = new Date();
		nextDate.setDate(nextDate.getDate() + (weeks * 7));
		
		State.labs.nextDue = {
			panel,
			dueAtISO: nextDate.toISOString()
		};
		save({'labs.nextDue': State.labs.nextDue});
		
		// Add to calendar
		State.calendar.events.push({
			id: Date.now(),
			title: `${panel} Panel Due`,
			date: nextDate.toISOString(),
			time: '09:00'
		});
		save({'calendar.events': State.calendar.events});
		
		logEvent('lab_next_due_scheduled', {panel, weeks});
	}
	
	function renderLabsHub() {
		if (State.labs.results.length === 0) {
			return `
				<div style="text-align:center; padding:2rem">
					<div style="font-size:3rem; margin-bottom:1rem">🧪</div>
					<h4>No lab results yet</h4>
					<p class="muted">Order your first blood test to see your results here</p>
					<button class="btn" onclick="orderBloodTest()">Order Blood Test</button>
				</div>
			`;
		}
		
		return `
			<div class="card-grid">
				${State.labs.results.map(result => `
					<div class="service-card">
						<h4>${result.panel} Panel</h4>
						<p class="muted">Reported: ${new Date(result.reportedAtISO).toLocaleDateString()}</p>
						<div style="margin-top:1rem">
							${result.metrics.slice(0, 3).map(metric => `
								<div style="display:flex; justify-content:space-between; margin-bottom:0.5rem">
									<span>${metric.code}</span>
									<span style="color:${metric.flag === 'normal' ? '#10b981' : metric.flag === 'high' ? '#ef4444' : '#f59e0b'}">${metric.value} ${metric.unit}</span>
								</div>
							`).join('')}
						</div>
						<button class="btn-ghost btn-small" onclick="viewLabResults('${result.id}')">View Full Report</button>
					</div>
				`).join('')}
			</div>
		`;
	}
	
	function orderBloodTest() {
		const labs = MODEL.catalog.labs.map(lab => `
			<button class="btn-ghost" onclick="selectBloodPanel('${lab.id}')" style="text-align:left; padding:1rem; border:1px solid #e5e7eb; border-radius:8px">
				<div style="font-weight:600; margin-bottom:0.25rem">${lab.name} - [${lab.credits} credit${lab.credits > 1 ? 's' : ''}]</div>
				<div style="font-size:0.9rem; color:var(--ink-60)">${lab.tag} test</div>
			</button>
		`).join('');
		
		openModal('order-blood-test', `
			<h3>Order Blood Test</h3>
			<p>Choose your blood test panel:</p>
			<div style="display:flex; flex-direction:column; gap:0.75rem; margin:1rem 0">
				${labs}
			</div>
			<div style="margin-top:1rem">
				<button class="btn-ghost" onclick="closeModal()">Cancel</button>
			</div>
		`);
	}
	
	function selectBloodPanel(panel) {
		const order = {
			id: Date.now().toString(),
			panel,
			orderedAtISO: new Date().toISOString(),
			status: 'pending'
		};
		
		State.labs.orders.push(order);
		save({'labs.orders': State.labs.orders});
		
		logEvent('lab_order_started', {panel});
		showToast(`${panel} panel ordered successfully!`);
		closeModal();
		
		// Award badge if first lab order
		if (State.labs.orders.length === 1) {
			awardBadge('labs-done');
		}
	}
	
	function viewLabResults(resultId) {
		const result = State.labs.results.find(r => r.id === resultId);
		if (!result) return;
		
		logEvent('lab_result_viewed', {panel: result.panel});
		
		openModal('lab-results', `
			<h3>${result.panel} Panel Results</h3>
			<p class="muted">Reported: ${new Date(result.reportedAtISO).toLocaleDateString()}</p>
			<div style="margin:1rem 0">
				${result.metrics.map(metric => `
					<div style="display:flex; justify-content:space-between; align-items:center; padding:0.75rem; border:1px solid #e5e7eb; border-radius:8px; margin-bottom:0.5rem">
						<div>
							<div style="font-weight:600">${metric.code}</div>
							<div style="font-size:0.9rem; color:var(--ink-60)">${metric.value} ${metric.unit}</div>
						</div>
						<div style="text-align:right">
							<span class="badge" style="background:${metric.flag === 'normal' ? '#10b981' : metric.flag === 'high' ? '#ef4444' : '#f59e0b'}; color:white">${metric.flag}</span>
							<div style="font-size:0.8rem; color:var(--ink-60)">${metric.refLow}-${metric.refHigh}</div>
						</div>
					</div>
				`).join('')}
			</div>
			<div style="margin-top:1rem">
				<button class="btn-ghost" onclick="closeModal()">Close</button>
			</div>
		`);
	}

	// =============== SEED DATA ===============
	function seedLabsData() {
		if (State.labs.results.length > 0) return; // Already seeded
		
		// Seed Core panel
		const coreResult = {
			id: 'core-1',
			panel: 'Core',
			collectedAtISO: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString(),
			reportedAtISO: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(),
			metrics: [
				{code: 'A1c', value: 41, unit: 'mmol/mol', refLow: 20, refHigh: 42, flag: 'normal', provenance: 'lab'},
				{code: 'LDL-C', value: 3.4, unit: 'mmol/L', refLow: 0, refHigh: 3.0, flag: 'high', provenance: 'lab'},
				{code: 'HDL-C', value: 1.2, unit: 'mmol/L', refLow: 1.0, refHigh: 3.0, flag: 'normal', provenance: 'lab'},
				{code: 'TG', value: 1.6, unit: 'mmol/L', refLow: 0, refHigh: 1.7, flag: 'normal', provenance: 'lab'},
				{code: 'hs-CRP', value: 1.8, unit: 'mg/L', refLow: 0, refHigh: 3.0, flag: 'normal', provenance: 'lab'},
				{code: 'ALT', value: 28, unit: 'U/L', refLow: 7, refHigh: 56, flag: 'normal', provenance: 'lab'},
				{code: 'Vit D', value: 48, unit: 'nmol/L', refLow: 50, refHigh: 200, flag: 'low', provenance: 'lab'}
			],
			doctorReviewed: true
		};
		
		// Seed Hormone panel
		const hormoneResult = {
			id: 'hormone-1',
			panel: 'Hormone',
			collectedAtISO: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString(),
			reportedAtISO: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),
			metrics: [
				{code: 'Testosterone', value: 9.5, unit: 'nmol/L', refLow: 8.6, refHigh: 29.0, flag: 'normal', provenance: 'lab'},
				{code: 'SHBG', value: 28, unit: 'nmol/L', refLow: 18, refHigh: 54, flag: 'normal', provenance: 'lab'}
			],
			doctorReviewed: true
		};
		
		State.labs.results.push(coreResult, hormoneResult);
		save({'labs.results': State.labs.results});
		
		// Award labs badge
		awardBadge('labs-done');
	}

	// =============== XP REWARDS FOR ACTIONS ===============
	function grantXPForAction(action, amount = 10) {
		if (!State.rewards?.state) return;
		
		const reasons = {
			'device_connected': 'Connected a wearable device',
			'assessment_completed': 'Completed a health assessment',
			'plan_selected': 'Selected a health plan',
			'checkout_completed': 'Completed checkout',
			'daily_login': 'Daily login bonus',
			'streak_milestone': 'Streak milestone reached'
		};
		
		grantXP(amount, reasons[action] || action);
	}

	// =============== STREAKS PAGE RENDERER ===============
	function renderStreaksPage() {
		console.log('renderStreaksPage called, currentView:', State.currentView);
		if (State.currentView !== 'streaks') {
			console.log('Not on streaks view, returning');
			return;
		}
		
		// Ensure rewards system is properly initialized
		if (!State.rewards) {
			console.log('Initializing rewards system');
			State.rewards = { xp: 0, level: 1, streak: { sleepDays: 0, stepsDays: 0 }, activeQuests: [] };
		}
		if (!State.rewards.state) {
			State.rewards.state = {
				xp: 0,
				level: 1,
				streak: {sleepDays:0, stepsDays:0, smokeFreeDays:0},
				badgesEarned: [],
				activeQuests: [],
				completedQuests: []
			};
		}
		if (!State.rewards.levels) {
			State.rewards.levels = [
				{level: 1, xp: 0},
				{level: 2, xp: 200},
				{level: 3, xp: 500},
				{level: 4, xp: 1000},
				{level: 5, xp: 2000}
			];
		}
		
		// Update streaks and check for new badges
		checkStreaks();
		checkBadges();
		
		// Update XP and level display
		const levelEl = document.getElementById('current-level');
		const xpEl = document.getElementById('current-xp');
		const progressBar = document.getElementById('xp-progress-bar');
		const xpToNext = document.getElementById('xp-to-next');
		
		const currentLevel = State.rewards.state.level || 1;
		const currentXP = State.rewards.state.xp || 0;
		
		if (levelEl) levelEl.textContent = `Lv ${currentLevel}`;
		if (xpEl) xpEl.textContent = `${currentXP} XP`;
		
		// Calculate XP progress safely
		let progressPercent = 0;
		let xpToNextLevel = 200;
		try {
			progressPercent = getXPProgress();
			xpToNextLevel = getXPToNextLevel();
		} catch (e) {
			// Fallback calculation
			const nextLevelXP = (currentLevel * 200);
			const currentLevelXP = ((currentLevel - 1) * 200);
			progressPercent = Math.min(100, Math.max(0, ((currentXP - currentLevelXP) / (nextLevelXP - currentLevelXP)) * 100));
			xpToNextLevel = nextLevelXP - currentXP;
		}
		
		if (progressBar) progressBar.style.width = `${progressPercent}%`;
		if (xpToNext) xpToNext.textContent = `${xpToNextLevel} XP to next level`;
		
		// Get streaks data for rendering
		const streaks = getStreakStatus();
		
		// Update daily streaks grid
		const dailyStreaksGrid = document.getElementById('daily-streaks-grid');
		if (dailyStreaksGrid) {
			dailyStreaksGrid.innerHTML = `
				<div class="streak-card ${streaks.steps.met ? 'met' : ''}" style="
					background: ${streaks.steps.met ? 'var(--mint-50)' : 'var(--canvas)'};
					border: 2px solid ${streaks.steps.met ? 'var(--numan-teal)' : '#e5e7eb'};
					border-radius: 16px;
					padding: 1.5rem;
					text-align: center;
					transition: all 0.3s ease;
					position: relative;
					overflow: hidden;
				">
					<div class="streak-icon" style="
						font-size: 2.5rem;
						margin-bottom: 1rem;
						display: block;
					">👟</div>
					<div class="streak-title" style="
						font-size: 1.1rem;
						font-weight: 700;
						color: var(--ink);
						margin-bottom: 0.5rem;
						text-transform: uppercase;
						letter-spacing: 0.05em;
					">Steps</div>
					<div class="streak-count" style="
						font-size: 3rem;
						font-weight: 800;
						color: ${streaks.steps.met ? 'var(--numan-teal)' : 'var(--ink-60)'};
						margin-bottom: 0.5rem;
						line-height: 1;
					">${streaks.steps.streak} ${streaks.steps.streak === 1 ? 'Day' : 'Days'}</div>
					<div class="streak-status" style="
						font-size: 0.9rem;
						color: ${streaks.steps.met ? '#10b981' : 'var(--ink-60)'};
						font-weight: 600;
						background: ${streaks.steps.met ? '#dcfce7' : '#f9fafb'};
						padding: 0.5rem 1rem;
						border-radius: 20px;
						display: inline-block;
					">${streaks.steps.met ? 'Met today!' : 'Not met today'}</div>
					<div class="streak-target" style="
						font-size: 0.8rem;
						color: var(--ink-60);
						margin-top: 0.75rem;
						opacity: 0.8;
					">Target: 8,000 steps</div>
				</div>
				<div class="streak-card ${streaks.sleep.met ? 'met' : ''}" style="
					background: ${streaks.sleep.met ? 'var(--mint-50)' : 'var(--canvas)'};
					border: 2px solid ${streaks.sleep.met ? 'var(--numan-teal)' : '#e5e7eb'};
					border-radius: 16px;
					padding: 1.5rem;
					text-align: center;
					transition: all 0.3s ease;
					position: relative;
					overflow: hidden;
				">
					<div class="streak-icon" style="
						font-size: 2.5rem;
						margin-bottom: 1rem;
						display: block;
					">😴</div>
					<div class="streak-title" style="
						font-size: 1.1rem;
						font-weight: 700;
						color: var(--ink);
						margin-bottom: 0.5rem;
						text-transform: uppercase;
						letter-spacing: 0.05em;
					">Sleep</div>
					<div class="streak-count" style="
						font-size: 3rem;
						font-weight: 800;
						color: ${streaks.sleep.met ? 'var(--numan-teal)' : 'var(--ink-60)'};
						margin-bottom: 0.5rem;
						line-height: 1;
					">${streaks.sleep.streak} ${streaks.sleep.streak === 1 ? 'Day' : 'Days'}</div>
					<div class="streak-status" style="
						font-size: 0.9rem;
						color: ${streaks.sleep.met ? '#10b981' : 'var(--ink-60)'};
						font-weight: 600;
						background: ${streaks.sleep.met ? '#dcfce7' : '#f9fafb'};
						padding: 0.5rem 1rem;
						border-radius: 20px;
						display: inline-block;
					">${streaks.sleep.met ? 'Met today!' : 'Not met today'}</div>
					<div class="streak-target" style="
						font-size: 0.8rem;
						color: var(--ink-60);
						margin-top: 0.75rem;
						opacity: 0.8;
					">Target: 7-9 hours</div>
				</div>
			`;
		}
		
		// Render wearables content on streaks page
		const wearablesContent = document.getElementById('streaks-wearables-content');
		if (wearablesContent) {
			const insights = getWearableInsights();
			const goals = getGoalProgress();
			
			wearablesContent.innerHTML = `
				<div class="metrics-grid" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:1rem; margin-top:1rem">
					<div class="metric-card" style="background:var(--canvas); padding:1rem; border-radius:8px; text-align:center">
						<h4 style="margin:0 0 0.5rem 0; color:var(--ink-60); font-size:0.9rem">Steps</h4>
						<div style="font-size:1.5rem; font-weight:700; color:var(--numan-teal); margin-bottom:0.25rem">${insights.metrics?.avgSteps || 0}</div>
						<div style="font-size:0.8rem; color:var(--ink-60)">Target: 8,000</div>
					</div>
					<div class="metric-card" style="background:var(--canvas); padding:1rem; border-radius:8px; text-align:center">
						<h4 style="margin:0 0 0.5rem 0; color:var(--ink-60); font-size:0.9rem">Sleep</h4>
						<div style="font-size:1.5rem; font-weight:700; color:var(--numan-teal); margin-bottom:0.25rem">${insights.metrics?.avgSleep || 0}h</div>
						<div style="font-size:0.8rem; color:var(--ink-60)">Target: 7-9h</div>
					</div>
					<div class="metric-card" style="background:var(--canvas); padding:1rem; border-radius:8px; text-align:center">
						<h4 style="margin:0 0 0.5rem 0; color:var(--ink-60); font-size:0.9rem">Resting HR</h4>
						<div style="font-size:1.5rem; font-weight:700; color:var(--numan-teal); margin-bottom:0.25rem">${insights.metrics?.avgRHR || 0} bpm</div>
						<div style="font-size:0.8rem; color:var(--ink-60)">Target: <60</div>
					</div>
					<div class="metric-card" style="background:var(--canvas); padding:1rem; border-radius:8px; text-align:center">
						<h4 style="margin:0 0 0.5rem 0; color:var(--ink-60); font-size:0.9rem">HRV</h4>
						<div style="font-size:1.5rem; font-weight:700; color:var(--numan-teal); margin-bottom:0.25rem">${insights.metrics?.avgHRV || 0} ms</div>
						<div style="font-size:0.8rem; color:var(--ink-60)">Target: >40</div>
					</div>
				</div>
			`;
		}
		
		// Update quests with dashboard content
		const questsContainer = document.getElementById('active-quests');
		if (questsContainer) {
			const quests = getActiveQuests();
			
			if (quests.length === 0) {
				questsContainer.innerHTML = '<p class="muted">No active quests. Complete your health goals to unlock new quests!</p>';
			} else {
				questsContainer.innerHTML = quests.map(quest => `
					<div class="service-card" style="margin-bottom:1rem">
						<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem">
							<h4 style="margin:0">${quest.title}</h4>
							<span class="badge" style="background:var(--numan-teal); color:white">+${quest.reward} XP</span>
						</div>
						<div style="background:#e5e7eb; height:6px; border-radius:3px; overflow:hidden; margin-bottom:0.5rem">
							<div style="background:var(--numan-teal); height:100%; width:${Math.min(100, (quest.current / quest.target) * 100)}%; transition:width 0.3s ease"></div>
						</div>
						<div style="display:flex; justify-content:space-between; align-items:center">
							<p class="muted" style="margin:0">${quest.current}/${quest.target}</p>
							${quest.current >= quest.target ? `<button class="btn btn-small" onclick="completeQuest('${quest.id}')">Complete</button>` : ''}
						</div>
					</div>
				`).join('');
			}
		}
		
		// Update badges
		const badgesContainer = document.getElementById('badges-container');
		if (badgesContainer) {
			badgesContainer.innerHTML = renderBadges();
		}
		
		// Update labs hub
		const labsHubCard = document.getElementById('labs-hub-card');
		const labsHub = document.getElementById('labs-hub');
		
		if (State.plan?.selectedIds?.includes('blood-tests')) {
			if (labsHubCard) labsHubCard.style.display = 'block';
			if (labsHub) labsHub.innerHTML = renderLabsHub();
		} else {
			if (labsHubCard) labsHubCard.style.display = 'none';
		}
	}

	// Expose to window for inline handlers
	Object.assign(window,{
		// ROUTER already exported
		// SERVICE REQUESTS
		openModal, closeModal, closeAssessmentModal, closeDriverPlaybookModal, requestServiceModal, submitServiceRequest, renderRequestsList,
		// DEVICE REQUESTS & BADGES
		requestDeviceModal, submitDeviceRequest, toggleDeviceReq, renderDeviceRequestsList, setPrimaryDevice, disconnectDevice, connectWearable, manageDevicesModal, skipWearables, populateLifestyleFromWearables, updateWearableDataDisplay, updateWearablesDataDisplay, updateWearableDataDisplayInOnboarding, renderOnboardingAssessments,
		// PLAN BUILDER
		renderPlan, toggleService, clearPlan, quickAddBundle, onCouponChange, onEmployerCodeChange, applyTier, eligibleForService, showGatedMessage, registerInterest, renderRecommendationExplanations,
		// TRIAGE
		riskScan,
		// DASHBOARD
		renderDashboard, renderDashboardChips, drawDashboardMiniAge, renderRiskFlags, renderTrends, handleRiskFlagAction, bookQuickCall, resetGoals, snoozeAlerts,
		// REFERRAL
		referModal, copyReferral,
		// EVENTS
		initCalendar, changeMonth, showDayEvents, rescheduleEvent, confirmReschedule, addCoachSession, confirmAddSession,
		// Wearables UI
		renderWearablesUI,
		// New Wearables Integration Functions
		addWearableConnection, removeWearableConnection, syncWearableData, getWearableInsights, updateStreaks, getActiveQuests, completeQuest,
		// Streaks & Goals
		getStreakStatus, updateDailyGoals, getGoalProgress,
		// Dashboard Integration
		renderDashboardWearables,
        goToAddons, goToCheckout,
		// Recommendations System
		getGoalPrimary, buildRecInput,
		// Assessment Modal Lifecycle
		finishAssessment,
		// Navigation Locking
		updateNavLocks, unlockNav,
		// Existing Plans
		toggleExistingPlan, renderExistingPlanForms, updateExistingPlan, removeExistingPlan,
		// Coach
		toggleCoachChat, sendCoachMessage, renderCoachMessages, appendCoachMessage, updateCoachButtonVisibility, updateCoachPlanInfo, openGPBookingModal, bookGPAppointment,
		// Landing deep link
		deepLinkToPlan,
		// Checkout
		loadCheckoutSummary, updateCheckout, toggleCheckoutBilling, completeCheckout, confirmCheckout, applyPartnerCode, populateDemoCheckoutData, clearFirstMonthSelections,
		// Onboarding controls
		startOnboarding, obNext, obPrev, toggleGoal, toggleSymptom, setUser, setOb, setPref, toggleConsent, calculateAgeFromDOB, applyPreferencesToSchedule, formatDateInput, updateAlcoholUnits, initAlcoholDisplay, toggleSmokingDetails, updateQuitReadinessLabel, updateBiologicalAgeModalContent, openBiologicalAgeExplanation, openBiologicalAgeExplanationFromPopup, openBiologicalAgePopup,
		// Symptoms
		selectSymptom, setOtherSymptoms,
		// Assessments
		startAssessment, showAssessmentModal, selectAssessmentAnswer, nextAssessmentQuestion, completeAssessment, completeScheduledAssessment, showAssessmentResult, repeatAssessment, viewAssessmentHistory, toggleAssessmentDropdown, showAssessmentResultInModal, getAssessmentInterpretation, addSuggestedAssessment, renderClinicalAssessmentOptions, addQuickAssessment, addClinicalAssessment, toggleClinicalAssessmentsAccordion, startClinicalAssessment, closeAssessmentHistoryModal,
		// Recommendation Engine
		getAssessment, buildFeatures, scorePackages, eligibleForTRT, assemblePlan, recommendPlan, explainSelections, checkSafetyFlags, editPlan, updatePlan, confirmPlanUpdate, showPriceUpdateConfirmation,
		// Account Page
		renderAccountPage, generateReferralCode, copyReferralCode, copyReferralLink, openFeedbackModal, openSupportModal, openManageSubscriptionModal, selectRating, submitFeedback,
		// Sign In/Out
		updateSignInOutButton, handleSignInOut, handleSignIn, handleSignOut,
		// NPS & Issues
		submitNPS, submitIssue,
		// Onboarding Biological Age
		renderOnboardingBiologicalAge, toggleOnboardingPeerComparison, renderOnboardingPeerComparison,
		// Age Calculation
		calculateAgeFromDOBInput, renderPeerComparison, refreshBiologicalAgeData, ensureWearablesData, updateBiologicalAgeDisplay,
		// Gamification System
		grantXP, levelFromXP, getXPProgress, getXPToNextLevel, checkStreaks, evaluateQuests, calculateQuestProgress, awardBadge, checkBadges, renderActiveQuests, renderBadges, grantXPForAction,
		// Labs System
		upsertLabResult, calculateLabFlag, renderLabTimeline, scheduleNextTest, renderLabsHub, orderBloodTest, selectBloodPanel, viewLabResults, seedLabsData,
		// Streaks Page
		renderStreaksPage,
		// Pricing System
           selectNewPlan, updateAddOnQty, renderMemberAddOns, updateNewPlanSummary, loadNewCheckoutSummary, setAnnual, selectPlan, setFirstMonthPicks,
		// Alert Management
		cleanupAlertBanners,
		// Misc
		resetDemo
	});
	// =============== RECOMMENDATION EVENT HANDLERS ===============
	document.getElementById('btnGetRecs')?.addEventListener('click', () => {
		try {
			const sig = recEngine.readSignals();
			console.log('Signals:', sig);
			const rec = recEngine.buildRecommendations(sig);
			console.log('Recommendations:', rec);
			
			// Ensure rec has the expected structure
			if (!rec || !rec.plan || !rec.picks) {
				console.error('Invalid recommendations structure:', rec);
				showToast('Error generating recommendations. Please try again.');
				return;
			}
			
			// Ensure addOns array exists
			if (!rec.addOns) {
				rec.addOns = [];
			}
			
			recEngine.renderModal(rec);
			recEngine.open();
			// focus the primary CTA for a11y
			setTimeout(()=>document.getElementById('btnApplyRecs')?.focus(), 0);
		} catch (error) {
			console.error('Error in recommendations:', error);
			showToast('Error generating recommendations. Please try again.');
		}
	});

	document.getElementById('btnApplyRecs')?.addEventListener('click', () => {
		recEngine.apply();
		recEngine.close();
		// Return focus to the button that launched the modal if it still exists
		setTimeout(()=>document.getElementById('btnGetRecs')?.focus(), 0);
	});

	// Generic close handler if you use data-close
	document.querySelectorAll('[data-close="recsModal"]').forEach(b=>{
		b.addEventListener('click', ()=> recEngine.close());
	});

	// Global error handler to prevent white screen crashes
	window.addEventListener('error', (event) => {
		console.error('Global error caught:', event.error);
		// Ensure at least one view is visible to prevent white screen
		const activeView = document.querySelector('[data-view].active');
		if (!activeView) {
			console.warn('No active view found after error, falling back to landing page');
			const landingView = document.querySelector('[data-view="landing"]');
			if (landingView) {
				document.querySelectorAll('[data-view]').forEach(v => v.classList.remove('active'));
				landingView.classList.add('active');
			}
		}
	});

	window.addEventListener('unhandledrejection', (event) => {
		console.error('Unhandled promise rejection:', event.reason);
		// Prevent the default browser behavior
		event.preventDefault();
	});

	document.addEventListener('DOMContentLoaded', ()=>{
		try {
		// Run state migration and install guards FIRST
		migrateState();
		installGlobalGuards();
		
		// Add defensive click handler for Biological age links
		document.addEventListener('click', (e) => {
			const a = e.target.closest('a[href="#biological-age"], a[data-route="biological-age"]');
			if (a){
				e.preventDefault();
				Router.go('metabolic-age');
			}
		});
		
		// Set boot guard to prevent accidental redirects during startup
		window.__bootGuardUntil = performance.now() + 800;
			
			// Initialize core systems with error handling
			if (typeof seedDemoOnce === 'function') seedDemoOnce();
			if (typeof ensureCorrectPlanTier === 'function') ensureCorrectPlanTier();
			if (typeof fixGenderValues === 'function') fixGenderValues();
			if (typeof renderDeviceBadges === 'function') renderDeviceBadges();
			if (typeof initializeToggles === 'function') initializeToggles();
			if (typeof updateNavigationVisibility === 'function') updateNavigationVisibility();
			if (typeof renderNewTierGrid === 'function') renderNewTierGrid();
			if (typeof refreshPlanSummary === 'function') refreshPlanSummary();
		
		// Initialize wearables system
			if (typeof loadWearablesFromStorage === 'function') loadWearablesFromStorage();
		
		// Initialize streaks and quests
			if (typeof updateStreaks === 'function') updateStreaks();
			if (typeof getActiveQuests === 'function') getActiveQuests();
		
		// Initialize navigation locks
			if (typeof updateNavLocks === 'function') updateNavLocks();
			if (typeof updateSignInOutButton === 'function') updateSignInOutButton();
		
		// Initialize gamification and labs systems
			if (typeof checkStreaks === 'function') checkStreaks();
			if (typeof evaluateQuests === 'function') evaluateQuests();
			if (typeof checkBadges === 'function') checkBadges();
			if (typeof seedLabsData === 'function') seedLabsData();
		
		// Award some demo badges for testing
		setTimeout(() => {
				try {
					if (State.rewards?.state?.badgesEarned && !State.rewards.state.badgesEarned.includes('first-sync')) {
				State.rewards.state.badgesEarned.push('first-sync');
				save({'rewards.state': State.rewards.state});
					}
				} catch (e) {
					console.warn('Error awarding demo badge:', e);
			}
		}, 1000);
		
		// Grant initial XP for completing onboarding
			try {
		if (State.onboarding?.completed && !State.rewards?.state?.onboardingRewarded) {
					if (typeof grantXP === 'function') grantXP(100, 'Completed onboarding');
			State.rewards.state.onboardingRewarded = true;
			save({'rewards.state': State.rewards.state});
				}
			} catch (e) {
				console.warn('Error granting onboarding XP:', e);
		}
		
		// Always start on landing page regardless of saved state
		// Clear any saved view to ensure we start fresh on landing
		State.currentView = 'landing';
		save({'currentView': 'landing'});
			
			// Force navigation to landing page with error handling
			try {
		Router.go('landing');
			} catch (e) {
				console.error('Error navigating to landing page:', e);
				// Fallback: manually show landing page
				const landingView = document.querySelector('[data-view="landing"]');
				if (landingView) {
					document.querySelectorAll('[data-view]').forEach(v => v.classList.remove('active'));
					landingView.classList.add('active');
				}
			}
			
		// Force scroll to top
		window.scrollTo(0, 0);
		document.documentElement.scrollTop = 0;
		document.body.scrollTop = 0;
			
		// Ensure home tiles and nav states initialize immediately
			if (typeof renderLandingTiles === 'function') renderLandingTiles();
			if (typeof updateNavigationVisibility === 'function') updateNavigationVisibility();
			if (typeof updateNavLocks === 'function') updateNavLocks();
			
		} catch (error) {
			console.error('Error during initialization:', error);
			// Fallback: ensure at least the landing page is visible
			try {
				const landingView = document.querySelector('[data-view="landing"]');
				if (landingView) {
					document.querySelectorAll('[data-view]').forEach(v => v.classList.remove('active'));
					landingView.classList.add('active');
				}
			} catch (fallbackError) {
				console.error('Fallback initialization failed:', fallbackError);
			}
		}
		
		// Clean up any invalid user data and ensure landing tiles are rendered
		cleanUserData();
		
		// Ensure landing tiles are rendered after a short delay to ensure DOM is ready
		setTimeout(() => {
			renderLandingTiles(); // double-call safe; idempotent render
			// Ensure navigation locks are applied after DOM is ready
			updateNavigationVisibility();
			updateNavLocks();
			// Debug: log current state
			console.log('Current view:', State.currentView);
			console.log('Navigation unlocked:', State.navUnlocked);
			console.log('Tests state:', State.tests);
		}, 50);
		
		setTimeout(() => {
			// Clear any stale BMI/WTH calculations
			updateBMIAndWTH();
			// Update biological age if we have data
			if (State.user.age || State.user.height || State.user.weight) {
				calculateBiologicalAge();
			}
		}, 100);
		
		runTests();
		// Update tests badge after a short delay to ensure State.tests is set
		setTimeout(() => {
			updateTestsBadge();
		}, 10);
	});
	</script>
	
	
</body>
</html>
</html>
